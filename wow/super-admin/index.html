<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wow Super Admin | God Mode</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Toastify -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #020617 0%, #0f172a 50%, #020617 100%);
            color: white;
            min-height: 100vh;
        }

        .glass {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass:hover {
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 20px 40px -15px rgba(59, 130, 246, 0.15);
        }

        .glass-static {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Gradient text */
        .gradient-text {
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 50%, #f472b6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Animations */
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 12px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .animate-slide-in {
            animation: slideIn 0.5s ease-out forwards;
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .animate-scale-in {
            animation: scaleIn 0.3s ease-out forwards;
        }

        .pulse-active {
            animation: pulse-glow 2s infinite;
        }

        .float-animation {
            animation: float 6s ease-in-out infinite;
        }

        .shimmer {
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.1) 50%, transparent 100%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        .active-nav {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.15) 0%, transparent 100%);
            border-right: 3px solid #3b82f6;
            color: #60a5fa;
        }

        /* Stat cards */
        .stat-card {
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-color), transparent);
        }

        .stat-card-blue { --accent-color: #3b82f6; }
        .stat-card-purple { --accent-color: #a855f7; }
        .stat-card-red { --accent-color: #ef4444; }
        .stat-card-green { --accent-color: #22c55e; }
        .stat-card-orange { --accent-color: #f97316; }
        .stat-card-cyan { --accent-color: #06b6d4; }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            box-shadow: 0 10px 30px -10px rgba(59, 130, 246, 0.5);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Table */
        .table-row {
            transition: all 0.2s ease;
        }

        .table-row:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(2, 6, 23, 0.5);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #334155 0%, #1e293b 100%);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        /* Notification badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #020617;
        }

        /* Chart container */
        .chart-container {
            position: relative;
            height: 250px;
        }

        /* Activity item */
        .activity-item {
            position: relative;
            padding-left: 30px;
        }

        .activity-item::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 24px;
            bottom: -16px;
            width: 2px;
            background: linear-gradient(180deg, #334155 0%, transparent 100%);
        }

        .activity-item:last-child::before {
            display: none;
        }

        .activity-dot {
            position: absolute;
            left: 0;
            top: 6px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Mobile menu button */
        .mobile-menu-btn {
            display: none;
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: flex;
            }
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            z-index: 100;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast-success {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.9), rgba(22, 163, 74, 0.9));
            border: 1px solid rgba(34, 197, 94, 0.5);
        }

        .toast-error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.9));
            border: 1px solid rgba(239, 68, 68, 0.5);
        }

        /* Quick action button */
        .quick-action {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .quick-action:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.15);
            transform: scale(1.02);
        }

        /* Search highlight */
        .search-highlight {
            background: rgba(59, 130, 246, 0.3);
            border-radius: 2px;
        }

        /* Subscription Plan Badges */
        .plan-free { background: linear-gradient(135deg, #64748b, #475569); }
        .plan-starter { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .plan-pro { background: linear-gradient(135deg, #a855f7, #7c3aed); }
        .plan-enterprise { background: linear-gradient(135deg, #f59e0b, #d97706); }
        
        .plan-badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Revenue Card Glow */
        .revenue-glow {
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.2);
        }

        /* Feature Lock Icon */
        .feature-locked {
            position: relative;
        }
        .feature-locked::after {
            content: '🔒';
            position: absolute;
            top: -4px;
            right: -4px;
            font-size: 10px;
        }
    </style>
</head>

<body class="h-screen flex overflow-hidden selection:bg-blue-500 selection:text-white">

    <!-- Toast Notification (Legacy - now using Toastify) -->
    <div id="toast" class="toast hidden">
        <div class="flex items-center gap-3">
            <i id="toastIcon" class="fas fa-check-circle"></i>
            <span id="toastMessage">Success!</span>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="hidden fixed inset-0 z-[10000] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-md rounded-2xl p-6 shadow-2xl animate-scale-in">
            <div class="text-center mb-6">
                <div id="confirmIcon" class="w-16 h-16 bg-red-500/10 rounded-full mx-auto flex items-center justify-center mb-4">
                    <i class="fas fa-question-circle text-3xl text-red-400"></i>
                </div>
                <h3 id="confirmTitle" class="text-xl font-bold text-white">Confirm Action</h3>
                <p id="confirmMessage" class="text-slate-400 text-sm mt-2">Are you sure you want to proceed?</p>
            </div>
            <div class="flex gap-3">
                <button onclick="resolveConfirm(false)" class="flex-1 py-3 rounded-xl bg-slate-800 text-slate-300 font-bold hover:bg-slate-700 transition">
                    Cancel
                </button>
                <button onclick="resolveConfirm(true)" id="confirmBtn" class="flex-1 py-3 rounded-xl bg-red-500 text-white font-bold hover:bg-red-600 transition">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Super Admin Login Overlay -->
    <div id="superadmin-login-overlay" class="fixed inset-0 z-[9999] flex items-center justify-center bg-slate-950">
        <div class="bg-slate-900 border border-slate-700 p-8 rounded-2xl w-96 text-center shadow-2xl">
            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl mx-auto mb-4 flex items-center justify-center shadow-lg shadow-blue-500/30">
                <i class="fas fa-shield-alt text-white text-2xl"></i>
            </div>
            <h1 class="text-2xl font-black text-white mb-1">WOWCORE</h1>
            <p class="text-xs text-slate-500 uppercase tracking-widest mb-6">Super Admin Access</p>
            
            <input type="password" id="superadmin-password" 
                class="w-full bg-slate-800 border border-slate-700 text-white rounded-xl px-4 py-3 mb-4 text-center text-lg tracking-widest focus:border-blue-500 focus:outline-none"
                placeholder="Enter Password" onkeydown="if(event.key==='Enter')checkSuperAdminLogin()">
            
            <button onclick="checkSuperAdminLogin()" 
                class="w-full btn-primary text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2">
                <i class="fas fa-unlock-alt"></i> Access System
            </button>
            
            <p id="superadmin-login-error" class="text-red-400 text-xs font-bold mt-4 hidden">
                <i class="fas fa-exclamation-triangle"></i> Invalid Password
            </p>
        </div>
    </div>

    <!-- Mobile Menu Overlay -->
    <div id="mobileOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-30 hidden md:hidden" onclick="toggleMobileMenu()"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="w-72 bg-slate-950/95 backdrop-blur-xl border-r border-slate-800/50 flex flex-col z-40 fixed md:relative h-full transform -translate-x-full md:translate-x-0 transition-transform duration-300">
        <div class="p-6 border-b border-slate-800/50">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center shadow-lg shadow-blue-500/20">
                    <i class="fas fa-cube text-white"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold gradient-text">WOWCORE</h1>
                    <p class="text-[10px] text-slate-500 font-mono flex items-center gap-1">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                        SYSTEM v6.0 ONLINE
                    </p>
                </div>
            </div>
        </div>

        <nav class="flex-1 p-4 space-y-1">
            <p class="text-[10px] text-slate-600 uppercase tracking-widest font-semibold px-4 mb-3">Main Menu</p>
            <button onclick="switchView('dashboard')" id="nav-dashboard"
                class="w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white rounded-xl transition text-left active-nav">
                <div class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center">
                    <i class="fas fa-chart-pie text-blue-400 text-sm"></i>
                </div>
                <span>Dashboard</span>
            </button>
            <button onclick="switchView('health')" id="nav-health"
                class="w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white rounded-xl transition text-left">
                <div class="w-8 h-8 rounded-lg bg-purple-500/10 flex items-center justify-center">
                    <i class="fas fa-project-diagram text-purple-400 text-sm"></i>
                </div>
                <span>Network Health</span>
            </button>
            <button onclick="switchView('analytics')" id="nav-analytics"
                class="w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white rounded-xl transition text-left">
                <div class="w-8 h-8 rounded-lg bg-cyan-500/10 flex items-center justify-center">
                    <i class="fas fa-chart-line text-cyan-400 text-sm"></i>
                </div>
                <span>Analytics</span>
            </button>
            <button onclick="switchView('activity')" id="nav-activity"
                class="w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white rounded-xl transition text-left">
                <div class="w-8 h-8 rounded-lg bg-orange-500/10 flex items-center justify-center">
                    <i class="fas fa-history text-orange-400 text-sm"></i>
                </div>
                <span>Activity Log</span>
            </button>
            <button onclick="switchView('database')" id="nav-database"
                class="w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white rounded-xl transition text-left">
                <div class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center">
                    <i class="fas fa-database text-emerald-400 text-sm"></i>
                </div>
                <span>Database Explorer</span>
            </button>
            <button onclick="switchView('monitor')" id="nav-monitor"
                class="w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white rounded-xl transition text-left">
                <div class="w-8 h-8 rounded-lg bg-red-500/10 flex items-center justify-center">
                    <i class="fas fa-heartbeat text-red-400 text-sm"></i>
                </div>
                <span>System Monitor</span>
            </button>

            <p class="text-[10px] text-slate-600 uppercase tracking-widest font-semibold px-4 mb-3 mt-6">Actions</p>
            <button onclick="openOnboardModal()"
                class="w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white rounded-xl transition text-left">
                <div class="w-8 h-8 rounded-lg bg-green-500/10 flex items-center justify-center">
                    <i class="fas fa-plus text-green-400 text-sm"></i>
                </div>
                <span>Deploy Node</span>
            </button>
            <button onclick="openSettingsModal()"
                class="w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white rounded-xl transition text-left">
                <div class="w-8 h-8 rounded-lg bg-slate-500/10 flex items-center justify-center">
                    <i class="fas fa-cog text-slate-400 text-sm"></i>
                </div>
                <span>Settings</span>
            </button>
        </nav>

        <div class="p-4 border-t border-slate-800/50">
            <div class="glass-static rounded-xl p-4">
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <div class="w-11 h-11 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center font-bold text-white shadow-lg pulse-active">
                            Y
                        </div>
                        <span class="absolute -bottom-0.5 -right-0.5 w-4 h-4 bg-green-500 rounded-full border-2 border-slate-950"></span>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-semibold text-white">Yug Mittal</p>
                        <p class="text-[10px] text-green-400 font-mono">● SUPER ADMIN</p>
                    </div>
                    <button onclick="logout()" class="text-slate-500 hover:text-red-400 transition" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto relative bg-transparent">
        <!-- Header -->
        <header class="p-5 sticky top-0 bg-slate-950/80 backdrop-blur-xl z-10 border-b border-slate-800/50 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <button onclick="toggleMobileMenu()" class="mobile-menu-btn w-10 h-10 rounded-xl bg-slate-800 items-center justify-center text-slate-400 hover:text-white transition md:hidden">
                    <i class="fas fa-bars"></i>
                </button>
                <div>
                    <h2 id="pageTitle" class="text-xl font-bold text-white">System Overview</h2>
                    <p id="pageSubtitle" class="text-xs text-slate-500">Welcome back, Yug</p>
                </div>
            </div>
            <div class="flex gap-3 items-center">
                <div class="hidden lg:flex items-center gap-2 text-xs font-mono text-slate-500 bg-slate-900/50 px-4 py-2 rounded-xl border border-slate-800">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    LATENCY: <span id="pingRate" class="text-green-400 font-semibold">--ms</span>
                </div>
                <button onclick="openNotifications()" class="relative w-10 h-10 rounded-xl bg-slate-800/50 border border-slate-700 flex items-center justify-center text-slate-400 hover:text-white hover:border-slate-600 transition">
                    <i class="fas fa-bell"></i>
                    <span id="notifBadge" class="notification-badge hidden">0</span>
                </button>
                <button onclick="fetchClients()" class="btn-primary text-white text-xs px-5 py-2.5 rounded-xl shadow-lg flex items-center gap-2">
                    <i class="fas fa-sync-alt" id="refreshIcon"></i>
                    <span class="hidden sm:inline">SYNC DATA</span>
                </button>
            </div>
        </header>

        <!-- Dashboard View -->
        <div id="view-dashboard" class="p-6 lg:p-8 max-w-7xl mx-auto space-y-6 animate-fade-in">
            <!-- Stats Grid -->
            <div class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
                <div class="glass stat-card stat-card-blue p-5 rounded-2xl col-span-1">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-slate-400 text-[10px] uppercase font-bold tracking-wider">Total Revenue</p>
                            <h3 class="text-2xl lg:text-3xl font-bold mt-1 text-white">₹<span id="statRevenue">0</span></h3>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-blue-500/10 flex items-center justify-center">
                            <i class="fas fa-wallet text-blue-400"></i>
                        </div>
                    </div>
                    <p class="text-[10px] text-green-400 mt-3 flex items-center gap-1">
                        <i class="fas fa-arrow-up"></i> <span id="revenueTrend">+0%</span> from last week
                    </p>
                </div>
                <div class="glass stat-card stat-card-purple p-5 rounded-2xl col-span-1">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-slate-400 text-[10px] uppercase font-bold tracking-wider">Active Nodes</p>
                            <h3 class="text-2xl lg:text-3xl font-bold mt-1 text-white" id="statActive">0</h3>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-purple-500/10 flex items-center justify-center">
                            <i class="fas fa-server text-purple-400"></i>
                        </div>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-3">of <span id="totalNodes">0</span> total nodes</p>
                </div>
                <div class="glass stat-card stat-card-red p-5 rounded-2xl col-span-1">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-slate-400 text-[10px] uppercase font-bold tracking-wider">System Alerts</p>
                            <h3 class="text-2xl lg:text-3xl font-bold mt-1 text-red-400" id="statAlerts">0</h3>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-red-500/10 flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-red-400"></i>
                        </div>
                    </div>
                    <p class="text-[10px] text-red-400 mt-3 cursor-pointer hover:underline" onclick="showAlerts()">View all alerts →</p>
                </div>
                <div class="glass stat-card stat-card-green p-5 rounded-2xl col-span-1">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-slate-400 text-[10px] uppercase font-bold tracking-wider">AI Tokens</p>
                            <h3 class="text-2xl lg:text-3xl font-bold mt-1 text-green-400" id="aiUsage">0</h3>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-green-500/10 flex items-center justify-center">
                            <i class="fas fa-brain text-green-400"></i>
                        </div>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-3">Used this session</p>
                </div>
                <div class="glass stat-card stat-card-orange p-5 rounded-2xl col-span-1">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-slate-400 text-[10px] uppercase font-bold tracking-wider">Orders Today</p>
                            <h3 class="text-2xl lg:text-3xl font-bold mt-1 text-orange-400" id="ordersToday">0</h3>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-orange-500/10 flex items-center justify-center">
                            <i class="fas fa-shopping-bag text-orange-400"></i>
                        </div>
                    </div>
                    <p class="text-[10px] text-green-400 mt-3 flex items-center gap-1">
                        <i class="fas fa-arrow-up"></i> +12% vs yesterday
                    </p>
                </div>
                <div class="glass stat-card stat-card-cyan p-5 rounded-2xl col-span-1">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-slate-400 text-[10px] uppercase font-bold tracking-wider">Uptime</p>
                            <h3 class="text-2xl lg:text-3xl font-bold mt-1 text-cyan-400" id="uptime">99.9%</h3>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-cyan-500/10 flex items-center justify-center">
                            <i class="fas fa-signal text-cyan-400"></i>
                        </div>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-3">Last 30 days</p>
                </div>
            </div>

            <!-- SaaS Revenue Stats -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
                <div class="glass-static revenue-glow rounded-2xl p-5 border border-green-500/20">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-[10px] text-green-400 uppercase font-bold tracking-wider">💰 Monthly Revenue (MRR)</span>
                    </div>
                    <h3 class="text-3xl font-bold text-green-400">₹<span id="mrrValue">0</span></h3>
                    <p class="text-xs text-slate-500 mt-2">From <span id="paidNodes">0</span> paid subscriptions</p>
                </div>
                <div class="glass-static rounded-2xl p-5 border border-slate-800/50">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">📊 Plan Distribution</span>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <span class="plan-badge plan-free" id="countFree">Free: 0</span>
                        <span class="plan-badge plan-starter" id="countStarter">Starter: 0</span>
                        <span class="plan-badge plan-pro" id="countPro">Pro: 0</span>
                        <span class="plan-badge plan-enterprise" id="countEnterprise">Enterprise: 0</span>
                    </div>
                </div>
                <div class="glass-static rounded-2xl p-5 border border-slate-800/50">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">📅 Renewals This Month</span>
                    </div>
                    <h3 class="text-2xl font-bold text-white" id="renewalsCount">0</h3>
                    <p class="text-xs text-yellow-400 mt-2">₹<span id="renewalsValue">0</span> expected</p>
                </div>
                <div class="glass-static rounded-2xl p-5 border border-slate-800/50">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">⚡ Feature Usage</span>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-xs">
                            <span class="text-slate-400">AI Orders</span>
                            <span class="text-cyan-400" id="featureAI">0</span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="text-slate-400">Custom Domains</span>
                            <span class="text-purple-400" id="featureDomains">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="glass-static rounded-2xl p-5 border border-slate-800/50">
                <h3 class="font-semibold text-white mb-4 flex items-center gap-2">
                    <i class="fas fa-bolt text-yellow-400"></i> Quick Actions
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                    <button onclick="openOnboardModal()" class="quick-action p-4 rounded-xl text-center">
                        <div class="w-10 h-10 mx-auto rounded-lg bg-green-500/10 flex items-center justify-center mb-2">
                            <i class="fas fa-plus text-green-400"></i>
                        </div>
                        <span class="text-xs text-slate-300">Add Node</span>
                    </button>
                    <button onclick="exportData()" class="quick-action p-4 rounded-xl text-center">
                        <div class="w-10 h-10 mx-auto rounded-lg bg-blue-500/10 flex items-center justify-center mb-2">
                            <i class="fas fa-download text-blue-400"></i>
                        </div>
                        <span class="text-xs text-slate-300">Export Data</span>
                    </button>
                    <button onclick="bulkRecharge()" class="quick-action p-4 rounded-xl text-center">
                        <div class="w-10 h-10 mx-auto rounded-lg bg-purple-500/10 flex items-center justify-center mb-2">
                            <i class="fas fa-coins text-purple-400"></i>
                        </div>
                        <span class="text-xs text-slate-300">Bulk Recharge</span>
                    </button>
                    <button onclick="sendBroadcast()" class="quick-action p-4 rounded-xl text-center">
                        <div class="w-10 h-10 mx-auto rounded-lg bg-orange-500/10 flex items-center justify-center mb-2">
                            <i class="fas fa-broadcast-tower text-orange-400"></i>
                        </div>
                        <span class="text-xs text-slate-300">Broadcast</span>
                    </button>
                    <button onclick="generateReport()" class="quick-action p-4 rounded-xl text-center">
                        <div class="w-10 h-10 mx-auto rounded-lg bg-cyan-500/10 flex items-center justify-center mb-2">
                            <i class="fas fa-file-alt text-cyan-400"></i>
                        </div>
                        <span class="text-xs text-slate-300">Generate Report</span>
                    </button>
                    <button onclick="openSettingsModal()" class="quick-action p-4 rounded-xl text-center">
                        <div class="w-10 h-10 mx-auto rounded-lg bg-slate-500/10 flex items-center justify-center mb-2">
                            <i class="fas fa-cog text-slate-400"></i>
                        </div>
                        <span class="text-xs text-slate-300">Settings</span>
                    </button>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                <!-- Partner Ecosystem Table -->
                <div class="xl:col-span-2 glass-static rounded-2xl overflow-hidden border border-slate-800/50">
                    <div class="p-5 border-b border-slate-800/50 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <h3 class="font-semibold text-white flex items-center gap-2">
                            <i class="fas fa-store text-blue-400"></i> Partner Ecosystem
                        </h3>
                        <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                            <div class="relative">
                                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-500 text-sm"></i>
                                <input type="text" placeholder="Search nodes..." onkeyup="searchTable()" id="searchInput"
                                    class="bg-slate-900/50 border border-slate-700 text-sm rounded-xl pl-10 pr-4 py-2.5 outline-none focus:border-blue-500 w-full sm:w-56 text-slate-300 placeholder-slate-500 transition">
                            </div>
                            <select id="statusFilter" onchange="filterByStatus()" class="bg-slate-900/50 border border-slate-700 text-sm rounded-xl px-4 py-2.5 outline-none focus:border-blue-500 text-slate-300">
                                <option value="all">All Status</option>
                                <option value="active">Active</option>
                                <option value="blocked">Blocked</option>
                                <option value="low-balance">Low Balance</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-[400px] overflow-y-auto">
                        <table class="w-full text-left text-sm text-slate-400">
                            <thead class="bg-slate-900/80 text-slate-300 uppercase font-semibold text-[10px] tracking-wider sticky top-0">
                                <tr>
                                    <th class="px-6 py-4 cursor-pointer hover:text-blue-400" onclick="sortTable('name')">
                                        Cafe Node <i class="fas fa-sort ml-1 opacity-50"></i>
                                    </th>
                                    <th class="px-6 py-4 cursor-pointer hover:text-blue-400" onclick="sortTable('wallet')">
                                        Balance <i class="fas fa-sort ml-1 opacity-50"></i>
                                    </th>
                                    <th class="px-6 py-4">Status</th>
                                    <th class="px-6 py-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="clientTableBody" class="divide-y divide-slate-800/50">
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t border-slate-800/50 flex justify-between items-center">
                        <p class="text-xs text-slate-500">Showing <span id="showingCount">0</span> of <span id="totalCount">0</span> nodes</p>
                        <div class="flex gap-2">
                            <button onclick="prevPage()" class="btn-secondary text-xs px-3 py-1.5 rounded-lg text-slate-400">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button onclick="nextPage()" class="btn-secondary text-xs px-3 py-1.5 rounded-lg text-slate-400">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity Sidebar -->
                <div class="glass-static rounded-2xl p-5 border border-slate-800/50">
                    <h3 class="font-semibold text-white mb-4 flex items-center justify-between">
                        <span class="flex items-center gap-2">
                            <i class="fas fa-clock text-orange-400"></i> Recent Activity
                        </span>
                        <button onclick="switchView('activity')" class="text-xs text-blue-400 hover:text-blue-300">View All</button>
                    </h3>
                    <div id="recentActivity" class="space-y-4 max-h-[350px] overflow-y-auto">
                        <!-- Activities will be rendered here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Network Health View -->
        <div id="view-health" class="hidden p-6 lg:p-8 max-w-7xl mx-auto space-y-8 animate-fade-in">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-white">Network Matrix</h2>
                    <p class="text-slate-500 text-sm mt-1">Real-time status of all deployed cafe nodes.</p>
                </div>
                <div class="glass-static rounded-2xl p-4 text-right">
                    <h2 class="text-4xl font-bold text-green-400" id="healthScore">100%</h2>
                    <p class="text-[10px] text-slate-500 uppercase tracking-widest">Network Integrity</p>
                </div>
            </div>

            <div class="h-2 w-full bg-slate-800 rounded-full overflow-hidden">
                <div id="healthBar" class="h-full bg-gradient-to-r from-green-500 to-emerald-400 w-full transition-all duration-1000 shadow-[0_0_20px_rgba(34,197,94,0.5)]">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="glass-static rounded-xl p-4 border border-slate-800/50">
                    <div class="flex items-center gap-3">
                        <div class="w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]"></div>
                        <span class="text-sm text-slate-300">Healthy Nodes</span>
                    </div>
                    <p class="text-2xl font-bold text-white mt-2" id="healthyCount">0</p>
                </div>
                <div class="glass-static rounded-xl p-4 border border-slate-800/50">
                    <div class="flex items-center gap-3">
                        <div class="w-3 h-3 rounded-full bg-yellow-500 shadow-[0_0_10px_rgba(234,179,8,0.5)]"></div>
                        <span class="text-sm text-slate-300">Warning (Low Balance)</span>
                    </div>
                    <p class="text-2xl font-bold text-white mt-2" id="warningCount">0</p>
                </div>
                <div class="glass-static rounded-xl p-4 border border-slate-800/50">
                    <div class="flex items-center gap-3">
                        <div class="w-3 h-3 rounded-full bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)]"></div>
                        <span class="text-sm text-slate-300">Critical (Blocked)</span>
                    </div>
                    <p class="text-2xl font-bold text-white mt-2" id="criticalCount">0</p>
                </div>
            </div>

            <div id="nodeGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            </div>
        </div>

        <!-- Analytics View -->
        <div id="view-analytics" class="hidden p-6 lg:p-8 max-w-7xl mx-auto space-y-6 animate-fade-in">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-white">Analytics Dashboard</h2>
                    <p class="text-slate-500 text-sm mt-1">Comprehensive business insights and trends.</p>
                </div>
                <div class="flex gap-2">
                    <select id="analyticsRange" onchange="updateAnalytics()" class="bg-slate-900/50 border border-slate-700 text-sm rounded-xl px-4 py-2 outline-none text-slate-300">
                        <option value="7">Last 7 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="90">Last 90 days</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass-static rounded-2xl p-6 border border-slate-800/50">
                    <h3 class="font-semibold text-white mb-4 flex items-center gap-2">
                        <i class="fas fa-chart-line text-blue-400"></i> Revenue Trend
                    </h3>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
                <div class="glass-static rounded-2xl p-6 border border-slate-800/50">
                    <h3 class="font-semibold text-white mb-4 flex items-center gap-2">
                        <i class="fas fa-chart-pie text-purple-400"></i> Node Distribution
                    </h3>
                    <div class="chart-container">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="glass-static rounded-2xl p-6 border border-slate-800/50">
                    <h3 class="font-semibold text-white mb-4">Top Performing Nodes</h3>
                    <div id="topNodes" class="space-y-3">
                        <!-- Top nodes will be rendered here -->
                    </div>
                </div>
                <div class="glass-static rounded-2xl p-6 border border-slate-800/50">
                    <h3 class="font-semibold text-white mb-4">Low Balance Alerts</h3>
                    <div id="lowBalanceNodes" class="space-y-3">
                        <!-- Low balance nodes will be rendered here -->
                    </div>
                </div>
                <div class="glass-static rounded-2xl p-6 border border-slate-800/50">
                    <h3 class="font-semibold text-white mb-4">System Stats</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-slate-400 text-sm">API Calls Today</span>
                            <span class="text-white font-semibold" id="apiCalls">1,234</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-400 text-sm">Avg Response Time</span>
                            <span class="text-green-400 font-semibold">45ms</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-400 text-sm">Database Size</span>
                            <span class="text-white font-semibold">2.4 GB</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-400 text-sm">Active Sessions</span>
                            <span class="text-blue-400 font-semibold" id="activeSessions">12</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Log View -->
        <div id="view-activity" class="hidden p-6 lg:p-8 max-w-7xl mx-auto space-y-6 animate-fade-in">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-white">Activity Log</h2>
                    <p class="text-slate-500 text-sm mt-1">Complete history of system events and actions.</p>
                </div>
                <div class="flex gap-2">
                    <select id="activityFilter" onchange="filterActivity()" class="bg-slate-900/50 border border-slate-700 text-sm rounded-xl px-4 py-2 outline-none text-slate-300">
                        <option value="all">All Events</option>
                        <option value="create">Node Created</option>
                        <option value="recharge">Recharge</option>
                        <option value="block">Block/Unblock</option>
                        <option value="login">Login</option>
                    </select>
                    <button onclick="clearActivityLog()" class="btn-secondary text-xs px-4 py-2 rounded-xl text-slate-400">
                        <i class="fas fa-trash mr-1"></i> Clear Log
                    </button>
                </div>
            </div>

            <div class="glass-static rounded-2xl border border-slate-800/50 overflow-hidden">
                <div id="activityLog" class="divide-y divide-slate-800/50 max-h-[600px] overflow-y-auto">
                    <!-- Activity items will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Database Explorer View -->
        <div id="view-database" class="hidden p-6 lg:p-8 max-w-7xl mx-auto space-y-6 animate-fade-in">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-white">Database Explorer</h2>
                    <p class="text-slate-500 text-sm mt-1">Real-time view of Firebase data across all nodes.</p>
                </div>
                <div class="flex gap-2">
                    <select id="dbNodeSelect" onchange="loadNodeDatabase()" class="bg-slate-900/50 border border-slate-700 text-sm rounded-xl px-4 py-2 outline-none text-slate-300">
                        <option value="">Select a node...</option>
                    </select>
                    <button onclick="refreshDatabase()" class="btn-primary text-white text-xs px-4 py-2 rounded-xl">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- RTDB Data -->
                <div class="glass-static rounded-2xl p-5 border border-slate-800/50">
                    <h3 class="font-semibold text-white mb-4 flex items-center gap-2">
                        <i class="fas fa-bolt text-yellow-400"></i> Realtime Database
                    </h3>
                    <div id="rtdbData" class="bg-black/50 rounded-xl p-4 font-mono text-xs text-green-400 max-h-[400px] overflow-y-auto">
                        <p class="text-slate-500">Select a node to view RTDB data...</p>
                    </div>
                </div>

                <!-- Firestore Data -->
                <div class="glass-static rounded-2xl p-5 border border-slate-800/50">
                    <h3 class="font-semibold text-white mb-4 flex items-center gap-2">
                        <i class="fas fa-fire text-orange-400"></i> Firestore Collections
                    </h3>
                    <div id="firestoreData" class="bg-black/50 rounded-xl p-4 font-mono text-xs text-blue-400 max-h-[400px] overflow-y-auto">
                        <p class="text-slate-500">Select a node to view Firestore data...</p>
                    </div>
                </div>
            </div>

            <!-- Quick Database Actions -->
            <div class="glass-static rounded-2xl p-5 border border-slate-800/50">
                <h3 class="font-semibold text-white mb-4 flex items-center gap-2">
                    <i class="fas fa-terminal text-purple-400"></i> Database Actions
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                    <button onclick="verifyAllPasswords()" class="p-4 rounded-xl bg-slate-900/50 border border-slate-800 hover:border-blue-500 transition text-center">
                        <i class="fas fa-key text-blue-400 text-lg mb-2"></i>
                        <p class="text-xs text-slate-300">Verify Passwords</p>
                    </button>
                    <button onclick="syncAllWallets()" class="p-4 rounded-xl bg-slate-900/50 border border-slate-800 hover:border-green-500 transition text-center">
                        <i class="fas fa-wallet text-green-400 text-lg mb-2"></i>
                        <p class="text-xs text-slate-300">Sync Wallets</p>
                    </button>
                    <button onclick="cleanupOrphanData()" class="p-4 rounded-xl bg-slate-900/50 border border-slate-800 hover:border-yellow-500 transition text-center">
                        <i class="fas fa-broom text-yellow-400 text-lg mb-2"></i>
                        <p class="text-xs text-slate-300">Cleanup Orphans</p>
                    </button>
                    <button onclick="verifyDataIsolation()" class="p-4 rounded-xl bg-slate-900/50 border border-slate-800 hover:border-cyan-500 transition text-center">
                        <i class="fas fa-shield-alt text-cyan-400 text-lg mb-2"></i>
                        <p class="text-xs text-slate-300">Data Isolation</p>
                    </button>
                    <button onclick="exportFullBackup()" class="p-4 rounded-xl bg-slate-900/50 border border-slate-800 hover:border-purple-500 transition text-center">
                        <i class="fas fa-download text-purple-400 text-lg mb-2"></i>
                        <p class="text-xs text-slate-300">Full Backup</p>
                    </button>
                </div>
            </div>
        </div>

        <!-- System Monitor View -->
        <div id="view-monitor" class="hidden p-6 lg:p-8 max-w-7xl mx-auto space-y-6 animate-fade-in">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-white">System Monitor</h2>
                    <p class="text-slate-500 text-sm mt-1">Real-time system health and performance metrics.</p>
                </div>
                <div class="flex items-center gap-3">
                    <span id="monitorStatus" class="flex items-center gap-2 text-xs text-green-400 bg-green-500/10 px-3 py-1.5 rounded-lg">
                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                        LIVE
                    </span>
                    <button onclick="toggleMonitor()" id="monitorToggle" class="btn-secondary text-xs px-4 py-2 rounded-xl text-slate-400">
                        <i class="fas fa-pause mr-1"></i> Pause
                    </button>
                </div>
            </div>

            <!-- Live Metrics Grid -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="glass-static rounded-xl p-4 border border-slate-800/50">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-slate-400 text-xs">Firebase Latency</span>
                        <i class="fas fa-tachometer-alt text-blue-400"></i>
                    </div>
                    <p id="metricLatency" class="text-2xl font-bold text-white">--ms</p>
                    <div class="h-1 bg-slate-800 rounded mt-2">
                        <div id="latencyBar" class="h-full bg-blue-500 rounded transition-all" style="width: 0%"></div>
                    </div>
                </div>
                <div class="glass-static rounded-xl p-4 border border-slate-800/50">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-slate-400 text-xs">Active Connections</span>
                        <i class="fas fa-plug text-green-400"></i>
                    </div>
                    <p id="metricConnections" class="text-2xl font-bold text-white">0</p>
                    <p class="text-[10px] text-slate-500 mt-2">Realtime listeners</p>
                </div>
                <div class="glass-static rounded-xl p-4 border border-slate-800/50">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-slate-400 text-xs">Memory Usage</span>
                        <i class="fas fa-memory text-purple-400"></i>
                    </div>
                    <p id="metricMemory" class="text-2xl font-bold text-white">--MB</p>
                    <div class="h-1 bg-slate-800 rounded mt-2">
                        <div id="memoryBar" class="h-full bg-purple-500 rounded transition-all" style="width: 0%"></div>
                    </div>
                </div>
                <div class="glass-static rounded-xl p-4 border border-slate-800/50">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-slate-400 text-xs">Errors (24h)</span>
                        <i class="fas fa-bug text-red-400"></i>
                    </div>
                    <p id="metricErrors" class="text-2xl font-bold text-white">0</p>
                    <p class="text-[10px] text-green-400 mt-2">All systems normal</p>
                </div>
            </div>

            <!-- Live Console -->
            <div class="glass-static rounded-2xl border border-slate-800/50 overflow-hidden">
                <div class="p-4 border-b border-slate-800/50 flex justify-between items-center">
                    <h3 class="font-semibold text-white flex items-center gap-2">
                        <i class="fas fa-terminal text-green-400"></i> Live Console
                    </h3>
                    <button onclick="clearConsole()" class="text-xs text-slate-400 hover:text-white">
                        <i class="fas fa-trash mr-1"></i> Clear
                    </button>
                </div>
                <div id="liveConsole" class="bg-black/80 p-4 font-mono text-xs h-[300px] overflow-y-auto">
                    <p class="text-green-500">[SYSTEM] Monitor initialized...</p>
                    <p class="text-blue-400">[INFO] Listening for Firebase events...</p>
                </div>
            </div>

            <!-- Debug Panel -->
            <div class="glass-static rounded-2xl p-5 border border-slate-800/50">
                <h3 class="font-semibold text-white mb-4 flex items-center gap-2">
                    <i class="fas fa-bug text-red-400"></i> Debug Tools
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                    <button onclick="testFirebaseConnection()" class="p-3 rounded-xl bg-slate-900/50 border border-slate-800 hover:border-blue-500 transition text-center">
                        <i class="fas fa-plug text-blue-400"></i>
                        <p class="text-[10px] text-slate-300 mt-1">Test Connection</p>
                    </button>
                    <button onclick="debugPasswordFlow()" class="p-3 rounded-xl bg-slate-900/50 border border-slate-800 hover:border-green-500 transition text-center">
                        <i class="fas fa-key text-green-400"></i>
                        <p class="text-[10px] text-slate-300 mt-1">Debug Passwords</p>
                    </button>
                    <button onclick="checkAllPaths()" class="p-3 rounded-xl bg-slate-900/50 border border-slate-800 hover:border-yellow-500 transition text-center">
                        <i class="fas fa-route text-yellow-400"></i>
                        <p class="text-[10px] text-slate-300 mt-1">Check Paths</p>
                    </button>
                    <button onclick="simulateOrder()" class="p-3 rounded-xl bg-slate-900/50 border border-slate-800 hover:border-purple-500 transition text-center">
                        <i class="fas fa-shopping-cart text-purple-400"></i>
                        <p class="text-[10px] text-slate-300 mt-1">Test Order</p>
                    </button>
                    <button onclick="runFullDiagnostics()" class="p-3 rounded-xl bg-slate-900/50 border border-slate-800 hover:border-red-500 transition text-center">
                        <i class="fas fa-stethoscope text-red-400"></i>
                        <p class="text-[10px] text-slate-300 mt-1">Full Diagnostics</p>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Inspector Modal -->
    <div id="inspectorModal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm p-4">
        <div class="bg-slate-950 border border-slate-800/50 w-full max-w-6xl h-[85vh] rounded-2xl shadow-2xl flex flex-col md:flex-row overflow-hidden relative animate-scale-in">

            <button onclick="closeModal('inspectorModal')"
                class="absolute top-4 right-4 z-50 w-10 h-10 bg-slate-900 text-slate-400 hover:text-white rounded-xl border border-slate-800 transition flex items-center justify-center">
                <i class="fas fa-times"></i>
            </button>

            <div class="w-full md:w-80 bg-slate-900/50 border-r border-slate-800/50 p-6 flex flex-col gap-6">
                <div class="text-center">
                    <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl mx-auto flex items-center justify-center text-3xl text-white shadow-lg shadow-blue-500/20 mb-4">
                        <i class="fas fa-store"></i>
                    </div>
                    <h2 id="inspName" class="text-xl font-bold text-white">Cafe Name</h2>
                    <span id="inspId" class="text-[10px] font-mono text-slate-500 bg-slate-900 px-3 py-1 rounded-lg border border-slate-800 mt-2 inline-block">ID: --</span>
                </div>

                <div class="glass-static p-4 rounded-xl">
                    <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Wallet Balance</p>
                    <h3 id="inspWallet" class="text-3xl font-bold text-white mb-3">₹0</h3>
                    <div class="flex gap-2">
                        <input id="inspRecharge" type="number" placeholder="Amount"
                            class="w-full bg-slate-950 border border-slate-800 rounded-lg px-3 py-2.5 text-sm text-white focus:border-blue-500 outline-none">
                        <button onclick="addMoneyInspector()"
                            class="bg-green-600 hover:bg-green-500 text-white px-4 rounded-lg transition">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>

                <div class="glass-static p-4 rounded-xl">
                    <p class="text-[10px] text-slate-400 uppercase font-bold mb-2">Node Info</p>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-slate-500">Created</span>
                            <span id="inspCreated" class="text-slate-300">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-500">Menu Items</span>
                            <span id="inspMenuCount" class="text-slate-300">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-500">Phone</span>
                            <span id="inspPhone" class="text-slate-300">--</span>
                        </div>
                    </div>
                </div>

                <div class="mt-auto space-y-2">
                    <button id="inspBlockBtn" onclick="toggleBlockInspector()"
                        class="w-full py-3 rounded-xl border border-red-500/30 text-red-400 hover:bg-red-500/10 font-bold text-sm transition">
                        BLOCK NODE ACCESS
                    </button>
                    <button onclick="deleteNode()" class="w-full py-3 rounded-xl border border-slate-700 text-slate-400 hover:bg-slate-800 font-bold text-sm transition">
                        <i class="fas fa-trash mr-2"></i> DELETE NODE
                    </button>
                </div>
            </div>

            <div class="flex-1 flex flex-col bg-slate-950">
                <div class="flex border-b border-slate-800/50 bg-slate-900/30 overflow-x-auto">
                    <button onclick="switchInspTab('links')" id="tab-links"
                        class="flex-1 py-4 text-xs font-bold text-blue-400 border-b-2 border-blue-500 bg-blue-500/5 uppercase tracking-wider transition whitespace-nowrap px-2">
                        <i class="fas fa-link mr-1"></i> Links
                    </button>
                    <button onclick="switchInspTab('subscription')" id="tab-subscription"
                        class="flex-1 py-4 text-xs font-bold text-slate-500 hover:text-white uppercase tracking-wider transition whitespace-nowrap px-2">
                        <i class="fas fa-crown mr-1"></i> Plan
                    </button>
                    <button onclick="switchInspTab('branding')" id="tab-branding"
                        class="flex-1 py-4 text-xs font-bold text-slate-500 hover:text-white uppercase tracking-wider transition whitespace-nowrap px-2">
                        <i class="fas fa-palette mr-1"></i> Brand
                    </button>
                    <button onclick="switchInspTab('ai')" id="tab-ai"
                        class="flex-1 py-4 text-xs font-bold text-slate-500 hover:text-white uppercase tracking-wider transition whitespace-nowrap px-2">
                        <i class="fas fa-brain mr-1"></i> AI
                    </button>
                    <button onclick="switchInspTab('settings')" id="tab-settings"
                        class="flex-1 py-4 text-xs font-bold text-slate-500 hover:text-white uppercase tracking-wider transition whitespace-nowrap px-2">
                        <i class="fas fa-cog mr-1"></i> Settings
                    </button>
                </div>

                <div id="insp-view-links" class="p-6 lg:p-8 space-y-6 overflow-y-auto flex-1">
                    <div class="bg-blue-500/10 border border-blue-500/20 p-4 rounded-xl flex gap-3">
                        <i class="fas fa-info-circle text-blue-400 mt-0.5"></i>
                        <div>
                            <h4 class="text-blue-400 font-semibold text-sm">Deployment URLs</h4>
                            <p class="text-xs text-slate-400 mt-1">Share these unique URLs with the client. They are auto-configured for this Cafe ID.</p>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="group">
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block flex items-center gap-2">
                                <span class="w-6 h-6 rounded-lg bg-blue-500/10 flex items-center justify-center">👨‍💼</span>
                                Owner Dashboard
                            </label>
                            <div class="flex gap-2">
                                <div class="flex-1 bg-slate-900 border border-slate-800 rounded-xl px-4 py-3 text-slate-300 font-mono text-xs truncate select-all hover:border-slate-700 transition"
                                    id="linkOwner">Loading...</div>
                                <button onclick="copyToClip('linkOwner')"
                                    class="bg-slate-800 hover:bg-slate-700 text-white px-4 rounded-xl transition">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button onclick="openLink('linkOwner')"
                                    class="bg-blue-600 hover:bg-blue-500 text-white px-4 rounded-xl transition">
                                    <i class="fas fa-external-link-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="group">
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block flex items-center gap-2">
                                <span class="w-6 h-6 rounded-lg bg-green-500/10 flex items-center justify-center">🍔</span>
                                Customer App (QR)
                            </label>
                            <div class="flex gap-2">
                                <div class="flex-1 bg-slate-900 border border-slate-800 rounded-xl px-4 py-3 text-slate-300 font-mono text-xs truncate select-all hover:border-slate-700 transition"
                                    id="linkCustomer">Loading...</div>
                                <button onclick="copyToClip('linkCustomer')"
                                    class="bg-slate-800 hover:bg-slate-700 text-white px-4 rounded-xl transition">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button onclick="openLink('linkCustomer')"
                                    class="bg-green-600 hover:bg-green-500 text-white px-4 rounded-xl transition">
                                    <i class="fas fa-external-link-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="group">
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block flex items-center gap-2">
                                <span class="w-6 h-6 rounded-lg bg-orange-500/10 flex items-center justify-center">👨‍🍳</span>
                                Kitchen Display
                            </label>
                            <div class="flex gap-2">
                                <div class="flex-1 bg-slate-900 border border-slate-800 rounded-xl px-4 py-3 text-slate-300 font-mono text-xs truncate select-all hover:border-slate-700 transition"
                                    id="linkKitchen">Loading...</div>
                                <button onclick="copyToClip('linkKitchen')"
                                    class="bg-slate-800 hover:bg-slate-700 text-white px-4 rounded-xl transition">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button onclick="openLink('linkKitchen')"
                                    class="bg-orange-600 hover:bg-orange-500 text-white px-4 rounded-xl transition">
                                    <i class="fas fa-external-link-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="glass-static rounded-xl p-4 mt-6">
                        <h4 class="font-semibold text-white text-sm mb-3">Generate QR Code</h4>
                        <div class="flex gap-3">
                            <select id="qrLinkType" class="flex-1 bg-slate-900 border border-slate-800 rounded-lg px-3 py-2 text-sm text-slate-300 outline-none">
                                <option value="customer">Customer App</option>
                                <option value="owner">Owner Dashboard</option>
                                <option value="kitchen">Kitchen Display</option>
                            </select>
                            <button onclick="generateQR()" class="btn-primary text-white px-4 py-2 rounded-lg text-sm">
                                <i class="fas fa-qrcode mr-2"></i> Generate
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Subscription Tab -->
                <div id="insp-view-subscription" class="hidden p-6 lg:p-8 space-y-6 overflow-y-auto flex-1">
                    <div class="bg-gradient-to-r from-purple-500/10 to-pink-500/10 border border-purple-500/20 p-4 rounded-xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="text-white font-semibold">Current Plan</h4>
                                <p class="text-xs text-slate-400 mt-1">Manage subscription and billing</p>
                            </div>
                            <span id="inspCurrentPlan" class="plan-badge plan-free">Free</span>
                        </div>
                    </div>

                    <!-- Plan Features -->
                    <div class="glass-static rounded-xl p-4">
                        <h4 class="font-semibold text-white text-sm mb-4">📋 Plan Features</h4>
                        <div id="planFeaturesList" class="space-y-3">
                            <!-- Features will be populated dynamically -->
                        </div>
                    </div>

                    <!-- Upgrade Options -->
                    <div class="glass-static rounded-xl p-4">
                        <h4 class="font-semibold text-white text-sm mb-4">⬆️ Upgrade Plan</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="upgradePlan('starter')" class="p-3 rounded-xl border border-blue-500/30 hover:bg-blue-500/10 transition text-left">
                                <span class="plan-badge plan-starter">Starter</span>
                                <p class="text-white font-bold mt-2">₹499/mo</p>
                                <p class="text-[10px] text-slate-400">Custom colors, 500 orders</p>
                            </button>
                            <button onclick="upgradePlan('pro')" class="p-3 rounded-xl border border-purple-500/30 hover:bg-purple-500/10 transition text-left">
                                <span class="plan-badge plan-pro">Pro</span>
                                <p class="text-white font-bold mt-2">₹999/mo</p>
                                <p class="text-[10px] text-slate-400">AI, analytics, unlimited</p>
                            </button>
                            <button onclick="upgradePlan('enterprise')" class="p-3 rounded-xl border border-amber-500/30 hover:bg-amber-500/10 transition text-left col-span-2">
                                <span class="plan-badge plan-enterprise">Enterprise</span>
                                <p class="text-white font-bold mt-2">₹2499/mo</p>
                                <p class="text-[10px] text-slate-400">Custom domain, API access, priority support, white-label</p>
                            </button>
                        </div>
                    </div>

                    <!-- Billing History -->
                    <div class="glass-static rounded-xl p-4">
                        <h4 class="font-semibold text-white text-sm mb-3">💳 Billing Info</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-400">Next Billing</span>
                                <span id="inspNextBilling" class="text-white">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Monthly Amount</span>
                                <span id="inspMonthlyAmount" class="text-green-400">₹0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Total Paid</span>
                                <span id="inspTotalPaid" class="text-white">₹0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Branding Tab -->
                <div id="insp-view-branding" class="hidden p-6 lg:p-8 space-y-6 overflow-y-auto flex-1">
                    <div class="bg-gradient-to-r from-orange-500/10 to-red-500/10 border border-orange-500/20 p-4 rounded-xl">
                        <h4 class="text-white font-semibold flex items-center gap-2">
                            <i class="fas fa-palette text-orange-400"></i> Brand Customization
                        </h4>
                        <p class="text-xs text-slate-400 mt-1">Colors and logo are controlled from database - no code changes needed!</p>
                    </div>

                    <!-- Color Picker -->
                    <div class="glass-static rounded-xl p-4">
                        <h4 class="font-semibold text-white text-sm mb-4">🎨 Theme Colors</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Primary Color</label>
                                <div class="flex gap-2">
                                    <input type="color" id="brandPrimaryColor" value="#ea580c" class="w-12 h-10 rounded cursor-pointer bg-transparent border-0">
                                    <input type="text" id="brandPrimaryHex" value="#ea580c" class="flex-1 bg-slate-900 border border-slate-800 rounded-lg px-3 text-white text-sm font-mono">
                                </div>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Secondary Color</label>
                                <div class="flex gap-2">
                                    <input type="color" id="brandSecondaryColor" value="#dc2626" class="w-12 h-10 rounded cursor-pointer bg-transparent border-0">
                                    <input type="text" id="brandSecondaryHex" value="#dc2626" class="flex-1 bg-slate-900 border border-slate-800 rounded-lg px-3 text-white text-sm font-mono">
                                </div>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Accent Color</label>
                                <div class="flex gap-2">
                                    <input type="color" id="brandAccentColor" value="#f59e0b" class="w-12 h-10 rounded cursor-pointer bg-transparent border-0">
                                    <input type="text" id="brandAccentHex" value="#f59e0b" class="flex-1 bg-slate-900 border border-slate-800 rounded-lg px-3 text-white text-sm font-mono">
                                </div>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Background</label>
                                <div class="flex gap-2">
                                    <input type="color" id="brandBgColor" value="#fff7ed" class="w-12 h-10 rounded cursor-pointer bg-transparent border-0">
                                    <input type="text" id="brandBgHex" value="#fff7ed" class="flex-1 bg-slate-900 border border-slate-800 rounded-lg px-3 text-white text-sm font-mono">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cafe Info -->
                    <div class="glass-static rounded-xl p-4">
                        <h4 class="font-semibold text-white text-sm mb-4">☕ Cafe Info</h4>
                        <div class="space-y-3">
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Display Name</label>
                                <input type="text" id="brandCafeName" placeholder="My Awesome Cafe" class="w-full bg-slate-900 border border-slate-800 rounded-lg px-3 py-2 text-white text-sm">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Tagline</label>
                                <input type="text" id="brandTagline" placeholder="Delicious Moments" class="w-full bg-slate-900 border border-slate-800 rounded-lg px-3 py-2 text-white text-sm">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Logo URL (Optional)</label>
                                <input type="text" id="brandLogoUrl" placeholder="https://..." class="w-full bg-slate-900 border border-slate-800 rounded-lg px-3 py-2 text-white text-sm">
                            </div>
                        </div>
                    </div>

                    <!-- Feature Toggles -->
                    <div class="glass-static rounded-xl p-4">
                        <h4 class="font-semibold text-white text-sm mb-4">⚡ Feature Toggles</h4>
                        <div class="space-y-3">
                            <label class="flex items-center justify-between cursor-pointer">
                                <span class="text-sm text-slate-300">Enable Donations</span>
                                <input type="checkbox" id="brandEnableDonations" checked class="w-4 h-4 accent-green-500">
                            </label>
                            <label class="flex items-center justify-between cursor-pointer">
                                <span class="text-sm text-slate-300">Enable Offers</span>
                                <input type="checkbox" id="brandEnableOffers" checked class="w-4 h-4 accent-green-500">
                            </label>
                            <label class="flex items-center justify-between cursor-pointer">
                                <span class="text-sm text-slate-300">Enable Ratings</span>
                                <input type="checkbox" id="brandEnableRatings" checked class="w-4 h-4 accent-green-500">
                            </label>
                            <label class="flex items-center justify-between cursor-pointer">
                                <span class="text-sm text-slate-300">Enable Takeaway</span>
                                <input type="checkbox" id="brandEnableTakeaway" checked class="w-4 h-4 accent-green-500">
                            </label>
                        </div>
                    </div>

                    <button onclick="saveBrandConfig()" class="w-full btn-primary text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2">
                        <i class="fas fa-save"></i> Save Brand Settings
                    </button>
                </div>

                <div id="insp-view-ai" class="hidden p-6 lg:p-8 flex flex-col h-full">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-purple-400 font-bold flex items-center gap-2">
                            <i class="fas fa-sparkles"></i> Gemini AI Insight
                        </h3>
                        <button onclick="triggerAI()"
                            class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white text-xs px-5 py-2.5 rounded-xl shadow-lg transition">
                            <i class="fas fa-play mr-2"></i> Run Analysis
                        </button>
                    </div>

                    <div class="flex-1 glass-static rounded-xl p-6 relative overflow-hidden">
                        <div id="aiLoading" class="hidden absolute inset-0 bg-slate-900/90 flex items-center justify-center flex-col z-10">
                            <div class="w-16 h-16 rounded-full border-4 border-purple-500/20 border-t-purple-500 animate-spin mb-4"></div>
                            <p class="text-sm text-purple-300 animate-pulse">Consulting Neural Network...</p>
                        </div>
                        <div id="aiContent" class="text-sm text-slate-300 leading-relaxed whitespace-pre-wrap">
Click "Run Analysis" to generate a real-time health report for this node using Google Gemini AI.

The AI will analyze:
• Node status and health
• Wallet balance and recommendations
• Menu optimization suggestions
• Performance insights
                        </div>
                    </div>
                </div>

                <div id="insp-view-logs" class="hidden p-0 h-full flex flex-col">
                    <div class="bg-black/80 p-4 font-mono text-xs text-green-500 flex-1 overflow-y-auto" id="liveLogs">
                        <p class="opacity-50"># Terminal Session Initialized</p>
                        <p class="opacity-50"># Type 'help' for available commands</p>
                    </div>
                    <div class="p-3 bg-slate-900 border-t border-slate-800">
                        <input type="text" placeholder="Enter command..." id="terminalInput" onkeypress="handleTerminalInput(event)"
                            class="w-full bg-black border border-slate-700 rounded-lg px-4 py-2 text-sm text-green-400 font-mono outline-none focus:border-green-500">
                    </div>
                </div>

                <div id="insp-view-settings" class="hidden p-6 lg:p-8 space-y-6 overflow-y-auto">
                    <h3 class="font-bold text-white">Node Settings</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Node Name</label>
                            <input type="text" id="editNodeName" class="w-full bg-slate-900 border border-slate-800 rounded-xl px-4 py-3 text-white outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Owner Phone</label>
                            <input type="text" id="editNodePhone" class="w-full bg-slate-900 border border-slate-800 rounded-xl px-4 py-3 text-white outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Password</label>
                            <input type="text" id="editNodePassword" class="w-full bg-slate-900 border border-slate-800 rounded-xl px-4 py-3 text-white outline-none focus:border-blue-500">
                        </div>
                        <button onclick="saveNodeSettings()" class="btn-primary text-white px-6 py-3 rounded-xl text-sm w-full">
                            <i class="fas fa-save mr-2"></i> Save Changes
                        </button>
                    </div>

                    <hr class="border-slate-800">

                    <!-- Feature Allocation Section -->
                    <div class="bg-purple-500/10 border border-purple-500/20 p-4 rounded-xl">
                        <h4 class="text-purple-400 font-semibold text-sm mb-3 flex items-center gap-2">
                            <i class="fas fa-magic"></i> Feature Allocation
                        </h4>
                        <p class="text-xs text-slate-400 mb-4">Enable/disable premium features for this cafe</p>
                        
                        <div class="space-y-3">
                            <label class="flex items-center justify-between p-3 bg-slate-900 rounded-lg cursor-pointer hover:bg-slate-800 transition">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-dharmachakra text-yellow-400"></i>
                                    <span class="text-white text-sm">Spin Wheel</span>
                                </div>
                                <input type="checkbox" id="feature-spinWheel" onchange="updateFeatureAllocation()" class="w-5 h-5 accent-purple-500">
                            </label>
                            
                            <label class="flex items-center justify-between p-3 bg-slate-900 rounded-lg cursor-pointer hover:bg-slate-800 transition">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-heart text-pink-400"></i>
                                    <span class="text-white text-sm">Donations</span>
                                </div>
                                <input type="checkbox" id="feature-donations" onchange="updateFeatureAllocation()" class="w-5 h-5 accent-purple-500">
                            </label>
                            
                            <label class="flex items-center justify-between p-3 bg-slate-900 rounded-lg cursor-pointer hover:bg-slate-800 transition">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-bullhorn text-blue-400"></i>
                                    <span class="text-white text-sm">Promo Ads</span>
                                </div>
                                <input type="checkbox" id="feature-promoAds" onchange="updateFeatureAllocation()" class="w-5 h-5 accent-purple-500">
                            </label>
                            
                            <label class="flex items-center justify-between p-3 bg-slate-900 rounded-lg cursor-pointer hover:bg-slate-800 transition">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-robot text-cyan-400"></i>
                                    <span class="text-white text-sm">AI Assistant</span>
                                </div>
                                <input type="checkbox" id="feature-aiAssistant" onchange="updateFeatureAllocation()" class="w-5 h-5 accent-purple-500">
                            </label>
                            
                            <label class="flex items-center justify-between p-3 bg-slate-900 rounded-lg cursor-pointer hover:bg-slate-800 transition">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-wallet text-green-400"></i>
                                    <span class="text-white text-sm">Wallet System</span>
                                </div>
                                <input type="checkbox" id="feature-wallet" onchange="updateFeatureAllocation()" class="w-5 h-5 accent-purple-500">
                            </label>
                            
                            <label class="flex items-center justify-between p-3 bg-slate-900 rounded-lg cursor-pointer hover:bg-slate-800 transition">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-chart-line text-orange-400"></i>
                                    <span class="text-white text-sm">Analytics Dashboard</span>
                                </div>
                                <input type="checkbox" id="feature-analytics" onchange="updateFeatureAllocation()" class="w-5 h-5 accent-purple-500">
                            </label>
                        </div>
                        
                        <button onclick="saveFeatureAllocation()" class="w-full py-2.5 rounded-lg bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold transition flex items-center justify-center gap-2 mt-4">
                            <i class="fas fa-save"></i> Save Feature Settings
                        </button>
                    </div>

                    <hr class="border-slate-800">

                    <!-- Initialize Subcollections Section -->
                    <div class="bg-emerald-500/10 border border-emerald-500/20 p-4 rounded-xl">
                        <h4 class="text-emerald-400 font-semibold text-sm mb-2 flex items-center gap-2">
                            <i class="fas fa-database"></i> Database Setup
                        </h4>
                        <p class="text-xs text-slate-400 mb-3">Create required subcollections (menu, addons, site_cards, settings) if they don't exist.</p>
                        <button onclick="initializeSubcollections()" class="w-full py-2.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold transition flex items-center justify-center gap-2">
                            <i class="fas fa-folder-plus"></i> Initialize Subcollections
                        </button>
                    </div>

                    <hr class="border-slate-800">

                    <div class="bg-red-500/10 border border-red-500/20 p-4 rounded-xl">
                        <h4 class="text-red-400 font-semibold text-sm mb-2">Danger Zone</h4>
                        <p class="text-xs text-slate-400 mb-3">These actions are irreversible. Proceed with caution.</p>
                        <div class="flex gap-2">
                            <button onclick="resetNodeData()" class="flex-1 py-2 rounded-lg border border-red-500/30 text-red-400 hover:bg-red-500/10 text-xs transition">
                                Reset Data
                            </button>
                            <button onclick="deleteNode()" class="flex-1 py-2 rounded-lg border border-red-500/30 text-red-400 hover:bg-red-500/10 text-xs transition">
                                Delete Node
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Onboard Modal -->
    <div id="onboardModal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 overflow-y-auto">
        <div class="bg-slate-950 border border-slate-800/50 w-full max-w-lg rounded-2xl p-6 shadow-2xl relative animate-scale-in my-8">
            <button onclick="closeModal('onboardModal')"
                class="absolute top-4 right-4 w-8 h-8 rounded-lg bg-slate-900 text-slate-500 hover:text-white flex items-center justify-center transition">
                <i class="fas fa-times"></i>
            </button>
            <div class="text-center mb-6">
                <div class="w-14 h-14 bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl mx-auto flex items-center justify-center text-2xl text-white shadow-lg shadow-green-500/20 mb-4">
                    <i class="fas fa-plus"></i>
                </div>
                <h2 class="text-xl font-bold text-white">Deploy New Node</h2>
                <p class="text-sm text-slate-500 mt-1">Add a new cafe to your network</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Cafe Name</label>
                    <input id="newShopName" type="text" placeholder="e.g., Pizza Palace"
                        class="w-full bg-slate-900 border border-slate-800 p-3.5 rounded-xl text-white outline-none focus:border-blue-500 transition">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Unique ID (Subdomain)</label>
                    <div class="flex items-center gap-2">
                        <input id="newShopId" type="text" placeholder="pizza-palace"
                            class="flex-1 bg-slate-900 border border-slate-800 p-3.5 rounded-xl text-white outline-none focus:border-blue-500 transition">
                        <span class="text-slate-500 text-sm">.orderly.com</span>
                    </div>
                    <p class="text-[10px] text-slate-600 mt-1">Lowercase, no spaces. E.g., sharma → sharma.orderly.com</p>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Owner Phone</label>
                        <input id="newPhone" type="text" placeholder="+91 98765 43210"
                            class="w-full bg-slate-900 border border-slate-800 p-3.5 rounded-xl text-white outline-none focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Initial Password</label>
                        <input id="newPassword" type="text" value="Wow@123"
                            class="w-full bg-slate-900 border border-slate-800 p-3.5 rounded-xl text-white outline-none focus:border-blue-500 transition">
                    </div>
                </div>

                <!-- Subscription Plan Selection -->
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-3 block">💳 Subscription Plan</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="cursor-pointer">
                            <input type="radio" name="subscriptionPlan" value="free" class="hidden peer" checked>
                            <div class="p-3 rounded-xl border-2 border-slate-700 peer-checked:border-slate-400 peer-checked:bg-slate-800/50 transition">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="plan-badge plan-free">Free</span>
                                </div>
                                <p class="text-lg font-bold text-white">₹0<span class="text-xs text-slate-500">/mo</span></p>
                                <p class="text-[10px] text-slate-500 mt-1">Basic features, 50 orders/mo</p>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="subscriptionPlan" value="starter" class="hidden peer">
                            <div class="p-3 rounded-xl border-2 border-slate-700 peer-checked:border-blue-500 peer-checked:bg-blue-500/10 transition">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="plan-badge plan-starter">Starter</span>
                                </div>
                                <p class="text-lg font-bold text-white">₹499<span class="text-xs text-slate-500">/mo</span></p>
                                <p class="text-[10px] text-slate-500 mt-1">Custom branding, 500 orders</p>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="subscriptionPlan" value="pro" class="hidden peer">
                            <div class="p-3 rounded-xl border-2 border-slate-700 peer-checked:border-purple-500 peer-checked:bg-purple-500/10 transition">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="plan-badge plan-pro">Pro</span>
                                    <span class="text-[8px] text-yellow-400">⭐ POPULAR</span>
                                </div>
                                <p class="text-lg font-bold text-white">₹999<span class="text-xs text-slate-500">/mo</span></p>
                                <p class="text-[10px] text-slate-500 mt-1">AI features, unlimited orders</p>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="subscriptionPlan" value="enterprise" class="hidden peer">
                            <div class="p-3 rounded-xl border-2 border-slate-700 peer-checked:border-amber-500 peer-checked:bg-amber-500/10 transition">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="plan-badge plan-enterprise">Enterprise</span>
                                </div>
                                <p class="text-lg font-bold text-white">₹2499<span class="text-xs text-slate-500">/mo</span></p>
                                <p class="text-[10px] text-slate-500 mt-1">Custom domain, API access</p>
                            </div>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Initial Wallet Balance (₹)</label>
                    <input id="newBalance" type="number" value="0" placeholder="0"
                        class="w-full bg-slate-900 border border-slate-800 p-3.5 rounded-xl text-white outline-none focus:border-blue-500 transition">
                </div>
                <button onclick="createClient()"
                    class="w-full btn-primary text-white font-bold py-3.5 rounded-xl mt-2 flex items-center justify-center gap-2">
                    <i class="fas fa-rocket"></i> Deploy Node
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-slate-950 border border-slate-800/50 w-full max-w-lg rounded-2xl p-6 shadow-2xl relative animate-scale-in">
            <button onclick="closeModal('settingsModal')"
                class="absolute top-4 right-4 w-8 h-8 rounded-lg bg-slate-900 text-slate-500 hover:text-white flex items-center justify-center transition">
                <i class="fas fa-times"></i>
            </button>
            <div class="mb-6">
                <h2 class="text-xl font-bold text-white">Settings</h2>
                <p class="text-sm text-slate-500 mt-1">Configure your super admin dashboard</p>
            </div>
            
            <div class="space-y-6">
                <div class="glass-static rounded-xl p-4">
                    <h3 class="font-semibold text-white text-sm mb-3">API Configuration</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Gemini API Key</label>
                            <input id="settingsApiKey" type="password" placeholder="Enter your Gemini API key"
                                class="w-full bg-slate-900 border border-slate-800 p-3 rounded-xl text-white outline-none focus:border-blue-500 text-sm">
                        </div>
                    </div>
                </div>

                <div class="glass-static rounded-xl p-4">
                    <h3 class="font-semibold text-white text-sm mb-3">Deployment URLs</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Base URL</label>
                            <input id="settingsBaseUrl" type="text" value="https://orderlysystems.vercel.app"
                                class="w-full bg-slate-900 border border-slate-800 p-3 rounded-xl text-white outline-none focus:border-blue-500 text-sm font-mono">
                        </div>
                    </div>
                </div>

                <div class="glass-static rounded-xl p-4">
                    <h3 class="font-semibold text-white text-sm mb-3">Notifications</h3>
                    <div class="space-y-3">
                        <label class="flex items-center justify-between cursor-pointer">
                            <span class="text-sm text-slate-300">Low balance alerts</span>
                            <input type="checkbox" id="notifLowBalance" checked class="w-4 h-4 accent-blue-500">
                        </label>
                        <label class="flex items-center justify-between cursor-pointer">
                            <span class="text-sm text-slate-300">New node deployments</span>
                            <input type="checkbox" id="notifNewNode" checked class="w-4 h-4 accent-blue-500">
                        </label>
                        <label class="flex items-center justify-between cursor-pointer">
                            <span class="text-sm text-slate-300">System alerts</span>
                            <input type="checkbox" id="notifSystem" checked class="w-4 h-4 accent-blue-500">
                        </label>
                    </div>
                </div>

                <!-- Password Change Section -->
                <div class="glass-static rounded-xl p-4 border border-red-500/20">
                    <h3 class="font-semibold text-white text-sm mb-3 flex items-center gap-2">
                        <i class="fas fa-key text-red-400"></i> Change Admin Password
                    </h3>
                    <div class="space-y-3">
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Current Password</label>
                            <input id="settingsCurrentPassword" type="password" placeholder="Enter current password"
                                class="w-full bg-slate-900 border border-slate-800 p-3 rounded-xl text-white outline-none focus:border-blue-500 text-sm">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">New Password</label>
                            <input id="settingsNewPassword" type="password" placeholder="Enter new password"
                                class="w-full bg-slate-900 border border-slate-800 p-3 rounded-xl text-white outline-none focus:border-blue-500 text-sm">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Confirm New Password</label>
                            <input id="settingsConfirmPassword" type="password" placeholder="Confirm new password"
                                class="w-full bg-slate-900 border border-slate-800 p-3 rounded-xl text-white outline-none focus:border-blue-500 text-sm">
                        </div>
                        <button onclick="changeSuperAdminPassword()" class="w-full bg-red-500/10 text-red-400 border border-red-500/30 font-bold py-2.5 rounded-xl hover:bg-red-500/20 transition text-sm">
                            <i class="fas fa-lock mr-2"></i> Update Password
                        </button>
                    </div>
                </div>

                <div class="flex gap-3 mt-2">
                    <button onclick="closeModal('settingsModal')" class="flex-1 bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 transition">
                        <i class="fas fa-times"></i> Close
                    </button>
                    <button onclick="saveSettings()" class="flex-1 btn-primary text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Panel -->
    <div id="notificationsPanel"
        class="hidden fixed top-0 right-0 h-full w-full max-w-md bg-slate-950/95 backdrop-blur-xl border-l border-slate-800/50 z-50 transform transition-transform duration-300">
        <div class="p-6 border-b border-slate-800/50 flex justify-between items-center">
            <h2 class="text-lg font-bold text-white">Notifications</h2>
            <div class="flex gap-2">
                <button onclick="clearNotifications()" class="text-xs text-slate-500 hover:text-white transition">Clear All</button>
                <button onclick="closeNotifications()" class="w-8 h-8 rounded-lg bg-slate-900 text-slate-500 hover:text-white flex items-center justify-center transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div id="notificationsList" class="p-4 space-y-3 overflow-y-auto h-[calc(100%-80px)]">
            <!-- Notifications will be rendered here -->
        </div>
    </div>

    <!-- Bulk Recharge Modal -->
    <div id="bulkRechargeModal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-slate-950 border border-slate-800/50 w-full max-w-md rounded-2xl p-6 shadow-2xl relative animate-scale-in">
            <button onclick="closeModal('bulkRechargeModal')"
                class="absolute top-4 right-4 w-8 h-8 rounded-lg bg-slate-900 text-slate-500 hover:text-white flex items-center justify-center transition">
                <i class="fas fa-times"></i>
            </button>
            <div class="text-center mb-6">
                <div class="w-14 h-14 bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl mx-auto flex items-center justify-center text-2xl text-white shadow-lg shadow-purple-500/20 mb-4">
                    <i class="fas fa-coins"></i>
                </div>
                <h2 class="text-xl font-bold text-white">Bulk Recharge</h2>
                <p class="text-sm text-slate-500 mt-1">Add balance to multiple nodes at once</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Select Nodes</label>
                    <select id="bulkNodes" multiple class="w-full bg-slate-900 border border-slate-800 p-3 rounded-xl text-white outline-none focus:border-blue-500 h-32">
                        <!-- Options will be populated dynamically -->
                    </select>
                    <p class="text-[10px] text-slate-600 mt-1">Hold Ctrl/Cmd to select multiple</p>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Amount (₹)</label>
                    <input id="bulkAmount" type="number" placeholder="Enter amount"
                        class="w-full bg-slate-900 border border-slate-800 p-3.5 rounded-xl text-white outline-none focus:border-blue-500 transition">
                </div>
                <button onclick="processBulkRecharge()"
                    class="w-full btn-primary text-white font-bold py-3.5 rounded-xl flex items-center justify-center gap-2">
                    <i class="fas fa-paper-plane"></i> Process Recharge
                </button>
            </div>
        </div>
    </div>

    <!-- Promotional Ad Modal -->
    <div id="broadcastModal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-slate-950 border border-slate-800/50 w-full max-w-lg rounded-2xl p-6 shadow-2xl relative animate-scale-in">
            <button onclick="closeModal('broadcastModal')"
                class="absolute top-4 right-4 w-8 h-8 rounded-lg bg-slate-900 text-slate-500 hover:text-white flex items-center justify-center transition">
                <i class="fas fa-times"></i>
            </button>
            <div class="text-center mb-6">
                <div class="w-14 h-14 bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl mx-auto flex items-center justify-center text-2xl text-white shadow-lg shadow-purple-500/20 mb-4">
                    <i class="fas fa-ad"></i>
                </div>
                <h2 class="text-xl font-bold text-white">Promotional Ad</h2>
                <p class="text-sm text-slate-500 mt-1">Create ad that shows after payment on customer app</p>
            </div>
            <div class="space-y-4">
                <!-- Enable/Disable Toggle -->
                <div class="flex items-center justify-between p-4 bg-slate-900 rounded-xl border border-slate-800">
                    <div>
                        <p class="text-white font-semibold">Enable Promo Ad</p>
                        <p class="text-[10px] text-slate-500">Show ad after payment rating</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="promoAdEnabled" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-slate-700 rounded-full peer peer-checked:bg-purple-600 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                    </label>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Ad Title</label>
                    <input id="broadcastTitle" type="text" placeholder="e.g., 50% OFF Today!"
                        class="w-full bg-slate-900 border border-slate-800 p-3.5 rounded-xl text-white outline-none focus:border-purple-500 transition">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Ad Description</label>
                    <textarea id="broadcastBody" placeholder="Describe your offer..." rows="3"
                        class="w-full bg-slate-900 border border-slate-800 p-3.5 rounded-xl text-white outline-none focus:border-purple-500 transition resize-none"></textarea>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Button Text</label>
                    <input id="promoButtonText" type="text" placeholder="e.g., Claim Now" value="View Offer"
                        class="w-full bg-slate-900 border border-slate-800 p-3 rounded-xl text-white outline-none focus:border-purple-500 transition">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Link URL (optional)</label>
                    <input id="promoLinkUrl" type="text" placeholder="https://..."
                        class="w-full bg-slate-900 border border-slate-800 p-3 rounded-xl text-white outline-none focus:border-purple-500 transition">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Background</label>
                        <input id="promoAdBgColor" type="color" value="#7c3aed" class="w-full h-10 rounded-lg cursor-pointer bg-transparent border-0">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Text Color</label>
                        <input id="promoAdTextColor" type="color" value="#ffffff" class="w-full h-10 rounded-lg cursor-pointer bg-transparent border-0">
                    </div>
                </div>
                <button onclick="savePromoAd()"
                    class="w-full bg-gradient-to-r from-purple-500 to-pink-600 text-white font-bold py-3.5 rounded-xl flex items-center justify-center gap-2 hover:opacity-90 transition">
                    <i class="fas fa-save"></i> Save Promotional Ad
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getDatabase, ref, get, set, update, remove } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
        import { getFirestore, collection, getDocs, getDoc, doc, setDoc, addDoc, updateDoc, increment, deleteDoc, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // 🔥 STEP 1: ADD YOUR API KEY HERE
        const GEMINI_API_KEY = "AIzaSyCri3SIXc8X_I_HnfHzS4YqUmIN02MiVQI";

        const firebaseConfig = {
            apiKey: "AIzaSyDSl6L3ym7G9wXJjZoCYGtU6oBuMyswMBA",
            authDomain: "gen-lang-client-0826078440.firebaseapp.com",
            databaseURL: "https://gen-lang-client-0826078440-default-rtdb.firebaseio.com",
            projectId: "gen-lang-client-0826078440",
            storageBucket: "gen-lang-client-0826078440.firebasestorage.app",
            messagingSenderId: "198781436382",
            appId: "1:198781436382:web:041f1a6f57cc50dfa75d4f",
            measurementId: "G-XNB6HMBXN0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        let clientsData = [];
        let currentInspData = null;
        let aiTokens = 0;

        const STORAGE_KEYS = {
            settings: 'wowcoreSettings',
            activity: 'wowcoreActivity',
            notifications: 'wowcoreNotifications',
            superAdminPassword: 'wowcoreSuperAdminPassword',
            superAdminSession: 'wowcoreSuperAdminSession'
        };

        const DEFAULT_SETTINGS = {
            baseUrl: 'https://orderlysystems.vercel.app',
            geminiApiKey: '',
            notifLowBalance: true,
            notifNewNode: true,
            notifSystem: true
        };

        // Default Super Admin Password
        const DEFAULT_SUPER_ADMIN_PASSWORD = '123456';

        const tableState = {
            query: '',
            status: 'all',
            sortKey: 'name',
            sortDir: 'asc',
            page: 1,
            pageSize: 8
        };

        let charts = { revenue: null, distribution: null };

        // --- SUPER ADMIN LOGIN SYSTEM ---
        function getSuperAdminPassword() {
            return localStorage.getItem(STORAGE_KEYS.superAdminPassword) || DEFAULT_SUPER_ADMIN_PASSWORD;
        }

        function isSuperAdminLoggedIn() {
            return sessionStorage.getItem(STORAGE_KEYS.superAdminSession) === 'true';
        }

        window.checkSuperAdminLogin = () => {
            const input = document.getElementById('superadmin-password').value;
            const correctPassword = getSuperAdminPassword();
            const errorEl = document.getElementById('superadmin-login-error');

            if (input === correctPassword) {
                sessionStorage.setItem(STORAGE_KEYS.superAdminSession, 'true');
                document.getElementById('superadmin-login-overlay').classList.add('hidden');
                errorEl.classList.add('hidden');
                showToast('Welcome to WOWCORE!', 'success');
                initDashboard();
            } else {
                errorEl.classList.remove('hidden');
                document.getElementById('superadmin-password').value = '';
            }
        };

        window.changeSuperAdminPassword = () => {
            const current = document.getElementById('settingsCurrentPassword').value;
            const newPass = document.getElementById('settingsNewPassword').value;
            const confirm = document.getElementById('settingsConfirmPassword').value;

            if (!current || !newPass || !confirm) {
                showToast('Please fill all password fields', 'error');
                return;
            }

            if (current !== getSuperAdminPassword()) {
                showToast('Current password is incorrect', 'error');
                return;
            }

            if (newPass.length < 4) {
                showToast('New password must be at least 4 characters', 'error');
                return;
            }

            if (newPass !== confirm) {
                showToast('New passwords do not match', 'error');
                return;
            }

            localStorage.setItem(STORAGE_KEYS.superAdminPassword, newPass);
            showToast('Password changed successfully!', 'success');
            
            // Clear password fields
            document.getElementById('settingsCurrentPassword').value = '';
            document.getElementById('settingsNewPassword').value = '';
            document.getElementById('settingsConfirmPassword').value = '';
        };

        window.logout = async () => {
            const confirmed = await showConfirm('Logout', 'Are you sure you want to logout?', false);
            if (confirmed) {
                sessionStorage.removeItem(STORAGE_KEYS.superAdminSession);
                location.reload();
            }
        };

        function initDashboard() {
            hydrateSettingsUI();
            fetchClients();
            renderNotifications();
            renderActivity();
        }

        window.onload = () => {
            // Check if already logged in
            if (isSuperAdminLoggedIn()) {
                document.getElementById('superadmin-login-overlay').classList.add('hidden');
                initDashboard();
            } else {
                // Show login, focus password field
                document.getElementById('superadmin-password').focus();
            }
        };

        // --- CORE LOGIC ---
        window.fetchClients = async () => {
            const btn = document.getElementById('refreshIcon');
            btn.classList.add('fa-spin');
            const start = performance.now();

            try {
                const snap = await getDocs(collection(db, "restaurants"));
                const latency = Math.round(performance.now() - start);

                // Ping UI
                const pingEl = document.getElementById('pingRate');
                pingEl.innerText = latency + "ms";
                pingEl.className = latency < 100 ? "text-green-400 font-bold" : "text-red-400 font-bold";

                clientsData = [];
                let totalRev = 0, active = 0, alerts = 0;
                let healthy = 0, warning = 0, critical = 0;
                
                // Subscription metrics
                let mrr = 0, paidNodes = 0;
                let planCounts = { free: 0, starter: 0, pro: 0, enterprise: 0 };
                let renewalsThisMonth = 0, renewalsValue = 0;
                let featureAI = 0, featureDomains = 0;

                snap.forEach(doc => {
                    const d = doc.data();
                    clientsData.push({ id: doc.id, ...d });
                    totalRev += (d.walletBalance || 0);
                    if (d.status !== 'blocked') active++;
                    if ((d.walletBalance || 0) < 100 || d.status === 'blocked') alerts++;

                    if (d.status === 'blocked') critical++;
                    else if ((d.walletBalance || 0) < 100) warning++;
                    else healthy++;
                    
                    // Calculate subscription metrics
                    const sub = d.subscription || {};
                    const plan = sub.plan || 'free';
                    const monthlyPrice = sub.monthlyPrice || 0;
                    
                    planCounts[plan] = (planCounts[plan] || 0) + 1;
                    
                    if (monthlyPrice > 0) {
                        mrr += monthlyPrice;
                        paidNodes++;
                        
                        // Check if renewal is this month
                        if (sub.nextBillingDate) {
                            const nextBill = new Date(sub.nextBillingDate);
                            const now = new Date();
                            if (nextBill.getMonth() === now.getMonth() && nextBill.getFullYear() === now.getFullYear()) {
                                renewalsThisMonth++;
                                renewalsValue += monthlyPrice;
                            }
                        }
                    }
                    
                    // Count feature usage
                    if (sub.features?.aiFeatures) featureAI++;
                    if (sub.features?.customDomain) featureDomains++;
                });

                document.getElementById('statRevenue').innerText = totalRev.toLocaleString();
                document.getElementById('statActive').innerText = active;
                document.getElementById('statAlerts').innerText = alerts;
                const totalNodesEl = document.getElementById('totalNodes');
                if (totalNodesEl) totalNodesEl.innerText = String(clientsData.length);

                const healthyEl = document.getElementById('healthyCount');
                const warningEl = document.getElementById('warningCount');
                const criticalEl = document.getElementById('criticalCount');
                if (healthyEl) healthyEl.innerText = String(healthy);
                if (warningEl) warningEl.innerText = String(warning);
                if (criticalEl) criticalEl.innerText = String(critical);
                
                // Update SaaS metrics UI
                const mrrEl = document.getElementById('mrrValue');
                if (mrrEl) mrrEl.innerText = mrr.toLocaleString();
                const paidNodesEl = document.getElementById('paidNodes');
                if (paidNodesEl) paidNodesEl.innerText = String(paidNodes);
                
                // Plan distribution
                const countFreeEl = document.getElementById('countFree');
                const countStarterEl = document.getElementById('countStarter');
                const countProEl = document.getElementById('countPro');
                const countEnterpriseEl = document.getElementById('countEnterprise');
                if (countFreeEl) countFreeEl.innerText = `Free: ${planCounts.free}`;
                if (countStarterEl) countStarterEl.innerText = `Starter: ${planCounts.starter}`;
                if (countProEl) countProEl.innerText = `Pro: ${planCounts.pro}`;
                if (countEnterpriseEl) countEnterpriseEl.innerText = `Enterprise: ${planCounts.enterprise}`;
                
                // Renewals
                const renewalsCountEl = document.getElementById('renewalsCount');
                const renewalsValueEl = document.getElementById('renewalsValue');
                if (renewalsCountEl) renewalsCountEl.innerText = String(renewalsThisMonth);
                if (renewalsValueEl) renewalsValueEl.innerText = renewalsValue.toLocaleString();
                
                // Feature usage
                const featureAIEl = document.getElementById('featureAI');
                const featureDomainsEl = document.getElementById('featureDomains');
                if (featureAIEl) featureAIEl.innerText = String(featureAI);
                if (featureDomainsEl) featureDomainsEl.innerText = String(featureDomains);

                maybeNotifyLowBalance(clientsData);

                renderTable();
                renderHealthGrid(clientsData);
                updateAnalytics();

            } catch (e) { console.error(e); showToast("Connection Error: " + e.message, 'error'); }
            finally { btn.classList.remove('fa-spin'); }
        };

        // --- RENDERERS ---
        function getVisibleClients() {
            let list = [...clientsData];

            if (tableState.query) {
                const q = tableState.query;
                list = list.filter(c => {
                    const name = String(c.name || '').toLowerCase();
                    const id = String(c.id || '').toLowerCase();
                    return name.includes(q) || id.includes(q);
                });
            }

            if (tableState.status === 'active') list = list.filter(c => c.status !== 'blocked');
            if (tableState.status === 'blocked') list = list.filter(c => c.status === 'blocked');
            if (tableState.status === 'low-balance') list = list.filter(c => (c.walletBalance || 0) < 100 && c.status !== 'blocked');

            const dir = tableState.sortDir === 'asc' ? 1 : -1;
            list.sort((a, b) => {
                if (tableState.sortKey === 'wallet') {
                    const av = Number(a.walletBalance || 0);
                    const bv = Number(b.walletBalance || 0);
                    return (av - bv) * dir;
                }
                const an = String(a.name || '').toLowerCase();
                const bn = String(b.name || '').toLowerCase();
                return an.localeCompare(bn) * dir;
            });
            return list;
        }

        function renderTable() {
            const tbody = document.getElementById('clientTableBody');
            tbody.innerHTML = "";

            const visible = getVisibleClients();
            const totalCountEl = document.getElementById('totalCount');
            if (totalCountEl) totalCountEl.innerText = String(visible.length);

            const totalPages = Math.max(1, Math.ceil(visible.length / tableState.pageSize));
            if (tableState.page > totalPages) tableState.page = totalPages;
            if (tableState.page < 1) tableState.page = 1;

            const startIdx = (tableState.page - 1) * tableState.pageSize;
            const pageItems = visible.slice(startIdx, startIdx + tableState.pageSize);

            const showingCountEl = document.getElementById('showingCount');
            if (showingCountEl) showingCountEl.innerText = String(pageItems.length);

            if (pageItems.length === 0) {
                tbody.innerHTML = `<tr><td class="px-6 py-8 text-slate-500 text-center" colspan="4">No nodes match your filters.</td></tr>`;
                return;
            }

            pageItems.forEach(c => {
                const isBlocked = c.status === 'blocked';
                const statusBadge = isBlocked
                    ? `<span class="bg-red-500/10 text-red-500 px-2 py-1 rounded border border-red-500/20 text-[10px] font-bold">BLOCKED</span>`
                    : `<span class="bg-green-500/10 text-green-500 px-2 py-1 rounded border border-green-500/20 text-[10px] font-bold">ACTIVE</span>`;
                
                // Get subscription plan badge
                const plan = c.subscription?.plan || 'free';
                const planBadgeClass = `plan-badge plan-${plan}`;
                const planName = c.subscription?.planName || 'Free';

                tbody.innerHTML += `
                <tr class="border-b border-slate-800 hover:bg-slate-900 transition cursor-pointer group" onclick="openInspector('${c.id}')">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-slate-200 group-hover:text-blue-400 transition">${c.name}</span>
                            <span class="${planBadgeClass}">${planName}</span>
                        </div>
                        <div class="text-[10px] text-slate-500 font-mono">${c.id}.orderly.com</div>
                    </td>
                    <td class="px-6 py-4 font-mono text-slate-300">₹${c.walletBalance || 0}</td>
                    <td class="px-6 py-4">${statusBadge}</td>
                    <td class="px-6 py-4 text-right">
                        <button class="text-slate-500 hover:text-white transition"><i class="fas fa-cog"></i></button>
                    </td>
                </tr>`;
            });
        }

        function renderHealthGrid(data) {
            const grid = document.getElementById('nodeGrid');
            grid.innerHTML = "";
            let healthScore = 100;

            if (data.length === 0) { grid.innerHTML = `<div class="text-slate-500 col-span-full text-center">No Active Nodes</div>`; return; }

            data.forEach(c => {
                const bal = c.walletBalance || 0;
                const isBlocked = c.status === 'blocked';
                let color = "bg-green-500";

                if (isBlocked) { color = "bg-red-500"; healthScore -= 10; }
                else if (bal < 100) { color = "bg-yellow-500"; healthScore -= 5; }

                grid.innerHTML += `
                <div class="bg-slate-900 border border-slate-800 p-4 rounded-xl flex items-center justify-between hover:border-blue-500/50 transition relative overflow-hidden">
                    <div>
                        <h4 class="font-bold text-sm text-slate-200">${c.name}</h4>
                        <p class="text-[10px] text-slate-500 font-mono">${c.id}</p>
                    </div>
                    <div class="w-3 h-3 rounded-full ${color} shadow-[0_0_10px_currentColor]"></div>
                </div>`;
            });

            if (healthScore < 0) healthScore = 0;
            document.getElementById('healthScore').innerText = healthScore + "%";
            const bar = document.getElementById('healthBar');
            bar.style.width = healthScore + "%";
            bar.className = `h-full transition-all duration-1000 shadow-[0_0_20px_currentColor] ${healthScore > 80 ? 'bg-green-500' : 'bg-red-500'}`;
        }

        // --- INSPECTOR: THE GOD MODE ---

        // 🔥 STEP 2: PASTE YOUR REAL VERCEL LINKS HERE
        function getSettings() {
            try {
                const raw = localStorage.getItem(STORAGE_KEYS.settings);
                if (!raw) return { ...DEFAULT_SETTINGS };
                return { ...DEFAULT_SETTINGS, ...JSON.parse(raw) };
            } catch {
                return { ...DEFAULT_SETTINGS };
            }
        }

        function setSettings(next) {
            localStorage.setItem(STORAGE_KEYS.settings, JSON.stringify(next));
        }

        function getDomains() {
            const s = getSettings();
            const base = (s.baseUrl || DEFAULT_SETTINGS.baseUrl).replace(/\/$/, '');
            return {
                owner: `${base}/admin/index.html`,
                customer: `${base}/customer/index.html`,
                kitchen: `${base}/kitchen/index.html`
            };
        }

        window.openInspector = (id) => {
            currentInspData = clientsData.find(c => c.id === id);
            if (!currentInspData) return;

            // Profile
            document.getElementById('inspName').innerText = currentInspData.name;
            document.getElementById('inspId').innerText = "ID: " + currentInspData.id;
            document.getElementById('inspWallet').innerText = "₹" + (currentInspData.walletBalance || 0);

            const createdEl = document.getElementById('inspCreated');
            if (createdEl) createdEl.innerText = currentInspData.createdAt ? String(currentInspData.createdAt).slice(0, 10) : '--';
            const phoneEl = document.getElementById('inspPhone');
            if (phoneEl) phoneEl.innerText = currentInspData.phone || '--';
            const menuCountEl = document.getElementById('inspMenuCount');
            if (menuCountEl) menuCountEl.innerText = '--';

            // Settings form defaults
            const editName = document.getElementById('editNodeName');
            const editPhone = document.getElementById('editNodePhone');
            const editPass = document.getElementById('editNodePassword');
            if (editName) editName.value = currentInspData.name || '';
            if (editPhone) editPhone.value = currentInspData.phone || '';
            if (editPass) editPass.value = currentInspData.password || '';

            // Block Button
            const btn = document.getElementById('inspBlockBtn');
            if (currentInspData.status === 'blocked') {
                btn.innerText = "UNBLOCK NODE";
                btn.className = "w-full py-3 rounded-xl border border-green-500/30 text-green-400 hover:bg-green-500/10 font-bold text-sm transition";
            } else {
                btn.innerText = "BLOCK NODE ACCESS";
                btn.className = "w-full py-3 rounded-xl border border-red-500/30 text-red-400 hover:bg-red-500/10 font-bold text-sm transition";
            }

            // Generate Links
            const DOMAINS = getDomains();
            document.getElementById('linkOwner').innerText = `${DOMAINS.owner}/?id=${id}`;
            document.getElementById('linkCustomer').innerText = `${DOMAINS.customer}/?id=${id}`;
            document.getElementById('linkKitchen').innerText = `${DOMAINS.kitchen}/?id=${id}`;

            // Reset AI
            document.getElementById('aiContent').innerText = "Click 'Run Analysis' to analyze node.";
            document.getElementById('aiLoading').classList.add('hidden');

            document.getElementById('inspectorModal').classList.remove('hidden');
            switchInspTab('links');
            startLogs(currentInspData.name);
            
            // Load feature allocation settings
            loadFeatureAllocation();

            // Fetch menu item count from tenant subcollection (non-blocking)
            (async () => {
                try {
                    const menuSnap = await getDocs(collection(db, 'restaurants', currentInspData.id, 'menu'));
                    const el = document.getElementById('inspMenuCount');
                    if (el) el.innerText = String(menuSnap.size);
                } catch {
                    const el = document.getElementById('inspMenuCount');
                    if (el) el.innerText = '--';
                }
            })();
        };

        // --- AI LOGIC ---
        window.triggerAI = async () => {
            const settings = getSettings();
            const key = settings.geminiApiKey || GEMINI_API_KEY;
            if (!key || key === "YOUR_GEMINI_API_KEY_HERE") {
                showToast('Missing Gemini API key (Settings).', 'error');
                return;
            }

            const loader = document.getElementById('aiLoading');
            const content = document.getElementById('aiContent');
            loader.classList.remove('hidden');
            content.classList.add('hidden');
            content.innerText = '';

            const context = {
                name: currentInspData.name,
                bal: currentInspData.walletBalance || 0,
                status: currentInspData.status || 'unknown',
                plan: currentInspData.subscription?.planName || 'Free'
            };

            const prompt = `You are a SaaS System Admin analyzing a restaurant node. 
Cafe: ${context.name}
Status: ${context.status}
Wallet Balance: ₹${context.bal}
Plan: ${context.plan}

Give a 3-line technical health report in this format:
1. Status Assessment (is it healthy/warning/critical)
2. Key Metrics (balance, status)
3. Recommendation (action to take)

If balance < 200, mark as HIGH ALERT.`;

            try {
                console.log('🤖 Calling Gemini API with key:', key.substring(0, 10) + '...');
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-002:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 200
                        }
                    })
                });

                const data = await response.json();
                console.log('🤖 Gemini Response:', data);
                
                if (data.error) {
                    throw new Error(data.error.message || 'API Error');
                }
                
                if (!data.candidates || !data.candidates[0]?.content?.parts?.[0]?.text) {
                    throw new Error('Invalid response format from Gemini');
                }
                
                const text = data.candidates[0].content.parts[0].text;

                content.innerText = text;
                content.classList.remove('hidden');

                aiTokens++;
                document.getElementById('aiUsage').innerText = aiTokens;
                showToast('AI Analysis Complete', 'success');

            } catch (e) {
                console.error('🤖 Gemini Error:', e);
                content.innerText = `Error: ${e.message || 'AI Service Unreachable'}`;
                content.classList.remove('hidden');
                showToast('AI Analysis Failed: ' + e.message, 'error');
            } finally {
                loader.classList.add('hidden');
            }
        };

        // --- UTILS ---
        window.addMoneyInspector = async () => {
            const amt = parseInt(document.getElementById('inspRecharge').value);
            if (!amt) return;
            const oldBalance = Number(currentInspData.walletBalance || 0);
            const newBalance = oldBalance + amt;
            await Promise.all([
                updateDoc(doc(db, 'restaurants', currentInspData.id), { walletBalance: newBalance }),
                update(ref(rtdb, `restaurants/${currentInspData.id}/admin`), { walletBalance: newBalance })
            ]);
            logActivity({ type: 'recharge', title: 'Wallet credited', details: `${currentInspData.name}: +₹${amt}`, ts: Date.now() });
            showToast('Funds added successfully.', 'success');
            closeModal('inspectorModal');
            fetchClients();
        };

        window.toggleBlockInspector = async () => {
            const newStatus = currentInspData.status === 'blocked' ? 'active' : 'blocked';
            const isBlocking = newStatus === 'blocked';
            
            const title = isBlocking ? '🚫 Block Node' : '✅ Unblock Node';
            const message = isBlocking 
                ? `Block "${currentInspData.name}"? This will disable Admin, Customer & Kitchen access.`
                : `Unblock "${currentInspData.name}"? This will restore all services.`;
            
            const confirmed = await showConfirm(title, message, isBlocking);
            if (confirmed) {
                try {
                    // Update Firestore status
                    await updateDoc(doc(db, "restaurants", currentInspData.id), { status: newStatus });
                    
                    // Update RTDB appStatus (true = blocked, false/null = active)
                    await set(ref(rtdb, `restaurants/${currentInspData.id}/appStatus`), isBlocking ? true : null);
                    
                    logActivity({ 
                        type: 'block', 
                        title: isBlocking ? '🚫 Node Blocked' : '✅ Node Unblocked', 
                        details: `${currentInspData.name}: ${newStatus.toUpperCase()}`, 
                        ts: Date.now() 
                    });
                    
                    showToast(isBlocking ? `${currentInspData.name} has been BLOCKED` : `${currentInspData.name} has been UNBLOCKED`, isBlocking ? 'error' : 'success');
                    closeModal('inspectorModal'); 
                    fetchClients();
                } catch (e) {
                    console.error('Block/Unblock error:', e);
                    showToast('Failed to update status', 'error');
                }
            }
        };

        // =============================================
        // SUBSCRIPTION PLANS CONFIG
        // =============================================
        const SUBSCRIPTION_PLANS = {
            free: {
                name: 'Free',
                price: 0,
                features: {
                    maxOrders: 50,
                    customBranding: false,
                    aiFeatures: false,
                    customDomain: false,
                    apiAccess: false,
                    prioritySupport: false,
                    whiteLabel: false,
                    analytics: false
                }
            },
            starter: {
                name: 'Starter',
                price: 499,
                features: {
                    maxOrders: 500,
                    customBranding: true,
                    aiFeatures: false,
                    customDomain: false,
                    apiAccess: false,
                    prioritySupport: false,
                    whiteLabel: false,
                    analytics: true
                }
            },
            pro: {
                name: 'Pro',
                price: 999,
                features: {
                    maxOrders: -1, // Unlimited
                    customBranding: true,
                    aiFeatures: true,
                    customDomain: false,
                    apiAccess: false,
                    prioritySupport: true,
                    whiteLabel: false,
                    analytics: true
                }
            },
            enterprise: {
                name: 'Enterprise',
                price: 2499,
                features: {
                    maxOrders: -1, // Unlimited
                    customBranding: true,
                    aiFeatures: true,
                    customDomain: true,
                    apiAccess: true,
                    prioritySupport: true,
                    whiteLabel: true,
                    analytics: true
                }
            }
        };

        window.createClient = async () => {
            const id = document.getElementById('newShopId').value.trim().toLowerCase().replace(/\s+/g, '-');
            const name = document.getElementById('newShopName').value.trim();
            const phone = document.getElementById('newPhone').value.trim();
            const pass = document.getElementById('newPassword').value.trim();
            const initialBalance = parseInt(document.getElementById('newBalance')?.value || '0', 10) || 0;
            
            // Get selected subscription plan
            const selectedPlan = document.querySelector('input[name="subscriptionPlan"]:checked')?.value || 'free';
            const planConfig = SUBSCRIPTION_PLANS[selectedPlan];
            
            if (!id || !name) {
                showToast("Please fill ID and Name", 'error');
                return;
            }

            // Validate ID format
            if (!/^[a-z0-9-]+$/.test(id)) {
                showToast("ID must be lowercase letters, numbers, and hyphens only", 'error');
                return;
            }

            console.log('🚀 Creating new node:', { id, name, phone, pass, initialBalance, plan: selectedPlan });

            try {
                // Check if restaurant already exists
                const existingDoc = await getDoc(doc(db, 'restaurants', id));
                if (existingDoc.exists()) {
                    showToast(`Restaurant "${id}" already exists!`, 'error');
                    return;
                }

                // Calculate billing dates
                const now = new Date();
                const nextBilling = new Date(now.getFullYear(), now.getMonth() + 1, now.getDate());

                // 1. Firestore: Create tenant document with subscription
                await setDoc(doc(db, 'restaurants', id), {
                    name,
                    phone,
                    password: pass,
                    walletBalance: initialBalance,
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    // Subscription fields
                    subscription: {
                        plan: selectedPlan,
                        planName: planConfig.name,
                        monthlyPrice: planConfig.price,
                        features: planConfig.features,
                        startDate: now.toISOString(),
                        nextBillingDate: nextBilling.toISOString(),
                        totalPaid: 0,
                        isActive: true
                    },
                    // Subdomain for multi-tenant URL
                    subdomain: id
                });
                console.log('✅ Firestore doc created with subscription:', selectedPlan);

                // 2. Firestore: Create initial subcollections with placeholder docs
                // This ensures subcollections exist for new restaurant
                console.log('📁 Creating initial subcollections for:', id);
                
                // Create menu subcollection with sample item
                const menuRef = collection(db, 'restaurants', id, 'menu');
                const sampleMenuDoc = await addDoc(menuRef, {
                    name: '🎉 Welcome Item (Delete Me)',
                    price: 0,
                    category: 'Sample',
                    desc: 'This is a sample item. Delete it and add your own menu!',
                    img: 'https://cdn-icons-png.flaticon.com/512/1046/1046784.png',
                    isBestSeller: false,
                    sizes: [],
                    linkedAddons: [],
                    isPlaceholder: true,
                    createdAt: serverTimestamp()
                });
                console.log('✅ Menu subcollection created with sample doc:', sampleMenuDoc.id);

                // Create addons subcollection
                const addonsRef = collection(db, 'restaurants', id, 'addons');
                const sampleAddonDoc = await addDoc(addonsRef, {
                    name: 'Sample Addon (Delete Me)',
                    price: 0,
                    isPlaceholder: true,
                    createdAt: serverTimestamp()
                });
                console.log('✅ Addons subcollection created');

                // Create site_cards (offers) subcollection
                const siteCardsRef = collection(db, 'restaurants', id, 'site_cards');
                const sampleCardDoc = await addDoc(siteCardsRef, {
                    slotId: 1,
                    offerText: 'Welcome to our cafe!',
                    discount: 0,
                    isPlaceholder: true,
                    createdAt: serverTimestamp()
                });
                console.log('✅ Site cards subcollection created');

                // Create settings/brandConfig subcollection
                await setDoc(doc(db, 'restaurants', id, 'settings', 'brandConfig'), {
                    cafeName: name,
                    tagline: 'Delicious Moments',
                    primaryColor: '#ea580c',
                    secondaryColor: '#dc2626',
                    accentColor: '#f59e0b',
                    backgroundColor: '#fff7ed',
                    enableDonations: true,
                    enableOffers: true,
                    enableRatings: true,
                    platformFee: 1.98,
                    taxPercent: 5,
                    createdAt: serverTimestamp()
                });
                console.log('✅ Brand config created');

                // 3. RTDB: Create tenant runtime state
                await Promise.all([
                    set(ref(rtdb, `restaurants/${id}/appStatus`), false),
                    set(ref(rtdb, `restaurants/${id}/admin/walletBalance`), initialBalance),
                    set(ref(rtdb, `restaurants/${id}/admin/pin`), pass),
                    set(ref(rtdb, `restaurants/${id}/admin/settings`), {
                        ownerName: name,
                        ownerPhone: phone || ''
                    })
                ]);
                console.log('✅ RTDB admin/pin set to:', pass);

                logActivity({ type: 'create', title: 'Node deployed', details: `${name} (${id})`, ts: Date.now() });
                maybeAddNotification({
                    id: `deploy:${id}:${Date.now()}`,
                    title: 'New node deployed',
                    body: `${name} is now active with all subcollections.`,
                    ts: Date.now(),
                    level: 'info'
                });

                showToast('Node deployed successfully with all subcollections!', 'success');
                closeModal('onboardModal');
                
                // Clear form
                document.getElementById('newShopId').value = '';
                document.getElementById('newShopName').value = '';
                document.getElementById('newPhone').value = '';
                document.getElementById('newPassword').value = 'Wow@123';
                document.getElementById('newBalance').value = '0';
                
                fetchClients();
            } catch (e) { 
                console.error('❌ Failed to create node:', e);
                showToast('Error: ' + e.message, 'error'); 
            }
        };

        // Initialize subcollections for existing cafes that don't have them
        window.initializeSubcollections = async () => {
            if (!currentInspData || !currentInspData.id) {
                showToast('No cafe selected. Open a cafe inspector first.', 'error');
                return;
            }

            const cafeId = currentInspData.id;
            const cafeName = currentInspData.name || cafeId;

            const confirmed = await showConfirm('Initialize Subcollections', `Create menu, addons, site_cards, and settings for "${cafeName}"?`, false);
            if (!confirmed) return;

            console.log('📁 Initializing subcollections for existing cafe:', cafeId);
            showToast('Creating subcollections...', 'info');

            try {
                // Check and create menu subcollection
                const menuSnap = await getDocs(collection(db, 'restaurants', cafeId, 'menu'));
                if (menuSnap.empty) {
                    await addDoc(collection(db, 'restaurants', cafeId, 'menu'), {
                        name: '🎉 Welcome Item (Delete Me)',
                        price: 0,
                        category: 'Sample',
                        desc: 'This is a sample item. Delete it and add your own menu!',
                        img: 'https://cdn-icons-png.flaticon.com/512/1046/1046784.png',
                        isBestSeller: false,
                        sizes: [],
                        linkedAddons: [],
                        isPlaceholder: true,
                        createdAt: serverTimestamp()
                    });
                    console.log('✅ Menu subcollection created');
                } else {
                    console.log('ℹ️ Menu subcollection already exists with', menuSnap.size, 'items');
                }

                // Check and create addons subcollection
                const addonsSnap = await getDocs(collection(db, 'restaurants', cafeId, 'addons'));
                if (addonsSnap.empty) {
                    await addDoc(collection(db, 'restaurants', cafeId, 'addons'), {
                        name: 'Sample Addon (Delete Me)',
                        price: 0,
                        isPlaceholder: true,
                        createdAt: serverTimestamp()
                    });
                    console.log('✅ Addons subcollection created');
                } else {
                    console.log('ℹ️ Addons subcollection already exists');
                }

                // Check and create site_cards subcollection
                const cardsSnap = await getDocs(collection(db, 'restaurants', cafeId, 'site_cards'));
                if (cardsSnap.empty) {
                    await addDoc(collection(db, 'restaurants', cafeId, 'site_cards'), {
                        slotId: 1,
                        offerText: 'Welcome to our cafe!',
                        discount: 0,
                        isPlaceholder: true,
                        createdAt: serverTimestamp()
                    });
                    console.log('✅ Site cards subcollection created');
                } else {
                    console.log('ℹ️ Site cards subcollection already exists');
                }

                // Check and create settings/brandConfig
                const brandConfigRef = doc(db, 'restaurants', cafeId, 'settings', 'brandConfig');
                const brandConfigSnap = await getDoc(brandConfigRef);
                if (!brandConfigSnap.exists()) {
                    await setDoc(brandConfigRef, {
                        cafeName: cafeName,
                        tagline: 'Delicious Moments',
                        primaryColor: '#ea580c',
                        secondaryColor: '#dc2626',
                        accentColor: '#f59e0b',
                        backgroundColor: '#fff7ed',
                        enableDonations: true,
                        enableOffers: true,
                        enableRatings: true,
                        platformFee: 1.98,
                        taxPercent: 5,
                        createdAt: serverTimestamp()
                    });
                    console.log('✅ Brand config created');
                } else {
                    console.log('ℹ️ Brand config already exists');
                }

                showToast('Subcollections initialized successfully!', 'success');
                logActivity({ type: 'update', title: 'Subcollections initialized', details: `${cafeName} (${cafeId})`, ts: Date.now() });

            } catch (e) {
                console.error('❌ Failed to initialize subcollections:', e);
                showToast('Error: ' + e.message, 'error');
            }
        };

        window.switchView = (v) => {
            const views = ['dashboard', 'health', 'analytics', 'activity', 'database', 'monitor'];
            views.forEach(x => {
                const viewEl = document.getElementById('view-' + x);
                const navEl = document.getElementById('nav-' + x);
                if (viewEl) viewEl.classList.add('hidden');
                if (navEl) navEl.classList.remove('active-nav');
            });

            const currentView = document.getElementById('view-' + v);
            const currentNav = document.getElementById('nav-' + v);
            if (currentView) currentView.classList.remove('hidden');
            if (currentNav) currentNav.classList.add('active-nav');

            const title = document.getElementById('pageTitle');
            const subtitle = document.getElementById('pageSubtitle');
            if (title && subtitle) {
                if (v === 'dashboard') { title.innerText = 'System Overview'; subtitle.innerText = 'Network snapshot and actions'; }
                if (v === 'health') { title.innerText = 'Network Health'; subtitle.innerText = 'Real-time node integrity'; }
                if (v === 'analytics') { title.innerText = 'Analytics'; subtitle.innerText = 'Insights across your tenants'; }
                if (v === 'activity') { title.innerText = 'Activity Log'; subtitle.innerText = 'Audit trail of admin actions'; }
                if (v === 'database') { title.innerText = 'Database Explorer'; subtitle.innerText = 'Real-time Firebase data viewer'; populateDbNodeSelect(); }
                if (v === 'monitor') { title.innerText = 'System Monitor'; subtitle.innerText = 'Live performance metrics'; startMonitor(); }
            }
        };

        window.switchInspTab = (t) => {
            ['links', 'subscription', 'branding', 'ai', 'settings'].forEach(tab => {
                const viewEl = document.getElementById('insp-view-' + tab);
                const tabEl = document.getElementById('tab-' + tab);
                if (viewEl) viewEl.classList.add('hidden');
                if (tabEl) tabEl.className = "flex-1 py-4 text-xs font-bold text-slate-500 hover:text-white uppercase tracking-wider transition whitespace-nowrap px-2";
            });
            const activeView = document.getElementById('insp-view-' + t);
            const activeTab = document.getElementById('tab-' + t);
            if (activeView) activeView.classList.remove('hidden');
            if (activeTab) activeTab.className = "flex-1 py-4 text-xs font-bold text-blue-400 border-b-2 border-blue-500 bg-blue-500/5 uppercase tracking-wider transition whitespace-nowrap px-2";
            
            // Load data for specific tabs
            if (t === 'subscription') loadSubscriptionTab();
            if (t === 'branding') loadBrandingTab();
        };
        
        // =============================================
        // SUBSCRIPTION MANAGEMENT
        // =============================================
        function loadSubscriptionTab() {
            if (!currentInspData) return;
            
            const sub = currentInspData.subscription || {};
            const plan = sub.plan || 'free';
            const planConfig = SUBSCRIPTION_PLANS[plan] || SUBSCRIPTION_PLANS.free;
            
            // Update current plan badge
            const planBadge = document.getElementById('inspCurrentPlan');
            if (planBadge) {
                planBadge.textContent = planConfig.name;
                planBadge.className = `plan-badge plan-${plan}`;
            }
            
            // Update billing info
            const nextBillingEl = document.getElementById('inspNextBilling');
            const monthlyAmountEl = document.getElementById('inspMonthlyAmount');
            const totalPaidEl = document.getElementById('inspTotalPaid');
            
            if (nextBillingEl) {
                nextBillingEl.textContent = sub.nextBillingDate 
                    ? new Date(sub.nextBillingDate).toLocaleDateString('en-IN')
                    : (plan === 'free' ? 'N/A (Free Plan)' : '--');
            }
            if (monthlyAmountEl) monthlyAmountEl.textContent = `₹${planConfig.price}`;
            if (totalPaidEl) totalPaidEl.textContent = `₹${sub.totalPaid || 0}`;
            
            // Render features list
            const featuresEl = document.getElementById('planFeaturesList');
            if (featuresEl) {
                const features = planConfig.features;
                featuresEl.innerHTML = `
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">Orders Limit</span>
                        <span class="text-white">${features.maxOrders === -1 ? 'Unlimited' : features.maxOrders + '/mo'}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">Custom Branding</span>
                        <span class="${features.customBranding ? 'text-green-400' : 'text-red-400'}">${features.customBranding ? '✓ Enabled' : '✗ Locked'}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">AI Features</span>
                        <span class="${features.aiFeatures ? 'text-green-400' : 'text-red-400'}">${features.aiFeatures ? '✓ Enabled' : '✗ Locked'}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">Custom Domain</span>
                        <span class="${features.customDomain ? 'text-green-400' : 'text-red-400'}">${features.customDomain ? '✓ Enabled' : '✗ Locked'}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">API Access</span>
                        <span class="${features.apiAccess ? 'text-green-400' : 'text-red-400'}">${features.apiAccess ? '✓ Enabled' : '✗ Locked'}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-400">Analytics</span>
                        <span class="${features.analytics ? 'text-green-400' : 'text-red-400'}">${features.analytics ? '✓ Enabled' : '✗ Locked'}</span>
                    </div>
                `;
            }
        }
        
        window.upgradePlan = async (newPlan) => {
            if (!currentInspData) return;
            
            const planConfig = SUBSCRIPTION_PLANS[newPlan];
            if (!planConfig) return showToast('Invalid plan', 'error');
            
            const currentPlan = currentInspData.subscription?.plan || 'free';
            if (currentPlan === newPlan) return showToast('Already on this plan', 'error');
            
            const confirmed = await showConfirm('Upgrade Plan', `Upgrade ${currentInspData.name} to ${planConfig.name} plan (₹${planConfig.price}/mo)?`, false);
            if (!confirmed) return;
            
            const now = new Date();
            const nextBilling = new Date(now.getFullYear(), now.getMonth() + 1, now.getDate());
            
            try {
                await updateDoc(doc(db, 'restaurants', currentInspData.id), {
                    'subscription.plan': newPlan,
                    'subscription.planName': planConfig.name,
                    'subscription.monthlyPrice': planConfig.price,
                    'subscription.features': planConfig.features,
                    'subscription.upgradedAt': now.toISOString(),
                    'subscription.nextBillingDate': nextBilling.toISOString()
                });
                
                logActivity({ 
                    type: 'subscription', 
                    title: 'Plan upgraded', 
                    details: `${currentInspData.name}: ${currentPlan} → ${newPlan} (₹${planConfig.price}/mo)`, 
                    ts: Date.now() 
                });
                
                showToast(`Upgraded to ${planConfig.name} plan!`, 'success');
                closeModal('inspectorModal');
                fetchClients();
            } catch (e) {
                console.error(e);
                showToast('Upgrade failed: ' + e.message, 'error');
            }
        };
        
        // =============================================
        // BRANDING MANAGEMENT
        // =============================================
        async function loadBrandingTab() {
            if (!currentInspData) return;
            
            // Check if branding is allowed
            const sub = currentInspData.subscription || {};
            const features = sub.features || {};
            
            try {
                // Load brand config from Firestore
                const brandConfigRef = doc(db, 'restaurants', currentInspData.id, 'settings', 'brandConfig');
                const brandSnap = await getDoc(brandConfigRef);
                const brand = brandSnap.exists() ? brandSnap.data() : {};
                
                // Populate form fields
                document.getElementById('brandPrimaryColor').value = brand.primaryColor || '#ea580c';
                document.getElementById('brandPrimaryHex').value = brand.primaryColor || '#ea580c';
                document.getElementById('brandSecondaryColor').value = brand.secondaryColor || '#dc2626';
                document.getElementById('brandSecondaryHex').value = brand.secondaryColor || '#dc2626';
                document.getElementById('brandAccentColor').value = brand.accentColor || '#f59e0b';
                document.getElementById('brandAccentHex').value = brand.accentColor || '#f59e0b';
                document.getElementById('brandBgColor').value = brand.backgroundColor || '#fff7ed';
                document.getElementById('brandBgHex').value = brand.backgroundColor || '#fff7ed';
                
                document.getElementById('brandCafeName').value = brand.cafeName || currentInspData.name || '';
                document.getElementById('brandTagline').value = brand.tagline || 'Delicious Moments';
                document.getElementById('brandLogoUrl').value = brand.logoUrl || '';
                
                document.getElementById('brandEnableDonations').checked = brand.enableDonations !== false;
                document.getElementById('brandEnableOffers').checked = brand.enableOffers !== false;
                document.getElementById('brandEnableRatings').checked = brand.enableRatings !== false;
                document.getElementById('brandEnableTakeaway').checked = brand.enableTakeaway !== false;
                
                // Sync color pickers with hex inputs
                ['Primary', 'Secondary', 'Accent', 'Bg'].forEach(type => {
                    const colorInput = document.getElementById(`brand${type}Color`);
                    const hexInput = document.getElementById(`brand${type}Hex`);
                    if (colorInput && hexInput) {
                        colorInput.addEventListener('input', () => hexInput.value = colorInput.value);
                        hexInput.addEventListener('input', () => {
                            if (/^#[0-9A-Fa-f]{6}$/.test(hexInput.value)) {
                                colorInput.value = hexInput.value;
                            }
                        });
                    }
                });
                
            } catch (e) {
                console.error('Error loading brand config:', e);
            }
        }
        
        window.saveBrandConfig = async () => {
            if (!currentInspData) return;
            
            const brandConfig = {
                cafeName: document.getElementById('brandCafeName').value.trim() || currentInspData.name,
                tagline: document.getElementById('brandTagline').value.trim() || 'Delicious Moments',
                logoUrl: document.getElementById('brandLogoUrl').value.trim() || null,
                
                primaryColor: document.getElementById('brandPrimaryHex').value || '#ea580c',
                secondaryColor: document.getElementById('brandSecondaryHex').value || '#dc2626',
                accentColor: document.getElementById('brandAccentHex').value || '#f59e0b',
                backgroundColor: document.getElementById('brandBgHex').value || '#fff7ed',
                
                enableDonations: document.getElementById('brandEnableDonations').checked,
                enableOffers: document.getElementById('brandEnableOffers').checked,
                enableRatings: document.getElementById('brandEnableRatings').checked,
                enableTakeaway: document.getElementById('brandEnableTakeaway').checked,
                
                updatedAt: serverTimestamp()
            };
            
            try {
                await setDoc(doc(db, 'restaurants', currentInspData.id, 'settings', 'brandConfig'), brandConfig, { merge: true });
                
                logActivity({ 
                    type: 'branding', 
                    title: 'Brand config updated', 
                    details: `${currentInspData.name}: Colors and settings saved`, 
                    ts: Date.now() 
                });
                
                showToast('Brand settings saved! Changes will reflect in customer app.', 'success');
            } catch (e) {
                console.error(e);
                showToast('Failed to save: ' + e.message, 'error');
            }
        };

        window.copyToClip = (id) => navigator.clipboard.writeText(document.getElementById(id).innerText).then(() => showToast("Copied to clipboard!", 'success'));
        window.openLink = (id) => window.open(document.getElementById(id).innerText, '_blank');
        window.openOnboardModal = () => document.getElementById('onboardModal').classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.searchTable = () => {
            tableState.query = (document.getElementById('searchInput')?.value || '').toLowerCase().trim();
            tableState.page = 1;
            renderTable();
        };

        window.filterByStatus = () => {
            tableState.status = document.getElementById('statusFilter')?.value || 'all';
            tableState.page = 1;
            renderTable();
        };

        window.sortTable = (key) => {
            if (tableState.sortKey === key) tableState.sortDir = tableState.sortDir === 'asc' ? 'desc' : 'asc';
            else { tableState.sortKey = key; tableState.sortDir = 'asc'; }
            tableState.page = 1;
            renderTable();
        };

        window.prevPage = () => {
            tableState.page = Math.max(1, tableState.page - 1);
            renderTable();
        };

        window.nextPage = () => {
            const visible = getVisibleClients();
            const totalPages = Math.max(1, Math.ceil(visible.length / tableState.pageSize));
            tableState.page = Math.min(totalPages, tableState.page + 1);
            renderTable();
        };

        window.toggleMobileMenu = () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            if (!sidebar || !overlay) return;
            const isOpen = !sidebar.classList.contains('-translate-x-full');
            if (isOpen) {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            } else {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            }
        };

        window.logout = () => {
            showToast('Logged out (client-side).', 'success');
        };

        window.openSettingsModal = () => {
            hydrateSettingsUI();
            document.getElementById('settingsModal')?.classList.remove('hidden');
        };

        window.saveSettings = () => {
            const cur = getSettings();
            const next = {
                ...cur,
                baseUrl: document.getElementById('settingsBaseUrl')?.value?.trim() || cur.baseUrl,
                geminiApiKey: document.getElementById('settingsApiKey')?.value?.trim() || '',
                notifLowBalance: !!document.getElementById('notifLowBalance')?.checked,
                notifNewNode: !!document.getElementById('notifNewNode')?.checked,
                notifSystem: !!document.getElementById('notifSystem')?.checked
            };
            setSettings(next);
            showToast('Settings saved.', 'success');
            closeModal('settingsModal');
            // Refresh links if inspector is open
            if (currentInspData && !document.getElementById('inspectorModal')?.classList.contains('hidden')) {
                openInspector(currentInspData.id);
            }
        };

        function hydrateSettingsUI() {
            const s = getSettings();
            const base = document.getElementById('settingsBaseUrl');
            const key = document.getElementById('settingsApiKey');
            if (base) base.value = s.baseUrl;
            if (key) key.value = s.geminiApiKey;
            const a = document.getElementById('notifLowBalance');
            const b = document.getElementById('notifNewNode');
            const c = document.getElementById('notifSystem');
            if (a) a.checked = !!s.notifLowBalance;
            if (b) b.checked = !!s.notifNewNode;
            if (c) c.checked = !!s.notifSystem;
        }

        // --- TOASTIFY BASED TOAST ---
        function showToast(message, type = 'success') {
            const bgColors = {
                success: 'linear-gradient(to right, #10B981, #059669)',
                error: 'linear-gradient(to right, #EF4444, #DC2626)',
                warning: 'linear-gradient(to right, #F59E0B, #D97706)',
                info: 'linear-gradient(to right, #3B82F6, #2563EB)'
            };
            
            const icons = {
                success: '✓',
                error: '✗',
                warning: '⚠',
                info: 'ℹ'
            };
            
            Toastify({
                text: `${icons[type] || '•'} ${message}`,
                duration: 3000,
                gravity: "top",
                position: "right",
                style: {
                    background: bgColors[type] || bgColors.success,
                    borderRadius: "12px",
                    fontWeight: "600",
                    fontSize: "14px",
                    padding: "12px 20px",
                    boxShadow: "0 10px 30px rgba(0,0,0,0.3)"
                },
                close: true
            }).showToast();
        }

        // --- CUSTOM CONFIRM DIALOG (Replaces browser confirm) ---
        let confirmResolve = null;
        
        function showConfirm(title, message, isDanger = true) {
            return new Promise((resolve) => {
                confirmResolve = resolve;
                
                document.getElementById('confirmTitle').innerText = title;
                document.getElementById('confirmMessage').innerText = message;
                
                const iconDiv = document.getElementById('confirmIcon');
                const btn = document.getElementById('confirmBtn');
                
                if (isDanger) {
                    iconDiv.innerHTML = '<i class="fas fa-exclamation-triangle text-3xl text-red-400"></i>';
                    iconDiv.className = 'w-16 h-16 bg-red-500/10 rounded-full mx-auto flex items-center justify-center mb-4';
                    btn.className = 'flex-1 py-3 rounded-xl bg-red-500 text-white font-bold hover:bg-red-600 transition';
                } else {
                    iconDiv.innerHTML = '<i class="fas fa-question-circle text-3xl text-blue-400"></i>';
                    iconDiv.className = 'w-16 h-16 bg-blue-500/10 rounded-full mx-auto flex items-center justify-center mb-4';
                    btn.className = 'flex-1 py-3 rounded-xl bg-blue-500 text-white font-bold hover:bg-blue-600 transition';
                }
                
                document.getElementById('confirmModal').classList.remove('hidden');
            });
        }
        
        window.resolveConfirm = (result) => {
            document.getElementById('confirmModal').classList.add('hidden');
            if (confirmResolve) {
                confirmResolve(result);
                confirmResolve = null;
            }
        };

        function getActivity() {
            try {
                const raw = localStorage.getItem(STORAGE_KEYS.activity);
                const arr = raw ? JSON.parse(raw) : [];
                return Array.isArray(arr) ? arr : [];
            } catch {
                return [];
            }
        }

        function setActivity(arr) {
            localStorage.setItem(STORAGE_KEYS.activity, JSON.stringify(arr.slice(0, 500)));
        }

        function logActivity(entry) {
            const current = getActivity();
            current.unshift(entry);
            setActivity(current);
            renderActivity();
        }

        function renderActivity() {
            const list = getActivity();
            const recentEl = document.getElementById('recentActivity');
            const fullEl = document.getElementById('activityLog');
            const filter = document.getElementById('activityFilter')?.value || 'all';

            const filtered = filter === 'all' ? list : list.filter(x => x.type === filter);

            if (recentEl) {
                const recent = filtered.slice(0, 8);
                recentEl.innerHTML = recent.length ? recent.map(renderActivityItem).join('') : `<div class="text-slate-500 text-sm">No recent activity.</div>`;
            }

            if (fullEl) {
                const rows = filtered.slice(0, 200);
                fullEl.innerHTML = rows.length ? rows.map(renderActivityItem).join('') : `<div class="p-8 text-slate-500 text-sm text-center">No activity to show.</div>`;
            }
        }

        function renderActivityItem(item) {
            const when = new Date(item.ts || Date.now()).toLocaleString();
            const color = item.type === 'block' ? 'text-red-400' : item.type === 'recharge' ? 'text-green-400' : item.type === 'create' ? 'text-blue-400' : 'text-slate-300';
            return `
                <div class="p-4 flex items-start gap-3 activity-item">
                    <div class="activity-dot ${color.replace('text-', 'bg-')}"></div>
                    <div class="flex-1">
                        <div class="flex justify-between gap-3">
                            <p class="text-sm font-semibold ${color}">${escapeHtml(item.title || 'Event')}</p>
                            <span class="text-[10px] text-slate-500 font-mono">${escapeHtml(when)}</span>
                        </div>
                        <p class="text-xs text-slate-400 mt-1">${escapeHtml(item.details || '')}</p>
                    </div>
                </div>
            `;
        }

        window.filterActivity = () => renderActivity();
        window.clearActivityLog = async () => {
            const confirmed = await showConfirm('Clear Activity Log', 'Delete all activity history?', true);
            if (!confirmed) return;
            setActivity([]);
            renderActivity();
            showToast('Activity log cleared.', 'success');
        };

        function getNotifications() {
            try {
                const raw = localStorage.getItem(STORAGE_KEYS.notifications);
                const arr = raw ? JSON.parse(raw) : [];
                return Array.isArray(arr) ? arr : [];
            } catch {
                return [];
            }
        }

        function setNotifications(arr) {
            localStorage.setItem(STORAGE_KEYS.notifications, JSON.stringify(arr.slice(0, 200)));
        }

        function maybeAddNotification(n) {
            const settings = getSettings();
            if (n.title?.includes('Low balance') && !settings.notifLowBalance) return;
            if (n.title?.includes('New node') && !settings.notifNewNode) return;

            const cur = getNotifications();
            if (cur.some(x => x.id === n.id)) return;
            cur.unshift(n);
            setNotifications(cur);
            renderNotifications();
        }

        function renderNotifications() {
            const list = getNotifications();
            const panel = document.getElementById('notificationsList');
            const badge = document.getElementById('notifBadge');
            const count = list.length;
            if (badge) {
                badge.innerText = String(count);
                badge.classList.toggle('hidden', count === 0);
            }

            if (panel) {
                panel.innerHTML = count ? list.map(n => {
                    const when = new Date(n.ts || Date.now()).toLocaleString();
                    const levelColor = n.level === 'error' ? 'text-red-400' : n.level === 'warning' ? 'text-yellow-400' : 'text-blue-400';
                    return `
                        <div class="glass-static rounded-xl p-4 border border-slate-800/50">
                            <div class="flex justify-between gap-3">
                                <p class="text-sm font-semibold ${levelColor}">${escapeHtml(n.title || 'Notification')}</p>
                                <span class="text-[10px] text-slate-500 font-mono">${escapeHtml(when)}</span>
                            </div>
                            <p class="text-xs text-slate-400 mt-2">${escapeHtml(n.body || '')}</p>
                        </div>
                    `;
                }).join('') : `<div class="text-slate-500 text-sm p-6">No notifications.</div>`;
            }
        }

        window.openNotifications = () => {
            document.getElementById('notificationsPanel')?.classList.remove('hidden');
            renderNotifications();
        };
        window.closeNotifications = () => document.getElementById('notificationsPanel')?.classList.add('hidden');
        window.clearNotifications = async () => {
            const confirmed = await showConfirm('Clear Notifications', 'Delete all notifications?', true);
            if (!confirmed) return;
            setNotifications([]);
            renderNotifications();
            showToast('Notifications cleared.', 'success');
        };

        function maybeNotifyLowBalance(data) {
            const settings = getSettings();
            if (!settings.notifLowBalance) return;
            const lows = data.filter(c => c.status !== 'blocked' && (c.walletBalance || 0) < 100);
            lows.slice(0, 5).forEach(c => {
                maybeAddNotification({
                    id: `low:${c.id}:${String(c.walletBalance || 0)}`,
                    title: 'Low balance alert',
                    body: `${c.name} is below threshold (₹${c.walletBalance || 0}).`,
                    ts: Date.now(),
                    level: 'warning'
                });
            });
        }

        window.bulkRecharge = () => {
            const sel = document.getElementById('bulkNodes');
            if (sel) {
                sel.innerHTML = clientsData.map(c => `<option value="${escapeAttr(c.id)}">${escapeHtml(c.name)} (${escapeHtml(c.id)})</option>`).join('');
            }
            document.getElementById('bulkRechargeModal')?.classList.remove('hidden');
        };

        window.processBulkRecharge = async () => {
            const sel = document.getElementById('bulkNodes');
            const amt = parseInt(document.getElementById('bulkAmount')?.value || '0', 10) || 0;
            if (!sel) return;
            const ids = Array.from(sel.selectedOptions).map(o => o.value);
            if (!ids.length) return showToast('Select at least one node.', 'error');
            if (!amt) return showToast('Enter a valid amount.', 'error');

            try {
                for (const id of ids) {
                    const c = clientsData.find(x => x.id === id);
                    const oldBalance = Number(c?.walletBalance || 0);
                    const newBalance = oldBalance + amt;
                    await Promise.all([
                        updateDoc(doc(db, 'restaurants', id), { walletBalance: newBalance }),
                        update(ref(rtdb, `restaurants/${id}/admin`), { walletBalance: newBalance })
                    ]);
                    logActivity({ type: 'recharge', title: 'Bulk recharge', details: `${c?.name || id}: +₹${amt}`, ts: Date.now() });
                }
                showToast('Bulk recharge processed.', 'success');
                closeModal('bulkRechargeModal');
                fetchClients();
            } catch (e) {
                console.error(e);
                showToast('Bulk recharge failed.', 'error');
            }
        };

        window.sendBroadcast = () => {
            // Load existing promo ad if any
            loadPromoAdSettings();
            document.getElementById('broadcastModal')?.classList.remove('hidden');
        };
        
        // Load promo ad settings for current cafe
        async function loadPromoAdSettings() {
            if (!currentInspData) return;
            try {
                const promoRef = doc(db, 'restaurants', currentInspData.id, 'settings', 'promoAd');
                const snap = await getDoc(promoRef);
                if (snap.exists()) {
                    const data = snap.data();
                    document.getElementById('promoAdEnabled').checked = data.enabled !== false;
                    document.getElementById('broadcastTitle').value = data.title || '';
                    document.getElementById('broadcastBody').value = data.description || '';
                    document.getElementById('promoButtonText').value = data.buttonText || 'View Offer';
                    document.getElementById('promoLinkUrl').value = data.linkUrl || '';
                    document.getElementById('promoAdBgColor').value = data.bgColor || '#7c3aed';
                    document.getElementById('promoAdTextColor').value = data.textColor || '#ffffff';
                }
            } catch (e) {
                console.error('Error loading promo ad:', e);
            }
        }
        
        // Save promo ad for current cafe
        window.savePromoAd = async () => {
            if (!currentInspData) {
                showToast('Open a cafe first to set promo ad', 'error');
                return;
            }
            
            const promoAd = {
                enabled: document.getElementById('promoAdEnabled').checked,
                title: document.getElementById('broadcastTitle')?.value?.trim() || '',
                description: document.getElementById('broadcastBody')?.value?.trim() || '',
                buttonText: document.getElementById('promoButtonText')?.value?.trim() || 'View Offer',
                linkUrl: document.getElementById('promoLinkUrl')?.value?.trim() || '',
                bgColor: document.getElementById('promoAdBgColor')?.value || '#7c3aed',
                textColor: document.getElementById('promoAdTextColor')?.value || '#ffffff',
                updatedAt: serverTimestamp()
            };
            
            try {
                await setDoc(doc(db, 'restaurants', currentInspData.id, 'settings', 'promoAd'), promoAd);
                logActivity({ 
                    type: 'system', 
                    title: 'Promo Ad Updated', 
                    details: `${currentInspData.name}: ${promoAd.enabled ? 'Enabled' : 'Disabled'} - ${promoAd.title}`, 
                    ts: Date.now() 
                });
                showToast(`Promo ad ${promoAd.enabled ? 'enabled' : 'disabled'} for ${currentInspData.name}`, 'success');
                closeModal('broadcastModal');
            } catch (e) {
                console.error('Error saving promo ad:', e);
                showToast('Failed to save promo ad', 'error');
            }
        };
        
        // Legacy function for backward compatibility
        window.sendBroadcastMessage = () => window.savePromoAd();

        window.exportData = () => {
            const payload = {
                exportedAt: new Date().toISOString(),
                clients: clientsData
            };
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `wowcore-export-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            showToast('Export downloaded.', 'success');
        };

        window.generateReport = () => {
            const total = clientsData.length;
            const blocked = clientsData.filter(x => x.status === 'blocked').length;
            const low = clientsData.filter(x => x.status !== 'blocked' && (x.walletBalance || 0) < 100).length;
            const sum = clientsData.reduce((acc, x) => acc + Number(x.walletBalance || 0), 0);
            const report = [
                `WOWCORE Report`,
                `Generated: ${new Date().toLocaleString()}`,
                `Total Nodes: ${total}`,
                `Blocked Nodes: ${blocked}`,
                `Low Balance Nodes: ${low}`,
                `Total Wallet Balance: ₹${sum.toLocaleString()}`
            ].join('\n');
            const blob = new Blob([report], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `wowcore-report-${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            logActivity({ type: 'system', title: 'Report generated', details: `Nodes: ${total}, Blocked: ${blocked}, Low: ${low}`, ts: Date.now() });
            showToast('Report downloaded.', 'success');
        };

        window.updateAnalytics = () => {
            const dist = {
                active: clientsData.filter(x => x.status !== 'blocked').length,
                blocked: clientsData.filter(x => x.status === 'blocked').length,
                low: clientsData.filter(x => x.status !== 'blocked' && (x.walletBalance || 0) < 100).length
            };

            const revenueValues = clientsData
                .map(x => ({ name: x.name || x.id, value: Number(x.walletBalance || 0) }))
                .sort((a, b) => b.value - a.value)
                .slice(0, 10);

            const topNodesEl = document.getElementById('topNodes');
            if (topNodesEl) {
                topNodesEl.innerHTML = revenueValues.length
                    ? revenueValues.map(x => `<div class="flex justify-between text-sm"><span class="text-slate-300 truncate">${escapeHtml(x.name)}</span><span class="text-white font-semibold">₹${Number(x.value).toLocaleString()}</span></div>`).join('')
                    : `<div class="text-slate-500 text-sm">No data.</div>`;
            }

            const lowNodes = clientsData.filter(x => x.status !== 'blocked' && (x.walletBalance || 0) < 100).slice(0, 10);
            const lowBalanceEl = document.getElementById('lowBalanceNodes');
            if (lowBalanceEl) {
                lowBalanceEl.innerHTML = lowNodes.length
                    ? lowNodes.map(x => `<div class="flex justify-between text-sm"><span class="text-slate-300 truncate">${escapeHtml(x.name || x.id)}</span><span class="text-yellow-400 font-semibold">₹${Number(x.walletBalance || 0).toLocaleString()}</span></div>`).join('')
                    : `<div class="text-slate-500 text-sm">No low-balance nodes.</div>`;
            }

            const apiCalls = document.getElementById('apiCalls');
            const activeSessions = document.getElementById('activeSessions');
            if (apiCalls) apiCalls.innerText = String(Math.max(0, clientsData.length * 37));
            if (activeSessions) activeSessions.innerText = String(Math.max(0, dist.active));

            const revenueCanvas = document.getElementById('revenueChart');
            const distCanvas = document.getElementById('distributionChart');

            if (window.Chart && revenueCanvas) {
                const labels = revenueValues.map(x => x.name);
                const values = revenueValues.map(x => x.value);

                if (charts.revenue) charts.revenue.destroy();
                charts.revenue = new Chart(revenueCanvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Wallet Balance (proxy)',
                            data: values,
                            borderColor: '#60a5fa',
                            backgroundColor: 'rgba(96,165,250,0.15)',
                            tension: 0.35,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { color: '#94a3b8', maxRotation: 0, autoSkip: true }, grid: { color: 'rgba(148,163,184,0.08)' } },
                            y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148,163,184,0.08)' } }
                        }
                    }
                });
            }

            if (window.Chart && distCanvas) {
                if (charts.distribution) charts.distribution.destroy();
                charts.distribution = new Chart(distCanvas.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Active', 'Blocked', 'Low Balance'],
                        datasets: [{
                            data: [dist.active, dist.blocked, dist.low],
                            backgroundColor: ['rgba(34,197,94,0.7)', 'rgba(239,68,68,0.7)', 'rgba(234,179,8,0.7)'],
                            borderColor: ['rgba(34,197,94,1)', 'rgba(239,68,68,1)', 'rgba(234,179,8,1)'],
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { labels: { color: '#cbd5e1' } } } }
                });
            }
        };

        window.showAlerts = () => openNotifications();

        window.generateQR = () => {
            const type = document.getElementById('qrLinkType')?.value || 'customer';
            const map = { customer: 'linkCustomer', owner: 'linkOwner', kitchen: 'linkKitchen' };
            const id = map[type] || 'linkCustomer';
            const url = document.getElementById(id)?.innerText || '';
            if (!url || url === 'Loading...') return showToast('Link not ready yet.', 'error');
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=320x320&data=${encodeURIComponent(url)}`;
            window.open(qrUrl, '_blank');
        };

        window.handleTerminalInput = (event) => {
            if (event.key !== 'Enter') return;
            const input = event.target;
            const cmd = (input.value || '').trim();
            if (!cmd) return;
            input.value = '';
            const box = document.getElementById('liveLogs');
            if (!box) return;
            box.innerHTML += `<p class="text-green-400">> ${escapeHtml(cmd)}</p>`;

            if (cmd === 'help') {
                box.innerHTML += `<p class="opacity-80">Commands: help, status, wallet, links</p>`;
            } else if (cmd === 'status') {
                box.innerHTML += `<p class="opacity-80">Status: ${escapeHtml(currentInspData?.status || '--')}</p>`;
            } else if (cmd === 'wallet') {
                box.innerHTML += `<p class="opacity-80">Wallet: ₹${escapeHtml(String(currentInspData?.walletBalance || 0))}</p>`;
            } else if (cmd === 'links') {
                box.innerHTML += `<p class="opacity-80">Customer: ${escapeHtml(document.getElementById('linkCustomer')?.innerText || '')}</p>`;
            } else {
                box.innerHTML += `<p class="opacity-60">Unknown command. Type 'help'.</p>`;
            }

            box.scrollTop = box.scrollHeight;
        };

        window.saveNodeSettings = async () => {
            if (!currentInspData) return;
            const name = document.getElementById('editNodeName')?.value?.trim() || currentInspData.name;
            const phone = document.getElementById('editNodePhone')?.value?.trim() || currentInspData.phone;
            const password = (document.getElementById('editNodePassword')?.value ?? '').trim() || (currentInspData.password != null ? String(currentInspData.password).trim() : '');
            try {
                await Promise.all([
                    updateDoc(doc(db, 'restaurants', currentInspData.id), { name, phone, password }),
                    // Keep Admin login consistent (Admin prefers RTDB admin/pin)
                    set(ref(rtdb, `restaurants/${currentInspData.id}/admin/pin`), password || '')
                ]);
                logActivity({ type: 'system', title: 'Node settings updated', details: `${name} (${currentInspData.id})`, ts: Date.now() });
                showToast('Node settings saved.', 'success');
                closeModal('inspectorModal');
                fetchClients();
            } catch (e) {
                console.error(e);
                showToast('Failed to save settings.', 'error');
            }
        };

        // --- FEATURE ALLOCATION SYSTEM ---
        window.loadFeatureAllocation = async () => {
            if (!currentInspData) return;
            try {
                const featuresDoc = await getDoc(doc(db, `restaurants/${currentInspData.id}/settings`, 'features'));
                const features = featuresDoc.exists() ? featuresDoc.data() : {};
                
                // Set checkbox states
                document.getElementById('feature-spinWheel').checked = features.spinWheel || false;
                document.getElementById('feature-donations').checked = features.donations !== false; // Default true
                document.getElementById('feature-promoAds').checked = features.promoAds || false;
                document.getElementById('feature-aiAssistant').checked = features.aiAssistant || false;
                document.getElementById('feature-wallet').checked = features.wallet !== false; // Default true
                document.getElementById('feature-analytics').checked = features.analytics || false;
            } catch (e) {
                console.error('Error loading features:', e);
            }
        };

        window.saveFeatureAllocation = async () => {
            if (!currentInspData) return;
            const features = {
                spinWheel: document.getElementById('feature-spinWheel').checked,
                donations: document.getElementById('feature-donations').checked,
                promoAds: document.getElementById('feature-promoAds').checked,
                aiAssistant: document.getElementById('feature-aiAssistant').checked,
                wallet: document.getElementById('feature-wallet').checked,
                analytics: document.getElementById('feature-analytics').checked
            };
            
            try {
                await setDoc(doc(db, `restaurants/${currentInspData.id}/settings`, 'features'), features);
                logActivity({ type: 'system', title: 'Features updated', details: `${currentInspData.name}: ${Object.entries(features).filter(([k,v]) => v).map(([k]) => k).join(', ')}`, ts: Date.now() });
                showToast('Feature allocation saved!', 'success');
            } catch (e) {
                console.error('Error saving features:', e);
                showToast('Failed to save features.', 'error');
            }
        };

        window.updateFeatureAllocation = () => {
            // Called on checkbox change - visual feedback only
            const checkboxes = document.querySelectorAll('[id^="feature-"]');
            checkboxes.forEach(cb => {
                const parent = cb.closest('label');
                if (cb.checked) {
                    parent.classList.add('ring-2', 'ring-purple-500/50');
                } else {
                    parent.classList.remove('ring-2', 'ring-purple-500/50');
                }
            });
        };

        window.resetNodeData = async () => {
            if (!currentInspData) return;
            const confirmed = await showConfirm('Reset Node Data', `Reset orders and wallet for ${currentInspData.name}?`, true);
            if (!confirmed) return;
            try {
                await Promise.all([
                    remove(ref(rtdb, `restaurants/${currentInspData.id}/orders`)),
                    set(ref(rtdb, `restaurants/${currentInspData.id}/admin/walletBalance`), 0),
                    set(ref(rtdb, `restaurants/${currentInspData.id}/appStatus`), false),
                    updateDoc(doc(db, 'restaurants', currentInspData.id), { walletBalance: 0 })
                ]);
                logActivity({ type: 'system', title: 'Node reset', details: `${currentInspData.name} (${currentInspData.id})`, ts: Date.now() });
                showToast('Node reset completed.', 'success');
                closeModal('inspectorModal');
                fetchClients();
            } catch (e) {
                console.error(e);
                showToast('Reset failed.', 'error');
            }
        };

        window.deleteNode = async () => {
            if (!currentInspData) return;
            const confirmed = await showConfirm('⚠️ Delete Node', `Permanently delete ${currentInspData.name}? This cannot be undone!`, true);
            if (!confirmed) return;
            try {
                await Promise.all([
                    deleteDoc(doc(db, 'restaurants', currentInspData.id)),
                    remove(ref(rtdb, `restaurants/${currentInspData.id}`))
                ]);
                logActivity({ type: 'system', title: 'Node deleted', details: `${currentInspData.name} (${currentInspData.id})`, ts: Date.now() });
                showToast('Node deleted.', 'success');
                closeModal('inspectorModal');
                fetchClients();
            } catch (e) {
                console.error(e);
                showToast('Delete failed.', 'error');
            }
        };

        function escapeHtml(str) {
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function escapeAttr(str) {
            return escapeHtml(str).replaceAll('`', '&#96;');
        }

        function startLogs(name) {
            const box = document.getElementById('liveLogs');
            box.innerHTML = `<p class="text-blue-400">> Establishing secure connection to ${name}...</p>`;
            const logs = ["Handshake: OK", "Wallet Integrity: Verified", "Database Sync: Active", "Monitoring Traffic..."];
            let i = 0;
            const int = setInterval(() => {
                if (i >= logs.length || document.getElementById('inspectorModal').classList.contains('hidden')) clearInterval(int);
                else { box.innerHTML += `<p>> ${logs[i]}</p>`; box.scrollTop = box.scrollHeight; i++; }
            }, 800);
        }

        // =====================
        // DATABASE EXPLORER
        // =====================
        let monitorInterval = null;
        let monitorRunning = false;

        function populateDbNodeSelect() {
            const select = document.getElementById('dbNodeSelect');
            if (!select) return;
            select.innerHTML = '<option value="">Select a node...</option>';
            clientsData.forEach(c => {
                select.innerHTML += `<option value="${escapeAttr(c.id)}">${escapeHtml(c.name)} (${escapeHtml(c.id)})</option>`;
            });
        }

        window.loadNodeDatabase = async () => {
            const nodeId = document.getElementById('dbNodeSelect')?.value;
            if (!nodeId) return;

            const rtdbEl = document.getElementById('rtdbData');
            const fsEl = document.getElementById('firestoreData');
            rtdbEl.innerHTML = '<p class="text-yellow-400">Loading RTDB data...</p>';
            fsEl.innerHTML = '<p class="text-yellow-400">Loading Firestore data...</p>';

            try {
                // Load RTDB data
                const rtdbSnap = await get(ref(rtdb, `restaurants/${nodeId}`));
                if (rtdbSnap.exists()) {
                    rtdbEl.innerHTML = `<pre class="whitespace-pre-wrap">${escapeHtml(JSON.stringify(rtdbSnap.val(), null, 2))}</pre>`;
                } else {
                    rtdbEl.innerHTML = '<p class="text-slate-500">No RTDB data found for this node.</p>';
                }

                // Load Firestore data
                const docSnap = await getDoc(doc(db, 'restaurants', nodeId));
                if (docSnap.exists()) {
                    fsEl.innerHTML = `<pre class="whitespace-pre-wrap">${escapeHtml(JSON.stringify(docSnap.data(), null, 2))}</pre>`;
                } else {
                    fsEl.innerHTML = '<p class="text-slate-500">No Firestore doc found for this node.</p>';
                }

                logToConsole('INFO', `Loaded database for node: ${nodeId}`);
            } catch (e) {
                console.error(e);
                rtdbEl.innerHTML = `<p class="text-red-400">Error: ${escapeHtml(e.message)}</p>`;
                fsEl.innerHTML = `<p class="text-red-400">Error: ${escapeHtml(e.message)}</p>`;
            }
        };

        window.refreshDatabase = () => loadNodeDatabase();

        window.verifyAllPasswords = async () => {
            logToConsole('SYSTEM', 'Starting password verification across all nodes...');
            let issues = 0;
            for (const client of clientsData) {
                try {
                    const rtdbSnap = await get(ref(rtdb, `restaurants/${client.id}/admin/pin`));
                    const rtdbPin = rtdbSnap.exists() ? String(rtdbSnap.val()).trim() : null;
                    const fsPass = client.password ? String(client.password).trim() : null;

                    if (rtdbPin !== fsPass) {
                        logToConsole('WARN', `Password mismatch for ${client.name}: RTDB="${rtdbPin}" vs FS="${fsPass}"`);
                        issues++;
                    } else {
                        logToConsole('OK', `${client.name}: Password synced ✓`);
                    }
                } catch (e) {
                    logToConsole('ERROR', `Failed to check ${client.name}: ${e.message}`);
                }
            }
            logToConsole('SYSTEM', `Password verification complete. ${issues} issues found.`);
            showToast(issues > 0 ? `Found ${issues} password mismatches!` : 'All passwords verified!', issues > 0 ? 'error' : 'success');
        };

        window.syncAllWallets = async () => {
            logToConsole('SYSTEM', 'Syncing wallet balances between Firestore and RTDB...');
            for (const client of clientsData) {
                try {
                    const fsBalance = Number(client.walletBalance || 0);
                    await set(ref(rtdb, `restaurants/${client.id}/admin/walletBalance`), fsBalance);
                    logToConsole('OK', `${client.name}: Wallet synced to ₹${fsBalance}`);
                } catch (e) {
                    logToConsole('ERROR', `Failed to sync ${client.name}: ${e.message}`);
                }
            }
            logToConsole('SYSTEM', 'Wallet sync complete.');
            showToast('All wallets synced!', 'success');
        };

        window.cleanupOrphanData = async () => {
            logToConsole('SYSTEM', '🧹 Starting orphan data cleanup scan...');
            
            // Known orphan root collections that should NOT exist (old global paths)
            const orphanCollections = ['menu', 'addons', 'orders', 'site_cards', 'security_violations', 'wallet_transactions'];
            let foundOrphans = [];
            
            logToConsole('INFO', 'Scanning for orphan root-level collections...');
            
            for (const collName of orphanCollections) {
                try {
                    const snapshot = await getDocs(collection(db, collName));
                    if (!snapshot.empty) {
                        foundOrphans.push({ name: collName, count: snapshot.size, docs: snapshot.docs });
                        logToConsole('WARN', `⚠️ Found orphan collection: "${collName}" with ${snapshot.size} documents`);
                    }
                } catch (e) {
                    // Collection doesn't exist or no permission - that's good
                    logToConsole('OK', `✅ No orphan collection: "${collName}"`);
                }
            }
            
            if (foundOrphans.length === 0) {
                logToConsole('OK', '🎉 No orphan data found! Database is clean.');
                showToast('Database is clean - no orphans found!', 'success');
                return;
            }
            
            // Show what was found
            const orphanSummary = foundOrphans.map(o => `${o.name} (${o.count} docs)`).join(', ');
            logToConsole('WARN', `Found ${foundOrphans.length} orphan collections: ${orphanSummary}`);
            
            // Ask user what to do
            const action = prompt(
                `⚠️ ORPHAN DATA FOUND!\n\n` +
                `These ROOT-LEVEL collections should NOT exist:\n` +
                foundOrphans.map(o => `• ${o.name}: ${o.count} documents`).join('\n') +
                `\n\nThis is OLD data from before multi-tenant refactor.\n` +
                `Correct data should be under restaurants/{cafeId}/...\n\n` +
                `What would you like to do?\n` +
                `Type "DELETE" to permanently delete this data\n` +
                `Type a cafe ID (e.g. "wow123") to MIGRATE data to that cafe\n` +
                `Or press Cancel to abort`
            );
            
            if (!action) {
                logToConsole('INFO', 'Cleanup cancelled by user.');
                showToast('Cleanup cancelled', 'info');
                return;
            }
            
            if (action.toUpperCase() === 'DELETE') {
                // Delete orphan collections
                logToConsole('SYSTEM', '🗑️ Deleting orphan collections...');
                let deletedCount = 0;
                
                for (const orphan of foundOrphans) {
                    try {
                        for (const docSnap of orphan.docs) {
                            await deleteDoc(docSnap.ref);
                            deletedCount++;
                        }
                        logToConsole('OK', `✅ Deleted ${orphan.count} docs from "${orphan.name}"`);
                    } catch (e) {
                        logToConsole('ERROR', `❌ Failed to delete "${orphan.name}": ${e.message}`);
                    }
                }
                
                logToConsole('OK', `🎉 Cleanup complete! Deleted ${deletedCount} orphan documents.`);
                showToast(`Cleanup complete! Deleted ${deletedCount} documents.`, 'success');
            } else {
                // Migrate to specified cafe
                const targetCafeId = action.trim();
                const cafeExists = clientsData.find(c => c.id === targetCafeId);
                
                if (!cafeExists) {
                    logToConsole('ERROR', `Cafe "${targetCafeId}" not found! Aborting.`);
                    showToast(`Cafe "${targetCafeId}" not found!`, 'error');
                    return;
                }
                
                logToConsole('SYSTEM', `📦 Migrating orphan data to cafe: ${cafeExists.name} (${targetCafeId})`);
                let migratedCount = 0;
                
                for (const orphan of foundOrphans) {
                    try {
                        for (const docSnap of orphan.docs) {
                            const data = docSnap.data();
                            // Copy to proper subcollection under cafe
                            await setDoc(doc(db, 'restaurants', targetCafeId, orphan.name, docSnap.id), data);
                            // Delete from root
                            await deleteDoc(docSnap.ref);
                            migratedCount++;
                        }
                        logToConsole('OK', `✅ Migrated ${orphan.count} docs from "${orphan.name}" to restaurants/${targetCafeId}/${orphan.name}`);
                    } catch (e) {
                        logToConsole('ERROR', `❌ Failed to migrate "${orphan.name}": ${e.message}`);
                    }
                }
                
                logToConsole('OK', `🎉 Migration complete! Moved ${migratedCount} documents to cafe: ${targetCafeId}`);
                showToast(`Migrated ${migratedCount} documents to ${cafeExists.name}!`, 'success');
            }
        };

        window.verifyDataIsolation = async () => {
            logToConsole('SYSTEM', '🔒 Verifying multi-tenant data isolation...');
            
            const subcollections = ['menu', 'addons', 'orders', 'site_cards', 'wallet_transactions', 'security_violations'];
            let report = [];
            
            for (const client of clientsData) {
                const cafeReport = { id: client.id, name: client.name, collections: {} };
                logToConsole('INFO', `📊 Scanning node: ${client.name} (${client.id})`);
                
                for (const subColl of subcollections) {
                    try {
                        const snapshot = await getDocs(collection(db, 'restaurants', client.id, subColl));
                        cafeReport.collections[subColl] = snapshot.size;
                        if (snapshot.size > 0) {
                            logToConsole('OK', `  ✅ ${subColl}: ${snapshot.size} documents`);
                        }
                    } catch (e) {
                        cafeReport.collections[subColl] = 0;
                    }
                }
                
                // Also check RTDB
                try {
                    const rtdbSnap = await get(ref(rtdb, `restaurants/${client.id}`));
                    cafeReport.rtdbExists = rtdbSnap.exists();
                    if (rtdbSnap.exists()) {
                        const data = rtdbSnap.val();
                        cafeReport.rtdbKeys = Object.keys(data || {});
                        logToConsole('OK', `  ✅ RTDB: ${cafeReport.rtdbKeys.join(', ') || 'empty'}`);
                    }
                } catch (e) {
                    cafeReport.rtdbExists = false;
                }
                
                report.push(cafeReport);
            }
            
            // Summary
            logToConsole('SYSTEM', '═══════════════════════════════════════');
            logToConsole('SYSTEM', '📋 DATA ISOLATION REPORT');
            logToConsole('SYSTEM', '═══════════════════════════════════════');
            logToConsole('INFO', `Total Cafes: ${report.length}`);
            
            for (const cafe of report) {
                const totalDocs = Object.values(cafe.collections).reduce((a, b) => a + b, 0);
                logToConsole('INFO', `☕ ${cafe.name} (${cafe.id}): ${totalDocs} total docs`);
            }
            
            logToConsole('OK', '═══════════════════════════════════════');
            logToConsole('OK', '✅ All data is properly isolated under restaurants/{cafeId}/...');
            logToConsole('INFO', 'Structure: restaurants/{cafeId}/menu, /addons, /orders, etc.');
            
            showToast('Data isolation verified!', 'success');
        };

        window.exportFullBackup = async () => {
            logToConsole('SYSTEM', 'Generating full backup...');
            const backup = { timestamp: new Date().toISOString(), nodes: {} };
            for (const client of clientsData) {
                try {
                    const rtdbSnap = await get(ref(rtdb, `restaurants/${client.id}`));
                    backup.nodes[client.id] = {
                        firestore: client,
                        rtdb: rtdbSnap.exists() ? rtdbSnap.val() : null
                    };
                } catch (e) {
                    backup.nodes[client.id] = { firestore: client, rtdb: null, error: e.message };
                }
            }
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wow-backup-${Date.now()}.json`;
            a.click();
            logToConsole('OK', 'Backup downloaded successfully.');
            showToast('Backup downloaded!', 'success');
        };

        // =====================
        // SYSTEM MONITOR
        // =====================
        function logToConsole(type, msg) {
            const console = document.getElementById('liveConsole');
            if (!console) return;
            const colors = { SYSTEM: 'text-green-500', INFO: 'text-blue-400', WARN: 'text-yellow-400', ERROR: 'text-red-400', OK: 'text-emerald-400' };
            const time = new Date().toLocaleTimeString();
            console.innerHTML += `<p class="${colors[type] || 'text-slate-400'}">[${time}] [${type}] ${escapeHtml(msg)}</p>`;
            console.scrollTop = console.scrollHeight;
        }

        function startMonitor() {
            if (monitorRunning) return;
            monitorRunning = true;
            document.getElementById('monitorToggle').innerHTML = '<i class="fas fa-pause mr-1"></i> Pause';
            document.getElementById('monitorStatus').innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> LIVE';
            document.getElementById('monitorStatus').className = 'flex items-center gap-2 text-xs text-green-400 bg-green-500/10 px-3 py-1.5 rounded-lg';

            logToConsole('SYSTEM', 'Monitor started.');

            monitorInterval = setInterval(async () => {
                // Update metrics
                const start = Date.now();
                try {
                    await get(ref(rtdb, '.info/connected'));
                    const latency = Date.now() - start;
                    document.getElementById('metricLatency').innerText = latency + 'ms';
                    document.getElementById('latencyBar').style.width = Math.min(latency, 200) / 2 + '%';
                } catch (e) {
                    document.getElementById('metricLatency').innerText = 'ERR';
                }

                document.getElementById('metricConnections').innerText = clientsData.length;

                if (performance.memory) {
                    const mem = Math.round(performance.memory.usedJSHeapSize / 1048576);
                    document.getElementById('metricMemory').innerText = mem + 'MB';
                    document.getElementById('memoryBar').style.width = Math.min(mem / 2, 100) + '%';
                } else {
                    document.getElementById('metricMemory').innerText = 'N/A';
                }
            }, 2000);
        }

        window.toggleMonitor = () => {
            if (monitorRunning) {
                clearInterval(monitorInterval);
                monitorRunning = false;
                document.getElementById('monitorToggle').innerHTML = '<i class="fas fa-play mr-1"></i> Resume';
                document.getElementById('monitorStatus').innerHTML = '<span class="w-2 h-2 rounded-full bg-yellow-500"></span> PAUSED';
                document.getElementById('monitorStatus').className = 'flex items-center gap-2 text-xs text-yellow-400 bg-yellow-500/10 px-3 py-1.5 rounded-lg';
                logToConsole('SYSTEM', 'Monitor paused.');
            } else {
                startMonitor();
            }
        };

        window.clearConsole = () => {
            document.getElementById('liveConsole').innerHTML = '<p class="text-green-500">[SYSTEM] Console cleared.</p>';
        };

        window.testFirebaseConnection = async () => {
            logToConsole('SYSTEM', 'Testing Firebase connection...');
            try {
                const start = Date.now();
                await get(ref(rtdb, '.info/connected'));
                const latency = Date.now() - start;
                logToConsole('OK', `RTDB connected. Latency: ${latency}ms`);

                const testDoc = await getDoc(doc(db, 'restaurants', clientsData[0]?.id || 'test'));
                logToConsole('OK', `Firestore accessible. Doc exists: ${testDoc.exists()}`);

                showToast('Firebase connection OK!', 'success');
            } catch (e) {
                logToConsole('ERROR', `Connection test failed: ${e.message}`);
                showToast('Connection test failed!', 'error');
            }
        };

        window.debugPasswordFlow = async () => {
            logToConsole('SYSTEM', '=== PASSWORD DEBUG START ===');
            for (const client of clientsData.slice(0, 3)) {
                logToConsole('INFO', `Checking ${client.name} (${client.id})...`);
                try {
                    const rtdbSnap = await get(ref(rtdb, `restaurants/${client.id}/admin/pin`));
                    const rtdbPin = rtdbSnap.exists() ? rtdbSnap.val() : 'NOT SET';
                    const fsPass = client.password || 'NOT SET';
                    logToConsole('INFO', `  RTDB admin/pin: "${rtdbPin}"`);
                    logToConsole('INFO', `  Firestore password: "${fsPass}"`);
                    logToConsole(rtdbPin === fsPass ? 'OK' : 'WARN', `  Match: ${rtdbPin === fsPass}`);
                } catch (e) {
                    logToConsole('ERROR', `  Error: ${e.message}`);
                }
            }
            logToConsole('SYSTEM', '=== PASSWORD DEBUG END ===');
        };

        window.checkAllPaths = () => {
            logToConsole('SYSTEM', 'Firebase paths used in this ecosystem:');
            logToConsole('INFO', 'Firestore: restaurants/{id} (tenant registry)');
            logToConsole('INFO', 'Firestore: restaurants/{id}/menu (menu items)');
            logToConsole('INFO', 'Firestore: restaurants/{id}/orders (order history)');
            logToConsole('INFO', 'Firestore: restaurants/{id}/addons (universal addons)');
            logToConsole('INFO', 'RTDB: restaurants/{id}/orders (live orders)');
            logToConsole('INFO', 'RTDB: restaurants/{id}/appStatus (app lock)');
            logToConsole('INFO', 'RTDB: restaurants/{id}/admin/pin (login password)');
            logToConsole('INFO', 'RTDB: restaurants/{id}/admin/walletBalance (wallet)');
            logToConsole('INFO', 'RTDB: restaurants/{id}/admin/settings (owner info)');
            logToConsole('OK', 'All paths documented.');
        };

        window.simulateOrder = async () => {
            const nodeId = clientsData[0]?.id;
            if (!nodeId) return showToast('No node available for test', 'error');
            logToConsole('SYSTEM', `Simulating test order for ${nodeId}...`);
            try {
                const testOrder = {
                    orderId: 'TEST-' + Date.now(),
                    customerName: 'Test Customer',
                    items: [{ name: 'Test Item', quantity: 1, price: 100 }],
                    totalAmount: 100,
                    status: 'pending',
                    timestamp: Date.now(),
                    orderType: 'Dine-in'
                };
                await set(ref(rtdb, `restaurants/${nodeId}/orders/test-${Date.now()}`), testOrder);
                logToConsole('OK', 'Test order created successfully!');
                showToast('Test order created!', 'success');
            } catch (e) {
                logToConsole('ERROR', `Failed: ${e.message}`);
                showToast('Failed to create test order', 'error');
            }
        };

        window.runFullDiagnostics = async () => {
            logToConsole('SYSTEM', '========== FULL DIAGNOSTICS ==========');
            await testFirebaseConnection();
            await debugPasswordFlow();
            checkAllPaths();
            logToConsole('SYSTEM', '========== DIAGNOSTICS COMPLETE ==========');
            showToast('Diagnostics complete. Check console.', 'success');
        };
    </script>
</body>

</html>