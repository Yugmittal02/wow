<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Wow Cafe | Premium App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f3f4f6; 
            min-height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            -webkit-tap-highlight-color: transparent; 
        }
        .font-mono { font-family: 'Space Mono', monospace; }
        
        .mobile-frame {
            width: 100%;
            max-width: 420px; 
            height: 90vh;
            max-height: 850px;
            background: #fff7ed;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border-radius: 2.5rem; 
            overflow: hidden; 
            border: 8px solid #fff; 
            display: flex;
            flex-direction: column;
        }

        @media (max-width: 480px) {
            body { 
                background-color: #fff7ed; 
                display: block; 
                height: 100vh;
                overflow-x: hidden;
            }
            .mobile-frame {
                max-width: 100%;
                height: 100%; 
                max-height: none;
                border-radius: 0;
                border: none;
                box-shadow: none;
                position: fixed; 
                top: 0; left: 0; right: 0; bottom: 0;
            }
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        
        @keyframes printReceipt { 
            0% { transform: scale(0.9); opacity: 0; } 
            100% { transform: scale(1); opacity: 1; } 
        }

        .slide-up { animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .pop-in { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .print-anim { animation: printReceipt 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

        .zigzag-orange {
            background: linear-gradient(-45deg, transparent 5px, #f97316 5px) 0 5px,
                        linear-gradient(45deg, transparent 5px, #f97316 5px) 0 5px;
            background-repeat: repeat-x;
            background-size: 10px 10px;
            height: 10px;
            width: 100%;
        }

        .emoji-bg {
            background-image: radial-gradient(#fdba74 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .glass-header {
            background: rgba(255, 247, 237, 0.9);
            backdrop-filter: blur(10px);
        }

        .explore-btn.active {
            background-color: #ffedd5;
            border-color: #f97316;
            transform: scale(0.95);
        }

        .toast-center {
            top: 50% !important;
            transform: translateY(-50%) !important;
            margin-top: 0 !important;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3) !important;
            border-radius: 16px !important;
            font-weight: bold !important;
            text-align: center !important;
            padding: 16px 24px !important;
        }

        .custom-radio:checked + label {
            background-color: #fff7ed;
            border-color: #f97316;
            color: #c2410c;
            box-shadow: 0 4px 6px -1px rgba(249, 115, 22, 0.1);
        }
        
        .center-modal {
            display: flex;
            align-items: center; 
            justify-content: center;
        }

        .love-btn {
            background: #fff;
            border: 1px solid #e5e7eb;
            color: #6b7280;
            transition: all 0.3s;
        }
        .love-btn.active {
            background: #ec4899;
            border-color: #ec4899;
            color: white;
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
            transform: scale(0.98);
        }
        
        .donation-btn.active {
            background-color: #f97316;
            color: white;
            border-color: #f97316;
            transform: scale(0.95);
        }

        .donation-section {
            background: linear-gradient(135deg, #fff1f2 0%, #fff7ed 100%);
            border: 1px solid #fecdd3;
        }
        
        .star-rating {
            display: flex;
            justify-content: center;
            gap: 12px;
        }
        .star-rating i {
            transition: all 0.2s;
            cursor: pointer;
            opacity: 0;
            transform: scale(0);
        }
        .star-rating i.visible {
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        .star-rating i:hover, .star-rating i.hovered {
            transform: scale(1.3) !important;
            color: #fbbf24;
        }
    </style>
</head>
<body>

<div class="mobile-frame bg-orange-50 emoji-bg" id="app-frame">

    <div id="splash-screen" class="absolute inset-0 z-[100] bg-gradient-to-br from-orange-600 to-amber-500 flex flex-col items-center justify-center text-white h-full w-full">
        <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center mb-4 shadow-xl animate-bounce">
            <i class="fas fa-utensils text-5xl text-orange-600"></i>
        </div>
        <h1 class="text-5xl font-extrabold tracking-tighter drop-shadow-md">Wow<span class="text-yellow-200">Cafe</span></h1>
        <p class="text-sm font-medium tracking-[0.3em] mt-2 uppercase opacity-90">Delicious Moments</p>
    </div>

    <div id="login-modal" class="absolute inset-0 z-[90] bg-black/60 hidden items-end sm:items-center justify-center backdrop-blur-sm p-0 sm:p-4">
        <div class="bg-white w-full sm:max-w-xs h-auto p-8 rounded-t-[2.5rem] sm:rounded-[2.5rem] shadow-2xl slide-up relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-orange-400 to-red-500"></div>
            <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mb-4 mx-auto text-3xl">ðŸ‘‹</div>
            <h2 class="text-3xl font-extrabold text-gray-900 mb-2 text-center">Let's Eat!</h2>
            <p class="text-gray-500 text-sm mb-8 text-center">Tell us your name to start.</p>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase ml-2">Your Name</label>
                    <input type="text" id="user-name" class="w-full bg-gray-50 border border-gray-200 rounded-2xl px-5 py-4 font-bold text-lg focus:ring-2 focus:ring-orange-500 outline-none text-gray-800" placeholder="e.g. Rahul">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase ml-2">Phone Number</label>
                    <input type="tel" id="user-phone" class="w-full bg-gray-50 border border-gray-200 rounded-2xl px-5 py-4 font-bold text-lg focus:ring-2 focus:ring-orange-500 outline-none text-gray-800" placeholder="9876543210" maxlength="10">
                </div>
                <button onclick="saveUser()" class="w-full bg-gradient-to-r from-orange-600 to-amber-500 text-white font-bold text-lg py-4 rounded-2xl shadow-xl shadow-orange-200 active:scale-95 transition-transform mt-4">
                    Enter Cafe <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="offer-success-modal" class="absolute inset-0 z-[140] bg-black/80 hidden items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl relative pop-in text-center border-4 border-green-400">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg animate-bounce">
                <i class="fas fa-gift text-4xl text-green-600"></i>
            </div>
            <h2 class="text-2xl font-black text-gray-800 mb-1">Woohoo! ðŸŽ‰</h2>
            <p class="text-sm text-gray-500 font-bold mb-4" id="offer-success-name">Coupon Applied</p>
            <div class="bg-green-50 border border-green-200 rounded-xl p-4 mb-6">
                <p class="text-xs text-green-600 uppercase tracking-wider font-bold mb-1">You Saved</p>
                <p class="text-4xl font-black text-green-700 tracking-tight">â‚¹<span id="offer-saved-amount">0</span></p>
            </div>
            <button onclick="closeOfferSuccessModal()" class="w-full bg-green-600 text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-green-700 transition-all active:scale-95">
                Awesome!
            </button>
        </div>
    </div>

    <div id="main-app" class="flex-1 h-full overflow-y-auto hide-scrollbar opacity-0 transition-opacity duration-500 pb-24 relative">
        
        <header class="sticky top-0 z-40 glass-header border-b border-orange-100/50 pb-3 pt-4 sm:pt-4">
            <div class="px-5 py-2 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-black text-gray-800 tracking-tight">Wow<span class="text-orange-600">Cafe</span></h1>
                    <div class="flex items-center gap-1.5 mt-0.5">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <p class="text-xs font-bold text-gray-500 uppercase tracking-wide">Hi, <span id="display-name" class="text-gray-900 font-extrabold text-sm border-b-2 border-orange-200">Guest</span></p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleNotif()" class="w-10 h-10 bg-white shadow-sm border border-orange-100 rounded-full flex items-center justify-center text-gray-600 hover:bg-orange-50 hover:text-orange-600 transition-colors relative">
                        <i class="fas fa-receipt"></i>
                        <span id="notif-dot" class="absolute top-2 right-2.5 w-2 h-2 bg-red-500 rounded-full border border-white animate-pulse hidden"></span>
                    </button>
                </div>
            </div>

            <div class="px-5">
                <div class="relative group">
                    <i class="fas fa-search absolute left-4 top-3.5 text-gray-400 group-focus-within:text-orange-500 transition-colors"></i>
                    <input type="text" oninput="filterMenu(this.value)" placeholder="Search 'Pizza'..." class="w-full bg-white border border-orange-100 rounded-2xl pl-11 pr-4 py-3 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-orange-500/20 shadow-sm transition-all">
                </div>
            </div>
        </header>

        <div class="px-5 mt-4">
            <div class="flex justify-between items-end mb-3">
                <h3 class="font-bold text-gray-800 text-lg">Crazy Offers ðŸŽ‰</h3>
            </div>
            <div id="banner-container" class="flex overflow-x-auto gap-4 hide-scrollbar snap-x scroll-smooth pb-4 min-h-[140px]">
                 <div class="w-full text-center text-xs text-gray-400 py-10">Loading Offers...</div>
            </div>
        </div>

        <div class="px-5 mt-0">
            <h3 class="font-bold text-gray-800 text-lg mb-3">Explore Menu</h3>
            <div class="flex overflow-x-auto gap-3 hide-scrollbar pb-2">
                <div onclick="filterByExplore('All')" class="explore-btn active flex-shrink-0 w-20 h-24 bg-gray-800 rounded-xl flex flex-col items-center justify-center gap-1 border border-gray-600 cursor-pointer transition-all active:scale-95 shadow-sm" id="exp-all">
                    <span class="text-2xl">ðŸ½ï¸</span><span class="text-[10px] font-bold text-white">All Menu</span>
                </div>
                <div onclick="filterByExplore('Pizza')" class="explore-btn flex-shrink-0 w-20 h-24 bg-red-50 rounded-xl flex flex-col items-center justify-center gap-1 border border-red-100 cursor-pointer transition-all active:scale-95 hover:bg-red-100" id="exp-pizza">
                    <span class="text-2xl">ðŸ•</span><span class="text-[10px] font-bold text-red-800">Pizza</span>
                </div>
                <div onclick="filterByExplore('Burger')" class="explore-btn flex-shrink-0 w-20 h-24 bg-yellow-50 rounded-xl flex flex-col items-center justify-center gap-1 border border-yellow-100 cursor-pointer transition-all active:scale-95 hover:bg-yellow-100" id="exp-burger">
                    <span class="text-2xl">ðŸ”</span><span class="text-[10px] font-bold text-yellow-800">Burger</span>
                </div>
                <div onclick="filterByExplore('Sandwich')" class="explore-btn flex-shrink-0 w-20 h-24 bg-green-50 rounded-xl flex flex-col items-center justify-center gap-1 border border-green-100 cursor-pointer transition-all active:scale-95 hover:bg-green-100" id="exp-sandwich">
                    <span class="text-2xl">ðŸ¥ª</span><span class="text-[10px] font-bold text-green-800">Sandwich</span>
                </div>
                 <div onclick="filterByExplore('Pasta')" class="explore-btn flex-shrink-0 w-20 h-24 bg-orange-50 rounded-xl flex flex-col items-center justify-center gap-1 border border-orange-100 cursor-pointer transition-all active:scale-95 hover:bg-orange-100" id="exp-pasta">
                    <span class="text-2xl">ðŸ</span><span class="text-[10px] font-bold text-orange-800">Pasta</span>
                </div>
                 <div onclick="filterByExplore('Drinks')" class="explore-btn flex-shrink-0 w-20 h-24 bg-blue-50 rounded-xl flex flex-col items-center justify-center gap-1 border border-blue-100 cursor-pointer transition-all active:scale-95 hover:bg-blue-100" id="exp-drinks">
                    <span class="text-2xl">ðŸ¥¤</span><span class="text-[10px] font-bold text-blue-800">Drinks</span>
                </div>
                <div onclick="filterByExplore('Dessert')" class="explore-btn flex-shrink-0 w-20 h-24 bg-pink-50 rounded-xl flex flex-col items-center justify-center gap-1 border border-pink-100 cursor-pointer transition-all active:scale-95 hover:bg-pink-100" id="exp-dessert">
                    <span class="text-2xl">ðŸ§</span><span class="text-[10px] font-bold text-pink-800">Dessert</span>
                </div>
            </div>
        </div>

        <div class="px-5 mt-4 pb-10">
            <h3 class="font-bold text-gray-800 text-lg mb-4 flex items-center gap-2">Items <span class="text-[10px] bg-orange-100 text-orange-800 px-2 py-0.5 rounded-full" id="menu-count">Loading...</span></h3>
            <div id="menu-container" class="grid grid-cols-1 gap-5">
                <p class="text-center text-gray-400 text-sm">Waiting for Admin to add items...</p>
            </div>
            
            <div class="pb-10 pt-10 text-center w-full">
                <div class="grid grid-cols-3 gap-0 text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-4 border-t border-orange-100/50 pt-6 w-full">
                    <span onclick="openInfoModal('Policy')" class="cursor-pointer hover:text-orange-600 transition-colors py-2">Policy</span>
                    <span onclick="openInfoModal('Contact')" class="cursor-pointer hover:text-orange-600 transition-colors py-2 border-x border-gray-200">Contact</span>
                    <span onclick="openInfoModal('Help')" class="cursor-pointer hover:text-orange-600 transition-colors py-2">Help</span>
                </div>
                <div onclick="handleBrandingClick()" class="flex items-center justify-center gap-1.5 opacity-60 hover:opacity-100 transition-opacity cursor-pointer">
                    <span class="text-[10px] text-gray-400 font-medium">Powered by</span>
                    <span class="font-black text-xs text-gray-700 tracking-tight flex items-center gap-0.5">
                        Automation<span class="text-orange-600 text-sm">X</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="absolute inset-0 z-[150] bg-black/80 hidden center-modal backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-xs rounded-[2rem] p-6 slide-up relative shadow-2xl">
            <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-3">
                <h3 class="text-xl font-bold text-gray-800">Customize It! ðŸŽ¨</h3>
                <button onclick="closeCustomModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center hover:bg-red-50 hover:text-red-500 transition-colors"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="space-y-5 overflow-y-auto max-h-[50vh] pb-4 hide-scrollbar" id="custom-options">
            </div>

            <div class="pt-4 border-t border-gray-100">
                <button onclick="confirmCustomization()" class="w-full bg-orange-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-orange-200 active:scale-95 transition-transform flex justify-between px-6">
                    <span>Add Item</span>
                    <span id="custom-price-display"></span>
                </button>
            </div>
        </div>
    </div>

    <div id="cart-bar" onclick="openCheckout()" class="absolute bottom-6 left-5 right-5 max-w-[380px] mx-auto bg-gradient-to-r from-orange-600 to-red-600 text-white p-4 rounded-2xl shadow-2xl shadow-orange-400/50 flex justify-between items-center z-40 transform translate-y-40 transition-transform duration-500 cursor-pointer ring-4 ring-white/50">
        <div class="flex items-center gap-4">
            <div class="bg-white/20 backdrop-blur-md w-10 h-10 rounded-full flex items-center justify-center font-bold text-white border border-white/30" id="cart-count">0</div>
            <div class="flex flex-col">
                <span class="text-xs font-medium text-orange-100 opacity-80 uppercase tracking-wide">Total</span>
                <span class="text-xl font-bold leading-none">â‚¹<span id="cart-total">0</span></span>
            </div>
        </div>
        <div class="bg-white text-orange-600 px-5 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 shadow-lg hover:bg-orange-50 transition-colors">
            View Cart <i class="fas fa-shopping-bag"></i>
        </div>
    </div>

    <div id="checkout-sheet" class="absolute inset-0 z-[50] hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity opacity-0" id="checkout-bg" onclick="closeCheckout()"></div>
        <div class="absolute bottom-0 left-0 right-0 w-full bg-orange-50 rounded-t-[2rem] h-[92%] flex flex-col transform translate-y-full transition-transform duration-300 border-t-8 border-orange-500" id="checkout-panel">
            
            <div class="bg-white px-6 py-4 rounded-t-[1.5rem] shadow-sm flex justify-between items-center z-10 border-b border-orange-100">
                <h2 class="text-xl font-bold flex items-center gap-2 text-orange-900">ðŸ½ï¸ Your Tray</h2>
                <button onclick="closeCheckout()" class="w-8 h-8 rounded-full bg-orange-50 flex items-center justify-center text-orange-600 hover:bg-orange-100"><i class="fas fa-times"></i></button>
            </div>

            <div class="flex-1 overflow-y-auto hide-scrollbar pb-32 relative">
                <div class="mx-5 mt-5 bg-orange-100 p-1 rounded-xl flex relative">
                    <button onclick="setOrderType('Dine-in')" id="btn-dine" class="flex-1 py-2.5 rounded-lg text-sm font-bold text-center transition-all bg-white text-orange-900 shadow-sm border border-orange-200">Dine-in</button>
                    <button onclick="setOrderType('Takeaway')" id="btn-take" class="flex-1 py-2.5 rounded-lg text-sm font-bold text-center transition-all text-orange-700 hover:bg-white/50">Takeaway</button>
                </div>

                <div class="p-5 m-5 rounded-none border-b-2 border-dashed border-gray-300 relative">
                      <div class="absolute left-0 top-0 bottom-0 w-[2px] bg-red-200 ml-4"></div>
                      <div class="flex items-center gap-3 mb-4 pl-6">
                        <div class="w-10 h-10 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center font-bold text-lg"><i class="fas fa-clipboard-list"></i></div>
                        <div>
                            <h3 class="font-bold text-gray-800" id="order-type-label">Dine-in Order</h3>
                            <p class="text-xs text-gray-500 font-mono" id="customer-info-bill">--</p>
                        </div>
                    </div>
                    <div id="bill-items" class="space-y-4 pl-6"></div>
                </div>

                <div class="mx-5 mb-4 donation-section p-4 rounded-2xl shadow-sm">
                    <h4 class="text-xs font-bold text-red-500 uppercase tracking-wide mb-2 flex items-center gap-2"><i class="fas fa-hand-holding-heart"></i> Support & Donate â¤ï¸</h4>
                    <div class="flex gap-2 mb-3">
                        <button onclick="setDonation(5, this)" class="donation-btn flex-1 py-2 border border-red-200 rounded-lg text-sm font-bold text-red-600 bg-white transition-all hover:bg-red-50">â‚¹5</button>
                        <button onclick="setDonation(10, this)" class="donation-btn flex-1 py-2 border border-red-200 rounded-lg text-sm font-bold text-red-600 bg-white transition-all hover:bg-red-50">â‚¹10</button>
                        <button onclick="setDonation(50, this)" class="donation-btn flex-1 py-2 border border-red-200 rounded-lg text-sm font-bold text-red-600 bg-white transition-all hover:bg-red-50">â‚¹50</button>
                    </div>
                    
                    <button id="love-btn-toggle" onclick="toggleLoveDonation()" class="love-btn w-full py-3 rounded-xl flex items-center justify-center gap-2 font-bold text-sm text-pink-600 border-pink-200">
                        <i class="fas fa-heart animate-pulse"></i> Donate â‚¹10 & Spread Love
                    </button>
                </div>

                <div class="mx-5 mb-2">
                    <div class="bg-white border border-gray-200 rounded-xl p-2 flex gap-2 mb-3 shadow-sm">
                        <input type="text" id="manual-coupon-code" placeholder="Enter Coupon Code" 
                               class="flex-1 bg-transparent outline-none text-sm font-bold text-gray-700 px-2 uppercase">
                        <button onclick="applyManualCoupon()" 
                                class="bg-orange-600 text-white text-xs font-bold px-4 py-2 rounded-lg hover:bg-orange-700 transition">
                            APPLY
                        </button>
                    </div>

                    <button onclick="toggleOffers()" class="w-full bg-amber-50 border border-amber-200 border-dashed rounded-xl p-3 flex justify-between items-center text-sm font-bold text-amber-800 hover:bg-amber-100 transition-colors">
                        <span class="flex items-center gap-2"><i class="fas fa-ticket-alt text-amber-600"></i> View Available Offers</span>
                        <i class="fas fa-chevron-down text-amber-400 transition-transform" id="offer-arrow"></i>
                    </button>
                    <div id="offers-dropdown" class="hidden mt-3 space-y-3 transition-all"></div>
                </div>

                <div class="bg-white p-5 mx-5 rounded-2xl shadow-sm border border-gray-100 mb-6 relative overflow-hidden mt-4">
                    <div class="zigzag absolute top-0 left-0 w-full opacity-30"></div>
                    <h3 class="font-bold text-gray-800 mb-3 pt-2">Bill Details</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between text-gray-600"><span>Item Total</span><span>â‚¹<span id="summary-total">0.00</span></span></div>
                        <div class="flex justify-between text-gray-500 text-[11px]"><span>Tax (5%)</span><span>â‚¹<span id="summary-tax">0.00</span></span></div>
                        <div class="flex justify-between text-gray-500 text-[11px]"><span>Platform Fee</span><span>â‚¹0.98</span></div>
                        <div class="flex justify-between text-red-500 text-[11px] font-bold"><span>Donation</span><span>â‚¹<span id="summary-donation">0</span></span></div>
                        <div id="discount-row" class="flex justify-between text-green-600 font-medium hidden"><span>Discount</span><span>- â‚¹<span id="summary-discount">0</span></span></div>
                        <div class="flex justify-between text-xl font-extrabold text-gray-900 mt-3 pt-3 border-t border-dashed border-gray-300">
                            <span>To Pay</span><span>â‚¹<span id="summary-grand">0.00</span></span>
                        </div>
                    </div>
                    <div class="zigzag absolute bottom-0 left-0 w-full rotate-180 opacity-30"></div>
                </div>
            </div>

            <div class="absolute bottom-0 left-0 right-0 bg-white p-4 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] z-20 rounded-t-2xl">
                <button onclick="openPaymentModal()" class="w-full bg-gradient-to-r from-orange-600 to-red-600 text-white font-bold text-lg py-4 rounded-2xl shadow-lg shadow-orange-200 active:scale-[0.98] transition-all flex justify-between px-6 items-center">
                    <span class="text-sm opacity-90 flex flex-col items-start leading-tight">
                        <span class="text-xs text-orange-100 font-normal">TOTAL PAYABLE</span>
                        â‚¹<span id="btn-pay-amt">0.00</span>
                    </span>
                    <span>Proceed to Pay <i class="fas fa-angle-right ml-2"></i></span>
                </button>
            </div>
        </div>
    </div>

    <div id="payment-modal" class="absolute inset-0 z-[60] hidden center-modal">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closePaymentModal()"></div>
        <div class="w-full sm:max-w-md bg-orange-50 rounded-[2rem] p-6 relative transform transition-all scale-100 mx-4 max-h-[90vh] overflow-y-auto" id="payment-panel">
            <button onclick="closePaymentModal()" class="absolute top-4 right-4 w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center z-10"><i class="fas fa-times text-gray-600"></i></button>
            
            <!-- Payment Options View -->
            <div id="payment-options-view" class="text-center pt-2">
                <h2 class="text-2xl font-black mb-2 text-gray-800">Choose Payment</h2>
                <p class="text-sm text-gray-500 mb-6">Total Amount: <strong class="text-orange-600 text-xl">â‚¹<span id="pay-modal-amt">0.00</span></strong></p>
                
                <div class="space-y-4">
                    <!-- Pay Cash Button -->
                    <button id="btn-cash-pay" onclick="processOrder('Cash')" class="w-full bg-white border-2 border-green-500 p-5 rounded-2xl flex items-center justify-between hover:bg-green-50 transition-colors group shadow-lg shadow-green-100 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center text-white text-xl shadow-green-200 shadow-lg"><i class="fas fa-money-bill-wave"></i></div>
                            <div class="text-left">
                                <h3 class="font-black text-lg text-green-900 leading-tight">PAY CASH</h3>
                                <p class="text-xs text-green-700 font-bold uppercase tracking-wider mt-0.5">At Counter</p>
                            </div>
                        </div>
                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center"><i class="fas fa-chevron-right text-green-600"></i></div>
                    </button>
                    
                    <!-- Pay Online Button -->
                    <button id="btn-online-pay" onclick="showOnlinePaymentView()" class="w-full bg-white border-2 border-blue-500 p-5 rounded-2xl flex items-center justify-between hover:bg-blue-50 transition-colors group shadow-lg shadow-blue-100 active:scale-95">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white text-xl shadow-blue-200 shadow-lg"><i class="fas fa-qrcode"></i></div>
                            <div class="text-left">
                                <h3 class="font-black text-lg text-blue-900 leading-tight">PAY ONLINE</h3>
                                <p class="text-xs text-blue-700 font-bold uppercase tracking-wider mt-0.5">UPI / QR Code</p>
                            </div>
                        </div>
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center"><i class="fas fa-chevron-right text-blue-600"></i></div>
                    </button>
                </div>
                <p class="text-[10px] text-gray-400 mt-6 uppercase font-bold tracking-widest">Secure Payment System</p>
            </div>
            
            <!-- Online Payment View (QR Code) -->
            <div id="online-payment-view" class="hidden">
                <button onclick="backToPaymentOptions()" class="flex items-center gap-2 text-gray-600 font-bold text-sm mb-4 hover:text-orange-600">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                
                <div class="text-center">
                    <h2 class="text-xl font-black mb-1 text-gray-800">Scan & Pay</h2>
                    <p class="text-2xl font-black text-orange-600 mb-4">â‚¹<span id="qr-amount">0.00</span></p>
                    
                    <!-- QR Code Display -->
                    <div id="qr-code-container" class="bg-white p-4 rounded-2xl shadow-lg mb-4 inline-block">
                        <div id="qr-code-display" class="w-48 h-48 bg-gray-100 rounded-xl flex items-center justify-center mx-auto">
                            <i class="fas fa-qrcode text-5xl text-gray-300"></i>
                        </div>
                        <p id="qr-payment-name" class="text-sm font-bold text-gray-700 mt-2">Business Name</p>
                        <p id="qr-upi-id" class="text-xs text-gray-500">UPI ID</p>
                    </div>
                    
                    <p class="text-xs text-red-500 font-bold mb-4"><i class="fas fa-lock mr-1"></i> Amount is fixed and cannot be changed</p>
                    
                    <!-- UPI App Buttons -->
                    <div class="space-y-2 mb-4">
                        <p class="text-xs text-gray-500 font-bold uppercase">Or pay using UPI app</p>
                        <div class="grid grid-cols-4 gap-2">
                            <button onclick="openUPIApp('gpay')" class="flex flex-col items-center p-3 bg-white rounded-xl shadow hover:shadow-md transition-shadow active:scale-95">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f2/Google_Pay_Logo.svg/512px-Google_Pay_Logo.svg.png" alt="GPay" class="w-8 h-8 object-contain mb-1">
                                <span class="text-[10px] font-bold text-gray-600">GPay</span>
                            </button>
                            <button onclick="openUPIApp('phonepe')" class="flex flex-col items-center p-3 bg-white rounded-xl shadow hover:shadow-md transition-shadow active:scale-95">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5f/PhonePe_Logo.png/480px-PhonePe_Logo.png" alt="PhonePe" class="w-8 h-8 object-contain mb-1">
                                <span class="text-[10px] font-bold text-gray-600">PhonePe</span>
                            </button>
                            <button onclick="openUPIApp('paytm')" class="flex flex-col items-center p-3 bg-white rounded-xl shadow hover:shadow-md transition-shadow active:scale-95">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/24/Paytm_Logo_%28standalone%29.svg/1280px-Paytm_Logo_%28standalone%29.svg.png" alt="Paytm" class="w-8 h-8 object-contain mb-1">
                                <span class="text-[10px] font-bold text-gray-600">Paytm</span>
                            </button>
                            <button onclick="openUPIApp('bhim')" class="flex flex-col items-center p-3 bg-white rounded-xl shadow hover:shadow-md transition-shadow active:scale-95">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e1/UPI-Logo-vector.svg/1200px-UPI-Logo-vector.svg.png" alt="BHIM" class="w-8 h-8 object-contain mb-1">
                                <span class="text-[10px] font-bold text-gray-600">BHIM</span>
                            </button>
                        </div>
                    </div>
                    
                    <button onclick="confirmOnlinePayment()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-transform">
                        <i class="fas fa-check-circle mr-2"></i> I've Paid - Confirm Order
                    </button>
                    
                    <p class="text-[10px] text-gray-400 mt-3">After payment, tap the button above to place your order</p>
                </div>
            </div>
        </div>
    </div>

    <div id="success-screen" class="absolute inset-0 z-[100] bg-gray-900/90 hidden flex-col items-center justify-center p-4 backdrop-blur-sm h-full w-full">
        <div class="bg-white w-full max-w-sm shadow-2xl relative print-anim overflow-hidden rounded-[2rem] flex flex-col items-center text-center">
            
            <div id="success-header" class="bg-orange-50 p-8 w-full border-b border-orange-100 relative flex flex-col items-center">
                <div class="zigzag-orange absolute bottom-0 left-0 w-full opacity-50"></div>
                <h1 class="text-3xl font-black text-gray-800 mb-1">Wow<span class="text-orange-600">Cafe</span></h1>
                
                <div id="success-icon" class="w-16 h-16 bg-orange-500 rounded-full flex items-center justify-center mb-2 mt-4 text-white text-2xl shadow-xl shadow-orange-200 animate-bounce">
                    <i class="fas fa-utensils"></i>
                </div>
                
                <h2 class="text-xl font-bold text-gray-800" id="success-title">Order Placed!</h2>
                <div id="payment-status-badge" class="mt-2 px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-bold border border-yellow-200 animate-pulse">
                    <i class="fas fa-clock mr-1"></i> Payment Pending
                </div>
            </div>

            <div class="p-6 relative w-full overflow-y-auto">
                
                <p class="text-gray-600 font-medium italic mb-4">"Thank you for ordering!"</p>

                <div class="text-center mb-6">
                    <h1 class="text-4xl font-extrabold text-gray-900">â‚¹<span id="final-amt">0.00</span></h1>
                    <p class="text-xs text-gray-400 uppercase tracking-wider font-bold mt-1" id="amount-label">To Pay at Counter</p>
                </div>

                <div class="space-y-3 mb-6 bg-gray-50 p-4 rounded-xl border border-gray-100">
                    <div class="flex justify-between text-sm border-b border-gray-200 pb-2">
                        <span class="text-gray-500">Customer</span>
                        <span class="font-bold text-gray-800" id="receipt-customer">--</span>
                    </div>
                    <div class="flex justify-between text-sm border-b border-gray-200 pb-2">
                        <span class="text-gray-500">Order Type</span>
                        <span class="font-bold text-gray-800" id="receipt-order-type">--</span>
                    </div>
                      <div class="flex justify-between text-sm border-b border-gray-200 pb-2">
                        <span class="text-gray-500">Unique ID</span>
                        <span class="font-mono font-bold text-orange-600 bg-orange-50 px-2 rounded" id="txn-id">--</span>
                    </div>
                      <div class="flex justify-between text-sm pb-2">
                        <span class="text-gray-500">Date & Time</span>
                        <div class="text-right">
                             <div class="font-bold text-gray-800 text-xs" id="receipt-date">--</div>
                             <div class="font-bold text-gray-800 text-xs" id="receipt-time">--</div>
                        </div>
                    </div>
                </div>

                <button onclick="resetApp()" id="btn-home" class="w-full bg-orange-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-orange-200 hover:bg-orange-700 transition-colors">
                    Back to Home
                </button>
            </div>
            
            <div class="zigzag absolute bottom-0 left-0 w-full"></div>
            
            <div id="rating-widget" class="absolute inset-0 bg-black/60 backdrop-blur-sm z-[110] hidden items-center justify-center p-4">
                <div class="bg-white rounded-3xl p-8 shadow-2xl text-center max-w-xs w-full pop-in">
                    <div class="w-16 h-16 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <i class="fas fa-star text-3xl text-white"></i>
                    </div>
                    <h3 class="font-bold text-gray-800 text-xl mb-2">Rate Your Experience ðŸŒŸ</h3>
                    <p class="text-sm text-gray-500 mb-4">How was your ordering experience?</p>
                    <div class="star-rating text-4xl text-gray-300 py-4">
                        <i class="fas fa-star" onclick="submitRating(1)"></i>
                        <i class="fas fa-star" onclick="submitRating(2)"></i>
                        <i class="fas fa-star" onclick="submitRating(3)"></i>
                        <i class="fas fa-star" onclick="submitRating(4)"></i>
                        <i class="fas fa-star" onclick="submitRating(5)"></i>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Tap a star to rate</p>
                </div>
            </div>

        </div>
    </div>
    
    <div id="notif-modal" class="absolute inset-0 z-[80] bg-black/60 hidden items-start justify-center backdrop-blur-sm pt-20" onclick="toggleNotif()">
        <div class="bg-white w-[90%] max-w-[380px] rounded-2xl shadow-2xl p-5 m-auto relative" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-3">
                <h3 class="font-bold text-lg">ðŸ”” Recent Bills</h3>
                <button onclick="toggleNotif()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div id="recent-orders-list" class="space-y-3 max-h-[300px] overflow-y-auto hide-scrollbar">
                <p class="text-sm text-gray-400 italic text-center py-4" id="empty-notif">No recent orders yet.</p>
            </div>
        </div>
    </div>

    <div id="bill-detail-modal" class="absolute inset-0 z-[90] bg-black/70 hidden items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-sm rounded-[2rem] overflow-hidden shadow-2xl relative slide-up max-h-[85vh] flex flex-col">
            <div class="bg-orange-50 p-6 border-b border-orange-100 text-center relative flex-shrink-0">
                <button onclick="closeBillDetail()" class="absolute top-4 right-4 w-8 h-8 bg-white/50 rounded-full flex items-center justify-center"><i class="fas fa-times text-gray-600"></i></button>
                <div class="zigzag-orange absolute bottom-0 left-0 w-full opacity-50"></div>
                <h1 class="text-2xl font-black text-gray-800">Wow<span class="text-orange-600">Cafe</span></h1>
                <div class="font-mono text-orange-600 font-bold bg-white inline-block px-3 py-1 rounded-lg mt-2 text-sm shadow-sm" id="hist-id">#ID</div>
                <div id="hist-payment-badge" class="mt-2 px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-bold border border-yellow-200 inline-block">
                    <i class="fas fa-clock mr-1"></i> Payment Pending
                </div>
            </div>
            
            <div class="p-5 overflow-y-auto flex-1 hide-scrollbar">
                <div class="space-y-2 mb-4 bg-gray-50 p-4 rounded-xl border border-gray-100">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Customer</span>
                        <span class="font-bold text-gray-800" id="hist-customer">--</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Order Type</span>
                        <span class="font-bold text-gray-800" id="hist-order-type">--</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Date & Time</span>
                        <span class="font-bold text-gray-800 text-xs" id="hist-date">--</span>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Order Items</h4>
                    <div class="space-y-2 bg-white border border-gray-100 rounded-xl p-3" id="hist-items"></div>
                </div>
                
                <div class="bg-gradient-to-r from-orange-50 to-amber-50 p-4 rounded-xl border border-orange-100">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600 font-bold">Total Amount</span>
                        <span class="text-2xl font-black text-orange-600">â‚¹<span id="hist-total">0</span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="info-modal" class="absolute inset-0 z-[110] bg-black/60 hidden items-center justify-center backdrop-blur-sm p-5">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl relative slide-up">
            <button onclick="closeInfoModal()" class="absolute top-4 right-4 w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center"><i class="fas fa-times"></i></button>
            <h2 class="text-xl font-bold text-gray-800 mb-4" id="info-title">Title</h2>
            <div class="text-sm text-gray-600 leading-relaxed space-y-2" id="info-content">
                </div>
        </div>
    </div>

</div>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getDatabase, ref, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, where, serverTimestamp as firestoreTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDSl6L3ym7G9wXJjZoCYGtU6oBuMyswMBA",
      authDomain: "gen-lang-client-0826078440.firebaseapp.com",
      databaseURL: "https://gen-lang-client-0826078440-default-rtdb.firebaseio.com", 
      projectId: "gen-lang-client-0826078440",
      storageBucket: "gen-lang-client-0826078440.firebasestorage.app",
      messagingSenderId: "198781436382",
      appId: "1:198781436382:web:041f1a6f57cc50dfa75d4f",
      measurementId: "G-XNB6HMBXN0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);        
    const dbFirestore = getFirestore(app);
    
    // Restaurant ID - Get from URL or default to 'Orderly'
    // Added 'id' parameter so Admin and Customer use the same ID
    const urlParams = new URLSearchParams(window.location.search);
    const RESTAURANT_ID = urlParams.get('id') || urlParams.get('r') || urlParams.get('restaurant') || 'Orderly';
    console.log('ðŸª Restaurant ID:', RESTAURANT_ID);

    window.rawMenuDocs = [];
    window.allAddons = {}; 
    window.currentDocId = null; // Store Firestore Document ID for rating
    window.customerSiteSettings = {}; // Store customer site settings (QR, UPI, etc.)
    
    // Load Customer Site Settings (QR Code, UPI ID, etc.)
    async function loadPaymentSettings() {
        try {
            const docSnap = await getDoc(doc(dbFirestore, "restaurants", RESTAURANT_ID, "settings", "customerSite"));
            if (docSnap.exists()) {
                window.customerSiteSettings = docSnap.data();
                
                // Update QR Display
                if (window.customerSiteSettings.qrImage) {
                    document.getElementById('qr-code-display').innerHTML = `
                        <img src="${window.customerSiteSettings.qrImage}" class="w-full h-full object-contain rounded-xl">
                    `;
                }
                
                // Update Payment Name and UPI ID
                if (window.customerSiteSettings.paymentName) {
                    document.getElementById('qr-payment-name').innerText = window.customerSiteSettings.paymentName;
                }
                if (window.customerSiteSettings.upiId) {
                    document.getElementById('qr-upi-id').innerText = window.customerSiteSettings.upiId;
                }
                
                // Update Brand Name if available
                if (window.customerSiteSettings.brandName) {
                    const brandEl = document.querySelector('.text-5xl.font-extrabold');
                    if (brandEl) {
                        brandEl.innerHTML = window.customerSiteSettings.brandName.replace(/(\w+)$/, '<span class="text-yellow-200">$1</span>');
                    }
                }
            }
        } catch (e) {
            console.error('Failed to load payment settings:', e);
        }
    }
    window.loadPaymentSettings = loadPaymentSettings;

    function processMenuData() {
        window.menuData = window.rawMenuDocs.map(item => {
            let finalAddons = [];
            if (item.linkedAddons && Array.isArray(item.linkedAddons)) {
                finalAddons = item.linkedAddons.map(id => {
                    const addonData = window.allAddons[id];
                    if (addonData) return { name: addonData.name, price: Number(addonData.price) };
                    return null;
                }).filter(Boolean);
            }
            else if (item.addons) {
                if (Array.isArray(item.addons)) finalAddons = item.addons;
                else if (typeof item.addons === 'object') finalAddons = Object.values(item.addons);
            }

            return {
                ...item,
                sizes: item.sizes, 
                addons: finalAddons
            };
        });

        document.getElementById('menu-count').innerText = `${window.menuData.length} Items`;
        if (window.filterByExplore) window.filterByExplore(window.currentCategory);
    }

    function initAddonsSync() {
        const addonRef = collection(dbFirestore, "restaurants", RESTAURANT_ID, "addons");
        onSnapshot(addonRef, (snapshot) => {
            window.allAddons = {};
            snapshot.forEach(doc => {
                const data = doc.data();
                window.allAddons[doc.id] = { name: data.name, price: data.price };
            });
            processMenuData();
        });
    }

    function initMenuSync() {
        const menuRef = collection(dbFirestore, "restaurants", RESTAURANT_ID, "menu");
        onSnapshot(menuRef, (snapshot) => {
            window.rawMenuDocs = [];
            snapshot.forEach(doc => {
                const item = doc.data();
                
                // Only show items that are available (available !== false)
                // If available is undefined or true, show the item
                if (item.available === false) {
                    console.log("ðŸš« Item hidden (unavailable):", item.name);
                    return; // Skip this item
                }
                
                let safeSizes = [];
                if (item.sizes) {
                    if (Array.isArray(item.sizes)) safeSizes = item.sizes;
                    else if (typeof item.sizes === 'object') safeSizes = Object.values(item.sizes);
                }
                
                safeSizes = safeSizes.map(s => ({
                    name: s.name,
                    price: Number(s.price) 
                }));

                window.rawMenuDocs.push({
                    id: doc.id,
                    name: item.name,
                    price: Number(item.price),
                    type: item.isVeg ? 'Veg' : 'Non-Veg', 
                    isVeg: item.isVeg, 
                    isBestseller: item.isBestseller || false, 
                    category: item.category,
                    desc: item.desc,
                    img: item.img || 'https://via.placeholder.com/150',
                    rating: 4.5,
                    linkedAddons: item.linkedAddons || [], 
                    addons: item.addons,
                    sizes: safeSizes
                });
            });
            processMenuData();
        });
    }

    function initOffersSync() {
        const cardsRef = collection(dbFirestore, "restaurants", RESTAURANT_ID, "site_cards");
        onSnapshot(cardsRef, (snapshot) => {
            window.offerList = [];
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                if(data.offerText && data.offerText !== "No Offer") {
                    window.offerList.push({
                        id: docSnap.id,
                        title: data.discount > 0 ? `${data.discount}% OFF` : 'SPECIAL',
                        desc: data.offerText,
                        code: 'OFFER' + data.slotId,
                        minAmt: 100,
                        discountPercent: data.discount || 0,
                        discountFlat: data.discountFlat || 0,
                        color: 'from-orange-500 to-red-600',
                        img: data.img,
                        isPersonal: false
                    });
                }
            });
            
            // 2. Ab Personal Won Coupons load karo (User ke phone number se)
            if (window.wowUser && window.wowUser.phone) {
                const couponQuery = query(
                    collection(dbFirestore, "restaurants", RESTAURANT_ID, "coupons"), 
                    where("userPhone", "==", window.wowUser.phone),
                    where("status", "==", "active") // Sirf active coupons dikhao
                );

                onSnapshot(couponQuery, (couponSnap) => {
                    // Remove old personal coupons from list
                    window.offerList = window.offerList.filter(o => !o.isPersonal);
                    
                    // Add personal won coupons
                    couponSnap.forEach(couponDoc => {
                        const data = couponDoc.data();
                        window.offerList.push({
                            id: couponDoc.id, // Doc ID zaroori hai status update ke liye
                            title: "ðŸŽ‰ YOU WON!",
                            desc: data.desc, // "10% OFF"
                            code: data.code,
                            minAmt: 0, // Jeete hue coupon pe min amount 0 rakho
                            discountPercent: data.isFlat ? 0 : data.discountValue,
                            discountFlat: data.isFlat ? data.discountValue : 0,
                            color: 'from-purple-600 to-pink-600', // Alag color
                            isPersonal: true // Flag taaki humein pata chale ye DB wala coupon hai
                        });
                    });
                    
                    if(window.renderOffers) window.renderOffers();
                });
            }
            
            // Ensure UI updates whenever data changes
            if(window.initBanners) window.initBanners();
            if(window.renderOffers) window.renderOffers();
        });
    }
    
    // --- 1. NEW: Offer Success Modal Show Function ---
    window.showOfferSuccessModal = (savedAmount, offerName) => {
        // Update Text
        document.getElementById('offer-saved-amount').innerText = savedAmount;
        document.getElementById('offer-success-name').innerText = offerName;

        // Show Modal
        const modal = document.getElementById('offer-success-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        // Confetti Blast (Patakhe)
        if (typeof confetti === 'function') {
            confetti({
                particleCount: 150,
                spread: 100,
                origin: { y: 0.6 },
                colors: ['#22c55e', '#fbbf24'] // Green and Yellow confetti
            });
        }
    };

    // --- 2. NEW: Close Modal Function ---
    window.closeOfferSuccessModal = () => {
        const modal = document.getElementById('offer-success-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    };

    // --- 3. UPDATED: applyOffer Function (Logic for both) ---
    window.applyOffer = (index) => {
        // Calculate Total Cart Value
        const total = window.wowCart.reduce((a,b) => a + (b.price * b.qty), 0);
        const offer = window.offerList[index];

        // 1. Check if offer exists
        if (!offer) return;

        // 2. Toggle Logic (Agar pehle se select hai to deselect kar do)
        if (window.selectedOffer === index) {
            window.selectedOffer = null;
            if(typeof Toastify !== 'undefined') Toastify({ text: "Offer Removed", style: { background: "#6b7280" }, duration: 1000 }).showToast();
        } else {
            // 3. Validation: Minimum Amount Check
            if (total < offer.minAmt) {
                const diff = offer.minAmt - total;
                if(typeof Toastify !== 'undefined') Toastify({ text: `Add items worth â‚¹${diff} more to apply!`, className: "toast-center", style: { background: "#EF4444" } }).showToast();
                return;
            }

            // 4. Calculate Savings (Dikhane ke liye)
            let saved = 0;
            if (offer.discountPercent > 0) {
                saved = Math.round(total * (offer.discountPercent / 100));
            } else {
                saved = offer.discountFlat;
            }

            // 5. Apply Offer
            window.selectedOffer = index;
            
            // 6. Trigger Celebration Popup! ðŸŽ‰
            showOfferSuccessModal(saved, offer.code || offer.title);
        }

        // 7. Update UI
        renderOffers();
        // Dropdown ko band kar do taaki popup dikhe
        document.getElementById('offers-dropdown').classList.add('hidden'); 
        document.getElementById('offer-arrow').classList.remove('rotate-180');
        
        calculateTotals();
    };

    // --- 4. UPDATED: applyManualCoupon (Connects to applyOffer) ---
    window.applyManualCoupon = async () => {
        const codeInput = document.getElementById('manual-coupon-code');
        const code = codeInput.value.trim().toUpperCase();

        if(!code) {
            if(typeof Toastify !== 'undefined') Toastify({ text: "Enter a code", style: { background: "#EF4444" }, duration: 2000 }).showToast();
            return;
        }

        // List mein dhoondo
        const foundIndex = window.offerList.findIndex(o => o.code === code);

        if (foundIndex !== -1) {
            // Agar mil gaya, to wahi logic use karo jo upar banaya hai
            window.applyOffer(foundIndex); 
            
            // Input clear karo
            codeInput.value = "";
        } else {
            if(typeof Toastify !== 'undefined') Toastify({ text: "Invalid or Expired Code", style: { background: "#EF4444" }, duration: 2000 }).showToast();
        }
    };
    
    // Rating logic specifically for Firestore
    window.submitRating = async (star) => {
        // Highlight selected stars
        const stars = document.querySelectorAll('.star-rating i');
        stars.forEach((s, idx) => {
            if(idx < star) {
                s.classList.add('text-yellow-400');
                s.classList.remove('text-gray-300');
            }
        });

        if(typeof Toastify !== 'undefined') {
            Toastify({ 
                text: "Thanks for rating! â­", 
                className: "toast-center", 
                style: { background: "#10B981" }, 
                duration: 1500
            }).showToast();
        }

        // Add to Database
        if(window.currentDocId) {
             try {
                const orderRef = doc(dbFirestore, "restaurants", RESTAURANT_ID, "orders", window.currentDocId);
                await updateDoc(orderRef, { rating: star });
             } catch(e) { console.log("Rating save error", e); }
        }

        // Close rating and reset app
        setTimeout(() => {
            document.getElementById('rating-widget').classList.add('hidden');
            document.getElementById('rating-widget').classList.remove('flex');
            
            // Reset app after rating
            setTimeout(() => {
                window.resetApp();
            }, 1000);
        }, 1000);
    }
    
    // Show rating widget
    // --- FIX: Stars animation logic added ---
    function showRatingWidget() {
        const ratingWidget = document.getElementById('rating-widget');
        if (ratingWidget) {
            // 1. Modal open karo (z-index 110 already set hai HTML mein)
            ratingWidget.classList.remove('hidden');
            ratingWidget.classList.add('flex');

            // 2. FIX: Stars ko visible banane ke liye animation trigger karo
            const stars = document.querySelectorAll('.star-rating i');
            
            // Reset stars pehle (agar dobara open ho raha ho)
            stars.forEach(star => {
                star.classList.remove('visible', 'text-yellow-400');
                star.classList.add('text-gray-300');
            });

            // Ek-ek karke stars ko pop-up karo
            stars.forEach((star, index) => {
                setTimeout(() => {
                    star.classList.add('visible');
                }, index * 100); // 100ms ka delay har star ke beech
            });
        }
    }

    const timeout = (ms) => new Promise((_, r) => setTimeout(() => r(new Error("Timeout")), ms));

    window.processOrder = async (method) => {
        const btn = document.getElementById('btn-cash-pay');
        const originalContent = btn.innerHTML;
        
        if(!window.wowCart || window.wowCart.length === 0) {
            if(typeof Toastify !== 'undefined') Toastify({ text: "Cart is empty!", className: "toast-center", style: { background: "#EF4444" } }).showToast();
            return;
        }

        btn.disabled = true;
        btn.innerHTML = `<div class="flex items-center justify-center gap-2"><div class="w-6 h-6 border-4 border-gray-200 border-t-green-500 rounded-full animate-spin"></div> Processing...</div>`;

        try {
            // IMPORTANT FIX: Re-fetch user data from local storage to ensure it's up-to-date before ordering
            const savedUser = localStorage.getItem('wowUser');
            if(savedUser) {
                window.wowUser = JSON.parse(savedUser);
            }
            
            const currentUser = window.wowUser || { name: 'Guest', phone: '0000000000' };
            const grandTotal = document.getElementById('summary-grand').innerText;
            const orderID = `WOW-${Date.now().toString().slice(-3)}-${Math.floor(1000 + Math.random() * 9000)}`;

            const orderData = {
                orderId: orderID,
                customer: { name: currentUser.name, phone: currentUser.phone },
                customerName: currentUser.name, // <<-- THIS IS THE FIX (To top-level field)
                customerMobile: currentUser.phone, // <<-- THIS IS THE FIX (To top-level field)
                items: window.wowCart,
                totalAmount: grandTotal,
                status: "pending", 
                paymentMethod: method,
                paymentStatus: "pending", 
                orderType: window.orderType, // Add Order Type to Database
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString(),
                timestamp: serverTimestamp(),
                createdAt: new Date()
            };

            const rtdbPromise = push(ref(db, `restaurants/${RESTAURANT_ID}/orders`), orderData);
            // We need to await addDoc to get the reference ID for updating rating later
            const docRef = await addDoc(collection(dbFirestore, "restaurants", RESTAURANT_ID, "orders"), orderData);
            window.currentDocId = docRef.id;

            await Promise.race([rtdbPromise, timeout(8000)]);

            const savedHistory = JSON.parse(localStorage.getItem('wowRecentOrders') || '[]');
            savedHistory.unshift({
                id: orderID,
                docId: docRef.id, // Store Firestore doc ID for payment tracking
                amount: grandTotal,
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString(),
                items: [...window.wowCart],
                orderType: window.orderType,
                paymentStatus: 'pending' // Initially pending
            });
            if(savedHistory.length > 10) savedHistory.pop();
            localStorage.setItem('wowRecentOrders', JSON.stringify(savedHistory));
            if(window.loadRecentOrders) window.loadRecentOrders();
            
            // Listen for payment status update from admin
            listenForPaymentUpdate(docRef.id, orderID);

            window.wowCart = [];
            
            // Step 4: Check karo agar koi offer selected tha aur wo Personal DB coupon tha
            if (window.selectedOffer !== null && window.selectedOffer !== undefined) {
                const usedOffer = window.offerList[window.selectedOffer];
                
                if (usedOffer && usedOffer.isPersonal && usedOffer.id) {
                    // Firestore mein status update karo -> 'used'
                    try {
                        await updateDoc(doc(dbFirestore, "restaurants", RESTAURANT_ID, "coupons", usedOffer.id), {
                            status: 'used',
                            usedAt: firestoreTimestamp(),
                            usedOnOrder: orderID
                        });
                        console.log("âœ… Coupon marked as USED in DB:", usedOffer.code);
                    } catch (e) {
                        console.error("Failed to mark coupon used", e);
                    }
                }
            }

            // Reset Selection
            window.selectedOffer = null;
            
            if(window.saveCartToStorage) window.saveCartToStorage();
            if(window.updateCartBar) window.updateCartBar();
            if(window.renderMenu && window.menuData) window.renderMenu(window.currentCategory === 'All' ? window.menuData : window.menuData.filter(i => i.category === window.currentCategory));
            
            document.getElementById('txn-id').innerText = orderID;
            document.getElementById('final-amt').innerText = grandTotal;
            document.getElementById('receipt-date').innerText = new Date().toLocaleDateString();
            document.getElementById('receipt-time').innerText = new Date().toLocaleTimeString();
            document.getElementById('receipt-customer').innerText = currentUser.name; // Update customer name on receipt
            document.getElementById('receipt-order-type').innerText = window.orderType; // Update order type on receipt

            document.getElementById('success-screen').classList.remove('hidden');
            document.getElementById('success-screen').classList.add('flex');
            
            // Rating widget will be triggered automatically after payment is collected
            // via the listenForPaymentUpdate function

            if(window.closePaymentModal) window.closePaymentModal();
            if(window.closeCheckout) window.closeCheckout();

        } catch (error) {
            console.error(error);
            if(typeof Toastify !== 'undefined') Toastify({ text: "Network Error! Try again.", className: "toast-center", style: { background: "#EF4444" } }).showToast();
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalContent;
        }
    };

    window.onload = () => {
        setTimeout(() => {
            document.getElementById('splash-screen').style.display = 'none';
            const savedUser = localStorage.getItem('wowUser');
            const savedCart = localStorage.getItem('wowCartData');
            
            if(savedCart) window.wowCart = JSON.parse(savedCart);
            if(savedUser) {
                window.wowUser = JSON.parse(savedUser);
                initUI();
            } else {
                document.getElementById('login-modal').classList.remove('hidden');
                document.getElementById('login-modal').classList.add('flex');
            }
        }, 2000);
    };

    function initUI() {
        document.getElementById('display-name').innerText = window.wowUser.name.split(' ')[0];
        document.getElementById('main-app').classList.remove('opacity-0');
        document.getElementById('main-app').classList.add('fade-in');
        
        initAddonsSync(); 
        initMenuSync();
        initOffersSync();
        
        if(window.updateCartBar) window.updateCartBar(); 
        if(window.loadRecentOrders) window.loadRecentOrders(); 
    }
</script>

<script>
    window.wowCart = [];
    window.recentOrders = [];
    window.menuData = [];
    window.offerList = [];
    window.wowUser = null;
    window.selectedOffer = null;
    window.orderType = 'Dine-in';
    window.currentCategory = 'All';
    window.currentCustomItem = null; 
    window.donationAmt = 0;
    const PLATFORM_FEE = 0.98;

    window.initBanners = () => {
        const container = document.getElementById('banner-container');
        if(window.offerList.length === 0) {
            container.innerHTML = '<div class="w-full text-center text-xs text-gray-400 py-2">No active offers</div>';
            return;
        }
        
        // LIMIT TO 3 CARDS ONLY
        const limitedOffers = window.offerList.slice(0, 3);
        
        container.innerHTML = limitedOffers.map(offer => {
            // Logic: If URL exists, show photo, else gradient.
            const hasImg = offer.img && offer.img.startsWith('http');
            const bgStyle = hasImg 
                ? `background-image: url('${offer.img}'); background-size: cover; background-position: center;` 
                : `background-image: linear-gradient(to right, #f97316, #dc2626);`; // Fallback gradient
            
            // Use a gradient overlay for clarity and readability of white text
            const overlayClass = hasImg ? 'bg-gradient-to-t from-black/80 via-black/40 to-transparent' : 'bg-transparent';
            
            return `
            <div class="flex-shrink-0 w-64 h-32 rounded-2xl p-0 relative overflow-hidden shadow-lg snap-center" style="${bgStyle}">
                <div class="absolute top-2 right-3 z-20 opacity-60 font-black text-[10px] tracking-widest text-white uppercase pointer-events-none drop-shadow-sm">WowCafe</div>
                
                <div class="relative z-10 h-full flex flex-col justify-end p-4 ${overlayClass}">
                    <div class="bg-white/20 text-white px-2 py-0.5 rounded w-fit text-[10px] font-bold mb-2 uppercase tracking-wider backdrop-blur-sm">
                         ${offer.title}
                    </div>
                    <h3 class="text-xl font-black leading-tight mb-1 text-white drop-shadow-sm">${offer.desc}</h3>
                </div>
            </div>
        `}).join('');
    };

    window.handleBrandingClick = () => {
        if(confirm("Open AutomationX website?")) {
            window.open("https://automation-x-rp3z.vercel.app/", "_blank");
        }
    };

    window.saveCartToStorage = () => {
        localStorage.setItem('wowCartData', JSON.stringify(window.wowCart));
    }

    window.saveUser = () => {
        const name = document.getElementById('user-name').value;
        const phone = document.getElementById('user-phone').value;
        if(name && phone) {
            window.wowUser = { name, phone };
            localStorage.setItem('wowUser', JSON.stringify(window.wowUser));
            document.getElementById('login-modal').classList.add('hidden');
            location.reload(); 
        } else {
            if(typeof Toastify !== 'undefined') Toastify({ text: "Please enter details", className: "toast-center", style: { background: "#EF4444" } }).showToast();
        }
    };

    window.loadRecentOrders = () => {
        const history = JSON.parse(localStorage.getItem('wowRecentOrders') || '[]');
        window.recentOrders = history;
        const container = document.getElementById('recent-orders-list');
        
        if(history.length === 0) {
            container.innerHTML = '<p class="text-sm text-gray-400 italic text-center py-4">No recent orders yet.</p>';
            document.getElementById('notif-dot').classList.add('hidden');
            return;
        }

        document.getElementById('notif-dot').classList.remove('hidden');
        container.innerHTML = history.map((order, idx) => {
            const isPaid = order.paymentStatus === 'paid' || order.paymentStatus === 'collected';
            const statusBadge = isPaid 
                ? `<span class="text-[9px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded-full font-bold"><i class="fas fa-check-circle"></i> Paid</span>`
                : `<span class="text-[9px] bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded-full font-bold animate-pulse"><i class="fas fa-clock"></i> Pending</span>`;
            
            return `
            <div onclick="openBillDetail(${idx})" class="flex justify-between items-center p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-orange-50 transition-colors border border-gray-100">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full ${isPaid ? 'bg-green-100 text-green-600' : 'bg-orange-100 text-orange-600'} flex items-center justify-center font-bold text-xs">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <div>
                        <div class="font-bold text-gray-800 text-sm">Order #${order.id.split('-')[1]}...</div>
                        <div class="text-[10px] text-gray-400">${order.date}, ${order.time}</div>
                        ${statusBadge}
                    </div>
                </div>
                <div class="font-bold ${isPaid ? 'text-green-600' : 'text-orange-600'} text-sm">â‚¹${order.amount}</div>
            </div>
        `}).join('');
    }

    window.filterByExplore = (cat) => {
        window.currentCategory = cat;
        document.querySelectorAll('.explore-btn').forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.getElementById(`exp-${cat.toLowerCase()}`);
        if(activeBtn) activeBtn.classList.add('active');
        renderMenu(cat === 'All' ? window.menuData : window.menuData.filter(i => i.category === cat));
    }
    
    window.filterMenu = (val) => {
        const filtered = window.menuData.filter(i => i.name.toLowerCase().includes(val.toLowerCase()));
        renderMenu(filtered);
    };

    window.renderMenu = (items) => {
        const div = document.getElementById('menu-container');
        div.innerHTML = '';
        
        if (items.length === 0 && window.menuData.length === 0) {
            div.innerHTML = '<p class="text-center text-gray-400 py-10">Waiting for Admin to add items...</p>';
            document.getElementById('menu-count').innerText = `0 Items`;
            return;
        }

        document.getElementById('menu-count').innerText = `${items.length} Items`;
        
        items.forEach(item => {
            const totalQty = window.wowCart.filter(c => c.parentId === item.id).reduce((sum, c) => sum + c.qty, 0);
            
            // --- UPDATED: Force Green Dot for everything by default ---
            const typeColor = 'green'; 
            
            const bestsellerBadge = item.isBestseller 
                ? `<span class="ml-2 bg-gradient-to-r from-orange-500 to-red-500 text-white text-[9px] font-black px-1.5 py-0.5 rounded shadow-sm">ðŸ”¥ BESTSELLER</span>`
                : '';

            const hasCustomization = (item.sizes && item.sizes.length > 0) || (item.addons && item.addons.length > 0);
            const customBadge = hasCustomization 
                ? `<span class="text-[9px] font-bold text-orange-600 bg-orange-50 border border-orange-100 px-1.5 py-0.5 rounded mt-1 inline-block">âœ¨ Customizable</span>` 
                : '';

            let btnHtml = '';
            
            if(totalQty > 0) {
                 btnHtml = `
                 <div class="flex items-center bg-white rounded-lg shadow-sm border border-orange-200 overflow-hidden w-full h-8">
                    <button onclick="decrementItem('${item.id}')" class="w-8 h-full flex items-center justify-center text-orange-600 hover:bg-orange-50 active:bg-orange-100 font-bold">-</button>
                    <span class="flex-1 text-center font-black text-sm text-gray-800">${totalQty}</span>
                    <button onclick="openCustomModal('${item.id}')" class="w-8 h-full flex items-center justify-center text-orange-600 hover:bg-orange-50 active:bg-orange-100 font-bold">+</button>
                 </div>`;
            } else {
                 btnHtml = `
                 <button onclick="openCustomModal('${item.id}')" class="w-full h-8 shadow-sm rounded-lg bg-white border border-orange-200 text-orange-600 font-extrabold text-xs hover:bg-orange-50 transition-colors uppercase">
                    ADD
                 </button>`;
            }

            div.innerHTML += `
            <div class="bg-white p-3 rounded-[1.2rem] shadow-sm border border-orange-100 flex gap-3 h-32 relative overflow-visible">
                <div class="flex-1 flex flex-col justify-between py-1">
                    <div>
                        <div class="flex items-center gap-1 mb-1">
                            <div class="w-3 h-3 border border-${typeColor}-600 flex justify-center items-center rounded-[2px]"><div class="w-1.5 h-1.5 bg-${typeColor}-600 rounded-full"></div></div>
                            <div class="bg-yellow-50 px-1 rounded text-[10px] font-bold text-yellow-700 flex items-center gap-0.5">â­ ${item.rating}</div>
                            ${bestsellerBadge}
                        </div>
                        <h3 class="font-bold text-gray-800 leading-tight text-[15px] mb-1">${item.name}</h3>
                        <p class="font-bold text-gray-900 text-sm">â‚¹${item.price}</p>
                        ${customBadge}
                        <p class="text-xs text-gray-400 mt-1 line-clamp-1">${item.desc}</p>
                    </div>
                </div>
                <div class="w-24 h-full relative flex-shrink-0 flex flex-col justify-between items-center gap-2">
                    <img src="${item.img}" class="w-full h-16 object-cover rounded-xl bg-gray-100">
                    ${btnHtml}
                </div>
            </div>`;
        });
    }

    window.decrementItem = (parentId) => {
        const itemsInCart = window.wowCart.filter(c => c.parentId === parentId);
        if(itemsInCart.length > 0) {
            const lastItem = itemsInCart[itemsInCart.length - 1]; 
            updateQty(lastItem.id, -1);
        }
    }

    window.openCustomModal = (id) => {
        const item = window.menuData.find(i => i.id === id);
        window.currentCustomItem = item;
        const container = document.getElementById('custom-options');
        container.innerHTML = '';

        if (item.sizes && item.sizes.length > 0) {
            let sizesHtml = `<h4 class="font-bold text-gray-700 mb-2 text-sm">Select Size</h4><div class="flex flex-wrap gap-2">`;
            
            item.sizes.forEach((sizeObj, index) => {
                const isChecked = index === 0 ? 'checked' : '';
                const displaySize = sizeObj.name.charAt(0).toUpperCase() + sizeObj.name.slice(1);
                
                sizesHtml += `
                    <div class="flex-1 min-w-[80px]">
                        <input type="radio" name="size" id="size-${index}" value="${index}" 
                               data-price="${sizeObj.price}" 
                               data-name="${displaySize}" 
                               class="hidden custom-radio" ${isChecked} onchange="updateModalPrice()">
                        <label for="size-${index}" class="block border border-gray-200 rounded-xl p-3 text-center cursor-pointer transition-all font-bold text-sm text-gray-600">
                            ${displaySize}<br><span class="text-[10px] font-normal">â‚¹${sizeObj.price}</span>
                        </label>
                    </div>
                `;
            });
            sizesHtml += `</div>`;
            container.innerHTML += sizesHtml;
        }

        let safeAddons = item.addons || [];
        if(safeAddons.length > 0) {
             let addonsHtml = safeAddons.map((addon, idx) => `
                <label class="flex items-center justify-between border border-gray-200 p-3 rounded-xl cursor-pointer">
                    <span class="text-sm font-bold text-gray-600">${addon.name}</span>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-400">+â‚¹${addon.price}</span>
                        <input type="checkbox" data-name="${addon.name}" data-price="${addon.price}" class="w-5 h-5 accent-orange-500 addon-check" onchange="updateModalPrice()">
                    </div>
                </label>
             `).join('');

             container.innerHTML += `
             <div class="mt-4">
                <h4 class="font-bold text-gray-700 mb-2 text-sm">Add-ons</h4>
                <div class="space-y-2">${addonsHtml}</div>
             </div>`;
        } else {
             container.innerHTML += `<p class="text-xs text-gray-400 italic text-center py-2 mt-2">No extra add-ons available.</p>`;
        }

        updateModalPrice(); 
        document.getElementById('custom-modal').classList.remove('hidden');
        document.getElementById('custom-modal').classList.add('flex'); 
    }

    window.closeCustomModal = () => {
        document.getElementById('custom-modal').classList.add('hidden');
        document.getElementById('custom-modal').classList.remove('flex');
    }

    window.updateModalPrice = () => {
        if(!window.currentCustomItem) return;
        let price = 0;

        const sizeInput = document.querySelector('input[name="size"]:checked');
        if (sizeInput) {
            price = parseFloat(sizeInput.dataset.price);
        } else {
            price = window.currentCustomItem.price; 
        }

        document.querySelectorAll('.addon-check:checked').forEach(chk => {
            price += parseInt(chk.dataset.price || 0);
        });

        document.getElementById('custom-price-display').innerText = `â‚¹${price}`;
    }

    window.confirmCustomization = () => {
        let finalPrice = 0;
        let sizeName = "Regular";
        let extras = [];

        const sizeInput = document.querySelector('input[name="size"]:checked');
        if (sizeInput) {
            finalPrice = parseFloat(sizeInput.dataset.price);
            sizeName = sizeInput.dataset.name;
        } else {
            finalPrice = window.currentCustomItem.price;
        }

        document.querySelectorAll('.addon-check:checked').forEach(chk => {
            finalPrice += parseInt(chk.dataset.price || 0);
            extras.push(chk.dataset.name);
        });

        const variantDetails = `${sizeName}${extras.length > 0 ? ', ' + extras.join(', ') : ''}`;
        const variantId = `${window.currentCustomItem.id}-${sizeName}-${extras.join('')}`; 

        window.addToCart(variantId, window.currentCustomItem.id, window.currentCustomItem.name, variantDetails, finalPrice);
        window.closeCustomModal();
        
        if(typeof Toastify !== 'undefined') Toastify({ text: "Item Added", className: "toast-center", style: { background: "#10B981" }, duration: 1000 }).showToast();
    }

    window.addToCart = (id, parentId, name, variantDetails, price) => {
        const existing = window.wowCart.find(c => c.id === id);
        if(existing) {
            existing.qty++;
        } else {
            window.wowCart.push({ id, parentId, name, variantDetails, price, qty: 1 });
        }
        window.saveCartToStorage();
        updateCartBar();
        renderMenu(window.currentCategory === 'All' ? window.menuData : window.menuData.filter(i => i.category === window.currentCategory));
    }

    window.updateQty = (id, change) => {
        const item = window.wowCart.find(c => c.id === id);
        if(item) {
            item.qty += change;
            if(item.qty <= 0) window.wowCart = window.wowCart.filter(c => c.id !== id);
        }
        window.saveCartToStorage(); 
        updateCartBar();
        renderBill();
        renderMenu(window.currentCategory === 'All' ? window.menuData : window.menuData.filter(i => i.category === window.currentCategory));
    }

    window.editCartItem = (id) => {
        const itemIndex = window.wowCart.findIndex(c => c.id === id);
        if(itemIndex > -1) {
            const parentId = window.wowCart[itemIndex].parentId;
            window.wowCart.splice(itemIndex, 1); 
            window.saveCartToStorage();
            updateCartBar();
            renderBill();
            openCustomModal(parentId); 
        }
    }

    window.updateCartBar = () => {
        const count = window.wowCart.reduce((a,b) => a + b.qty, 0);
        const total = window.wowCart.reduce((a,b) => a + (b.price * b.qty), 0);
        const bar = document.getElementById('cart-bar');
        
        if(count > 0) {
            bar.classList.remove('translate-y-40');
            document.getElementById('cart-count').innerText = count;
            document.getElementById('cart-total').innerText = total;
        } else {
            bar.classList.add('translate-y-40');
            closeCheckout();
        }
    }

    window.openCheckout = () => {
        document.getElementById('customer-info-bill').innerText = window.wowUser.name;
        document.getElementById('receipt-customer').innerText = window.wowUser.name;
        const sheet = document.getElementById('checkout-sheet');
        sheet.classList.remove('hidden');
        setTimeout(() => {
            document.getElementById('checkout-bg').classList.remove('opacity-0');
            document.getElementById('checkout-panel').classList.remove('translate-y-full');
        }, 10);
        renderBill();
        renderOffers();
    };

    window.closeCheckout = () => {
        document.getElementById('checkout-bg').classList.add('opacity-0');
        document.getElementById('checkout-panel').classList.add('translate-y-full');
        setTimeout(() => document.getElementById('checkout-sheet').classList.add('hidden'), 300);
    };

    window.renderBill = () => {
        const list = document.getElementById('bill-items');
        list.innerHTML = window.wowCart.map(i => `
            <div class="flex justify-between items-center text-sm border-b border-gray-100 last:border-0 pb-2 last:pb-0 border-dashed">
                <div class="flex-1">
                      <span class="text-gray-800 font-bold block">${i.name}</span>
                      <span class="text-[10px] text-blue-600 font-bold bg-blue-50 px-1 rounded block w-fit mb-1">[${i.variantDetails}]</span>
                      <span class="text-xs text-gray-400">â‚¹${i.price} x ${i.qty}</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="editCartItem('${i.id}')" class="w-8 h-8 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center hover:bg-blue-100"><i class="fas fa-pencil-alt text-xs"></i></button>
                    
                    <div class="flex items-center bg-gray-50 rounded-lg p-1 gap-3 border border-gray-200">
                        <button onclick="updateQty('${i.id}', -1)" class="w-5 h-5 flex items-center justify-center text-gray-500 bg-white rounded shadow-sm"><i class="fas fa-minus text-[8px]"></i></button>
                        <span class="text-xs font-bold text-gray-800 w-2 text-center">${i.qty}</span>
                        <button onclick="updateQty('${i.id}', 1)" class="w-5 h-5 flex items-center justify-center text-green-600 bg-white rounded shadow-sm"><i class="fas fa-plus text-[8px]"></i></button>
                    </div>
                </div>
            </div>
        `).join('');
        calculateTotals();
    }

    window.setDonation = (amt, btn) => {
        window.donationAmt = amt;
        document.getElementById('love-btn-toggle').classList.remove('active');
        document.getElementById('love-btn-toggle').innerHTML = `<i class="fas fa-heart animate-pulse"></i> Donate â‚¹10 & Spread Love`;
        updateDonationUI();
        calculateTotals();
        
        const originalText = `â‚¹${amt}`;
        btn.innerText = "Thanks!";
        if (typeof confetti === 'function') confetti({ particleCount: 50, spread: 50, origin: { y: 0.7 }, colors: ['#ec4899'] });
        setTimeout(() => { btn.innerText = originalText; }, 1500);
    }

    window.toggleLoveDonation = () => {
        const btn = document.getElementById('love-btn-toggle');
        if(btn.classList.contains('active')) {
            window.donationAmt = 0;
            btn.classList.remove('active');
            btn.innerHTML = `<i class="fas fa-heart animate-pulse"></i> Donate â‚¹10 & Spread Love`;
        } else {
            window.donationAmt = 10;
            btn.classList.add('active');
            btn.innerHTML = `<i class="fas fa-check"></i> Thanks for Love!`;
            if (typeof confetti === 'function') confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#ec4899', '#f472b6'] });
        }
        updateDonationUI();
        calculateTotals();
    }

    window.updateDonationUI = () => {
        document.querySelectorAll('.donation-btn').forEach(btn => btn.classList.remove('active'));
        if(window.donationAmt === 5) document.querySelectorAll('.donation-btn')[0].classList.add('active');
        if(window.donationAmt === 10 && !document.getElementById('love-btn-toggle').classList.contains('active')) document.querySelectorAll('.donation-btn')[1].classList.add('active');
        if(window.donationAmt === 50) document.querySelectorAll('.donation-btn')[2].classList.add('active');
    }

    window.calculateTotals = () => {
        let total = window.wowCart.reduce((a,b) => a + (b.price * b.qty), 0);
        let discount = 0;
        if(window.selectedOffer !== null) {
            const offer = window.offerList[window.selectedOffer];
            if(total >= offer.minAmt) {
                if(offer.discountPercent > 0) discount = Math.round(total * (offer.discountPercent / 100));
                else discount = offer.discountFlat;
            } else window.selectedOffer = null;
        }
        
        const tax = (total - discount) * 0.05;
        const grand = (total - discount) + tax + PLATFORM_FEE + window.donationAmt;

        document.getElementById('summary-total').innerText = total;
        document.getElementById('summary-tax').innerText = tax.toFixed(2);
        document.getElementById('summary-donation').innerText = window.donationAmt;
        document.getElementById('summary-grand').innerText = grand.toFixed(2);
        document.getElementById('btn-pay-amt').innerText = grand.toFixed(2);
        document.getElementById('pay-modal-amt').innerText = grand.toFixed(2);
        
        if(discount > 0) {
            document.getElementById('discount-row').classList.remove('hidden');
            document.getElementById('summary-discount').innerText = discount;
        } else {
            document.getElementById('discount-row').classList.add('hidden');
        }
    }

    window.toggleOffers = () => {
        document.getElementById('offers-dropdown').classList.toggle('hidden');
        document.getElementById('offer-arrow').classList.toggle('rotate-180');
    }
    
    window.renderOffers = () => {
        const container = document.getElementById('offers-dropdown');
        container.innerHTML = '';
        window.offerList.forEach((offer, index) => {
            const isSelected = window.selectedOffer === index;
            container.innerHTML += `
            <div onclick="applyOffer(${index})" class="border ${isSelected ? 'border-orange-500 bg-orange-50' : 'border-gray-200 bg-white'} rounded-xl p-3 flex justify-between items-center cursor-pointer hover:shadow-md transition-all">
                <div class="flex gap-3 items-center">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br ${offer.color} text-white flex items-center justify-center text-[10px] font-bold"><i class="fas fa-tag"></i></div>
                    <div><h4 class="font-bold text-gray-800 text-xs leading-none">${offer.code}</h4><p class="text-[10px] text-gray-500 mt-0.5">${offer.desc}</p></div>
                </div>
                <div class="text-[10px] font-bold ${isSelected ? 'text-orange-600' : 'text-blue-600'}">${isSelected ? 'APPLIED' : 'APPLY'}</div>
            </div>`;
        });
        calculateTotals();
    }

    window.applyOffer = (index) => {
        const total = window.wowCart.reduce((a,b) => a + (b.price * b.qty), 0);
        if(window.selectedOffer === index) {
            window.selectedOffer = null;
        } else {
            if(total >= window.offerList[index].minAmt) window.selectedOffer = index;
            else { if(typeof Toastify !== 'undefined') Toastify({text: `Add more items`, className: "toast-center", style: {background: "#F59E0B"}}).showToast(); return; }
        }
        renderOffers();
        toggleOffers();
    };

    window.openPaymentModal = () => {
        const modal = document.getElementById('payment-modal');
        const panel = document.getElementById('payment-panel');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        panel.classList.remove('scale-95', 'opacity-0');
        panel.classList.add('scale-100', 'opacity-100');
        
        // Reset to payment options view
        document.getElementById('payment-options-view').classList.remove('hidden');
        document.getElementById('online-payment-view').classList.add('hidden');
        
        // Load customer site settings for QR
        loadPaymentSettings();
    };

    window.closePaymentModal = () => {
         const panel = document.getElementById('payment-panel');
         panel.classList.remove('scale-100', 'opacity-100');
         panel.classList.add('scale-95', 'opacity-0');
         setTimeout(() => {
             document.getElementById('payment-modal').classList.add('hidden');
             document.getElementById('payment-modal').classList.remove('flex');
             // Reset views
             document.getElementById('payment-options-view').classList.remove('hidden');
             document.getElementById('online-payment-view').classList.add('hidden');
         }, 200);
    };
    
    // Show Online Payment View with QR
    window.showOnlinePaymentView = () => {
        document.getElementById('payment-options-view').classList.add('hidden');
        document.getElementById('online-payment-view').classList.remove('hidden');
        
        // Set amount
        const amount = document.getElementById('pay-modal-amt').innerText;
        document.getElementById('qr-amount').innerText = amount;
    };
    
    // Back to Payment Options
    window.backToPaymentOptions = () => {
        document.getElementById('online-payment-view').classList.add('hidden');
        document.getElementById('payment-options-view').classList.remove('hidden');
    };
    
    // Open UPI App with pre-filled amount (non-changeable via intent)
    window.openUPIApp = (app) => {
        const amount = document.getElementById('qr-amount').innerText;
        const upiId = window.customerSiteSettings?.upiId || '';
        const payeeName = window.customerSiteSettings?.paymentName || 'Business';
        
        if (!upiId) {
            Toastify({ text: "UPI not configured!", className: "toast-center", style: { background: "#EF4444" } }).showToast();
            return;
        }
        
        // UPI Intent URL with fixed amount
        const upiUrl = `upi://pay?pa=${encodeURIComponent(upiId)}&pn=${encodeURIComponent(payeeName)}&am=${amount}&cu=INR&tn=Order%20Payment`;
        
        // App-specific deep links
        let deepLink = upiUrl;
        switch(app) {
            case 'gpay':
                deepLink = `gpay://upi/pay?pa=${encodeURIComponent(upiId)}&pn=${encodeURIComponent(payeeName)}&am=${amount}&cu=INR&tn=Order%20Payment`;
                break;
            case 'phonepe':
                deepLink = `phonepe://pay?pa=${encodeURIComponent(upiId)}&pn=${encodeURIComponent(payeeName)}&am=${amount}&cu=INR&tn=Order%20Payment`;
                break;
            case 'paytm':
                deepLink = `paytmmp://pay?pa=${encodeURIComponent(upiId)}&pn=${encodeURIComponent(payeeName)}&am=${amount}&cu=INR&tn=Order%20Payment`;
                break;
            case 'bhim':
                deepLink = upiUrl; // BHIM uses standard UPI intent
                break;
        }
        
        // Try to open the app
        window.location.href = deepLink;
        
        // Fallback to standard UPI intent after a short delay
        setTimeout(() => {
            window.location.href = upiUrl;
        }, 2500);
    };
    
    // Confirm Online Payment - Process order with Online method
    window.confirmOnlinePayment = () => {
        processOrder('Online');
    };

    window.resetApp = () => {
        const s = document.getElementById('success-screen');
        s.classList.add('hidden');
        s.classList.remove('flex');
    };

    window.setOrderType = (t) => {
        window.orderType = t;
        document.getElementById('order-type-label').innerText = t + ' Order';
        document.getElementById('btn-dine').className = t === 'Dine-in' ? 'flex-1 py-2.5 rounded-lg text-sm font-bold text-center bg-white text-orange-900 shadow-sm border border-orange-200' : 'flex-1 py-2.5 rounded-lg text-sm font-bold text-center text-orange-700';
        document.getElementById('btn-take').className = t === 'Takeaway' ? 'flex-1 py-2.5 rounded-lg text-sm font-bold text-center bg-white text-orange-900 shadow-sm border border-orange-200' : 'flex-1 py-2.5 rounded-lg text-sm font-bold text-center text-orange-700';
    };
    
    window.toggleNotif = () => {
        const modal = document.getElementById('notif-modal');
        modal.classList.toggle('hidden');
    }

    window.openBillDetail = (index) => {
        const order = window.recentOrders[index];
        document.getElementById('hist-id').innerText = order.id;
        document.getElementById('hist-total').innerText = order.amount;
        document.getElementById('hist-date').innerText = `${order.date} at ${order.time}`;
        document.getElementById('hist-customer').innerText = window.wowUser?.name || 'Guest';
        document.getElementById('hist-order-type').innerText = order.orderType || 'Dine-in';
        
        // Payment Status Badge
        const isPaid = order.paymentStatus === 'paid' || order.paymentStatus === 'collected';
        const badge = document.getElementById('hist-payment-badge');
        if (isPaid) {
            badge.className = 'mt-2 px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold border border-green-200 inline-block';
            badge.innerHTML = '<i class="fas fa-check-circle mr-1"></i> Payment Collected';
        } else {
            badge.className = 'mt-2 px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-bold border border-yellow-200 inline-block animate-pulse';
            badge.innerHTML = '<i class="fas fa-clock mr-1"></i> Payment Pending';
        }
        
        const container = document.getElementById('hist-items');
        container.innerHTML = order.items.map(i => `
            <div class="flex justify-between items-start text-sm py-2 border-b border-gray-50 last:border-0">
                <div class="flex-1">
                    <span class="text-gray-800 font-bold block">${i.name}</span>
                    <span class="text-[10px] text-blue-600 bg-blue-50 px-1 rounded">[${i.variantDetails}]</span>
                    <span class="text-[10px] text-gray-400 block mt-1">â‚¹${i.price} Ã— ${i.qty}</span>
                </div>
                <span class="text-gray-800 font-bold">â‚¹${i.price * i.qty}</span>
            </div>
        `).join('');

        document.getElementById('bill-detail-modal').classList.remove('hidden');
        document.getElementById('bill-detail-modal').classList.add('flex');
    }

    window.closeBillDetail = () => {
        document.getElementById('bill-detail-modal').classList.add('hidden');
        document.getElementById('bill-detail-modal').classList.remove('flex');
    }

    const infoData = {
        'Policy': `
            <p><strong>1. Payments:</strong> Currently accepting Cash on Counter only.</p>
            <p><strong>2. Refunds:</strong> Orders once prepared cannot be cancelled or refunded.</p>
            <p><strong>3. Outside Food:</strong> Consumption of outside food is strictly prohibited.</p>
            <p><strong>4. Rights:</strong> WowCafe reserves the right to admission.</p>
        `,
        'Contact': `
            <p><i class="fas fa-phone mr-2 text-orange-500"></i> +91 86191 52422</p>
            <p><i class="fas fa-envelope mr-2 text-orange-500"></i> help@wowcafe.in</p>
            <p><i class="fas fa-map-marker-alt mr-2 text-orange-500"></i> Shop 12, Food Court, City Mall.</p>
        `,
        'Help': `
            <p><strong>Missing Items?</strong> Please report to the counter immediately.</p>
            <p><strong>Allergies?</strong> Inform staff before ordering about nuts or dairy allergies.</p>
            <p><strong>Feedback:</strong> We love to hear from you! Drop a note at the counter.</p>
        `
    };

    window.openInfoModal = (type) => {
        document.getElementById('info-title').innerText = type;
        document.getElementById('info-content').innerHTML = infoData[type];
        document.getElementById('info-modal').classList.remove('hidden');
        document.getElementById('info-modal').classList.add('flex');
    }

    window.closeInfoModal = () => {
        document.getElementById('info-modal').classList.add('hidden');
        document.getElementById('info-modal').classList.remove('flex');
    }
</script>
</body>
</html>
