<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orderly Management - Business Admin Pro</title>

    <!-- Initial Loading Screen (shows immediately) -->
    <style>
        #initial-loader {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #1f2937, #111827);
            display: flex; align-items: center; justify-content: center;
            z-index: 999999; font-family: system-ui;
        }
        #initial-loader .loader-content {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #initial-loader .spinner {
            width: 60px; height: 60px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid #f97316;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        #initial-loader .brand { color: #f97316; font-size: 1.75rem; font-weight: 800; text-align: center; }
        #initial-loader .sub { color: #9ca3af; font-size: 0.9rem; margin-top: 10px; text-align: center; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase compat scripts removed; using type="module" below -->
       
    <style>
        /* --- MODERN THEME VARIABLES --- */
        :root {
            --primary: #ea580c;
            --primary-hover: #c2410c;
            --primary-light: #fff7ed;
            --primary-border: #fed7aa;
            --gradient-start: #ea580c;
            --gradient-end: #dc2626;
        }

        /* =====================================================
           MOBILE PERFORMANCE OPTIMIZATIONS
           ===================================================== */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        html {
            scroll-behavior: smooth;
            -webkit-text-size-adjust: 100%;
        }
        
        body {
            overscroll-behavior-y: contain;
            touch-action: manipulation;
        }
        
        /* GPU acceleration for smooth animations */
        .glass-card, .modal-enter, .nav-item, button, [class*="hover:"] {
            transform: translateZ(0);
            will-change: transform, opacity;
            backface-visibility: hidden;
        }
        
        /* Optimize images for mobile */
        img {
            content-visibility: auto;
        }
        
        /* Smooth scrolling for all scrollable containers */
        [class*="overflow-y-auto"], [class*="overflow-x-auto"] {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        
        /* Reduce motion for users who prefer it */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        * {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        body.theme-blue {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --primary-light: #eff6ff;
            --primary-border: #bfdbfe;
            --gradient-start: #2563eb;
            --gradient-end: #7c3aed;
        }

        body.theme-green {
            --primary: #16a34a;
            --primary-hover: #15803d;
            --primary-light: #f0fdf4;
            --primary-border: #bbf7d0;
            --gradient-start: #16a34a;
            --gradient-end: #0891b2;
        }

        body.theme-purple {
            --primary: #9333ea;
            --primary-hover: #7e22ce;
            --primary-light: #faf5ff;
            --primary-border: #e9d5ff;
            --gradient-start: #9333ea;
            --gradient-end: #ec4899;
        }

        body.theme-dark {
            --primary: #f97316;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f3f4f6;
        }

        body.theme-dark .bg-white { background-color: #1e293b !important; color: #f3f4f6; border-color: #334155; }
        body.theme-dark .bg-gray-50 { background-color: #0f172a !important; color: #cbd5e1; }
        body.theme-dark .text-gray-800 { color: #f1f5f9 !important; }
        body.theme-dark .text-gray-600, body.theme-dark .text-gray-500 { color: #94a3b8 !important; }
        body.theme-dark .border-gray-100, body.theme-dark .border-gray-200 { border-color: #334155 !important; }
        body.theme-dark input, body.theme-dark select, body.theme-dark textarea { background-color: #1e293b; color: white; border-color: #475569; }
        body.theme-dark .glass-card { background: rgba(30, 41, 59, 0.8) !important; }

        /* Modern Glass Cards */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
        }

        /* Gradient Backgrounds */
        .gradient-primary {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
        }

        .gradient-success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .gradient-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .gradient-info {
            background: linear-gradient(135deg, #3b82f6, #6366f1);
        }

        .gradient-purple {
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
        }

        /* Navigation Styles */
        .nav-item.active {
            background: linear-gradient(90deg, var(--primary-light), transparent);
            color: var(--primary);
            border-right: 3px solid var(--primary);
        }

        .nav-item:hover:not(.active) {
            background-color: #f8fafc;
        }

        /* Quick Action Buttons */
        .quick-action-btn {
            background: white;
            border: 2px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .quick-action-btn:hover {
            border-color: var(--primary);
            background: var(--primary-light);
            transform: scale(1.02);
        }

        .quick-action-btn:active {
            transform: scale(0.98);
        }

        /* Stat Cards */
        .stat-card {
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
        }

        .stat-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        /* Visibility Control */
        .hide-section { display: none !important; }

        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Modal Animation */
        .modal-enter {
            animation: modalIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* Sidebar */
        #sidebar {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-closed { transform: translateX(-100%); }
        .sidebar-open { transform: translateX(0); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #cbd5e1, #94a3b8); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Status Badges */
        .status-badge {
            font-size: 0.75rem;
            padding: 0.35rem 0.75rem;
            border-radius: 9999px;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .status-pending { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .status-preparing { background: #fff7ed; color: #ea580c; border: 1px solid #fed7aa; animation: pulse 2s infinite; }
        .status-ready { background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }
        .status-completed { background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }

        /* Progress Ring */
        .progress-ring { transform: rotate(-90deg); }
        .progress-ring-circle {
            transition: stroke-dashoffset 0.5s ease;
            stroke-linecap: round;
        }

        /* Pulse Animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Live Indicator */
        .live-dot {
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            animation: livePulse 1.5s infinite;
        }

        @keyframes livePulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }

        /* Table Styles */
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .table-row-hover:hover { background-color: #f8fafc; }

        /* Best Seller Glow */
        .bestseller-glow {
            box-shadow: 0 0 15px rgba(234, 179, 8, 0.3);
            border-color: #fbbf24 !important;
        }

        /* Login Overlay */
        #login-overlay {
            backdrop-filter: blur(20px);
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,247,237,0.9));
        }

        /* Low Balance Alert */
        @keyframes redAlertPulse {
            0%, 100% { box-shadow: inset 0 0 0 0 rgba(239, 68, 68, 0); }
            50% { box-shadow: inset 0 0 80px 10px rgba(239, 68, 68, 0.3); }
        }

        .low-balance-active {
            animation: redAlertPulse 2s infinite;
            position: fixed;
            inset: 0;
            z-index: 9998;
            pointer-events: none;
            border: 6px solid rgba(239, 68, 68, 0.5);
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 200px;
        }

        /* Clickable Cards */
        .clickable-card {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clickable-card:hover {
            transform: translateY(-2px);
        }

        /* Button Load More */
        .btn-load-more {
            display: block;
            width: 100%;
            padding: 14px;
            text-align: center;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            color: #475569;
            font-weight: 700;
            border-radius: 0 0 1rem 1rem;
            transition: all 0.2s;
            cursor: pointer;
        }

        .btn-load-more:hover {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            color: #1e293b;
        }

        .btn-load-more.hidden { display: none; }

        /* App Blocked Overlay */
        #app-blocked-overlay { z-index: 100000; background: white; }

        /* =====================================================
           MOBILE RESPONSIVE STYLES
           ===================================================== */
        
        /* Mobile First - Base Styles */
        @media (max-width: 640px) {
            /* Typography */
            .text-2xl { font-size: 1.25rem !important; }
            .text-3xl { font-size: 1.5rem !important; }
            .text-4xl { font-size: 1.75rem !important; }
            
            /* Cards & Containers */
            .glass-card { 
                padding: 1rem !important; 
                margin: 0.5rem 0 !important;
                border-radius: 1rem !important;
            }
            
            /* Grid Layouts */
            .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
            .grid-cols-3, .grid-cols-4, .grid-cols-5, .grid-cols-6 { 
                grid-template-columns: repeat(2, minmax(0, 1fr)) !important; 
            }
            .md\\:grid-cols-3, .md\\:grid-cols-4, .lg\\:grid-cols-4, .lg\\:grid-cols-5, .lg\\:grid-cols-6 {
                grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
            }
            
            /* Spacing */
            .gap-4 { gap: 0.75rem !important; }
            .gap-6 { gap: 1rem !important; }
            .p-6 { padding: 1rem !important; }
            .p-8 { padding: 1.25rem !important; }
            .px-6 { padding-left: 1rem !important; padding-right: 1rem !important; }
            .py-6 { padding-top: 1rem !important; padding-bottom: 1rem !important; }
            
            /* Stat Cards */
            .stat-card { padding: 0.875rem !important; }
            .stat-card-icon { width: 36px !important; height: 36px !important; font-size: 16px !important; }
            
            /* Buttons */
            .quick-action-btn { 
                padding: 0.5rem 0.75rem !important; 
                font-size: 0.75rem !important;
            }
            
            /* Tables */
            .table-container { font-size: 0.75rem; }
            .table-container th, .table-container td { 
                padding: 0.5rem !important; 
                white-space: nowrap;
            }
            
            /* Modal improvements */
            .modal-enter { 
                width: 95% !important; 
                max-width: 95% !important;
                margin: 0.5rem !important;
                max-height: 90vh !important;
            }
            
            /* Main container */
            main { padding: 0.75rem !important; }
            
            /* Form elements */
            input, select, textarea {
                font-size: 16px !important; /* Prevents zoom on iOS */
            }
            
            /* Dashboard specific */
            .chart-container { height: 150px !important; }
            
            /* Hide on mobile */
            .hide-mobile { display: none !important; }
            
            /* Stack buttons on mobile */
            .flex.gap-2, .flex.gap-3, .flex.gap-4 {
                flex-wrap: wrap;
            }
            
            /* Full width buttons on mobile */
            .mobile-full-width { 
                width: 100% !important; 
                margin-bottom: 0.5rem;
            }
        }
        
        /* Small tablets */
        @media (min-width: 641px) and (max-width: 768px) {
            .grid-cols-4, .grid-cols-5, .grid-cols-6 { 
                grid-template-columns: repeat(3, minmax(0, 1fr)) !important; 
            }
            .glass-card { padding: 1.25rem !important; }
        }
        
        /* Tablet & Small Desktop */
        @media (min-width: 769px) and (max-width: 1024px) {
            .grid-cols-5, .grid-cols-6 { 
                grid-template-columns: repeat(4, minmax(0, 1fr)) !important; 
            }
        }
        
        /* Mobile sidebar */
        @media (max-width: 767px) {
            #sidebar {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                height: 100vh !important;
                z-index: 50 !important;
                width: 280px !important;
                transform: translateX(-100%);
            }
            
            #sidebar.sidebar-open {
                transform: translateX(0);
            }
            
            /* Sidebar overlay */
            .sidebar-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.5);
                z-index: 49;
                display: none;
            }
            
            .sidebar-overlay.active {
                display: block;
            }
        }
        
        /* Touch-friendly tap targets */
        @media (pointer: coarse) {
            button, .clickable-card, .nav-item {
                min-height: 44px;
                min-width: 44px;
            }
            
            .nav-item {
                padding: 0.875rem 1rem !important;
            }
        }
        
        /* Landscape mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .modal-enter {
                max-height: 85vh !important;
                overflow-y: auto !important;
            }
        }
        
        /* Print styles */
        @media print {
            #sidebar, header, .quick-action-btn, button { display: none !important; }
            .glass-card { box-shadow: none !important; border: 1px solid #ccc !important; }
        }
    </style>
    <link rel="manifest" href="manifest.json">
</head>

<body class="bg-gray-50 font-sans text-gray-700">

    <!-- Initial Loading Spinner (shows immediately on page load) -->
    <div id="initial-loader">
        <div class="loader-content">
            <div class="spinner"></div>
            <div class="brand">Orderly Management</div>
            <div class="sub">Loading dashboard...</div>
        </div>
    </div>

    <div id="app-blocked-overlay"
        class="fixed inset-0 hidden flex items-center justify-center flex-col text-center p-8 bg-white z-[100000]">
        <div class="max-w-md">
            <div class="bg-red-50 p-6 rounded-full mb-6 animate-bounce inline-block">
                <i class="fas fa-ban text-6xl text-red-600"></i>
            </div>
            <h1 class="text-4xl font-black text-gray-800 mb-2">Account Suspended</h1>
            <div class="bg-red-100 border border-red-200 rounded-xl p-4 mb-6">
                <p class="text-red-700 font-bold text-lg"><i class="fas fa-exclamation-triangle mr-2"></i>Payment Not Received</p>
                <p class="text-red-600 text-sm mt-1">Your subscription has been suspended due to non-payment.</p>
            </div>
            <p class="text-gray-500 mb-6">All services (Admin, Customer, Kitchen) are currently blocked. Please contact the administrator to restore access.</p>
            
            <div class="bg-gray-50 rounded-xl p-4 mb-6 text-left">
                <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                    <i class="fas fa-headset text-orange-600"></i> Contact Administrator
                </h3>
                <div class="space-y-2">
                    <a href="tel:+919876543210" class="flex items-center gap-3 text-gray-600 hover:text-orange-600 transition">
                        <i class="fas fa-phone w-5"></i>
                        <span>+91 98765 43210</span>
                    </a>
                    <a href="https://wa.me/919876543210" target="_blank" class="flex items-center gap-3 text-gray-600 hover:text-green-600 transition">
                        <i class="fab fa-whatsapp w-5"></i>
                        <span>WhatsApp Support</span>
                    </a>
                    <a href="mailto:support@orderly.com" class="flex items-center gap-3 text-gray-600 hover:text-blue-600 transition">
                        <i class="fas fa-envelope w-5"></i>
                        <span>support@orderly.com</span>
                    </a>

                </div>
                <!-- Spin Wheel Management Section (Admin) -->
                <div class="border-2 border-purple-200 bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl p-6 mt-2">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                        <div>
                            <h3 class="font-bold text-lg text-purple-800 flex items-center gap-2">
                                <i class="fas fa-dharmachakra text-purple-500"></i> Spin Wheel Management
                            </h3>
                            <p class="text-xs text-gray-500">Manage prizes, enable/disable, and view stats for the Spin Wheel feature.</p>
                        </div>
                        <div class="flex gap-2 items-center">
                            <label class="flex items-center gap-2 cursor-pointer select-none">
                                <span class="text-xs font-bold text-purple-700">Enable Spin Wheel</span>
                                <input type="checkbox" id="admin-spin-wheel-toggle" class="sr-only" onchange="toggleWheelEnabled()">
                                <span class="w-10 h-6 bg-gray-200 rounded-full relative flex-shrink-0">
                                    <span class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full shadow transition-transform duration-200" id="admin-spin-toggle-knob"></span>
                                </span>
                            </label>
                            <button onclick="openWheelPrizeModal()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold px-4 py-2 rounded-lg text-xs flex items-center gap-1">
                                <i class="fas fa-plus"></i> Add Prize
                            </button>
                        </div>
                    </div>
                    <div id="wheel-prizes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Prizes will be rendered here -->
                    </div>
                </div>
            </div>
            
            <button onclick="location.reload()" class="px-6 py-3 bg-gray-800 text-white rounded-xl font-bold text-sm hover:bg-gray-900 transition">
                <i class="fas fa-sync-alt mr-2"></i>Refresh Page
            </button>
        </div>
    </div>

    <div id="low-balance-overlay" class="hidden fixed top-0 left-0 right-0 z-[9998] pointer-events-none">
        <div class="bg-gradient-to-r from-red-600 to-red-500 text-white p-3 shadow-lg animate-pulse">
            <div class="max-w-7xl mx-auto flex items-center justify-center gap-3">
                <i class="fas fa-exclamation-triangle text-yellow-300 text-lg"></i>
                <span class="font-bold text-sm">?? LOW BALANCE ALERT: Your wallet balance is below ?100. Recharge now to avoid service interruption!</span>
                <a href="https://wa.me/919876543210?text=Hi,%20I%20need%20to%20recharge%20my%20Orderly%20wallet" target="_blank" class="pointer-events-auto bg-white text-red-600 px-4 py-1.5 rounded-lg font-bold text-xs hover:bg-red-50 transition">
                    <i class="fab fa-whatsapp mr-1"></i> Recharge Now
                </a>
            </div>
        </div>
    </div>

    <div id="login-overlay"
        class="fixed inset-0 z-[100] flex items-center justify-center flex-col transition-all duration-300">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96 border border-gray-100 text-center">
            <!-- Branding -->
            <div class="mb-6">
                <div class="w-16 h-16 bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl mx-auto mb-4 flex items-center justify-center shadow-lg">
                    <i class="fas fa-utensils text-white text-2xl"></i>
                </div>
                <h1 class="text-3xl font-black text-gray-800 tracking-tight">Orderly<span
                        class="text-orange-600"> Management</span></h1>
                <p class="text-xs text-gray-400 font-bold uppercase tracking-widest mt-1">Restaurant Admin Portal</p>
            </div>
            
            <!-- Cafe ID Display -->
            <div id="login-cafe-id" class="bg-gray-50 rounded-lg px-3 py-2 mb-4">
                <p class="text-[10px] text-gray-400 uppercase font-bold">Cafe ID</p>
                <p class="text-sm font-mono font-bold text-orange-600">Loading...</p>
            </div>
            
            <p class="text-sm text-gray-500 mb-4">Enter your admin password</p>
            <input type="password" id="login-pin"
                class="w-full text-lg font-medium border-2 border-gray-200 rounded-xl outline-none focus:border-orange-600 px-4 py-3 mb-4 tracking-normal"
                placeholder="Enter password..." autocomplete="current-password">
            <button onclick="checkAdminLogin()"
                class="w-full bg-orange-600 text-white font-bold py-3 rounded-xl hover:bg-orange-700 shadow-lg transition transform active:scale-95">
                <i class="fas fa-unlock-alt mr-2"></i>Unlock Panel
            </button>
            <p id="login-error" class="text-red-500 text-xs font-bold mt-4 hidden"><i class="fas fa-lock"></i> Incorrect Password</p>
            
            <!-- Forgot Password -->
            <div class="mt-6 pt-4 border-t border-gray-100">
                <button onclick="openForgotPassword()" class="text-sm text-gray-400 hover:text-orange-600 transition">
                    <i class="fas fa-key mr-1"></i>Forgot Password?
                </button>
            </div>
        </div>
        
        <!-- Footer Branding -->
        <p class="text-xs text-gray-400 mt-6">Powered by <span class="font-bold text-orange-500">Orderly</span> Platform</p>
    </div>
    
    <!-- FORGOT PASSWORD MODAL -->
    <div id="forgot-password-modal" class="fixed inset-0 bg-black/60 z-[101] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden">
            <div class="p-4 border-b border-gray-100 bg-orange-50 flex justify-between items-center">
                <h3 class="font-bold text-lg text-orange-800"><i class="fas fa-key mr-2"></i>Reset Password</h3>
                <button onclick="closeForgotPassword()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-orange-100 rounded-full mx-auto mb-4 flex items-center justify-center">
                        <i class="fas fa-headset text-orange-600 text-2xl"></i>
                    </div>
                    <h4 class="font-bold text-gray-800 mb-2">Contact Super Admin</h4>
                    <p class="text-sm text-gray-500">Your password can only be reset by the Orderly Super Admin who onboarded your restaurant.</p>
                </div>
                
                <div class="space-y-3">
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <p class="text-xs text-gray-400 uppercase font-bold mb-1">Email Support</p>
                        <a href="mailto:support@orderly.in" class="text-orange-600 font-bold hover:underline">
                            <i class="fas fa-envelope mr-2"></i>support@orderly.in
                        </a>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <p class="text-xs text-gray-400 uppercase font-bold mb-1">WhatsApp Support</p>
                        <a href="https://wa.me/919999999999?text=Hi, I forgot my Orderly admin password. My Cafe ID is: " target="_blank" class="text-green-600 font-bold hover:underline" id="whatsapp-support-link">
                            <i class="fab fa-whatsapp mr-2"></i>Chat on WhatsApp
                        </a>
                    </div>
                </div>
                
                <div class="mt-6 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                    <p class="text-xs text-yellow-700"><i class="fas fa-info-circle mr-1"></i>Please have your <b>Cafe ID</b> ready when contacting support.</p>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50">
                <button onclick="closeForgotPassword()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

    <div class="flex h-screen overflow-hidden relative">

        <div id="sidebar-overlay" onclick="toggleSidebar()"
            class="fixed inset-0 bg-black/50 z-20 hidden md:hidden transition-opacity"></div>

        <aside id="sidebar"
            class="w-64 bg-white shadow-2xl z-30 flex flex-col absolute md:relative h-full -translate-x-full md:translate-x-0 border-r border-gray-100 transition-transform duration-300">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center h-20 shrink-0">
                <div>
                    <h1 class="text-2xl font-black text-gray-800 tracking-tight">Orderly<span
                            class="text-orange-600"> Mgmt</span></h1>
                    <p id="sidebar-tenant-id" class="text-[10px] text-orange-500 font-bold uppercase tracking-widest mt-1 truncate max-w-[150px]">Loading...</p>
                </div>
                <button onclick="toggleSidebar()" class="md:hidden text-gray-400 hover:text-red-500 transition"><i
                        class="fas fa-times text-xl"></i></button>
            </div>

            <nav class="flex-1 mt-4 px-3 space-y-1 overflow-y-auto">
                <!-- Main Section -->
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider px-3 mb-2">Business</p>
                
                <button onclick="switchTab('dashboard')" id="nav-dashboard"
                    class="nav-item active w-full text-left px-4 py-3 rounded-xl text-gray-600 flex items-center gap-3 transition-all duration-200">
                    <div class="w-8 h-8 rounded-lg bg-orange-100 flex items-center justify-center">
                        <i class="fas fa-chart-line text-orange-600 text-sm"></i>
                    </div>
                    <div>
                        <span class="font-semibold block text-sm">Dashboard</span>
                        <span class="text-[10px] text-gray-400">Overview & Analytics</span>
                    </div>
                </button>
                
                <button onclick="switchTab('live')" id="nav-live"
                    class="nav-item w-full text-left px-4 py-3 rounded-xl text-gray-600 flex items-center gap-3 transition-all duration-200">
                    <div class="w-8 h-8 rounded-lg bg-red-100 flex items-center justify-center relative">
                        <i class="fas fa-fire text-red-600 text-sm"></i>
                        <span class="absolute -top-1 -right-1 live-dot"></span>
                    </div>
                    <div>
                        <span class="font-semibold block text-sm">Live Kitchen</span>
                        <span class="text-[10px] text-gray-400">Active Orders</span>
                    </div>
                </button>
                
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider px-3 mb-2 mt-4">Management</p>
                
                <button onclick="switchTab('menu')" id="nav-menu"
                    class="nav-item w-full text-left px-4 py-3 rounded-xl text-gray-600 flex items-center gap-3 transition-all duration-200">
                    <div class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center">
                        <i class="fas fa-utensils text-purple-600 text-sm"></i>
                    </div>
                    <span class="font-semibold text-sm">Menu & Items</span>
                </button>
                
                <button onclick="switchTab('inventory')" id="nav-inventory"
                    class="nav-item w-full text-left px-4 py-3 rounded-xl text-gray-600 flex items-center gap-3 transition-all duration-200">
                    <div class="w-8 h-8 rounded-lg bg-amber-100 flex items-center justify-center">
                        <i class="fas fa-boxes text-amber-600 text-sm"></i>
                    </div>
                    <div>
                        <span class="font-semibold block text-sm">Inventory</span>
                        <span class="text-[10px] text-gray-400" id="low-stock-badge">Stock Management</span>
                    </div>
                </button>
                
                <button onclick="switchTab('offers')" id="nav-offers"
                    class="nav-item w-full text-left px-4 py-3 rounded-xl text-gray-600 flex items-center gap-3 transition-all duration-200">
                    <div class="w-8 h-8 rounded-lg bg-yellow-100 flex items-center justify-center">
                        <i class="fas fa-tags text-yellow-600 text-sm"></i>
                    </div>
                    <span class="font-semibold text-sm">Offers & Promos</span>
                </button>
                
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider px-3 mb-2 mt-4">Reports</p>
                
                <button onclick="switchTab('orders')" id="nav-orders"
                    class="nav-item w-full text-left px-4 py-3 rounded-xl text-gray-600 flex items-center gap-3 transition-all duration-200">
                    <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center">
                        <i class="fas fa-history text-blue-600 text-sm"></i>
                    </div>
                    <span class="font-semibold text-sm">Order History</span>
                </button>

                <hr class="border-gray-100 my-3">

                <button onclick="switchTab('settings')" id="nav-settings"
                    class="nav-item w-full text-left px-4 py-3 rounded-xl text-gray-600 flex items-center gap-3 transition-all duration-200">
                    <div class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">
                        <i class="fas fa-cog text-gray-600 text-sm"></i>
                    </div>
                    <span class="font-semibold text-sm">Settings</span>
                </button>
            </nav>

            <div class="p-4 border-t border-gray-100 bg-gray-50 shrink-0">
                <div class="flex items-center justify-between gap-3">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-full bg-orange-600 text-white flex items-center justify-center font-bold shadow-lg">
                            A</div>
                        <div>
                            <p class="text-sm font-bold text-gray-800">Admin</p>
                            <p class="text-xs text-green-600 font-bold flex items-center gap-1"><span
                                    class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Online</p>
                        </div>
                    </div>
                    <button onclick="adminLogout()" class="text-red-500 hover:bg-red-50 p-2 rounded-lg transition"
                        title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </aside>

        <div class="flex-1 flex flex-col h-screen overflow-hidden">
            <header class="bg-white shadow-sm p-4 flex justify-between items-center md:hidden z-10 shrink-0">
                <h1 class="text-xl font-bold">Orderly<span class="text-orange-600"> Mgmt</span></h1>
                <div class="flex items-center gap-2">
                    <button onclick="toggleSidebar()" class="text-gray-600 p-2 rounded hover:bg-gray-100"><i
                            class="fas fa-bars text-xl"></i></button>
                </div>
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50/50 p-4 md:p-6 relative">

                <!--?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½ -->
                <!-- Command Center - REAL-TIME ANALYTICS DASHBOARD -->
                <!--?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½?ï¿½ï¿½?ï¿½ -->
                <div id="section-dashboard" class="fade-in space-y-6 w-full max-w-7xl mx-auto">
                    
                    <!-- Header with Live Sales Ticker & Quick Actions -->
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                        <div>
                            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 flex items-center gap-3">
                                <i class="fas fa-bullseye text-orange-500"></i> Command Center
                                <span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded-full font-bold animate-pulse">LIVE</span>
                            </h2>
                            <p class="text-gray-500 text-sm mt-1 flex items-center gap-2">
                                <span class="live-dot"></span>
                                Real-time business overview | <span id="current-date">--/--/----</span>
                            </p>
                        </div>
                        
                        <!-- Quick Action Buttons -->
                        <div class="flex flex-wrap gap-2">
                            <button onclick="switchTab('live')" class="quick-action-btn px-4 py-2.5 rounded-xl font-semibold text-sm flex items-center gap-2">
                                <i class="fas fa-fire text-red-500"></i> Kitchen
                            </button>
                            <button onclick="switchTab('orders')" class="quick-action-btn px-4 py-2.5 rounded-xl font-semibold text-sm flex items-center gap-2">
                                <i class="fas fa-receipt text-green-600"></i> Orders
                            </button>
                            <button onclick="generateEODReport()" class="quick-action-btn px-4 py-2.5 rounded-xl font-semibold text-sm flex items-center gap-2">
                                <i class="fas fa-file-invoice text-purple-600"></i> EOD Report
                            </button>
                        </div>
                    </div>

                    <!-- LIVE SALES TICKER -->
                    <div class="glass-card rounded-2xl overflow-hidden border-2 border-green-200 bg-gradient-to-r from-green-50 to-emerald-50">
                        <div class="p-4">
                            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                                <div class="flex items-center gap-4">
                                    <div class="w-16 h-16 rounded-2xl bg-green-500 flex items-center justify-center text-white shadow-lg">
                                        <i class="fas fa-rupee-sign text-2xl"></i>
                                    </div>
                                    <div>
                                        <p class="text-xs text-green-600 font-bold uppercase tracking-wider">LIVE SALES TODAY</p>
                                        <h3 class="text-4xl md:text-5xl font-black text-green-700" id="live-sales-ticker">&#8377;0</h3>
                                        <p class="text-xs text-green-600 mt-1">
                                            <span id="live-orders-count">0</span> orders | Last update: <span id="last-update-time">--:--</span>
                                        </p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-6">
                                    <!-- Order Velocity -->
                                    <div class="text-center">
                                        <p class="text-xs text-gray-500 font-bold uppercase">Orders/Hour</p>
                                        <div class="flex items-center gap-2 mt-1">
                                            <span class="text-3xl font-black text-blue-600" id="orders-per-hour">0</span>
                                            <span class="text-xs px-2 py-1 rounded-full font-bold" id="velocity-badge">--</span>
                                        </div>
                                    </div>
                                    <!-- Avg Order Value -->
                                    <div class="text-center">
                                        <p class="text-xs text-gray-500 font-bold uppercase">Avg Order</p>
                                        <p class="text-3xl font-black text-purple-600 mt-1" id="avg-order-value">&#8377;0</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Grid -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="glass-card stat-card p-5 rounded-2xl cursor-pointer hover:ring-2 hover:ring-green-300" onclick="switchTab('orders')">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs text-gray-500 font-semibold uppercase tracking-wide">Today's Revenue</p>
                                    <h3 class="text-2xl md:text-3xl font-black text-gray-800 mt-1" id="stat-today-revenue">&#8377;0</h3>
                                    <p class="text-xs text-green-600 font-semibold mt-1 flex items-center gap-1" id="stat-revenue-change">
                                        <i class="fas fa-arrow-up"></i> <span>+0%</span> vs yesterday
                                    </p>
                                </div>
                                <div class="stat-card-icon gradient-success text-white">
                                    <i class="fas fa-rupee-sign"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass-card stat-card p-5 rounded-2xl cursor-pointer hover:ring-2 hover:ring-blue-300" onclick="switchTab('orders')">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs text-gray-500 font-semibold uppercase tracking-wide">Today's Orders</p>
                                    <h3 class="text-2xl md:text-3xl font-black text-gray-800 mt-1" id="stat-today-orders">0</h3>
                                    <p class="text-xs text-blue-600 font-semibold mt-1" id="stat-orders-info">
                                        <i class="fas fa-chart-line"></i> <span id="stat-avg-order">&#8377;0</span> avg value
                                    </p>
                                </div>
                                <div class="stat-card-icon gradient-info text-white">
                                    <i class="fas fa-shopping-bag"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass-card stat-card p-5 rounded-2xl cursor-pointer hover:ring-2 hover:ring-orange-300" onclick="switchTab('live')">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs text-gray-500 font-semibold uppercase tracking-wide">Active Orders</p>
                                    <h3 class="text-2xl md:text-3xl font-black text-gray-800 mt-1" id="stat-active-orders">0</h3>
                                    <p class="text-xs text-orange-600 font-semibold mt-1">
                                        <span id="stat-pending">0</span> pending<span id="stat-prep">0</span> cooking
                                    </p>
                                </div>
                                <div class="stat-card-icon gradient-warning text-white">
                                    <i class="fas fa-fire-alt"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass-card stat-card p-5 rounded-2xl cursor-pointer hover:ring-2 hover:ring-purple-300" onclick="switchTab('menu')">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs text-gray-500 font-semibold uppercase tracking-wide">Menu Items</p>
                                    <h3 class="text-2xl md:text-3xl font-black text-gray-800 mt-1" id="stat-today-customers">0</h3>
                                    <p class="text-xs text-purple-600 font-semibold mt-1" id="stat-repeat-customers">
                                        <i class="fas fa-utensils"></i> <span>Active items</span>
                                    </p>
                                </div>
                                <div class="stat-card-icon gradient-purple text-white">
                                    <i class="fas fa-utensils"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!--?ï¿½ ALERTS PANEL -->
                    <div id="alerts-panel" class="hidden">
                        <div class="glass-card rounded-2xl overflow-hidden border-2 border-red-200 bg-gradient-to-r from-red-50 to-orange-50">
                            <div class="p-4 border-b border-red-100 flex justify-between items-center">
                                <h3 class="font-bold text-red-700 flex items-center gap-2">
                                    <i class="fas fa-exclamation-triangle animate-pulse"></i> Active Alerts
                                </h3>
                                <button onclick="dismissAllAlerts()" class="text-xs text-red-600 font-bold hover:underline">Dismiss All</button>
                            </div>
                            <div id="alerts-list" class="p-4 space-y-2 max-h-40 overflow-y-auto">
                                <!-- Alerts will be populated dynamically -->
                            </div>
                        </div>
                    </div>

                </div>

                <!-- LIVE KITCHEN SECTION (Renamed from old dashboard) -->
                <div id="section-live" class="hide-section fade-in space-y-6 w-full max-w-7xl mx-auto">
                    <div class="flex flex-col md:flex-row justify-between items-end gap-4">
                        <div>
                            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 flex items-center gap-3">
                                <span class="live-dot"></span>
                                Live Kitchen
                            </h2>
                            <p class="text-gray-500 text-sm mt-1">Order leaves when (Kitchen Completed + Paid)</p>
                        </div>
                        <div class="flex gap-2">
                            <span class="text-xs font-mono bg-white border border-gray-200 px-3 py-1.5 rounded-lg text-gray-600 shadow-sm" id="kitchen-date">--</span>
                        </div>
                    </div>

                    <!-- Kitchen Stats -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="glass-card p-4 rounded-xl text-center border-l-4 border-red-500">
                            <p class="text-xs text-gray-500 font-bold uppercase">Pending</p>
                            <h3 class="text-3xl font-black text-red-600 mt-1" id="kitchen-stat-pending">0</h3>
                        </div>
                        <div class="glass-card p-4 rounded-xl text-center border-l-4 border-orange-500">
                            <p class="text-xs text-gray-500 font-bold uppercase">Cooking</p>
                            <h3 class="text-3xl font-black text-orange-600 mt-1" id="kitchen-stat-prep">0</h3>
                        </div>
                        <div class="glass-card p-4 rounded-xl text-center border-l-4 border-green-500">
                            <p class="text-xs text-gray-500 font-bold uppercase">Ready</p>
                            <h3 class="text-3xl font-black text-green-600 mt-1" id="stat-ready">0</h3>
                        </div>
                        <div class="glass-card p-4 rounded-xl text-center border-l-4 border-blue-500">
                            <p class="text-xs text-gray-500 font-bold uppercase">Served/Unpaid</p>
                            <h3 class="text-3xl font-black text-blue-600 mt-1" id="stat-completed">0</h3>
                        </div>
                    </div>

                    <!-- Live Orders Table -->
                    <div class="glass-card rounded-2xl overflow-hidden">
                        <div class="p-5 border-b border-gray-100 bg-gradient-to-r from-red-50 to-orange-50 flex justify-between items-center">
                            <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                                <span class="relative flex h-3 w-3">
                                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                    <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                                </span>
                                Incoming Live Orders
                            </h3>
                        </div>
                        <div class="table-container">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-white text-gray-400 text-xs uppercase font-bold tracking-wider border-b border-gray-100">
                                    <tr>
                                        <th class="p-4">Order #</th>
                                        <th class="p-4">Type</th>
                                        <th class="p-4">Customer</th>
                                        <th class="p-4 w-1/3">Items</th>
                                        <th class="p-4">Payment</th>
                                        <th class="p-4">Status</th>
                                        <th class="p-4 text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="live-orders-table" class="text-sm divide-y divide-gray-50">
                                </tbody>
                            </table>
                            <div id="no-live-orders" class="hidden py-12 text-center text-gray-400">
                                <i class="fas fa-check-circle text-4xl text-green-300 mb-3"></i>
                                <p>Kitchen is Clear!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="section-menu" class="hide-section fade-in space-y-6 w-full max-w-7xl mx-auto">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Dynamic Menu Management</h2>
                            <p class="text-sm text-gray-500">Toggle items, set prices, manage add-ons & generate QR codes</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="toggleAddonModal()"
                                class="text-sm bg-purple-100 text-purple-700 px-4 py-2 rounded-lg font-bold hover:bg-purple-200">
                                <i class="fas fa-cubes"></i> Add-ons
                            </button>
                            <button onclick="openQRCodeModal()"
                                class="text-sm bg-blue-100 text-blue-700 px-4 py-2 rounded-lg font-bold hover:bg-blue-200">
                                <i class="fas fa-qrcode"></i> Generate QR
                            </button>
                            <button onclick="bulkToggleOutOfStock()"
                                class="text-sm bg-red-100 text-red-700 px-4 py-2 rounded-lg font-bold hover:bg-red-200">
                                <i class="fas fa-ban"></i> Bulk Toggle
                            </button>
                        </div>
                    </div>

                    <!-- Quick Stats & Filter -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="glass-card p-4 rounded-xl text-center">
                            <p class="text-xs text-gray-500 font-bold uppercase">Total Items</p>
                            <p class="text-2xl font-black text-gray-800" id="menu-total-items">0</p>
                        </div>
                        <div class="glass-card p-4 rounded-xl text-center border-2 border-green-200 bg-green-50">
                            <p class="text-xs text-green-600 font-bold uppercase">Available</p>
                            <p class="text-2xl font-black text-green-600" id="menu-available-items">0</p>
                        </div>
                        <div class="glass-card p-4 rounded-xl text-center border-2 border-red-200 bg-red-50">
                            <p class="text-xs text-red-600 font-bold uppercase">Stock</p>
                            <p class="text-2xl font-black text-red-600" id="menu-outofstock-items">0</p>
                        </div>
                        <div class="glass-card p-4 rounded-xl text-center border-2 border-yellow-200 bg-yellow-50">
                            <p class="text-xs text-yellow-600 font-bold uppercase">Best Sellers</p>
                            <p class="text-2xl font-black text-yellow-600" id="menu-bestseller-items">0</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div id="menu-form-card"
                            class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit sticky top-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="font-bold text-lg text-gray-800" id="menu-form-title"><i
                                        class="fas fa-plus-circle text-orange-600"></i> Add Item</h3>
                                <button onclick="resetMenuForm()" id="btn-cancel-edit"
                                    class="hidden text-xs text-red-600 font-bold">Cancel</button>
                            </div>
                            <div class="space-y-4">
                                <input type="hidden" id="m-edit-id">
                                <input type="text" id="m-name"
                                    class="w-full border bg-gray-50 p-3 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none"
                                    placeholder="Item Name">

                                <div class="grid grid-cols-2 gap-4">
                                    <div class="col-span-1">
                                        <label class="text-[10px] font-bold text-gray-500 uppercase">Display
                                            Price</label>
                                        <input type="number" id="m-price"
                                            class="w-full border bg-gray-50 p-3 rounded-xl outline-none border-orange-200"
                                            placeholder="e.g. 119">
                                    </div>
                                    <div class="col-span-1">
                                        <label class="text-[10px] font-bold text-gray-500 uppercase">Category</label>
                                        <select id="m-cat" class="w-full border bg-gray-50 p-3 rounded-xl outline-none">
                                            <option value="Pizza">Pizza</option>
                                            <option value="Burger">Burger</option>
                                            <option value="Pasta">Pasta</option>
                                            <option value="Sandwich">Sandwich</option>
                                            <option value="Drinks">Drinks</option>
                                            <option value="Dessert">Dessert</option>
                                            <option value="Non-Veg">Non-Veg</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Dine-in vs Delivery Pricing -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-[10px] font-bold text-gray-500 uppercase">Delivery Price</label>
                                        <input type="number" id="m-delivery-price"
                                            class="w-full border bg-gray-50 p-3 rounded-xl outline-none"
                                            placeholder="Rs. (optional, +Rs. for delivery)">
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-bold text-gray-500 uppercase">Preparation Time</label>
                                        <input type="number" id="m-prep-time"
                                            class="w-full border bg-gray-50 p-3 rounded-xl outline-none"
                                            placeholder="Minutes (e.g. 15)">
                                    </div>
                                </div>

                                <!-- Item Availability Toggle -->
                                <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-200">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-toggle-on text-green-600"></i>
                                        <label for="m-available" class="text-sm font-bold text-gray-700 cursor-pointer select-none">Item Available</label>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="m-available" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                    </label>
                                </div>

                                <div
                                    class="flex items-center gap-2 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                                    <input type="checkbox" id="m-bestseller"
                                        class="w-5 h-5 accent-orange-600 cursor-pointer">
                                    <label for="m-bestseller"
                                        class="text-sm font-bold text-gray-700 cursor-pointer select-none"><i
                                            class="fas fa-star text-yellow-500"></i> Mark as Best Seller</label>
                                </div>

                                <div class="border border-gray-200 p-3 rounded-xl bg-gray-50">
                                    <label class="text-xs font-bold text-gray-500 uppercase">Multi-Size Variants</label>
                                    <div id="size-container" class="space-y-2 mt-2"></div>
                                    <button onclick="addSizeRow()" class="mt-2 text-xs text-blue-600 font-bold">+ Add
                                        Size Option</button>
                                </div>
                                <div class="border border-gray-200 p-3 rounded-xl bg-gray-50 max-h-40 overflow-y-auto">
                                    <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Link
                                        Add-ons</label>
                                    <div id="addon-selector-list" class="space-y-2">
                                        <p class="text-xs text-gray-400">Loading...</p>
                                    </div>
                                </div>
                                <textarea id="m-desc" rows="2"
                                    class="w-full border bg-gray-50 p-3 rounded-xl outline-none"
                                    placeholder="Description..."></textarea>
                                <input type="text" id="m-img"
                                    class="w-full border bg-gray-50 p-3 rounded-xl outline-none"
                                    placeholder="Image URL">
                                <button onclick="saveMenuitem()" id="btn-save-item"
                                    class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition-all active:scale-95">Save
                                    Item</button>
                            </div>
                        </div>
                        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <div class="overflow-y-auto max-h-[700px] custom-scrollbar" id="menu-list-container">
                                <p class="text-center text-gray-400 py-10">Loading menu...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="section-offers" class="hide-section fade-in space-y-6 w-full max-w-7xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800">Offers & Banners</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="offers-container"></div>
                </div>

                <div id="section-orders" class="hide-section fade-in w-full max-w-7xl mx-auto">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Order History</h2>
                            <p class="text-xs text-gray-500">Shows ONLY (Paid + Kitchen Completed) orders.</p>
                        </div>
                        <div class="flex items-center gap-2 bg-white p-2 rounded-lg border border-gray-200 shadow-sm">
                            <span class="text-xs text-gray-500 font-bold uppercase">Filter Date:</span>
                            <input type="date" id="history-date-filter" onchange="filterHistoryByDate()"
                                class="outline-none text-sm text-gray-700">
                            <button onclick="clearHistoryFilter()"
                                class="text-xs text-red-500 font-bold hover:underline">Clear</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="table-container">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-bold">
                                    <tr>
                                        <th class="p-4">ID</th>
                                        <th class="p-4">Date/Time</th>
                                        <th class="p-4">Customer</th>
                                        <th class="p-4">Items</th>
                                        <th class="p-4">Amount</th>
                                        <th class="p-4">Rating</th>
                                        <th class="p-4">Final Status</th>
                                    </tr>
                                </thead>
                                <tbody id="history-orders-table"
                                    class="text-sm divide-y divide-gray-50 table-row-mobile"></tbody>
                            </table>
                            <div id="no-history-orders" class="hidden p-12 text-center text-gray-400">No completed &
                                paid orders found.</div>
                        </div>
                        <button id="btn-load-more-history" onclick="renderHistoryBatch()"
                            class="btn-load-more hidden">Load More Orders <i class="fas fa-chevron-down"></i></button>
                    </div>
                </div>

                <div id="section-settings" class="hide-section fade-in space-y-6 w-full max-w-7xl mx-auto">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">Admin Settings</h2>
                        <div class="flex gap-2">
                            <button onclick="openActivityLogsModal()" class="text-sm bg-slate-100 text-slate-700 px-4 py-2 rounded-lg font-bold hover:bg-slate-200">
                                <i class="fas fa-history"></i> Activity Logs
                            </button>
                            <button onclick="openBranchSelector()" class="text-sm bg-blue-100 text-blue-700 px-4 py-2 rounded-lg font-bold hover:bg-blue-200">
                                <i class="fas fa-store"></i> Switch Branch
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-lg mb-4 text-gray-800"><i
                                    class="fas fa-paint-brush text-orange-600"></i> Appearance</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <button onclick="setTheme('orange')"
                                    class="p-3 rounded-lg border-2 border-orange-500 bg-orange-50 text-orange-700 font-bold text-sm">Default
                                    Orange</button>
                                <button onclick="setTheme('blue')"
                                    class="p-3 rounded-lg border border-gray-200 hover:bg-blue-50 hover:border-blue-500 hover:text-blue-700 font-bold text-sm">Cool
                                    Blue</button>
                                <button onclick="setTheme('green')"
                                    class="p-3 rounded-lg border border-gray-200 hover:bg-green-50 hover:border-green-500 hover:text-green-700 font-bold text-sm">Nature
                                    Green</button>
                                <button onclick="setTheme('dark')"
                                    class="p-3 rounded-lg border border-gray-800 bg-gray-800 text-white font-bold text-sm">Dark
                                    Mode</button>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-lg mb-4 text-gray-800"><i
                                    class="fas fa-shield-alt text-red-600"></i> Security</h3>
                            <div class="space-y-3">
                                <label class="text-xs font-bold text-gray-500 uppercase">Change Dashboard Password</label>
                                <input type="password" id="new-admin-pin" placeholder="New password (min 4 chars)"
                                    class="w-full p-3 border rounded-lg outline-none focus:border-orange-500">
                                <button onclick="updateAdminPin()"
                                    class="w-full bg-gray-800 text-white font-bold py-2 rounded-lg hover:bg-black transition">Update
                                    PIN</button>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-lg mb-4 text-gray-800"><i
                                    class="fas fa-user-tie text-blue-600"></i> Owner Details</h3>
                            <div class="space-y-3">
                                <input type="text" id="setting-owner-name" placeholder="Owner Name"
                                    class="w-full p-3 border rounded-lg outline-none">
                                <input type="text" id="setting-owner-phone" placeholder="Support Phone"
                                    class="w-full p-3 border rounded-lg outline-none">
                                <button onclick="saveOwnerDetails()"
                                    class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700">Save
                                    Details</button>
                            </div>
                        </div>

                        <!-- Role-Based Access Control -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-lg mb-4 text-gray-800"><i class="fas fa-user-shield text-purple-600"></i> Role-Based Access (RBAC)</h3>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div>
                                        <p class="font-bold text-sm">Manager</p>
                                        <p class="text-xs text-gray-500">Can edit orders, apply discounts</p>
                                    </div>
                                    <button onclick="manageRole('manager')" class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded font-bold">Manage</button>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div>
                                        <p class="font-bold text-sm">Waiter</p>
                                        <p class="text-xs text-gray-500">Can take orders only</p>
                                    </div>
                                    <button onclick="manageRole('waiter')" class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded font-bold">Manage</button>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div>
                                        <p class="font-bold text-sm">Cashier</p>
                                        <p class="text-xs text-gray-500">Can process payments</p>
                                    </div>
                                    <button onclick="manageRole('cashier')" class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded font-bold">Manage</button>
                                </div>
                                <button onclick="openRBACModal()" class="w-full mt-2 text-sm text-purple-600 font-bold hover:underline">+ Add New Role</button>
                            </div>
                        </div>

                        <!-- KOT Printer Settings -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-lg mb-4 text-gray-800"><i class="fas fa-print text-green-600"></i> KOT Routing</h3>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div>
                                        <p class="font-bold text-sm">Kitchen Printer</p>
                                        <p class="text-xs text-gray-500">Food items</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="kot-kitchen" class="sr-only peer" checked>
                                        <div class="w-9 h-5 bg-gray-200 peer-focus:ring-2 peer-focus:ring-green-300 rounded-full peer peer-checked:bg-green-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-4"></div>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div>
                                        <p class="font-bold text-sm">Bar Printer</p>
                                        <p class="text-xs text-gray-500">Drinks & beverages</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="kot-bar" class="sr-only peer">
                                        <div class="w-9 h-5 bg-gray-200 peer-focus:ring-2 peer-focus:ring-green-300 rounded-full peer peer-checked:bg-green-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-4"></div>
                                    </label>
                                </div>
                                <button onclick="saveKOTSettings()" class="w-full bg-green-600 text-white font-bold py-2 rounded-lg hover:bg-green-700">Save KOT Settings</button>
                            </div>
                        </div>

                        <!-- Tax/GST Settings -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-lg mb-4 text-gray-800"><i class="fas fa-file-invoice-dollar text-amber-600"></i> Tax & Fees</h3>
                            <div class="space-y-3">
                                <!-- Tax Enable Toggle -->
                                <div class="flex items-center justify-between p-3 bg-amber-50 rounded-lg border border-amber-200">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-percentage text-amber-600"></i>
                                        <label for="setting-tax-enabled" class="text-sm font-bold text-gray-700 cursor-pointer select-none">Enable Tax</label>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="setting-tax-enabled" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-amber-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-600"></div>
                                    </label>
                                </div>
                                
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase">Tax Percentage (%)</label>
                                    <input type="number" id="setting-tax-percent" placeholder="5" value="5" class="w-full p-3 border rounded-lg outline-none">
                                </div>
                                
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase">Convenience Fee (?)</label>
                                    <input type="number" id="setting-convenience-fee" placeholder="1.98" value="1.98" step="0.01" class="w-full p-3 border rounded-lg outline-none">
                                </div>
                                
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase">GSTIN Number</label>
                                    <input type="text" id="setting-gstin" placeholder="e.g., 22AAAAA0000A1Z5" class="w-full p-3 border rounded-lg outline-none">
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-xs font-bold text-gray-500 uppercase">CGST %</label>
                                        <input type="number" id="setting-cgst" placeholder="2.5" class="w-full p-2 border rounded-lg outline-none">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-gray-500 uppercase">SGST %</label>
                                        <input type="number" id="setting-sgst" placeholder="2.5" class="w-full p-2 border rounded-lg outline-none">
                                    </div>
                                </div>
                                <button onclick="saveTaxSettings()" class="w-full bg-amber-600 text-white font-bold py-2 rounded-lg hover:bg-amber-700">Save Tax & Fee Settings</button>
                                <button onclick="downloadGSTReport()" class="w-full border border-amber-200 text-amber-700 font-bold py-2 rounded-lg hover:bg-amber-50">
                                    <i class="fas fa-download mr-1"></i> Download GST Report
                                </button>
                            </div>
                        </div>

                        <!-- Feature Toggles -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-lg mb-4 text-gray-800"><i class="fas fa-magic text-purple-600"></i> Premium Features</h3>
                            <p class="text-xs text-gray-500 mb-4">Features enabled by Super Admin. Contact support to enable more features.</p>
                            <div class="space-y-3">
                                
                                <!-- Spin Wheel Toggle -->
                                <div id="spinWheel-feature-row" class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-dharmachakra text-yellow-600 text-xl"></i>
                                        <div>
                                            <label for="setting-spin-wheel" class="text-sm font-bold text-gray-700 cursor-pointer select-none block">Spin Wheel</label>
                                            <span class="text-[10px] text-gray-400">Show spin wheel after payment</span>
                                        </div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="setting-spin-wheel" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-yellow-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-500"></div>
                                    </label>
                                </div>
                                
                                <!-- Donations Toggle -->
                                <div id="donations-feature-row" class="flex items-center justify-between p-3 bg-pink-50 rounded-lg border border-pink-200">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-heart text-pink-600 text-xl"></i>
                                        <div>
                                            <label for="setting-donations" class="text-sm font-bold text-gray-700 cursor-pointer select-none block">Donations</label>
                                            <span class="text-[10px] text-gray-400">Allow customer donations</span>
                                        </div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="setting-donations" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                                    </label>
                                </div>
                                
                                <!-- Promo Ads Toggle -->
                                <div id="promoAds-feature-row" class="flex items-center justify-between p-3 bg-blue-50 rounded-lg border border-blue-200">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-bullhorn text-blue-600 text-xl"></i>
                                        <div>
                                            <label for="setting-promo-ads" class="text-sm font-bold text-gray-700 cursor-pointer select-none block">Promo Ads</label>
                                            <span class="text-[10px] text-gray-400">Show promotional banners</span>
                                        </div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="setting-promo-ads" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                                    </label>
                                </div>
                                
                                <button onclick="saveFeatureSettings()" class="w-full bg-purple-600 text-white font-bold py-2 rounded-lg hover:bg-purple-700">
                                    <i class="fas fa-save mr-1"></i> Save Feature Settings
                                </button>
                            </div>
                        </div>

                        <!-- Promo Ad Configuration -->
                        <div id="promo-ad-config" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-lg mb-4 text-gray-800"><i class="fas fa-bullhorn text-blue-600"></i> Promotional Ad</h3>
                            <p class="text-xs text-gray-500 mb-4">Configure the promotional banner shown to customers after order</p>
                            <div class="space-y-3">
                                <!-- Enable Toggle -->
                                <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg border border-blue-200">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-toggle-on text-blue-600"></i>
                                        <label for="promo-ad-enabled" class="text-sm font-bold text-gray-700 cursor-pointer select-none">Enable Promo Ad</label>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="promo-ad-enabled" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                                    </label>
                                </div>
                                
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase">Ad Title</label>
                                    <input type="text" id="promo-ad-title" placeholder="e.g., Special Offer!" class="w-full p-3 border rounded-lg outline-none">
                                </div>
                                
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase">Description</label>
                                    <input type="text" id="promo-ad-description" placeholder="e.g., Get 20% off on your next order!" class="w-full p-3 border rounded-lg outline-none">
                                </div>
                                
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase">Button Text</label>
                                    <input type="text" id="promo-ad-button" placeholder="e.g., View Offer" class="w-full p-3 border rounded-lg outline-none">
                                </div>
                                
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase">Link URL (optional)</label>
                                    <input type="url" id="promo-ad-link" placeholder="https://..." class="w-full p-3 border rounded-lg outline-none">
                                </div>
                                
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-xs font-bold text-gray-500 uppercase">Background Color</label>
                                        <input type="color" id="promo-ad-bg-color" value="#7c3aed" class="w-full h-10 rounded-lg cursor-pointer">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-gray-500 uppercase">Text Color</label>
                                        <input type="color" id="promo-ad-text-color" value="#ffffff" class="w-full h-10 rounded-lg cursor-pointer">
                                    </div>
                                </div>
                                
                                <button onclick="savePromoAdSettings()" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-save mr-1"></i> Save Promo Ad
                                </button>
                            </div>
                        </div>

                        <!-- Privacy Policy -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-lg mb-4 text-gray-800"><i class="fas fa-shield-alt text-indigo-600"></i> Privacy Policy</h3>
                            <div class="space-y-3">
                                <p class="text-sm text-gray-600">View our comprehensive privacy policy that protects your business and customer data.</p>
                                <button onclick="openPrivacyPolicy()" class="w-full bg-indigo-600 text-white font-bold py-2 rounded-lg hover:bg-indigo-700">
                                    <i class="fas fa-eye mr-1"></i> View Privacy Policy
                                </button>
                            </div>
                        </div>

                        <!-- Terms & Conditions -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-lg mb-4 text-gray-800"><i class="fas fa-file-contract text-teal-600"></i> Terms & Conditions</h3>
                            <div class="space-y-3">
                                <p class="text-sm text-gray-600">Review the terms of service that govern your use of Orderly platform.</p>
                                <button onclick="openTermsConditions()" class="w-full bg-teal-600 text-white font-bold py-2 rounded-lg hover:bg-teal-700">
                                    <i class="fas fa-eye mr-1"></i> View Terms & Conditions
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Website Settings Section -->
                    <div class="mt-8 border-t pt-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-6"><i class="fas fa-globe text-orange-600 mr-2"></i> Customer Website Settings</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            
                            <!-- Brand Settings -->
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                <h3 class="font-bold text-lg mb-4 text-gray-800"><i class="fas fa-store text-orange-600"></i> Brand Details</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-xs font-bold text-gray-500 uppercase">Brand Name</label>
                                        <input type="text" id="cust-brand-name" placeholder="e.g., Wow Cafe" class="w-full p-3 border rounded-lg outline-none focus:border-orange-500">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-gray-500 uppercase">Tagline</label>
                                        <input type="text" id="cust-tagline" placeholder="e.g., Delicious Moments" class="w-full p-3 border rounded-lg outline-none focus:border-orange-500">
                                    </div>
                                    <button onclick="saveBrandSettings()" class="w-full bg-orange-600 text-white font-bold py-2 rounded-lg hover:bg-orange-700">
                                        <i class="fas fa-save mr-1"></i> Save Brand
                                    </button>
                                </div>
                            </div>

                            <!-- Contact Details -->
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                <h3 class="font-bold text-lg mb-4 text-gray-800"><i class="fas fa-phone-alt text-green-600"></i> Contact Details</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-xs font-bold text-gray-500 uppercase">Phone Number</label>
                                        <input type="tel" id="cust-phone" placeholder="9876543210" class="w-full p-3 border rounded-lg outline-none focus:border-green-500">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-gray-500 uppercase">WhatsApp Number</label>
                                        <input type="tel" id="cust-whatsapp" placeholder="9876543210" class="w-full p-3 border rounded-lg outline-none focus:border-green-500">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-gray-500 uppercase">Email</label>
                                        <input type="email" id="cust-email" placeholder="contact@example.com" class="w-full p-3 border rounded-lg outline-none focus:border-green-500">
                                    </div>
                                    <button onclick="saveContactSettings()" class="w-full bg-green-600 text-white font-bold py-2 rounded-lg hover:bg-green-700">
                                        <i class="fas fa-save mr-1"></i> Save Contact
                                    </button>
                                </div>
                            </div>

                            <!-- Address Details -->
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                <h3 class="font-bold text-lg mb-4 text-gray-800"><i class="fas fa-map-marker-alt text-red-600"></i> Address</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-xs font-bold text-gray-500 uppercase">Full Address</label>
                                        <textarea id="cust-address" rows="2" placeholder="Shop No. 1, Main Road, City" class="w-full p-3 border rounded-lg outline-none focus:border-red-500"></textarea>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="text-xs font-bold text-gray-500 uppercase">City</label>
                                            <input type="text" id="cust-city" placeholder="City" class="w-full p-3 border rounded-lg outline-none">
                                        </div>
                                        <div>
                                            <label class="text-xs font-bold text-gray-500 uppercase">Pincode</label>
                                            <input type="text" id="cust-pincode" placeholder="123456" class="w-full p-3 border rounded-lg outline-none">
                                        </div>
                                    </div>
                                    <button onclick="saveAddressSettings()" class="w-full bg-red-600 text-white font-bold py-2 rounded-lg hover:bg-red-700">
                                        <i class="fas fa-save mr-1"></i> Save Address
                                    </button>
                                </div>
                            </div>

                            <!-- Fees & Charges -->
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                <h3 class="font-bold text-lg mb-4 text-gray-800"><i class="fas fa-rupee-sign text-yellow-600"></i> Fees & Charges</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-xs font-bold text-gray-500 uppercase">Delivery Charge (₹)</label>
                                        <input type="number" id="cust-delivery-charge" placeholder="30" class="w-full p-3 border rounded-lg outline-none focus:border-yellow-500">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-gray-500 uppercase">Packaging Charge (₹)</label>
                                        <input type="number" id="cust-packaging-charge" placeholder="10" class="w-full p-3 border rounded-lg outline-none focus:border-yellow-500">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-gray-500 uppercase">Min Order for Free Delivery (₹)</label>
                                        <input type="number" id="cust-free-delivery-min" placeholder="500" class="w-full p-3 border rounded-lg outline-none focus:border-yellow-500">
                                    </div>
                                    <button onclick="saveChargesSettings()" class="w-full bg-yellow-600 text-white font-bold py-2 rounded-lg hover:bg-yellow-700">
                                        <i class="fas fa-save mr-1"></i> Save Charges
                                    </button>
                                </div>
                            </div>

                            <!-- Payment QR Code -->
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                <h3 class="font-bold text-lg mb-4 text-gray-800"><i class="fas fa-qrcode text-purple-600"></i> Payment QR Code</h3>
                                <div class="space-y-3">
                                    <div class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center">
                                        <div id="qr-preview" class="mb-3">
                                            <div class="w-32 h-32 bg-gray-100 rounded-lg mx-auto flex items-center justify-center">
                                                <i class="fas fa-qrcode text-4xl text-gray-300"></i>
                                            </div>
                                            <p class="text-xs text-gray-400 mt-2">No QR uploaded</p>
                                        </div>
                                        <input type="file" id="qr-upload" accept="image/*" class="hidden" onchange="previewQRCode(event)">
                                        <button onclick="document.getElementById('qr-upload').click()" class="text-sm bg-purple-100 text-purple-700 px-4 py-2 rounded-lg font-bold hover:bg-purple-200">
                                            <i class="fas fa-upload mr-1"></i> Upload QR
                                        </button>
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-gray-500 uppercase">UPI ID</label>
                                        <input type="text" id="cust-upi-id" placeholder="yourname@upi" class="w-full p-3 border rounded-lg outline-none focus:border-purple-500">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-gray-500 uppercase">Payment Receiver Name</label>
                                        <input type="text" id="cust-payment-name" placeholder="Business Name" class="w-full p-3 border rounded-lg outline-none focus:border-purple-500">
                                    </div>
                                    <button onclick="savePaymentSettings()" class="w-full bg-purple-600 text-white font-bold py-2 rounded-lg hover:bg-purple-700">
                                        <i class="fas fa-save mr-1"></i> Save Payment Settings
                                    </button>
                                </div>
                            </div>

                            <!-- Service Fees (Customer Side) -->
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                <h3 class="font-bold text-lg mb-4 text-gray-800"><i class="fas fa-percent text-blue-600"></i> Customer Fees</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-xs font-bold text-gray-500 uppercase">Service Fee (₹)</label>
                                        <input type="number" id="cust-service-fee" placeholder="5" step="0.01" class="w-full p-3 border rounded-lg outline-none focus:border-blue-500">
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg border border-blue-200">
                                        <div class="flex items-center gap-2">
                                            <i class="fas fa-toggle-on text-blue-600"></i>
                                            <label for="cust-show-fees" class="text-sm font-bold text-gray-700 cursor-pointer select-none">Show Fee Breakdown</label>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="cust-show-fees" class="sr-only peer" checked>
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                                        </label>
                                    </div>
                                    <button onclick="saveCustomerFeesSettings()" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700">
                                        <i class="fas fa-save mr-1"></i> Save Customer Fees
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- REPORTS SECTION -->

                        <!-- Spin Wheel Prize Modal (Admin) -->
                        <div id="wheel-prize-modal" class="hidden fixed inset-0 z-[1000] flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
                            <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl relative animate-scale-in">
                                <button onclick="closeWheelPrizeModal()" class="absolute top-4 right-4 w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-red-50 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
                                <h2 class="text-xl font-bold text-purple-700 mb-4 flex items-center gap-2"><i class="fas fa-dharmachakra"></i> Add/Edit Prize</h2>
                                <form id="wheel-prize-form" onsubmit="saveWheelPrize(); return false;" class="space-y-4">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 mb-1">Prize Text</label>
                                        <input type="text" id="prize-text" class="w-full p-3 border rounded-lg outline-none" placeholder="e.g., 10% OFF, ?50 OFF, Try Again" required>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-xs font-bold text-gray-500 mb-1">Value</label>
                                            <input type="number" id="prize-value" class="w-full p-3 border rounded-lg outline-none" placeholder="e.g., 10 or 50" required>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-bold text-gray-500 mb-1">Type</label>
                                            <select id="prize-type" class="w-full p-3 border rounded-lg outline-none">
                                                <option value="percent">Percent (%)</option>
                                                <option value="flat">Flat (?)</option>
                                                <option value="none">No Prize (Try Again)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 mb-1">Segment Color</label>
                                        <input type="color" id="prize-color" class="w-16 h-10 rounded-lg cursor-pointer" value="#a78bfa">
                                    </div>
                                    <div class="flex gap-2 justify-end">
                                        <button type="button" onclick="closeWheelPrizeModal()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-bold hover:bg-gray-300">Cancel</button>
                                        <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-purple-700">Save Prize</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                <!-- INVENTORY MANAGEMENT SECTION -->
                <div id="section-inventory" class="hide-section fade-in space-y-6 w-full max-w-7xl mx-auto">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Inventory Management</h2>
                            <p class="text-sm text-gray-500">Track stock levels, set alerts & manage ingredients</p>
                        </div>
                        <button onclick="openInventoryModal()" class="px-4 py-2 bg-amber-600 text-white rounded-xl font-bold hover:bg-amber-700 shadow-lg">
                            <i class="fas fa-plus mr-2"></i>Add Item
                        </button>
                    </div>

                    <!-- Inventory Stats -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="glass-card p-4 rounded-xl border-l-4 border-amber-500">
                            <p class="text-xs text-gray-500 font-bold uppercase">Total Items</p>
                            <h3 class="text-2xl font-black text-gray-800 mt-1" id="inv-total-items">0</h3>
                        </div>
                        <div class="glass-card p-4 rounded-xl border-l-4 border-red-500">
                            <p class="text-xs text-gray-500 font-bold uppercase">Stock</p>
                            <h3 class="text-2xl font-black text-red-600 mt-1" id="inv-low-stock">0</h3>
                        </div>
                        <div class="glass-card p-4 rounded-xl border-l-4 border-gray-500">
                            <p class="text-xs text-gray-500 font-bold uppercase">Stock</p>
                            <h3 class="text-2xl font-black text-gray-600 mt-1" id="inv-out-stock">0</h3>
                        </div>
                        <div class="glass-card p-4 rounded-xl border-l-4 border-green-500">
                            <p class="text-xs text-gray-500 font-bold uppercase">Stock Value</p>
                            <h3 class="text-2xl font-black text-green-600 mt-1" id="inv-total-value">Rs.0</h3>
                        </div>
                    </div>

                    <!-- Inventory Filters -->
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterInventory('all')" class="inv-filter-btn px-4 py-2 bg-gray-800 text-white rounded-lg text-sm font-bold">All Items</button>
                        <button onclick="filterInventory('low')" class="inv-filter-btn px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-bold hover:bg-red-100 hover:text-red-600">Stock</button>
                        <button onclick="filterInventory('vegetables')" class="inv-filter-btn px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-bold">Vegetables</button>
                        <button onclick="filterInventory('dairy')" class="inv-filter-btn px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-bold">Dairy</button>
                        <button onclick="filterInventory('spices')" class="inv-filter-btn px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-bold">Spices</button>
                        <button onclick="filterInventory('beverages')" class="inv-filter-btn px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-bold">Beverages</button>
                        <button onclick="filterInventory('packaging')" class="inv-filter-btn px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-bold">Packaging</button>
                    </div>

                    <!-- Inventory Table -->
                    <div class="glass-card rounded-2xl overflow-hidden">
                        <div class="p-4 bg-amber-50 border-b flex justify-between items-center">
                            <h3 class="font-bold text-amber-800">Stock Items</h3>
                            <div class="flex gap-2">
                                <input type="text" id="inv-search" placeholder="Search items..." class="px-3 py-1.5 text-sm border rounded-lg outline-none focus:border-amber-500">
                                <button onclick="exportInventory()" class="px-3 py-1.5 bg-white border rounded-lg text-sm font-bold hover:bg-gray-50">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
                                    <tr>
                                        <th class="p-4">Item Name</th>
                                        <th class="p-4">Category</th>
                                        <th class="p-4">Quantity</th>
                                        <th class="p-4">Unit</th>
                                        <th class="p-4">Cost/Unit</th>
                                        <th class="p-4">Stock</th>
                                        <th class="p-4">Status</th>
                                        <th class="p-4 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="inventory-table" class="divide-y">
                                    <tr><td colspan="8" class="p-8 text-center text-gray-400">Loading inventory...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <div id="addon-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden modal-enter">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg">Universal Add-ons</h3>
                <button onclick="toggleAddonModal()" class="text-gray-400 hover:text-red-500"><i
                        class="fas fa-times"></i></button>
            </div>
            <div class="p-4 space-y-4">
                <div class="flex gap-2">
                    <input type="text" id="new-addon-name" placeholder="Name"
                        class="flex-1 p-2 border rounded text-sm outline-none focus:border-orange-500">
                    <input type="number" id="new-addon-price" placeholder="Price"
                        class="w-20 p-2 border rounded text-sm outline-none focus:border-orange-500">
                    <button onclick="createUniversalAddon()"
                        class="bg-green-600 text-white px-4 rounded font-bold hover:bg-green-700"><i
                            class="fas fa-plus"></i></button>
                </div>
                <div class="max-h-60 overflow-y-auto border-t pt-2" id="universal-addons-list"></div>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden modal-enter">
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2" id="confirm-title">Are you sure?</h3>
                <p class="text-sm text-gray-500 mb-6" id="confirm-msg">This action cannot be undone.</p>
                <div class="flex gap-3 justify-center">
                    <button onclick="closeConfirmModal()"
                        class="px-5 py-2.5 rounded-xl border border-gray-300 font-bold text-gray-600 hover:bg-gray-50">Cancel</button>
                    <button id="btn-confirm-action"
                        class="px-5 py-2.5 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700 shadow-lg">Yes,
                        Delete</button>
                </div>
            </div>
        </div>
    </div>

    <div id="offer-editor-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden modal-enter">
            <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                <h3 class="font-bold text-lg text-gray-800">Edit Offer Card</h3>
                <button onclick="closeOfferModal()" class="text-gray-400 hover:text-red-500"><i
                        class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="offer-edit-id">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Offer Text</label>
                    <input type="text" id="offer-text-input"
                        class="w-full border p-3 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Discount %</label>
                    <input type="number" id="offer-disc-input" class="w-full border p-3 rounded-xl outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Minimum Order Value (?)</label>
                    <input type="number" id="offer-min-input" class="w-full border p-3 rounded-xl outline-none"
                        placeholder="e.g. 199">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Image URL</label>
                    <input type="text" id="offer-img-input" class="w-full border p-3 rounded-xl outline-none">
                </div>
                <button onclick="saveOfferData()"
                    class="w-full bg-orange-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-orange-700">Save
                    Offer</button>
                <button onclick="deleteOfferData()"
                    class="w-full bg-red-50 text-red-600 font-bold py-2 rounded-xl hover:bg-red-100 border border-red-100 text-sm">Remove
                    Offer</button>
            </div>
        </div>
    </div>

    <!-- INVENTORY MODAL -->
    <div id="inventory-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden modal-enter">
            <div class="p-4 border-b border-gray-100 bg-amber-50 flex justify-between items-center">
                <h3 class="font-bold text-lg text-amber-800" id="inv-modal-title">Add Inventory Item</h3>
                <button onclick="closeInventoryModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                <input type="hidden" id="inv-edit-id">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Item Name *</label>
                    <input type="text" id="inv-name" class="w-full border p-3 rounded-xl outline-none focus:border-amber-500" placeholder="e.g., Tomatoes, Cheese, Oil">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Category</label>
                        <select id="inv-category" class="w-full border p-3 rounded-xl outline-none">
                            <option value="vegetables">Vegetables</option>
                            <option value="dairy">Dairy</option>
                            <option value="meat">Meat</option>
                            <option value="spices">Spices</option>
                            <option value="grains">Grains</option>
                            <option value="beverages">Beverages</option>
                            <option value="packaging">Packaging</option>
                            <option value="cleaning">Cleaning</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Unit</label>
                        <select id="inv-unit" class="w-full border p-3 rounded-xl outline-none">
                            <option value="kg">Kg</option>
                            <option value="gram">Gram</option>
                            <option value="litre">Litre</option>
                            <option value="ml">ML</option>
                            <option value="piece">Piece</option>
                            <option value="packet">Packet</option>
                            <option value="box">Box</option>
                            <option value="dozen">Dozen</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Current Quantity *</label>
                        <input type="number" id="inv-qty" class="w-full border p-3 rounded-xl outline-none" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Cost per Unit (Rs.)</label>
                        <input type="number" id="inv-cost" class="w-full border p-3 rounded-xl outline-none" placeholder="0">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Min Stock Alert</label>
                        <input type="number" id="inv-min" class="w-full border p-3 rounded-xl outline-none" placeholder="10">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Supplier</label>
                        <input type="text" id="inv-supplier" class="w-full border p-3 rounded-xl outline-none" placeholder="Vendor name">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Notes</label>
                    <textarea id="inv-notes" rows="2" class="w-full border p-3 rounded-xl outline-none" placeholder="Storage instructions, expiry info..."></textarea>
                </div>
                <button onclick="saveInventoryItem()" class="w-full bg-amber-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-amber-700">
                    Save Item
                </button>
            </div>
        </div>
    </div>

    <!-- TABLE MODAL -->
    <div id="table-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden modal-enter">
            <div class="p-4 border-b border-gray-100 bg-cyan-50 flex justify-between items-center">
                <h3 class="font-bold text-lg text-cyan-800" id="table-modal-title">Add Table</h3>
                <button onclick="closeTableModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="table-edit-id">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Table Number *</label>
                        <input type="text" id="table-number" class="w-full border p-3 rounded-xl outline-none focus:border-cyan-500" placeholder="T1, A1, etc.">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Capacity</label>
                        <input type="number" id="table-capacity" class="w-full border p-3 rounded-xl outline-none" placeholder="4" value="4">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Location/Area</label>
                    <select id="table-area" class="w-full border p-3 rounded-xl outline-none">
                        <option value="indoor">Indoor</option>
                        <option value="outdoor">Outdoor</option>
                        <option value="terrace">Terrace</option>
                        <option value="private">Private Room</option>
                        <option value="bar">Bar Area</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Initial Status</label>
                    <select id="table-status" class="w-full border p-3 rounded-xl outline-none">
                        <option value="available">Available</option>
                        <option value="occupied">Occupied</option>
                        <option value="reserved">Reserved</option>
                        <option value="maintenance">Maintenance</option>
                    </select>
                </div>
                <button onclick="saveTable()" class="w-full bg-cyan-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-cyan-700">
                    Save Table
                </button>
            </div>
        </div>
    </div>

    <!-- TABLE ACTIONS MODAL -->
    <div id="table-actions-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden modal-enter">
            <div class="p-4 border-b border-gray-100 bg-cyan-50 flex justify-between items-center">
                <h3 class="font-bold text-lg text-cyan-800"><i class="fas fa-chair mr-2"></i>Table <span id="table-action-number">-</span></h3>
                <button onclick="closeTableActionsModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-2">
                <input type="hidden" id="table-action-id">
                <p class="text-sm text-gray-500 px-3 py-2">Current Status: <span id="table-action-status" class="font-bold text-cyan-600">-</span></p>
                <div class="space-y-1">
                    <button onclick="tableActionSetStatus('available')" class="w-full text-left px-4 py-3 rounded-xl hover:bg-green-50 flex items-center gap-3 transition">
                        <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                            <i class="fas fa-check text-green-600"></i>
                        </div>
                        <div>
                            <span class="font-semibold text-gray-800">Set Available</span>
                            <p class="text-xs text-gray-500">Mark table as free</p>
                        </div>
                    </button>
                    <button onclick="tableActionSetStatus('occupied')" class="w-full text-left px-4 py-3 rounded-xl hover:bg-red-50 flex items-center gap-3 transition">
                        <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center">
                            <i class="fas fa-user-friends text-red-600"></i>
                        </div>
                        <div>
                            <span class="font-semibold text-gray-800">Set Occupied</span>
                            <p class="text-xs text-gray-500">Guests seated</p>
                        </div>
                    </button>
                    <button onclick="tableActionReserve()" class="w-full text-left px-4 py-3 rounded-xl hover:bg-yellow-50 flex items-center gap-3 transition">
                        <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center">
                            <i class="fas fa-calendar-alt text-yellow-600"></i>
                        </div>
                        <div>
                            <span class="font-semibold text-gray-800">Make Reservation</span>
                            <p class="text-xs text-gray-500">Book for later</p>
                        </div>
                    </button>
                    <button onclick="tableActionEdit()" class="w-full text-left px-4 py-3 rounded-xl hover:bg-blue-50 flex items-center gap-3 transition">
                        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                            <i class="fas fa-pen text-blue-600"></i>
                        </div>
                        <div>
                            <span class="font-semibold text-gray-800">Edit Table</span>
                            <p class="text-xs text-gray-500">Change details</p>
                        </div>
                    </button>
                    <button onclick="tableActionDelete()" class="w-full text-left px-4 py-3 rounded-xl hover:bg-red-50 flex items-center gap-3 transition">
                        <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center">
                            <i class="fas fa-trash text-red-600"></i>
                        </div>
                        <div>
                            <span class="font-semibold text-gray-800">Delete Table</span>
                            <p class="text-xs text-gray-500">Remove permanently</p>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- STAFF MODAL -->
    <div id="staff-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden modal-enter">
            <div class="p-4 border-b border-gray-100 bg-teal-50 flex justify-between items-center">
                <h3 class="font-bold text-lg text-teal-800" id="staff-modal-title">Add Staff Member</h3>
                <button onclick="closeStaffModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                <input type="hidden" id="staff-edit-id">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Full Name *</label>
                    <input type="text" id="staff-name" class="w-full border p-3 rounded-xl outline-none focus:border-teal-500" placeholder="Employee name">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Role *</label>
                        <select id="staff-role" class="w-full border p-3 rounded-xl outline-none">
                            <option value="chef">Chef</option>
                            <option value="waiter">Waiter</option>
                            <option value="cashier">Cashier</option>
                            <option value="manager">Manager</option>
                            <option value="cleaner">Cleaner</option>
                            <option value="delivery">Delivery</option>
                            <option value="helper">Helper</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Phone *</label>
                        <input type="tel" id="staff-phone" class="w-full border p-3 rounded-xl outline-none" placeholder="9876543210">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Shift</label>
                        <select id="staff-shift" class="w-full border p-3 rounded-xl outline-none">
                            <option value="morning">Morning (6AM-2PM)</option>
                            <option value="evening">Evening (2PM-10PM)</option>
                            <option value="night">Night (10PM-6AM)</option>
                            <option value="full">Full Day</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Salary (Rs./month)</label>
                        <input type="number" id="staff-salary" class="w-full border p-3 rounded-xl outline-none" placeholder="15000">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Joining Date</label>
                    <input type="date" id="staff-joining" class="w-full border p-3 rounded-xl outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Address</label>
                    <textarea id="staff-address" rows="2" class="w-full border p-3 rounded-xl outline-none" placeholder="Employee address"></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Emergency Contact</label>
                    <input type="tel" id="staff-emergency" class="w-full border p-3 rounded-xl outline-none" placeholder="Emergency phone number">
                </div>
                <button onclick="saveStaff()" class="w-full bg-teal-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-teal-700">
                    Save Staff Member
                </button>
            </div>
        </div>
    </div>

    <!-- EXPENSE MODAL -->
    <div id="expense-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden modal-enter">
            <div class="p-4 border-b border-gray-100 bg-rose-50 flex justify-between items-center">
                <h3 class="font-bold text-lg text-rose-800" id="expense-modal-title">Add Expense</h3>
                <button onclick="closeExpenseModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="expense-edit-id">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Category *</label>
                    <select id="expense-category" class="w-full border p-3 rounded-xl outline-none">
                        <option value="ingredients">Ingredients/Raw Materials</option>
                        <option value="utilities">Utilities (Electricity, Gas, Water)</option>
                        <option value="salaries">Salaries & Wages</option>
                        <option value="rent">Rent</option>
                        <option value="maintenance">Maintenance & Repairs</option>
                        <option value="marketing">Marketing & Advertising</option>
                        <option value="packaging">Packaging</option>
                        <option value="transport">Transport & Delivery</option>
                        <option value="licenses">Licenses & Permits</option>
                        <option value="equipment">Equipment</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Description *</label>
                    <input type="text" id="expense-desc" class="w-full border p-3 rounded-xl outline-none focus:border-rose-500" placeholder="What was the expense for?">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Amount (Rs.) *</label>
                        <input type="number" id="expense-amount" class="w-full border p-3 rounded-xl outline-none" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Date</label>
                        <input type="date" id="expense-date" class="w-full border p-3 rounded-xl outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Paid To</label>
                    <input type="text" id="expense-vendor" class="w-full border p-3 rounded-xl outline-none" placeholder="Vendor/Person name">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Payment Method</label>
                    <select id="expense-payment" class="w-full border p-3 rounded-xl outline-none">
                        <option value="cash">Cash</option>
                        <option value="upi">UPI</option>
                        <option value="card">Card</option>
                        <option value="bank">Bank Transfer</option>
                        <option value="credit">Credit (Pending)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Receipt/Bill No (Optional)</label>
                    <input type="text" id="expense-receipt" class="w-full border p-3 rounded-xl outline-none" placeholder="Receipt number">
                </div>
                <button onclick="saveExpense()" class="w-full bg-rose-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-rose-700">
                    Save Expense
                </button>
            </div>
        </div>
    </div>

    <!-- SUPPLIER MODAL -->
    <div id="supplier-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden modal-enter">
            <div class="p-4 border-b border-gray-100 bg-lime-50 flex justify-between items-center">
                <h3 class="font-bold text-lg text-lime-800" id="supplier-modal-title">Add Supplier</h3>
                <button onclick="closeSupplierModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                <input type="hidden" id="supplier-edit-id">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Supplier/Company Name *</label>
                    <input type="text" id="supplier-name" class="w-full border p-3 rounded-xl outline-none focus:border-lime-500" placeholder="Vendor name">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Category</label>
                    <select id="supplier-category" class="w-full border p-3 rounded-xl outline-none">
                        <option value="vegetables">Vegetables & Fruits</option>
                        <option value="dairy">Dairy Products</option>
                        <option value="meat">Meat & Poultry</option>
                        <option value="seafood">Seafood</option>
                        <option value="grains">Grains & Flour</option>
                        <option value="spices">Spices & Condiments</option>
                        <option value="beverages">Beverages</option>
                        <option value="packaging">Packaging</option>
                        <option value="equipment">Equipment</option>
                        <option value="cleaning">Cleaning Supplies</option>
                        <option value="general">General</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Contact Person</label>
                        <input type="text" id="supplier-contact" class="w-full border p-3 rounded-xl outline-none" placeholder="Person name">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Phone *</label>
                        <input type="tel" id="supplier-phone" class="w-full border p-3 rounded-xl outline-none" placeholder="9876543210">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Email</label>
                    <input type="email" id="supplier-email" class="w-full border p-3 rounded-xl outline-none" placeholder="email@example.com">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Address</label>
                    <textarea id="supplier-address" rows="2" class="w-full border p-3 rounded-xl outline-none" placeholder="Full address"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Payment Terms</label>
                        <select id="supplier-terms" class="w-full border p-3 rounded-xl outline-none">
                            <option value="cod">Cash on Delivery</option>
                            <option value="advance">Advance Payment</option>
                            <option value="7days">7 Days Credit</option>
                            <option value="15days">15 Days Credit</option>
                            <option value="30days">30 Days Credit</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">GST Number</label>
                        <input type="text" id="supplier-gst" class="w-full border p-3 rounded-xl outline-none" placeholder="GST No.">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Notes</label>
                    <textarea id="supplier-notes" rows="2" class="w-full border p-3 rounded-xl outline-none" placeholder="Delivery days, special terms, etc."></textarea>
                </div>
                <button onclick="saveSupplier()" class="w-full bg-lime-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-lime-700">
                    Save Supplier
                </button>
            </div>
        </div>
    </div>

    <!-- RESERVATION MODAL -->
    <div id="reservation-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden modal-enter">
            <div class="p-4 border-b border-gray-100 bg-blue-50 flex justify-between items-center">
                <h3 class="font-bold text-lg text-blue-800">New Reservation</h3>
                <button onclick="closeReservationModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="reservation-table-id">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Customer Name *</label>
                    <input type="text" id="reservation-name" class="w-full border p-3 rounded-xl outline-none" placeholder="Guest name">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Phone *</label>
                        <input type="tel" id="reservation-phone" class="w-full border p-3 rounded-xl outline-none" placeholder="Phone number">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Guests</label>
                        <input type="number" id="reservation-guests" class="w-full border p-3 rounded-xl outline-none" placeholder="2" value="2">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Date *</label>
                        <input type="date" id="reservation-date" class="w-full border p-3 rounded-xl outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Time *</label>
                        <input type="time" id="reservation-time" class="w-full border p-3 rounded-xl outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Special Requests</label>
                    <textarea id="reservation-notes" rows="2" class="w-full border p-3 rounded-xl outline-none" placeholder="Birthday, anniversary, dietary needs..."></textarea>
                </div>
                <button onclick="saveReservation()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-blue-700">
                    Confirm Reservation
                </button>
            </div>
        </div>
    </div>

    <!-- STOCK ADJUSTMENT MODAL -->
    <div id="stock-adjust-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden modal-enter">
            <div class="p-4 border-b border-gray-100 bg-amber-50 flex justify-between items-center">
                <h3 class="font-bold text-lg text-amber-800">Stock</h3>
                <button onclick="closeStockAdjustModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="stock-item-id">
                <p class="font-bold text-gray-800" id="stock-item-name">Item Name</p>
                <p class="text-sm text-gray-500">Current: <span id="stock-current-qty" class="font-bold">0</span> <span id="stock-current-unit">units</span></p>
                <div class="flex gap-2">
                    <button onclick="setStockAction('add')" class="stock-action-btn flex-1 py-2 rounded-lg border-2 border-green-500 bg-green-50 text-green-700 font-bold text-sm">Stock</button>
                    <button onclick="setStockAction('remove')" class="stock-action-btn flex-1 py-2 rounded-lg border-2 border-gray-200 text-gray-600 font-bold text-sm">- Remove</button>
                </div>
                <input type="hidden" id="stock-action" value="add">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Quantity</label>
                    <input type="number" id="stock-qty" class="w-full border p-3 rounded-xl outline-none text-center text-xl font-bold" placeholder="0" min="0">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Reason</label>
                    <select id="stock-reason" class="w-full border p-3 rounded-xl outline-none">
                        <option value="purchase">New Purchase</option>
                        <option value="used">Used in Kitchen</option>
                        <option value="waste">Waste/Spoilage</option>
                        <option value="return">Return to Supplier</option>
                        <option value="correction">Correction</option>
                    </select>
                </div>
                <button onclick="confirmStockAdjust()" class="w-full bg-amber-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-amber-700">
                    Update Stock
                </button>
            </div>
        </div>
    </div>

    <!-- QR CODE GENERATOR MODAL -->
    <div id="qrcode-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden modal-enter">
            <div class="p-4 border-b border-gray-100 bg-blue-50 flex justify-between items-center">
                <h3 class="font-bold text-lg text-blue-800"><i class="fas fa-qrcode mr-2"></i>Digital Menu QR Code</h3>
                <button onclick="closeQRCodeModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4 text-center">
                <p class="text-sm text-gray-500">Scan this QR code to view the digital menu</p>
                <div id="qr-code-container" class="flex justify-center py-4">
                    <canvas id="qr-canvas" width="200" height="200" class="rounded-xl border-2 border-gray-200"></canvas>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-500 uppercase font-bold mb-1">Menu URL</p>
                    <div class="flex items-center gap-2">
                        <input type="text" id="menu-url-display" readonly class="flex-1 p-2 text-sm bg-white border rounded-lg text-gray-600" value="">
                        <button onclick="copyMenuURL()" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold hover:bg-blue-700">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="downloadQRCode()" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700">
                        <i class="fas fa-download mr-2"></i>Download QR
                    </button>
                    <button onclick="printQRCode()" class="flex-1 bg-purple-600 text-white py-3 rounded-xl font-bold hover:bg-purple-700">
                        <i class="fas fa-print mr-2"></i>Print
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ACTIVITY LOGS / AUDIT TRAIL MODAL -->
    <div id="activity-logs-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden modal-enter max-h-[80vh] flex flex-col">
            <div class="p-4 border-b border-gray-100 bg-slate-50 flex justify-between items-center shrink-0">
                <h3 class="font-bold text-lg text-slate-800"><i class="fas fa-history mr-2"></i>Activity Logs (Audit Trail)</h3>
                <button onclick="closeActivityLogsModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 border-b bg-gray-50 shrink-0">
                <div class="flex flex-wrap gap-2">
                    <select id="log-filter-type" onchange="filterActivityLogs()" class="px-3 py-2 text-sm border rounded-lg">
                        <option value="all">All Actions</option>
                        <option value="order">Orders</option>
                        <option value="menu">Menu Changes</option>
                        <option value="payment">Payments</option>
                        <option value="discount">Discounts</option>
                        <option value="settings">Settings</option>
                        <option value="staff">Staff Actions</option>
                    </select>
                    <input type="date" id="log-filter-date" onchange="filterActivityLogs()" class="px-3 py-2 text-sm border rounded-lg">
                    <button onclick="exportActivityLogs()" class="px-3 py-2 bg-green-100 text-green-700 rounded-lg text-sm font-bold hover:bg-green-200">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
                <div id="activity-logs-list" class="space-y-3">
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Loading activity logs...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- EOD REPORT MODAL -->
    <div id="eod-report-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden modal-enter max-h-[85vh] flex flex-col">
            <div class="p-4 border-b border-gray-100 bg-gradient-to-r from-emerald-50 to-green-50 flex justify-between items-center shrink-0">
                <h3 class="font-bold text-lg text-emerald-800"><i class="fas fa-file-invoice mr-2"></i>Day End Report (EOD)</h3>
                <button onclick="closeEODReportModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 flex-1 overflow-y-auto">
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                    <div class="p-4 bg-green-50 rounded-xl border border-green-200">
                        <p class="text-xs text-green-600 font-bold uppercase">Total Sales</p>
                        <p class="text-2xl font-black text-green-700" id="eod-modal-sales">Rs.0</p>
                    </div>
                    <div class="p-4 bg-blue-50 rounded-xl border border-blue-200">
                        <p class="text-xs text-blue-600 font-bold uppercase">Total Orders</p>
                        <p class="text-2xl font-black text-blue-700" id="eod-modal-orders">0</p>
                    </div>
                    <div class="p-4 bg-purple-50 rounded-xl border border-purple-200">
                        <p class="text-xs text-purple-600 font-bold uppercase">Avg Order</p>
                        <p class="text-2xl font-black text-purple-700" id="eod-modal-avg">Rs.0</p>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <h4 class="font-bold text-gray-800 mb-3">ayment Breakdown</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="flex justify-between items-center p-2 bg-white rounded-lg">
                                <span class="text-sm text-gray-600">Cash</span>
                                <span class="font-bold text-green-600" id="eod-cash-amount">Rs.0</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-white rounded-lg">
                                <span class="text-sm text-gray-600">UPI/Online</span>
                                <span class="font-bold text-blue-600" id="eod-online-amount">Rs.0</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-white rounded-lg">
                                <span class="text-sm text-gray-600">Card</span>
                                <span class="font-bold text-purple-600" id="eod-card-amount">Rs.0</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-white rounded-lg">
                                <span class="text-sm text-gray-600">Pending</span>
                                <span class="font-bold text-red-600" id="eod-pending-amount">Rs.0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <h4 class="font-bold text-gray-800 mb-3">Order Types</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="flex justify-between items-center p-2 bg-white rounded-lg">
                                <span class="text-sm text-gray-600">Dine-in</span>
                                <span class="font-bold" id="eod-dinein">0</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-white rounded-lg">
                                <span class="text-sm text-gray-600">Takeaway</span>
                                <span class="font-bold" id="eod-takeaway">0</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-white rounded-lg">
                                <span class="text-sm text-gray-600">Delivery</span>
                                <span class="font-bold" id="eod-delivery">0</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-white rounded-lg">
                                <span class="text-sm text-gray-600">Online Orders</span>
                                <span class="font-bold" id="eod-online-orders">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-red-50 p-4 rounded-xl border border-red-200">
                        <h4 class="font-bold text-red-800 mb-3">Discount Audit</h4>
                        <div id="eod-discount-audit" class="space-y-2 text-sm">
                            <p class="text-gray-500">Loading discount data...</p>
                        </div>
                    </div>

                    <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                        <h4 class="font-bold text-yellow-800 mb-3">Cash Drawer Reconciliation</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Expected Cash</label>
                                <p class="text-xl font-black text-gray-800" id="eod-expected-cash">Rs.0</p>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Actual Cash (Enter)</label>
                                <input type="number" id="eod-actual-cash" class="w-full p-2 border rounded-lg text-lg font-bold" placeholder="Rs.0">
                            </div>
                        </div>
                        <div class="mt-3 p-2 rounded-lg" id="eod-difference-box">
                            <span class="text-sm font-bold">Difference: </span>
                            <span id="eod-difference" class="font-black">Rs.0</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex gap-3 shrink-0">
                <button onclick="downloadEODReport()" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700">
                    <i class="fas fa-download mr-2"></i>Download Report
                </button>
                <button onclick="saveEODReport()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700">
                    <i class="fas fa-save mr-2"></i>Save & Close Day
                </button>
            </div>
        </div>
    </div>


    <!-- MULTI-BRANCH SELECTOR MODAL -->
    <div id="branch-selector-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden modal-enter">
            <div class="p-4 border-b border-gray-100 bg-gradient-to-r from-blue-50 to-indigo-50 flex justify-between items-center">
                <h3 class="font-bold text-lg text-blue-800"><i class="fas fa-store mr-2"></i>Switch Branch</h3>
                <button onclick="closeBranchSelector()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4">
                <p class="text-sm text-gray-500 mb-4">Select a branch to view its data</p>
                <div id="branch-list" class="space-y-3 max-h-60 overflow-y-auto">
                    <!-- Branches will be loaded here -->
                    <div class="text-center py-4 text-gray-400">
                        <i class="fas fa-spinner fa-spin"></i> Loading branches...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- REFUND/VOID ORDER MODAL -->
    <div id="refund-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden modal-enter">
            <div class="p-4 border-b border-gray-100 bg-red-50 flex justify-between items-center">
                <h3 class="font-bold text-lg text-red-800"><i class="fas fa-undo mr-2"></i>Refund / Void Order</h3>
                <button onclick="closeRefundModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="refund-order-id">
                <div class="p-3 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-500 uppercase font-bold">Order ID</p>
                    <p class="text-lg font-bold text-gray-800" id="refund-order-display">#----</p>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Reason for Refund/Void *</label>
                    <select id="refund-reason" class="w-full border p-3 rounded-xl outline-none">
                        <option value="">Select Reason</option>
                        <option value="customer_changed_mind">Customer Changed Mind</option>
                        <option value="wrong_order">Wrong Order Placed</option>
                        <option value="kitchen_error">Kitchen Error</option>
                        <option value="quality_issue">Quality Issue</option>
                        <option value="delayed_order">Order Delayed Too Long</option>
                        <option value="item_unavailable">Available</option>
                        <option value="duplicate_order">Duplicate Order</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Notes</label>
                    <textarea id="refund-notes" rows="2" class="w-full border p-3 rounded-xl outline-none" placeholder="Add any additional details..."></textarea>
                </div>
                <div class="flex gap-3">
                    <button onclick="processVoid()" class="flex-1 bg-yellow-500 text-white py-3 rounded-xl font-bold hover:bg-yellow-600">
                        <i class="fas fa-ban mr-2"></i>Void Order
                    </button>
                    <button onclick="processRefund()" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold hover:bg-red-700">
                        <i class="fas fa-undo mr-2"></i>Refund
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- INVENTORY RECIPE LINKING MODAL -->
    <div id="recipe-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden modal-enter max-h-[80vh] flex flex-col">
            <div class="p-4 border-b border-gray-100 bg-amber-50 flex justify-between items-center shrink-0">
                <h3 class="font-bold text-lg text-amber-800"><i class="fas fa-mortar-pestle mr-2"></i>Recipe Ingredients</h3>
                <button onclick="closeRecipeModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 flex-1 overflow-y-auto">
                <input type="hidden" id="recipe-menu-item-id">
                <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-500 uppercase font-bold">Menu Item</p>
                    <p class="text-lg font-bold text-gray-800" id="recipe-menu-item-name">Item Name</p>
                </div>
                <p class="text-sm text-gray-500 mb-3">Link inventory items that are used when this item is ordered:</p>
                <div id="recipe-ingredients-list" class="space-y-3">
                    <!-- Ingredients will be added here -->
                </div>
                <button onclick="addRecipeIngredient()" class="mt-4 w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 font-bold hover:border-amber-500 hover:text-amber-600">
                    <i class="fas fa-plus mr-2"></i>Add Ingredient
                </button>
            </div>
            <div class="p-4 border-t bg-gray-50 shrink-0">
                <button onclick="saveRecipe()" class="w-full bg-amber-600 text-white py-3 rounded-xl font-bold hover:bg-amber-700">
                    Save Recipe
                </button>
            </div>
        </div>
    </div>

    <!-- PRIVACY POLICY MODAL -->
    <div id="privacy-policy-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden modal-enter max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-100 bg-indigo-50 flex justify-between items-center shrink-0">
                <h3 class="font-bold text-lg text-indigo-800"><i class="fas fa-shield-alt mr-2"></i>Privacy Policy</h3>
                <button onclick="closePrivacyPolicy()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 flex-1 overflow-y-auto">
                <p class="text-sm text-gray-500 mb-4 text-center">Last Updated: December 2025</p>
                
                <!-- Accordion Sections -->
                <div class="space-y-2">
                    <!-- Section 1 -->
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <button onclick="toggleAccordion('pp-1')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-indigo-50 transition-colors text-left">
                            <span class="font-bold text-gray-800"><i class="fas fa-info-circle text-indigo-500 mr-2"></i>1. Introduction</span>
                            <i id="pp-1-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div id="pp-1" class="hidden p-4 bg-white border-t">
                            <p class="text-gray-600">Welcome to Orderly ("we," "our," or "us"). This Privacy Policy explains how we collect, use, disclose, and safeguard your information when you use our restaurant management platform and services. Please read this privacy policy carefully. By using Orderly, you consent to the data practices described in this policy.</p>
                        </div>
                    </div>

                    <!-- Section 2 -->
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <button onclick="toggleAccordion('pp-2')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-indigo-50 transition-colors text-left">
                            <span class="font-bold text-gray-800"><i class="fas fa-database text-indigo-500 mr-2"></i>2. Information We Collect</span>
                            <i id="pp-2-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div id="pp-2" class="hidden p-4 bg-white border-t space-y-3">
                            <p class="text-gray-600 font-semibold">Personal Information:</p>
                            <ul class="list-disc pl-6 text-gray-600 text-sm space-y-1">
                                <li>Restaurant owner name, email address, and contact number</li>
                                <li>Business name, address, GSTIN, and FSSAI license details</li>
                                <li>Staff information including names, roles, and contact details</li>
                                <li>Customer data including names, phone numbers, and order history</li>
                                <li>Payment and wallet transaction information</li>
                            </ul>
                            <p class="text-gray-600 font-semibold mt-3">Business Data:</p>
                            <ul class="list-disc pl-6 text-gray-600 text-sm space-y-1">
                                <li>Menu items, pricing, and inventory details</li>
                                <li>Order information, sales data, and revenue analytics</li>
                                <li>Table management and reservation data</li>
                                <li>Supplier information and expense records</li>
                            </ul>
                            <p class="text-gray-600 font-semibold mt-3">Technical Data:</p>
                            <ul class="list-disc pl-6 text-gray-600 text-sm space-y-1">
                                <li>Device information and browser type</li>
                                <li>IP address and location data</li>
                                <li>Usage patterns and activity logs</li>
                                <li>Cookies and tracking technologies</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Section 3 -->
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <button onclick="toggleAccordion('pp-3')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-indigo-50 transition-colors text-left">
                            <span class="font-bold text-gray-800"><i class="fas fa-cogs text-indigo-500 mr-2"></i>3. How We Use Your Information</span>
                            <i id="pp-3-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div id="pp-3" class="hidden p-4 bg-white border-t">
                            <ul class="list-disc pl-6 text-gray-600 text-sm space-y-1">
                                <li>To provide and maintain our restaurant management services</li>
                                <li>To process orders, payments, and wallet transactions</li>
                                <li>To generate business reports and analytics</li>
                                <li>To send important notifications about orders and updates</li>
                                <li>To improve our platform and develop new features</li>
                                <li>To comply with legal obligations and prevent fraud</li>
                                <li>To provide customer support and respond to inquiries</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Section 4 -->
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <button onclick="toggleAccordion('pp-4')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-indigo-50 transition-colors text-left">
                            <span class="font-bold text-gray-800"><i class="fas fa-lock text-indigo-500 mr-2"></i>4. Data Storage & Security</span>
                            <i id="pp-4-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div id="pp-4" class="hidden p-4 bg-white border-t">
                            <p class="text-gray-600 mb-3">Your data is stored securely on Google Firebase infrastructure with enterprise-grade security. We implement industry-standard security measures including:</p>
                            <ul class="list-disc pl-6 text-gray-600 text-sm space-y-1">
                                <li>SSL/TLS encryption for all data transmission</li>
                                <li>Firebase Authentication for secure access</li>
                                <li>Regular security audits and vulnerability assessments</li>
                                <li>Multi-tenant data isolation for each restaurant</li>
                                <li>Automatic data backups and disaster recovery</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Section 5 -->
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <button onclick="toggleAccordion('pp-5')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-indigo-50 transition-colors text-left">
                            <span class="font-bold text-gray-800"><i class="fas fa-share-alt text-indigo-500 mr-2"></i>5. Data Sharing & Disclosure</span>
                            <i id="pp-5-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div id="pp-5" class="hidden p-4 bg-white border-t">
                            <p class="text-gray-600 mb-3">We do not sell your personal information. We may share data only in these circumstances:</p>
                            <ul class="list-disc pl-6 text-gray-600 text-sm space-y-1">
                                <li>With payment processors to complete transactions</li>
                                <li>With service providers who assist in platform operations</li>
                                <li>When required by law or legal process</li>
                                <li>To protect our rights and prevent fraud</li>
                                <li>With your explicit consent</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Section 6 -->
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <button onclick="toggleAccordion('pp-6')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-indigo-50 transition-colors text-left">
                            <span class="font-bold text-gray-800"><i class="fas fa-user-shield text-indigo-500 mr-2"></i>6. Your Rights</span>
                            <i id="pp-6-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div id="pp-6" class="hidden p-4 bg-white border-t">
                            <p class="text-gray-600 mb-3">Under applicable data protection laws, you have the right to:</p>
                            <ul class="list-disc pl-6 text-gray-600 text-sm space-y-1">
                                <li>Access your personal data</li>
                                <li>Correct inaccurate data</li>
                                <li>Request deletion of your data</li>
                                <li>Export your data in a portable format</li>
                                <li>Opt-out of marketing communications</li>
                                <li>Lodge a complaint with supervisory authorities</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Section 7 -->
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <button onclick="toggleAccordion('pp-7')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-indigo-50 transition-colors text-left">
                            <span class="font-bold text-gray-800"><i class="fas fa-clock text-indigo-500 mr-2"></i>7. Data Retention</span>
                            <i id="pp-7-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div id="pp-7" class="hidden p-4 bg-white border-t">
                            <p class="text-gray-600">We retain your data for as long as your account is active or as needed to provide services. Financial and transaction data is retained as required by tax laws (typically 7 years). You may request account deletion at any time.</p>
                        </div>
                    </div>

                    <!-- Section 8 -->
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <button onclick="toggleAccordion('pp-8')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-indigo-50 transition-colors text-left">
                            <span class="font-bold text-gray-800"><i class="fas fa-cookie text-indigo-500 mr-2"></i>8. Cookies & Tracking</span>
                            <i id="pp-8-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div id="pp-8" class="hidden p-4 bg-white border-t">
                            <p class="text-gray-600">We use essential cookies for authentication and platform functionality. Analytics cookies help us understand usage patterns and improve services. You can control cookie preferences through your browser settings.</p>
                        </div>
                    </div>

                    <!-- Section 9 -->
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <button onclick="toggleAccordion('pp-9')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-indigo-50 transition-colors text-left">
                            <span class="font-bold text-gray-800"><i class="fas fa-child text-indigo-500 mr-2"></i>9. Children's Privacy</span>
                            <i id="pp-9-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div id="pp-9" class="hidden p-4 bg-white border-t">
                            <p class="text-gray-600">Orderly is not intended for individuals under 18 years of age. We do not knowingly collect personal information from children.</p>
                        </div>
                    </div>

                    <!-- Section 10 -->
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <button onclick="toggleAccordion('pp-10')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-indigo-50 transition-colors text-left">
                            <span class="font-bold text-gray-800"><i class="fas fa-edit text-indigo-500 mr-2"></i>10. Changes to Privacy Policy</span>
                            <i id="pp-10-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div id="pp-10" class="hidden p-4 bg-white border-t">
                            <p class="text-gray-600">We may update this Privacy Policy periodically. We will notify you of significant changes through the platform or email. Continued use after changes constitutes acceptance.</p>
                        </div>
                    </div>

                    <!-- Section 11 -->
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <button onclick="toggleAccordion('pp-11')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-indigo-50 transition-colors text-left">
                            <span class="font-bold text-gray-800"><i class="fas fa-envelope text-indigo-500 mr-2"></i>11. Contact Us</span>
                            <i id="pp-11-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div id="pp-11" class="hidden p-4 bg-white border-t">
                            <p class="text-gray-600 mb-3">For privacy-related inquiries or to exercise your rights, contact us at:</p>
                            <div class="bg-indigo-50 p-4 rounded-lg">
                                <p class="text-gray-700"><i class="fas fa-envelope mr-2 text-indigo-500"></i><strong>Email:</strong> privacy@orderly.in</p>
                                <p class="text-gray-700 mt-1"><i class="fas fa-map-marker-alt mr-2 text-indigo-500"></i><strong>Address:</strong> Orderly Technologies Pvt. Ltd., India</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 shrink-0">
                <button onclick="closePrivacyPolicy()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700">
                    I Understand
                </button>
            </div>
        </div>
    </div>

    <!-- TERMS & CONDITIONS MODAL -->
    <div id="terms-conditions-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden modal-enter max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-100 bg-teal-50 flex justify-between items-center shrink-0">
                <h3 class="font-bold text-lg text-teal-800"><i class="fas fa-file-contract mr-2"></i>Terms & Conditions</h3>
                <button onclick="closeTermsConditions()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 flex-1 overflow-y-auto">
                <p class="text-sm text-gray-500 mb-4 text-center">Effective Date: December 2025</p>
                
                <!-- Accordion Sections -->
                <div class="space-y-2">
                    <!-- Section 1 -->
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <button onclick="toggleAccordion('tc-1')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-teal-50 transition-colors text-left">
                            <span class="font-bold text-gray-800"><i class="fas fa-handshake text-teal-500 mr-2"></i>1. Agreement to Terms</span>
                            <i id="tc-1-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div id="tc-1" class="hidden p-4 bg-white border-t">
                            <p class="text-gray-600">By accessing or using Orderly restaurant management platform, you agree to be bound by these Terms and Conditions. If you disagree with any part of these terms, you may not access the service. These terms constitute a legally binding agreement between you ("Merchant" or "User") and Orderly Technologies Pvt. Ltd. ("Company," "we," or "us").</p>
                        </div>
                    </div>

                    <!-- Section 2 -->
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <button onclick="toggleAccordion('tc-2')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-teal-50 transition-colors text-left">
                            <span class="font-bold text-gray-800"><i class="fas fa-server text-teal-500 mr-2"></i>2. Service Description</span>
                            <i id="tc-2-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div id="tc-2" class="hidden p-4 bg-white border-t">
                            <p class="text-gray-600 mb-3">Orderly provides a comprehensive restaurant management platform including:</p>
                            <ul class="list-disc pl-6 text-gray-600 text-sm space-y-1">
                                <li>Point of Sale (POS) system</li>
                                <li>Menu and inventory management</li>
                                <li>Order management and kitchen display</li>
                                <li>Customer ordering application</li>
                                <li>Staff and table management</li>
                                <li>Business analytics and reporting</li>
                                <li>Digital wallet for platform fees</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Section 3 -->
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <button onclick="toggleAccordion('tc-3')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-teal-50 transition-colors text-left">
                            <span class="font-bold text-gray-800"><i class="fas fa-user-plus text-teal-500 mr-2"></i>3. Account Registration</span>
                            <i id="tc-3-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div id="tc-3" class="hidden p-4 bg-white border-t">
                            <p class="text-gray-600 mb-3">To use Orderly, you must:</p>
                            <ul class="list-disc pl-6 text-gray-600 text-sm space-y-1">
                                <li>Be at least 18 years old and have legal authority to enter contracts</li>
                                <li>Provide accurate and complete business information</li>
                                <li>Possess valid FSSAI license for food service operations</li>
                                <li>Maintain the confidentiality of your account credentials</li>
                                <li>Immediately notify us of any unauthorized access</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Section 4 -->
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <button onclick="toggleAccordion('tc-4')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-teal-50 transition-colors text-left">
                            <span class="font-bold text-gray-800"><i class="fas fa-wallet text-teal-500 mr-2"></i>4. Platform Fees & Wallet System</span>
                            <i id="tc-4-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div id="tc-4" class="hidden p-4 bg-white border-t space-y-3">
                            <p class="text-gray-600 font-semibold">4.1 Fee Structure:</p>
                            <ul class="list-disc pl-6 text-gray-600 text-sm space-y-1">
                                <li>Platform fee of ?1.98 per completed customer order</li>
                                <li>Fee is deducted from pre-loaded wallet balance</li>
                                <li>POS orders created by staff do not incur platform fees</li>
                                <li>Fees may be revised with 30 days prior notice</li>
                            </ul>
                            <p class="text-gray-600 font-semibold mt-3">4.2 Wallet Terms:</p>
                            <ul class="list-disc pl-6 text-gray-600 text-sm space-y-1">
                                <li>Wallet must maintain minimum balance for order processing</li>
                                <li>Recharge through authorized payment methods only</li>
                                <li>Wallet balance is non-refundable except account closure</li>
                                <li>Unused balance refundable after 30-day settlement period</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Section 5 -->
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <button onclick="toggleAccordion('tc-5')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-teal-50 transition-colors text-left">
                            <span class="font-bold text-gray-800"><i class="fas fa-tasks text-teal-500 mr-2"></i>5. User Responsibilities</span>
                            <i id="tc-5-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div id="tc-5" class="hidden p-4 bg-white border-t">
                            <p class="text-gray-600 mb-3">As a merchant using Orderly, you agree to:</p>
                            <ul class="list-disc pl-6 text-gray-600 text-sm space-y-1">
                                <li>Maintain accurate menu pricing and item availability</li>
                                <li>Honor all orders placed through the platform</li>
                                <li>Provide food that meets hygiene and safety standards</li>
                                <li>Handle customer complaints and refunds appropriately</li>
                                <li>Comply with all applicable laws and regulations</li>
                                <li>Not engage in fraudulent or deceptive practices</li>
                                <li>Not use the platform for illegal activities</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Section 6 -->
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <button onclick="toggleAccordion('tc-6')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-teal-50 transition-colors text-left">
                            <span class="font-bold text-gray-800"><i class="fas fa-copyright text-teal-500 mr-2"></i>6. Intellectual Property</span>
                            <i id="tc-6-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div id="tc-6" class="hidden p-4 bg-white border-t">
                            <p class="text-gray-600">All content, features, and functionality of Orderly platform including software, text, graphics, logos, and trademarks are owned by Orderly Technologies and protected by intellectual property laws. You may not copy, modify, distribute, or reverse engineer any part of the platform without written permission.</p>
                        </div>
                    </div>

                    <!-- Section 7 -->
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <button onclick="toggleAccordion('tc-7')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-teal-50 transition-colors text-left">
                            <span class="font-bold text-gray-800"><i class="fas fa-cloud text-teal-500 mr-2"></i>7. Service Availability</span>
                            <i id="tc-7-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div id="tc-7" class="hidden p-4 bg-white border-t">
                            <p class="text-gray-600 mb-3">We strive to maintain 99.9% platform uptime but do not guarantee uninterrupted access. We reserve the right to:</p>
                            <ul class="list-disc pl-6 text-gray-600 text-sm space-y-1">
                                <li>Modify or discontinue features with reasonable notice</li>
                                <li>Perform maintenance during off-peak hours</li>
                                <li>Suspend service for security or legal compliance</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Section 8 -->
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <button onclick="toggleAccordion('tc-8')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-teal-50 transition-colors text-left">
                            <span class="font-bold text-gray-800"><i class="fas fa-exclamation-triangle text-teal-500 mr-2"></i>8. Limitation of Liability</span>
                            <i id="tc-8-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div id="tc-8" class="hidden p-4 bg-white border-t">
                            <p class="text-gray-600 mb-3 font-semibold">TO THE MAXIMUM EXTENT PERMITTED BY LAW:</p>
                            <ul class="list-disc pl-6 text-gray-600 text-sm space-y-1">
                                <li>Orderly is provided "AS IS" without warranties of any kind</li>
                                <li>We are not liable for indirect, incidental, or consequential damages</li>
                                <li>Our total liability shall not exceed fees paid in last 12 months</li>
                                <li>We are not responsible for third-party payment gateway issues</li>
                                <li>We are not liable for data loss due to user negligence</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Section 9 -->
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <button onclick="toggleAccordion('tc-9')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-teal-50 transition-colors text-left">
                            <span class="font-bold text-gray-800"><i class="fas fa-shield-alt text-teal-500 mr-2"></i>9. Indemnification</span>
                            <i id="tc-9-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div id="tc-9" class="hidden p-4 bg-white border-t">
                            <p class="text-gray-600 mb-3">You agree to indemnify and hold harmless Orderly Technologies, its directors, employees, and partners from any claims, damages, or expenses arising from:</p>
                            <ul class="list-disc pl-6 text-gray-600 text-sm space-y-1">
                                <li>Your use of the platform</li>
                                <li>Violation of these terms</li>
                                <li>Food quality or safety issues</li>
                                <li>Customer disputes related to your restaurant</li>
                                <li>Any third-party claims against your business</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Section 10 -->
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <button onclick="toggleAccordion('tc-10')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-teal-50 transition-colors text-left">
                            <span class="font-bold text-gray-800"><i class="fas fa-user-times text-teal-500 mr-2"></i>10. Account Termination</span>
                            <i id="tc-10-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div id="tc-10" class="hidden p-4 bg-white border-t">
                            <p class="text-gray-600 mb-3">Either party may terminate this agreement:</p>
                            <ul class="list-disc pl-6 text-gray-600 text-sm space-y-1">
                                <li>You may close your account anytime with 7 days notice</li>
                                <li>We may suspend/terminate for terms violation</li>
                                <li>We may terminate for non-payment of platform fees</li>
                                <li>Data export available for 30 days after termination</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Section 11 -->
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <button onclick="toggleAccordion('tc-11')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-teal-50 transition-colors text-left">
                            <span class="font-bold text-gray-800"><i class="fas fa-balance-scale text-teal-500 mr-2"></i>11. Dispute Resolution</span>
                            <i id="tc-11-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div id="tc-11" class="hidden p-4 bg-white border-t">
                            <p class="text-gray-600 mb-3">Any disputes arising from these terms shall be:</p>
                            <ul class="list-disc pl-6 text-gray-600 text-sm space-y-1">
                                <li>First attempted to resolve through mutual negotiation</li>
                                <li>If unresolved, submitted to binding arbitration</li>
                                <li>Governed by the laws of India</li>
                                <li>Subject to exclusive jurisdiction of courts in India</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Section 12 -->
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <button onclick="toggleAccordion('tc-12')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-teal-50 transition-colors text-left">
                            <span class="font-bold text-gray-800"><i class="fas fa-edit text-teal-500 mr-2"></i>12. Modifications to Terms</span>
                            <i id="tc-12-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div id="tc-12" class="hidden p-4 bg-white border-t">
                            <p class="text-gray-600">We reserve the right to modify these terms at any time. Material changes will be notified 30 days in advance via email or platform notification. Continued use after changes indicates acceptance.</p>
                        </div>
                    </div>

                    <!-- Section 13 -->
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <button onclick="toggleAccordion('tc-13')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-teal-50 transition-colors text-left">
                            <span class="font-bold text-gray-800"><i class="fas fa-puzzle-piece text-teal-500 mr-2"></i>13. Severability</span>
                            <i id="tc-13-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div id="tc-13" class="hidden p-4 bg-white border-t">
                            <p class="text-gray-600">If any provision of these terms is found unenforceable, the remaining provisions shall continue in full force and effect.</p>
                        </div>
                    </div>

                    <!-- Section 14 -->
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <button onclick="toggleAccordion('tc-14')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-teal-50 transition-colors text-left">
                            <span class="font-bold text-gray-800"><i class="fas fa-envelope text-teal-500 mr-2"></i>14. Contact Information</span>
                            <i id="tc-14-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                        </button>
                        <div id="tc-14" class="hidden p-4 bg-white border-t">
                            <p class="text-gray-600 mb-3">For questions about these Terms & Conditions:</p>
                            <div class="bg-teal-50 p-4 rounded-lg">
                                <p class="text-gray-700"><i class="fas fa-envelope mr-2 text-teal-500"></i><strong>Email:</strong> legal@orderly.in</p>
                                <p class="text-gray-700 mt-1"><i class="fas fa-headset mr-2 text-teal-500"></i><strong>Support:</strong> support@orderly.in</p>
                                <p class="text-gray-700 mt-1"><i class="fas fa-map-marker-alt mr-2 text-teal-500"></i><strong>Address:</strong> Orderly Technologies Pvt. Ltd., India</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 shrink-0">
                <button onclick="closeTermsConditions()" class="w-full bg-teal-600 text-white py-3 rounded-xl font-bold hover:bg-teal-700">
                    I Accept
                </button>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getDatabase, ref, onValue, update, push, set, get, orderByChild } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, getDoc, onSnapshot, query, orderBy, limit, serverTimestamp, setDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDSl6L3ym7G9wXJjZoCYGtU6oBuMyswMBA",
            authDomain: "gen-lang-client-0826078440.firebaseapp.com",
            databaseURL: "https://gen-lang-client-0826078440-default-rtdb.firebaseio.com",
            projectId: "gen-lang-client-0826078440",
            storageBucket: "gen-lang-client-0826078440.firebasestorage.app",
            messagingSenderId: "198781436382",
            appId: "1:198781436382:web:041f1a6f57cc50dfa75d4f",
            measurementId: "G-XNB6HMBXN0"
        };

        const app = initializeApp(firebaseConfig);
        const dbRTDB = getDatabase(app);

        const dbFirestore = getFirestore(app); // Ye line pehle se hogi

        // ===============================
        // ? CORRECTED SPIN WHEEL LOGIC
        // ===============================
        let editingPrizeId = null;
        let wheelPrizes = [];
        let wheelEnabled = false;

        // Functions ko window object pe attach karna padega taki HTML buttons inhe call kar sakein
        window.loadWheelPrizes = async function() {
            if (!RESTAURANT_ID) return;
            
            // Firestore v11 Syntax Update
            const prizesRef = collection(dbFirestore, "restaurants", RESTAURANT_ID, "wheel_prizes");
            
            onSnapshot(prizesRef, (snapshot) => {
                wheelPrizes = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    wheelPrizes.push({
                        id: doc.id,
                        text: data.text,
                        value: data.value || 0,
                        type: data.type || (data.isFlat ? 'flat' : data.isFree ? 'none' : 'percent'),
                        color: data.color || '#a78bfa'
                    });
                });
                renderWheelPrizes();
            });

            // Settings Listener
            const settingRef = doc(dbFirestore, "restaurants", RESTAURANT_ID, "settings", "wheel");
            onSnapshot(settingRef, (docSnap) => {
                if (docSnap.exists()) {
                    wheelEnabled = docSnap.data().enabled;
                    updateWheelStatusUI();
                }
            });
        };

        window.renderWheelPrizes = function() {
            const grid = document.getElementById('wheel-prizes-grid');
            if (!grid) return;
            if (wheelPrizes.length === 0) {
                grid.innerHTML = '<p class="text-gray-400 text-sm col-span-3">No prizes added yet.</p>';
                return;
            }
            grid.innerHTML = wheelPrizes.map((p) => `
                <div class="bg-white border border-purple-100 rounded-xl p-4 flex flex-col gap-2 shadow-sm relative">
                    <div class="flex items-center gap-2">
                        <span class="w-5 h-5 rounded-full" style="background:${p.color}"></span>
                        <span class="font-bold text-purple-700">${p.text}</span>
                    </div>
                    <div class="flex items-center gap-2 text-xs">
                        <span class="bg-purple-100 text-purple-700 px-2 py-1 rounded">${p.type === 'percent' ? p.value + '% OFF' : p.type === 'flat' ? '?' + p.value + ' OFF' : 'No Prize'}</span>
                    </div>
                    <div class="flex gap-2 mt-2">
                        <button onclick="editWheelPrize('${p.id}')" class="text-xs px-3 py-1 bg-purple-50 text-purple-700 rounded hover:bg-purple-100 font-bold"><i class='fas fa-edit'></i> Edit</button>
                        <button onclick="deleteWheelPrize('${p.id}')" class="text-xs px-3 py-1 bg-red-50 text-red-600 rounded hover:bg-red-100 font-bold"><i class='fas fa-trash'></i> Delete</button>
                    </div>
                </div>
            `).join('');
        };

        window.updateWheelStatusUI = function() {
            const toggle = document.getElementById('admin-spin-wheel-toggle');
            const knob = document.getElementById('admin-spin-toggle-knob');
            if (toggle) toggle.checked = !!wheelEnabled;
            if (knob) knob.style.transform = wheelEnabled ? 'translateX(1.5rem)' : 'translateX(0)';
        };

        window.toggleWheelEnabled = async function() {
            if (!RESTAURANT_ID) return;
            const toggle = document.getElementById('admin-spin-wheel-toggle');
            const enabled = toggle.checked;
            await setDoc(doc(dbFirestore, "restaurants", RESTAURANT_ID, "settings", "wheel"), { enabled }, { merge: true });
            wheelEnabled = enabled;
            updateWheelStatusUI();
            window.showToast('Spin Wheel ' + (enabled ? 'enabled' : 'disabled'), 'success');
        };

        window.openWheelPrizeModal = function(prizeId = null) {
            editingPrizeId = prizeId;
            const modal = document.getElementById('wheel-prize-modal');
            if (!modal) return;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            document.getElementById('prize-text').value = '';
            document.getElementById('prize-value').value = '';
            document.getElementById('prize-color').value = '#a78bfa';
            
            if (prizeId) {
                const prize = wheelPrizes.find(p => p.id === prizeId);
                if (prize) {
                    document.getElementById('prize-text').value = prize.text;
                    document.getElementById('prize-value').value = prize.value;
                    document.getElementById('prize-type').value = prize.type;
                    document.getElementById('prize-color').value = prize.color;
                }
            }
        };

        window.closeWheelPrizeModal = function() {
            const modal = document.getElementById('wheel-prize-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
            editingPrizeId = null;
        };

        window.saveWheelPrize = async function() {
            if (!RESTAURANT_ID) return;
            const text = document.getElementById('prize-text').value.trim();
            const value = parseFloat(document.getElementById('prize-value').value);
            const type = document.getElementById('prize-type').value;
            const color = document.getElementById('prize-color').value;

            if (!text || (type !== 'none' && isNaN(value))) {
                window.showToast('Please fill all fields', 'error');
                return;
            }

            const data = { text, value: value || 0, type, color };

            try {
                if (editingPrizeId) {
                    await updateDoc(doc(dbFirestore, "restaurants", RESTAURANT_ID, "wheel_prizes", editingPrizeId), data);
                    window.showToast('Prize updated!', 'success');
                } else {
                    await addDoc(collection(dbFirestore, "restaurants", RESTAURANT_ID, "wheel_prizes"), data);
                    window.showToast('Prize added!', 'success');
                }
                window.closeWheelPrizeModal();
            } catch (e) {
                console.error(e);
                window.showToast('Failed to save prize', 'error');
            }
        };

        window.deleteWheelPrize = async function(prizeId) {
            if (!confirm('Delete this prize?')) return;
            try {
                await deleteDoc(doc(dbFirestore, "restaurants", RESTAURANT_ID, "wheel_prizes", prizeId));
                window.showToast('Prize deleted!', 'success');
            } catch (e) {
                window.showToast('Failed to delete', 'error');
            }
        };

        // =====================================================
        // ðŸ›¡ï¸ SECURITY & CRASH PREVENTION SYSTEM v3.0
        // Module: Anti-Hacker + Crash Protection
        // =====================================================

        // --- SECURITY CONSTANTS ---
        const SECURITY_CONFIG = {
            MAX_LOGIN_ATTEMPTS: 5,
            LOGIN_LOCKOUT_TIME: 15 * 60 * 1000, // 15 minutes
            MAX_REQUESTS_PER_MINUTE: 60,
            MAX_INPUT_LENGTH: 500,
            MAX_ARRAY_SIZE: 1000,
            ALLOWED_HTML_TAGS: [],
            SESSION_TIMEOUT: 24 * 60 * 60 * 1000, // 24 hours
        };

        // --- RATE LIMITER (Prevent DDoS/Spam) ---
        const rateLimiter = {
            requests: new Map(),
            loginAttempts: new Map(),
            
            checkLimit: function(action, limit = SECURITY_CONFIG.MAX_REQUESTS_PER_MINUTE) {
                const now = Date.now();
                const key = action;
                const history = this.requests.get(key) || [];
                
                // Clean old entries (older than 1 minute)
                const recentHistory = history.filter(t => now - t < 60000);
                
                if (recentHistory.length >= limit) {
                    console.warn('ðŸ›¡ï¸ Rate limit exceeded for:', action);
                    return false;
                }
                
                recentHistory.push(now);
                this.requests.set(key, recentHistory);
                return true;
            },
            
            checkLoginAttempt: function(tenantId) {
                const now = Date.now();
                const attempts = this.loginAttempts.get(tenantId) || { count: 0, lockUntil: 0 };
                
                if (attempts.lockUntil > now) {
                    const remainingTime = Math.ceil((attempts.lockUntil - now) / 60000);
                    return { allowed: false, message: `Too many attempts. Try again in ${remainingTime} minutes.` };
                }
                
                return { allowed: true };
            },
            
            recordLoginAttempt: function(tenantId, success) {
                const attempts = this.loginAttempts.get(tenantId) || { count: 0, lockUntil: 0 };
                
                if (success) {
                    this.loginAttempts.delete(tenantId);
                } else {
                    attempts.count++;
                    if (attempts.count >= SECURITY_CONFIG.MAX_LOGIN_ATTEMPTS) {
                        attempts.lockUntil = Date.now() + SECURITY_CONFIG.LOGIN_LOCKOUT_TIME;
                        attempts.count = 0;
                    }
                    this.loginAttempts.set(tenantId, attempts);
                }
            }
        };

        // --- INPUT SANITIZER (Prevent XSS/Injection) ---
        const sanitizer = {
            // Remove ALL HTML tags to prevent XSS
            escapeHtml: function(str) {
                if (typeof str !== 'string') return str;
                return str
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;')
                    .replace(/\//g, '&#x2F;');
            },
            
            // Sanitize input - remove dangerous characters
            sanitizeInput: function(input, maxLength = SECURITY_CONFIG.MAX_INPUT_LENGTH) {
                if (typeof input !== 'string') return input;
                let clean = input.trim();
                // Remove null bytes
                clean = clean.replace(/\0/g, '');
                // Limit length
                if (clean.length > maxLength) clean = clean.substring(0, maxLength);
                return clean;
            },
            
            // Validate tenant ID format
            validateTenantId: function(id) {
                if (!id || typeof id !== 'string') return false;
                const clean = id.trim().toLowerCase();
                // Only allow alphanumeric, hyphens, underscores (max 50 chars)
                return /^[a-z0-9_-]{1,50}$/.test(clean);
            },
            
            // Validate numeric input
            validateNumber: function(val, min = 0, max = 999999) {
                const num = Number(val);
                return !isNaN(num) && num >= min && num <= max;
            },
            
            // Sanitize object before saving to DB
            sanitizeObject: function(obj) {
                if (!obj || typeof obj !== 'object') return obj;
                const clean = {};
                for (const [key, value] of Object.entries(obj)) {
                    if (typeof value === 'string') {
                        clean[key] = this.sanitizeInput(value);
                    } else if (typeof value === 'number') {
                        clean[key] = this.validateNumber(value) ? value : 0;
                    } else if (Array.isArray(value)) {
                        clean[key] = value.slice(0, SECURITY_CONFIG.MAX_ARRAY_SIZE);
                    } else {
                        clean[key] = value;
                    }
                }
                return clean;
            }
        };

        // --- GLOBAL ERROR BOUNDARY (Prevent Crashes) ---
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('ðŸ”´ Global Error Caught:', { msg, url, lineNo, columnNo, error });
            // Don't crash the whole app
            if (window.showToast) {
                window.showToast('Something went wrong. Please refresh if issues persist.', 'error');
            }
            return true; // Prevent default error handling
        };

        window.onunhandledrejection = function(event) {
            console.error('ðŸ”´ Unhandled Promise Rejection:', event.reason);
            if (window.showToast) {
                window.showToast('Operation failed. Please try again.', 'error');
            }
            event.preventDefault();
        };

        // --- SAFE FUNCTION WRAPPER (Crash Protection) ---
        const safeExecute = async (fn, fallbackValue = null, errorMsg = 'Operation failed') => {
            try {
                return await fn();
            } catch (error) {
                console.error('ðŸ”´ Safe Execute Error:', error);
                if (window.showToast) window.showToast(errorMsg, 'error');
                return fallbackValue;
            }
        };

        // --- MEMORY PROTECTION ---
        const memoryGuard = {
            maxCacheSize: 5000,
            
            checkArraySize: function(arr, name = 'array') {
                if (arr && arr.length > this.maxCacheSize) {
                    console.warn(`ðŸ›¡ï¸ Memory Guard: ${name} exceeds limit (${arr.length}), trimming...`);
                    return arr.slice(-this.maxCacheSize);
                }
                return arr;
            },
            
            checkMapSize: function(map, name = 'map') {
                if (map && map.size > this.maxCacheSize) {
                    console.warn(`ðŸ›¡ï¸ Memory Guard: ${name} exceeds limit (${map.size}), clearing old entries...`);
                    const entries = Array.from(map.entries());
                    map.clear();
                    entries.slice(-Math.floor(this.maxCacheSize / 2)).forEach(([k, v]) => map.set(k, v));
                }
            }
        };

        // =====================================================
        // ENTERPRISE TENANT VALIDATION SYSTEM v2.0
        // Module 4: Security & Validation Matrix - ADMIN
        // =====================================================

        /**
         * STRICT TENANT RESOLUTION (with Security)
         */
        const resolveRestaurantId = () => {
            try {
                const qs = new URLSearchParams(window.location.search);
                let urlId = (qs.get('id') || qs.get('tenant') || qs.get('cafe') || '').trim().toLowerCase();
                
                // ðŸ›¡ï¸ SECURITY: Sanitize and validate tenant ID
                urlId = sanitizer.sanitizeInput(urlId, 50);
                
                if (urlId && !sanitizer.validateTenantId(urlId)) {
                    console.error('ðŸ›¡ï¸ SECURITY: Invalid tenant ID format rejected:', urlId);
                    return null;
                }
                
                if (urlId) {
                    console.log('[ADMIN] Tenant from URL:', urlId);
                    sessionStorage.setItem('wowAdminTenant', urlId);
                    localStorage.removeItem('wowRestaurantId');
                    return urlId;
                }
                
                let sessionId = (sessionStorage.getItem('wowAdminTenant') || '').trim();
                sessionId = sanitizer.sanitizeInput(sessionId, 50);
                
                if (sessionId && sanitizer.validateTenantId(sessionId)) {
                    console.log('[ADMIN] Using session tenant:', sessionId);
                    return sessionId;
                }
                
                console.error('?ï¿½Å’ [ADMIN] NO TENANT FOUND!');
                localStorage.removeItem('wowRestaurantId');
                return null;
            } catch (e) {
                console.error('Tenant resolution error:', e);
                return null;
            }
        };

        /**
         * STRICT TENANT VALIDATION - Checks Firestore for existence
         */
        const validateTenantExists = async (tenantId) => {
            if (!tenantId) return { valid: false, reason: 'NO_TENANT_ID' };
            
            try {
                console.log('ADMIN] Validating tenant exists in Firestore:', tenantId);
                
                // PRIMARY CHECK: Check restaurants collection (where super-admin creates restaurants)
                const restaurantDocRef = doc(dbFirestore, 'restaurants', tenantId);
                const restaurantSnap = await getDoc(restaurantDocRef);
                
                if (restaurantSnap.exists()) {
                    const restaurantData = restaurantSnap.data();
                    console.log('[OK]?ï¿½ï¿½ [ADMIN] Restaurant VERIFIED:', tenantId, restaurantData);
                    return { valid: true, data: restaurantData, cafeName: restaurantData.name || tenantId };
                }
                
                console.log('ADMIN] Restaurant doc not found, checking menu...');
                
                // FALLBACK: Check menu exists (legacy data)
                const menuRef = collection(dbFirestore, 'restaurants', tenantId, 'menu');
                const menuSnap = await getDocs(menuRef);
                
                if (!menuSnap.empty) {
                    console.log('[OK]?ï¿½ï¿½ [ADMIN] Tenant verified via menu data:', tenantId, 'Items:', menuSnap.size);
                    return { valid: true, data: { id: tenantId }, cafeName: tenantId };
                }
                
                console.error('?ï¿½Å’ [ADMIN] Tenant NOT FOUND:', tenantId);
                return { valid: false, reason: 'TENANT_NOT_FOUND' };
                
            } catch (error) {
                console.error('?ï¿½Å’ [ADMIN] Validation error:', error);
                console.error('?ï¿½Å’ [ADMIN] Error details:', error.message, error.code);
                // On network error, allow access (fail-open for better UX)
                if (error.code === 'unavailable' || error.message.includes('network')) {
                    console.warn('?ï¿½?ï¿½?ï¿½ [ADMIN] Network error - allowing access');
                    return { valid: true, data: { id: tenantId }, cafeName: tenantId };
                }
                return { valid: false, reason: 'VALIDATION_ERROR', error: error.message };
            }
        };

        /**
         * Shows 404 Error for invalid tenants
         */
        const showTenantNotFoundError = (tenantId, reason) => {
            document.body.innerHTML = `
                <div style="
                    min-height: 100vh;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
                    color: white;
                    font-family: system-ui, -apple-system, sans-serif;
                    text-align: center;
                    padding: 2rem;
                ">
                    <div style="max-width: 450px;">
                        <div style="
                            width: 100px;
                            height: 100px;
                            margin: 0 auto 20px;
                            background: linear-gradient(135deg, #ef4444, #dc2626);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 40px;
                            box-shadow: 0 15px 30px rgba(239, 68, 68, 0.3);
                        ">?</div>
                        
                        <h1 style="
                            font-size: 1.75rem;
                            font-weight: 800;
                            margin-bottom: 12px;
                            color: #f87171;
                        ">Cafe Not Found</h1>
                        
                        <p style="color: #94a3b8; font-size: 1rem; line-height: 1.6; margin-bottom: 20px;">
                            The cafe <strong style="color: #fbbf24;">"${tenantId || 'unknown'}"</strong> 
                            doesn't exist in our system.
                        </p>
                        
                        <div style="
                            background: rgba(239, 68, 68, 0.1);
                            border: 1px solid rgba(239, 68, 68, 0.3);
                            border-radius: 12px;
                            padding: 16px;
                            margin-bottom: 20px;
                        ">
                            <p style="color: #fca5a5; font-size: 0.85rem; margin: 0; font-family: monospace;">
                                Error: 404_TENANT_NOT_FOUND<br>
                                Reason: ${reason || 'Invalid cafe ID'}
                            </p>
                        </div>
                        
                        <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 20px;">
                            Get the correct Admin URL from Super Admin panel.
                        </p>
                        
                        <div style="display: flex; gap: 12px; justify-content: center;">
                            <button onclick="window.location.reload()" style="
                                background: #3b82f6;
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 10px;
                                font-size: 0.95rem;
                                font-weight: 600;
                                cursor: pointer;
                            ">Retry</button>
                            <button onclick="window.history.back()" style="
                                background: #374151;
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 10px;
                                font-size: 0.95rem;
                                font-weight: 600;
                                cursor: pointer;
                            ">Back</button>
                        </div>
                    </div>
                </div>
            `;
            throw new Error(`TENANT_NOT_FOUND: ${tenantId}`);
        };

        /**
         * Shows validation loader
         */
        const showValidationLoader = () => {
            const loader = document.createElement('div');
            loader.id = 'validation-loader';
            loader.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: linear-gradient(135deg, #1f2937, #111827);
                display: flex; align-items: center; justify-content: center;
                z-index: 99999; font-family: system-ui; color: white; text-align: center;
            `;
            loader.innerHTML = `
                <div>
                    <div class="orderly-spinner" style="
                        width: 60px; height: 60px; 
                        border: 4px solid rgba(255,255,255,0.1);
                        border-top: 4px solid #f97316;
                        border-radius: 50%;
                        animation: orderly-spin 1s linear infinite;
                        margin: 0 auto 20px;
                    "></div>
                    <h2 style="font-size: 1.5rem; font-weight: 700; color: #f97316; margin-bottom: 8px;">Orderly</h2>
                    <p style="font-size: 0.9rem; color: #9ca3af;">Loading admin dashboard...</p>
                </div>
                <style>@keyframes orderly-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
            `;
            document.body.appendChild(loader);
        };

        const hideValidationLoader = () => {
            const loader = document.getElementById('validation-loader');
            if (loader) loader.remove();
            // Also hide the initial loader
            const initialLoader = document.getElementById('initial-loader');
            if (initialLoader) initialLoader.style.display = 'none';
        };

        // =====================================================
        // MAIN INITIALIZATION WITH STRICT VALIDATION GATE
        // =====================================================
        
        let RESTAURANT_ID = null;
        let TENANT_DATA = null;

        const initializeAdminApp = async () => {
            let tenantId = resolveRestaurantId();
            
            // Default to 'Orderly' if no ID provided
            if (!tenantId || tenantId.trim() === '') {
                tenantId = 'Orderly';
                console.log('?ï¿½?ï¿½?ï¿½ No tenant ID in URL, defaulting to: Orderly');
            }
            
            showValidationLoader();
            
            // STRICT VALIDATION - Check Firestore
            const validation = await validateTenantExists(tenantId);
            
            hideValidationLoader();
            
            if (!validation.valid) {
                console.error('?ï¿½Å’ [ADMIN] Validation FAILED:', validation.reason);
                // Still allow access but show warning
                console.warn('?ï¿½?ï¿½?ï¿½ Proceeding without validation for development');
                RESTAURANT_ID = tenantId;
                TENANT_DATA = { id: tenantId, name: 'Orderly' };
                initAdminFeatures();
                return true;
            }
            
            // Tenant is VALID
            RESTAURANT_ID = tenantId;
            TENANT_DATA = validation.data;
            window.RESTAURANT_ID = tenantId;
            window.TENANT_DATA = validation.data;
            
            console.log('[OK]?ï¿½ï¿½ [ADMIN] Tenant validated:', RESTAURANT_ID);
            
            // NOW initialize all admin features
            initAdminFeatures();
            
            return true;
        };

        // Execute strict initialization
        initializeAdminApp().catch(err => {
            console.error('Admin initialization failed:', err);
            // Force hide loader on error
            const initialLoader = document.getElementById('initial-loader');
            if (initialLoader) initialLoader.style.display = 'none';
        });
        
        // Safety: Force hide loader after 15 seconds if Firebase doesn't connect
        setTimeout(() => {
            const initialLoader = document.getElementById('initial-loader');
            if (initialLoader && initialLoader.style.display !== 'none') {
                console.warn('?? Loader timeout - forcing hide after 15s');
                initialLoader.style.display = 'none';
                window.showToast && window.showToast('Connection slow. Some features may not work.', 'warning');
            }
        }, 15000);
        
        const getSessionKey = () => `wowAdminSession:${RESTAURANT_ID}`;

        // Function to initialize all admin features after validation
        const initAdminFeatures = () => {
            console.log('?ï¿½ï¿½ [ADMIN] Initializing admin features for:', RESTAURANT_ID);
            
            // Show tenant ID in sidebar
            const tenantEl = document.getElementById('sidebar-tenant-id');
            if (tenantEl) {
                tenantEl.innerText = RESTAURANT_ID ? `Ëœ?ï¿½ï¿½ ${RESTAURANT_ID}` : '?ï¿½?ï¿½?ï¿½ No Cafe ID';
                tenantEl.title = RESTAURANT_ID || 'Missing tenant ID';
            }
            
            // Initialize all features
                // ===============================
                // ? CORRECTED SPIN WHEEL LOGIC (MODULAR v11)
                // ===============================
                let editingPrizeId = null;
                let wheelPrizes = [];
                let wheelEnabled = false;

                // Note: Hum seedha 'dbFirestore' use karenge jo upar import kiya hai

                window.loadWheelPrizes = async function() {
                    if (!RESTAURANT_ID) return;

                    // 1. Load Prizes (Using Modular Syntax)
                    const prizesRef = collection(dbFirestore, "restaurants", RESTAURANT_ID, "wheel_prizes");
                    
                    onSnapshot(prizesRef, (snapshot) => {
                        wheelPrizes = [];
                        snapshot.forEach(docSnap => {
                            const data = docSnap.data();
                            wheelPrizes.push({
                                id: docSnap.id,
                                text: data.text,
                                value: data.value || 0,
                                type: data.type || (data.isFlat ? 'flat' : data.isFree ? 'none' : 'percent'),
                                color: data.color || '#a78bfa'
                            });
                        });
                        renderWheelPrizes();
                    });

                    // 2. Load Settings (Using Modular Syntax)
                    const settingsRef = doc(dbFirestore, "restaurants", RESTAURANT_ID, "settings", "wheel");
                    onSnapshot(settingsRef, (docSnap) => {
                        if (docSnap.exists()) {
                            wheelEnabled = docSnap.data().enabled;
                            updateWheelStatusUI();
                        }
                    });
                }

                window.renderWheelPrizes = function() {
                    const grid = document.getElementById('wheel-prizes-grid');
                    if (!grid) return;
                    
                    if (wheelPrizes.length === 0) {
                        grid.innerHTML = '<p class="text-gray-400 text-sm col-span-3">No prizes added yet.</p>';
                        return;
                    }
                    
                    grid.innerHTML = wheelPrizes.map((p) => `
                        <div class="bg-white border border-purple-100 rounded-xl p-4 flex flex-col gap-2 shadow-sm relative">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-purple-700">${p.text}</span>
                            </div>
                            <div class="flex items-center gap-2 text-xs">
                                <span class="bg-purple-100 text-purple-700 px-2 py-1 rounded">${p.type === 'percent' ? p.value + '% OFF' : p.type === 'flat' ? '?' + p.value + ' OFF' : 'No Prize'}</span>
                            </div>
                            <div class="flex gap-2 mt-2">
                                <button onclick="editWheelPrize('${p.id}')" class="text-xs px-3 py-1 bg-purple-50 text-purple-700 rounded hover:bg-purple-100 font-bold"><i class='fas fa-edit'></i> Edit</button>
                                <button onclick="deleteWheelPrize('${p.id}')" class="text-xs px-3 py-1 bg-red-50 text-red-600 rounded hover:bg-red-100 font-bold"><i class='fas fa-trash'></i> Delete</button>
                            </div>
                        </div>
                    `).join('');
                }

                window.updateWheelStatusUI = function() {
                    const toggle = document.getElementById('admin-spin-wheel-toggle');
                    const knob = document.getElementById('admin-spin-toggle-knob');
                    if (toggle) toggle.checked = !!wheelEnabled;
                    if (knob) knob.style.transform = wheelEnabled ? 'translateX(1.5rem)' : 'translateX(0)';
                }

                window.toggleWheelEnabled = async function() {
                    if (!RESTAURANT_ID) return;
                    const toggle = document.getElementById('admin-spin-wheel-toggle');
                    const enabled = toggle.checked;
                    
                    const settingsRef = doc(dbFirestore, "restaurants", RESTAURANT_ID, "settings", "wheel");
                    // Using setDoc with merge instead of .set()
                    await setDoc(settingsRef, { enabled }, { merge: true });
                    
                    wheelEnabled = enabled;
                    updateWheelStatusUI();
                    window.showToast('Spin Wheel ' + (enabled ? 'enabled' : 'disabled'), 'success');
                };

                window.openWheelPrizeModal = function(prizeId = null) {
                    editingPrizeId = prizeId;
                    const modal = document.getElementById('wheel-prize-modal');
                    if (!modal) return;
                    
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    
                    // Reset form
                    document.getElementById('prize-text').value = '';
                    document.getElementById('prize-value').value = '';
                    document.getElementById('prize-type').value = 'percent';
                    document.getElementById('prize-color').value = '#a78bfa';

                    if (prizeId) {
                        const prize = wheelPrizes.find(p => p.id === prizeId);
                        if (prize) {
                            document.getElementById('prize-text').value = prize.text;
                            document.getElementById('prize-value').value = prize.value;
                            document.getElementById('prize-type').value = prize.type;
                            document.getElementById('prize-color').value = prize.color;
                        }
                    }
                };

                window.closeWheelPrizeModal = function() {
                    const modal = document.getElementById('wheel-prize-modal');
                    if (!modal) return;
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    editingPrizeId = null;
                };

                window.saveWheelPrize = async function() {
                    const text = document.getElementById('prize-text').value.trim();
                    const value = parseFloat(document.getElementById('prize-value').value);
                    const type = document.getElementById('prize-type').value;
                    const color = document.getElementById('prize-color').value;

                    if (!text || (type !== 'none' && isNaN(value))) {
                        window.showToast('Please fill all fields', 'error');
                        return;
                    }

                    const data = {
                        text,
                        value: value || 0,
                        type,
                        color
                    };

                    try {
                        if (editingPrizeId) {
                            // Update existing (Modular)
                            const docRef = doc(dbFirestore, "restaurants", RESTAURANT_ID, "wheel_prizes", editingPrizeId);
                            await updateDoc(docRef, data); // updateDoc was imported but previously user used .set
                            window.showToast('Prize updated!', 'success');
                        } else {
                            // Add new (Modular)
                            const colRef = collection(dbFirestore, "restaurants", RESTAURANT_ID, "wheel_prizes");
                            await addDoc(colRef, data);
                            window.showToast('Prize added!', 'success');
                        }
                        closeWheelPrizeModal();
                    } catch (e) {
                        console.error(e);
                        window.showToast('Failed to save prize', 'error');
                    }
                };

                window.editWheelPrize = function(prizeId) {
                    window.openWheelPrizeModal(prizeId);
                };

                window.deleteWheelPrize = async function(prizeId) {
                    if (!confirm('Delete this prize?')) return;
                    try {
                        // Delete (Modular)
                        const docRef = doc(dbFirestore, "restaurants", RESTAURANT_ID, "wheel_prizes", prizeId);
                        await deleteDoc(docRef);
                        window.showToast('Prize deleted!', 'success');
                    } catch (e) {
                        console.error(e);
                        window.showToast('Failed to delete prize', 'error');
                    }
                };

                // Initialize on page load (Wait for Auth/Tenant ID)
                setTimeout(() => {
                    if(window.RESTAURANT_ID) loadWheelPrizes();
                }, 3000);
    
            initAuth();
            initLiveDashboard();
            initFinancials();
            // ? YE LINE ADD KARO
            if (window.loadWheelPrizes) window.loadWheelPrizes();
            if (window.loadCustomerSiteSettings) window.loadCustomerSiteSettings();
            initMenuLogic();
            initAddons();
            initOffers();
            initSystemMonitors();
            window.addSizeRow();
            
            // Initialize advanced dashboard
            initDashboard();
            
            // Initialize new restaurant management features
            if (typeof initInventory === 'function') initInventory();
            
            // Enforce subscription plan limits
            enforcePlanLimits();
            
            console.log('[OK] [ADMIN] All features initialized (including inventory)');
        };

        // --- FEATURE GATING / UNLOCKING ---
        const enforcePlanLimits = () => {
            // 1. Get Plan Features from verified TENANT_DATA (loaded on login)
            const subscription = window.TENANT_DATA?.subscription || {};
            const features = subscription.features || {};
            const planName = subscription.planName || 'Free';

            console.log(`ðŸ”’ Enforcing plan: ${planName}`, features);

            // 2. Hide/Show Tabs based on features
            const analyticsTab = document.getElementById('nav-reports');
            const crmTab = document.getElementById('nav-crm');
            const inventoryTab = document.getElementById('nav-inventory');

            // If 'analytics' feature is false, lock the tab
            if (features.analytics === false) {
                if (analyticsTab) {
                    analyticsTab.style.opacity = '0.5';
                    analyticsTab.style.pointerEvents = 'none';
                    analyticsTab.innerHTML += ' <i class="fas fa-lock text-xs ml-auto"></i>';
                    analyticsTab.title = 'Upgrade plan to unlock Analytics';
                }
            }

            // If 'crm' feature is false, lock the tab
            if (features.crm === false) {
                if (crmTab) {
                    crmTab.style.opacity = '0.5';
                    crmTab.style.pointerEvents = 'none';
                    crmTab.innerHTML += ' <i class="fas fa-lock text-xs ml-auto"></i>';
                    crmTab.title = 'Upgrade plan to unlock CRM';
                }
            }

            // If 'inventory' feature is false, lock the tab
            if (features.inventory === false) {
                if (inventoryTab) {
                    inventoryTab.style.opacity = '0.5';
                    inventoryTab.style.pointerEvents = 'none';
                    inventoryTab.innerHTML += ' <i class="fas fa-lock text-xs ml-auto"></i>';
                    inventoryTab.title = 'Upgrade plan to unlock Inventory';
                }
            }

            // 3. Show Plan Badge in Sidebar
            const sidebarTitle = document.querySelector('aside h1');
            if (sidebarTitle && !sidebarTitle.querySelector('.plan-badge')) {
                const badge = document.createElement('span');
                badge.className = "plan-badge text-[10px] bg-gray-800 text-white px-2 py-0.5 rounded ml-2 align-middle border border-gray-600";
                badge.innerText = planName.toUpperCase();
                
                // Color code by plan
                if (planName.toLowerCase() === 'premium' || planName.toLowerCase() === 'pro') {
                    badge.className = "plan-badge text-[10px] bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-2 py-0.5 rounded ml-2 align-middle";
                } else if (planName.toLowerCase() === 'basic') {
                    badge.className = "plan-badge text-[10px] bg-blue-600 text-white px-2 py-0.5 rounded ml-2 align-middle";
                }
                
                sidebarTitle.appendChild(badge);
            }

            console.log('ðŸ”“ Plan limits enforced:', planName);
        };

        // Global State
        const PLATFORM_FEE = 1.98; // Centralized Fee
        window.menuItemsCache = {};
        window.universalAddons = {};
        window.syncedOrdersCache = new Set();
        window.ordersCache = {}; // Store orders for EOD/reports
        window.currentAdminBalance = 0;
        window.previousBalance = null; // New for Recharge detection

        window.fullHistoryData = [];
        window.visibleHistoryCount = 0;
        window.crmData = [];
        window.visibleCRMCount = 0;

        const BATCH_SIZE = 20;

        // --- SECURITY: SAFE WALLET UPDATE WITH PERMISSION CHECK ---
        // This function ensures wallet is NEVER deducted without admin permission
        window.lastWalletUpdateSource = null; // Global flag for legitimate updates

        const safeWalletUpdate = async (newBalance, amount, description, source, requirePermission = true) => {
            const oldBalance = window.currentAdminBalance;
            const diff = newBalance - oldBalance;

            console.log(`?ï¿½?ï¿½ï¿½ Safe wallet update called:`, {
                oldBalance,
                newBalance,
                diff,
                source,
                description,
                requirePermission
            });

            // SECURITY CHECK 1: Block unauthorized RECHARGES (positive balance increase)
            // Only Super Admin via Firebase backend can add money to wallet
            if (diff > 0) {
                const errorMsg = `?? RECHARGE BLOCKED! Wallet recharge is only allowed via Super Admin.\nAttempted Amount: ?${diff.toFixed(2)}\nSource: ${source}`;
                console.error("SECURITY ALERT - Recharge Attempt Blocked:", errorMsg);
                
                window.showToast(`?? Recharge blocked! Only Super Admin can add funds.`, "error");
                
                // Log the attempted recharge hack
                try {
                    await addDoc(collection(dbFirestore, "restaurants", RESTAURANT_ID, "security_violations"), {
                        type: "unauthorized_recharge_attempt",
                        attemptedAmount: diff,
                        oldBalance: oldBalance,
                        attemptedNewBalance: newBalance,
                        source: source,
                        description: description,
                        timestamp: serverTimestamp(),
                        stackTrace: new Error().stack
                    });
                } catch (e) {
                    console.error("Failed to log security violation:", e);
                }
                
                throw new Error("UNAUTHORIZED_RECHARGE: Wallet recharge requires Super Admin access");
            }

            // SECURITY CHECK 2: Detect unauthorized deductions
            if (diff < 0 && requirePermission) {
                // Check if this is a legitimate admin-approved deduction
                const isLegitimate = source.includes("Admin Approval") ||
                    source.includes("POS (Pay Now)") ||
                    source === "Admin Approval";

                if (!isLegitimate) {
                    const errorMsg = `?? UNAUTHORIZED WALLET DEDUCTION DETECTED! ??\nAmount: ?${Math.abs(diff).toFixed(2)}\nSource: ${source}\nDescription: ${description}`;
                    console.error("CRITICAL SECURITY ALERT:", errorMsg);
                    console.trace("Stack trace:");

                    window.showToast(`?? UNAUTHORIZED DEDUCTION: ?${Math.abs(diff).toFixed(2)}`, "error");
                    setTimeout(() => {
                        window.showToast(`Source: ${source}`, "error");
                    }, 2000);

                    // Log security violation
                    try {
                        await addDoc(collection(dbFirestore, "restaurants", RESTAURANT_ID, "security_violations"), {
                            type: "unauthorized_wallet_deduction",
                            amount: Math.abs(diff),
                            oldBalance: oldBalance,
                            newBalance: newBalance,
                            source: source,
                            description: description,
                            timestamp: serverTimestamp(),
                            stackTrace: new Error().stack
                        });
                    } catch (e) {
                        console.error("Failed to log security violation:", e);
                    }

                    // REVERT the change if possible
                    throw new Error("UNAUTHORIZED_WALLET_DEDUCTION: Wallet deduction requires admin permission");
                }
            }

            // Mark as legitimate update before making change
            window.lastWalletUpdateSource = source;

            // Safe update
            await update(ref(dbRTDB, `restaurants/${RESTAURANT_ID}/admin`), { walletBalance: newBalance });
            window.currentAdminBalance = newBalance;

            // Log transaction
            if (diff !== 0) {
                await logTransaction(Math.abs(diff), description, diff > 0 ? "credit" : "debit", source);
            }

            console.log(`Ã…?ï¿½ï¿½?ï¿½ Safe wallet update completed: ${oldBalance} ?ï¿½ï¿½?ï¿½?ï¿½ï¿½ ${newBalance}(${diff > 0 ? '+' : ''}${diff.toFixed(2)})`, { source, description });

            // Clear flag after a short delay to allow monitoring to detect it
            setTimeout(() => {
                window.lastWalletUpdateSource = null;
            }, 1000);
        };

        // --- HELPER: LOG WALLET TRANSACTION ---
        // Handles both Recharges (Credit) and Deductions (Debit)
        const logTransaction = async (amount, description, type, source) => {
            try {
                await addDoc(collection(dbFirestore, "restaurants", RESTAURANT_ID, "wallet_transactions"), {
                    amount: Number(amount),
                    description: description,
                    type: type, // 'credit' or 'debit'
                    timestamp: serverTimestamp(),
                    source: source
                });
                console.log("Transaction logged successfully:", { amount, description, type, source });
            } catch (e) {
                console.error("Log failed - CRITICAL ERROR:", e);
                // Show error to user so they know logging failed
                window.showToast(`Failed to log transaction: ${description} `, "error");
            }
        };

        // --- AUTH & PERSISTENCE ---
        const initAuth = async () => {
            const loginOverlay = document.getElementById('login-overlay');
            const cafeIdDisplay = document.getElementById('login-cafe-id');
            
            // Display Cafe ID in login panel
            if (cafeIdDisplay && RESTAURANT_ID) {
                cafeIdDisplay.innerHTML = `
                    <p class="text-[10px] text-gray-400 uppercase font-bold">Cafe ID</p>
                    <p class="text-sm font-mono font-bold text-orange-600">${RESTAURANT_ID}</p>
                `;
            } else if (cafeIdDisplay) {
                cafeIdDisplay.innerHTML = `
                    <p class="text-[10px] text-red-400 uppercase font-bold">Error</p>
                    <p class="text-sm font-bold text-red-600">No Cafe ID in URL</p>
                `;
            }
            
            // Check for existing session - if active, hide login
            const session = localStorage.getItem(getSessionKey()) || localStorage.getItem('wowAdminSession');
            if (session === 'active' && RESTAURANT_ID) {
                loginOverlay.classList.add('hidden');
                console.log('? Session active - auto login');
            } else {
                // No session - show login overlay
                loginOverlay.classList.remove('hidden');
            }

            if (!RESTAURANT_ID) {
                const errorMsg = document.getElementById('login-error');
                if (errorMsg) {
                    errorMsg.classList.remove('hidden');
                    errorMsg.innerHTML = '<i class="fas fa-link"></i> Missing Cafe ID. Open Admin using link like <b>?id=YOUR_CAFE_ID</b>.';
                }
                return;
            }

            const ownerRef = ref(dbRTDB, `restaurants/${RESTAURANT_ID}/admin/settings`);
            onValue(ownerRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    document.getElementById('setting-owner-name').value = data.ownerName || '';
                    document.getElementById('setting-owner-phone').value = data.ownerPhone || '';
                }
            });

            const savedTheme = localStorage.getItem('wowAdminTheme');
            if (savedTheme) setTheme(savedTheme);
        };

        window.checkAdminLogin = async () => {
            const enteredPin = document.getElementById('login-pin').value;
            const errorMsg = document.getElementById('login-error');
            const btn = document.querySelector('button[onclick="checkAdminLogin()"]');
            
            // ðŸ›¡ï¸ SECURITY: Sanitize input
            const entered = sanitizer.sanitizeInput(String(enteredPin || '').trim(), 100);
            if(!entered) return;

            if (!RESTAURANT_ID) {
                errorMsg.classList.remove('hidden');
                errorMsg.innerHTML = '<i class="fas fa-link"></i> Missing Cafe ID in URL. Use <b>?id=...</b>.';
                return;
            }

            // ðŸ›¡ï¸ SECURITY: Rate limiting for login attempts
            const loginCheck = rateLimiter.checkLoginAttempt(RESTAURANT_ID);
            if (!loginCheck.allowed) {
                errorMsg.classList.remove('hidden');
                errorMsg.innerHTML = `<i class="fas fa-shield-alt"></i> ${sanitizer.escapeHtml(loginCheck.message)}`;
                return;
            }

            // ðŸ›¡ï¸ SECURITY: General rate limiting
            if (!rateLimiter.checkLimit('login', 10)) {
                errorMsg.classList.remove('hidden');
                errorMsg.innerHTML = '<i class="fas fa-shield-alt"></i> Too many requests. Please wait.';
                return;
            }

            try {
                if(btn) btn.innerText = 'Verifying...';
                console.log('Login attempt for tenant:', RESTAURANT_ID);

                // 1) Try RTDB PIN first (super-admin sets this on node creation)
                let rtdbPin = null;
                try {
                    const pinSnap = await get(ref(dbRTDB, `restaurants/${RESTAURANT_ID}/admin/pin`));
                    if (pinSnap.exists()) {
                        rtdbPin = String(pinSnap.val()).trim();
                        console.log('TDB admin/pin found:', rtdbPin);
                    } else {
                        console.log('TDB admin/pin does NOT exist');
                    }
                } catch (e) {
                    console.warn('ailed to read RTDB PIN:', e);
                }

                // 2) Fetch restaurant doc from Firestore (Super Admin sets password here)
                const docRef = doc(dbFirestore, 'restaurants', RESTAURANT_ID);
                const docSnap = await getDoc(docRef);

                // SECURITY: Only Super Admin provided password works
                // No default password - must use password set during onboarding

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const firestorePassword = data.password != null ? String(data.password).trim() : null;
                    // Removed for security
                    
                    // Accept RTDB PIN OR Firestore password
                    const matchRTDB = rtdbPin && rtdbPin === entered;
                    const matchFirestore = firestorePassword && firestorePassword === entered;
                    // Removed for security

                    if (matchRTDB || matchFirestore) {
                         document.getElementById('login-overlay').classList.add('hidden');
                         errorMsg.classList.add('hidden');
                         window.showToast('Welcome Back, ' + sanitizer.escapeHtml(data.name || 'Admin'), 'success');
                         localStorage.setItem(getSessionKey(), 'active');
                         localStorage.setItem('wowAdminSession', 'active'); // legacy
                         rateLimiter.recordLoginAttempt(RESTAURANT_ID, true); console.log('Login SUCCESS');
                    } else {
                        rateLimiter.recordLoginAttempt(RESTAURANT_ID, false); console.log('Password mismatch');
                        throw new Error('Incorrect Password');
                    }
                } else {
                    console.log('Restaurant doc not found');
                    throw new Error('Restaurant Not Found - Create it in Super Admin first');
                }
            } catch (e) {
                console.error('Login Error:', e);
                errorMsg.classList.remove('hidden');
                errorMsg.innerHTML = '<i class="fas fa-lock"></i> ' + sanitizer.escapeHtml(e.message || 'Login Failed');
                document.getElementById('login-pin').value = '';
            } finally {
                if(btn) btn.innerText = 'Unlock Panel';
            }
        };

        window.adminLogout = () => {
            // Direct logout without popup - just clear and reload
            localStorage.removeItem(getSessionKey());
            localStorage.removeItem('wowAdminSession');
            window.showToast('Logging out...', 'info');
            setTimeout(() => location.reload(), 500);
        };

        // --- FORGOT PASSWORD FUNCTIONS ---
        window.openForgotPassword = () => {
            document.getElementById('forgot-password-modal').classList.remove('hidden');
            // Update WhatsApp link with Cafe ID
            const whatsappLink = document.getElementById('whatsapp-support-link');
            if (whatsappLink && RESTAURANT_ID) {
                whatsappLink.href = `https://wa.me/919999999999?text=Hi, I forgot my Orderly admin password. My Cafe ID is: ${RESTAURANT_ID}`;
            }
        };

        window.closeForgotPassword = () => {
            document.getElementById('forgot-password-modal').classList.add('hidden');
        };

        document.getElementById('login-pin').addEventListener("keypress", function (event) {
            if (event.key === "Enter") window.checkAdminLogin();
        });

        // --- THEMES & SETTINGS ---
        window.setTheme = (themeName) => {
            document.body.className = "bg-gray-50 font-sans text-gray-700";
            if (themeName !== 'orange') document.body.classList.add(`theme - ${themeName}`);
            localStorage.setItem('wowAdminTheme', themeName);
            window.showToast(`Theme set to ${themeName}`, "success");
        };

        window.updateAdminPin = async () => {
            const newPin = document.getElementById('new-admin-pin').value;
            const normalized = (newPin || '').trim();
            const isSixDigitPin = normalized.length === 6 && /^\d{6}$/.test(normalized);
            const isStrongEnough = normalized.length >= 4;

            if (isSixDigitPin || isStrongEnough) {
                await update(ref(dbRTDB, `restaurants/${RESTAURANT_ID}/admin`), { pin: newPin });
                // Keep Firestore password in sync so login works even if RTDB read fails
                try {
                    await updateDoc(doc(dbFirestore, 'restaurants', RESTAURANT_ID), { password: String(newPin) });
                } catch (e) {
                    console.warn('Failed to sync PIN to Firestore:', e);
                }
                window.showToast(isSixDigitPin ? "Security PIN Updated!" : "Password Updated!", "success");
                document.getElementById('new-admin-pin').value = "";
            } else {
                window.showToast("Password too short (min 4 chars)", "error");
            }
        };

        window.saveOwnerDetails = async () => {
            const name = document.getElementById('setting-owner-name').value;
            const phone = document.getElementById('setting-owner-phone').value;
            await update(ref(dbRTDB, `restaurants/${RESTAURANT_ID}/admin/settings`), { ownerName: name, ownerPhone: phone });
            window.showToast("Owner Details Saved", "success");
        };

        // =====================================================
        // CUSTOMER WEBSITE SETTINGS FUNCTIONS
        // =====================================================
        
        // Save Brand Settings
        window.saveBrandSettings = async () => {
            const brandName = document.getElementById('cust-brand-name').value.trim();
            const tagline = document.getElementById('cust-tagline').value.trim();
            if (!brandName) {
                window.showToast("Brand name is required", "error");
                return;
            }
            try {
                await setDoc(doc(dbFirestore, "restaurants", RESTAURANT_ID, "settings", "customerSite"), {
                    brandName, tagline
                }, { merge: true });
                window.showToast("Brand settings saved!", "success");
            } catch (e) {
                console.error(e);
                window.showToast("Failed to save", "error");
            }
        };
        
        // Save Contact Settings
        window.saveContactSettings = async () => {
            const phone = document.getElementById('cust-phone').value.trim();
            const whatsapp = document.getElementById('cust-whatsapp').value.trim();
            const email = document.getElementById('cust-email').value.trim();
            try {
                await setDoc(doc(dbFirestore, "restaurants", RESTAURANT_ID, "settings", "customerSite"), {
                    phone, whatsapp, email
                }, { merge: true });
                window.showToast("Contact settings saved!", "success");
            } catch (e) {
                console.error(e);
                window.showToast("Failed to save", "error");
            }
        };
        
        // Save Address Settings
        window.saveAddressSettings = async () => {
            const address = document.getElementById('cust-address').value.trim();
            const city = document.getElementById('cust-city').value.trim();
            const pincode = document.getElementById('cust-pincode').value.trim();
            try {
                await setDoc(doc(dbFirestore, "restaurants", RESTAURANT_ID, "settings", "customerSite"), {
                    address, city, pincode
                }, { merge: true });
                window.showToast("Address saved!", "success");
            } catch (e) {
                console.error(e);
                window.showToast("Failed to save", "error");
            }
        };
        
        // Save Charges Settings
        window.saveChargesSettings = async () => {
            const deliveryCharge = parseFloat(document.getElementById('cust-delivery-charge').value) || 0;
            const packagingCharge = parseFloat(document.getElementById('cust-packaging-charge').value) || 0;
            const freeDeliveryMin = parseFloat(document.getElementById('cust-free-delivery-min').value) || 0;
            try {
                await setDoc(doc(dbFirestore, "restaurants", RESTAURANT_ID, "settings", "customerSite"), {
                    deliveryCharge, packagingCharge, freeDeliveryMin
                }, { merge: true });
                window.showToast("Charges saved!", "success");
            } catch (e) {
                console.error(e);
                window.showToast("Failed to save", "error");
            }
        };
        
        // Preview QR Code
        window.previewQRCode = (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('qr-preview').innerHTML = `
                        <img src="${e.target.result}" class="w-32 h-32 object-contain mx-auto rounded-lg border">
                        <p class="text-xs text-green-600 mt-2 font-bold">QR Ready to Save</p>
                    `;
                };
                reader.readAsDataURL(file);
            }
        };
        
        // Save Payment Settings (QR + UPI)
        window.savePaymentSettings = async () => {
            const upiId = document.getElementById('cust-upi-id').value.trim();
            const paymentName = document.getElementById('cust-payment-name').value.trim();
            const qrFile = document.getElementById('qr-upload').files[0];
            
            try {
                let qrImageBase64 = null;
                if (qrFile) {
                    qrImageBase64 = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(qrFile);
                    });
                }
                
                const updateData = { upiId, paymentName };
                if (qrImageBase64) updateData.qrImage = qrImageBase64;
                
                await setDoc(doc(dbFirestore, "restaurants", RESTAURANT_ID, "settings", "customerSite"), updateData, { merge: true });
                window.showToast("Payment settings saved!", "success");
            } catch (e) {
                console.error(e);
                window.showToast("Failed to save", "error");
            }
        };
        
        // Save Customer Fees Settings
        window.saveCustomerFeesSettings = async () => {
            const serviceFee = parseFloat(document.getElementById('cust-service-fee').value) || 0;
            const showFees = document.getElementById('cust-show-fees').checked;
            try {
                await setDoc(doc(dbFirestore, "restaurants", RESTAURANT_ID, "settings", "customerSite"), {
                    serviceFee, showFees
                }, { merge: true });
                window.showToast("Customer fees saved!", "success");
            } catch (e) {
                console.error(e);
                window.showToast("Failed to save", "error");
            }
        };
        
        // Load Customer Site Settings
        window.loadCustomerSiteSettings = async () => {
            try {
                const docSnap = await getDoc(doc(dbFirestore, "restaurants", RESTAURANT_ID, "settings", "customerSite"));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Brand
                    if (data.brandName) document.getElementById('cust-brand-name').value = data.brandName;
                    if (data.tagline) document.getElementById('cust-tagline').value = data.tagline;
                    // Contact
                    if (data.phone) document.getElementById('cust-phone').value = data.phone;
                    if (data.whatsapp) document.getElementById('cust-whatsapp').value = data.whatsapp;
                    if (data.email) document.getElementById('cust-email').value = data.email;
                    // Address
                    if (data.address) document.getElementById('cust-address').value = data.address;
                    if (data.city) document.getElementById('cust-city').value = data.city;
                    if (data.pincode) document.getElementById('cust-pincode').value = data.pincode;
                    // Charges
                    if (data.deliveryCharge !== undefined) document.getElementById('cust-delivery-charge').value = data.deliveryCharge;
                    if (data.packagingCharge !== undefined) document.getElementById('cust-packaging-charge').value = data.packagingCharge;
                    if (data.freeDeliveryMin !== undefined) document.getElementById('cust-free-delivery-min').value = data.freeDeliveryMin;
                    // Payment
                    if (data.upiId) document.getElementById('cust-upi-id').value = data.upiId;
                    if (data.paymentName) document.getElementById('cust-payment-name').value = data.paymentName;
                    if (data.qrImage) {
                        document.getElementById('qr-preview').innerHTML = `
                            <img src="${data.qrImage}" class="w-32 h-32 object-contain mx-auto rounded-lg border">
                            <p class="text-xs text-green-600 mt-2 font-bold">QR Code Active</p>
                        `;
                    }
                    // Customer Fees
                    if (data.serviceFee !== undefined) document.getElementById('cust-service-fee').value = data.serviceFee;
                    if (data.showFees !== undefined) document.getElementById('cust-show-fees').checked = data.showFees;
                }
            } catch (e) {
                console.error('Failed to load customer site settings:', e);
            }
        };

                // --- SYSTEM MONITORS (FINAL SECURE VERSION) ---
        const initSystemMonitors = () => {
            // 1. Monitor Block Status
            const appStatusRef = ref(dbRTDB, `restaurants/${RESTAURANT_ID}/appStatus`);
            onValue(appStatusRef, (snapshot) => {
                const isBlocked = snapshot.val();
                const overlay = document.getElementById('app-blocked-overlay');
                if (isBlocked === true) {
                    overlay.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                } else {
                    overlay.classList.add('hidden');
                    document.body.style.overflow = 'auto';
                }
            });
        };

        window.showToast = (msg, type = "success") => {
            let bg = type === "success" ? "#10B981" : "#EF4444";
            if (type === "info") bg = "#3B82F6";
            if (type === "warning") bg = "#F59E0B";
            Toastify({
                text: msg, duration: 3000, close: true, gravity: "top", position: "right",
                style: { background: bg, borderRadius: "8px", fontWeight: "bold", fontSize: "14px" }
            }).showToast();
        };

        // --- NAVIGATION - STRICT VISIBILITY CONTROL ---
        window.switchTab = (tabName) => {
            const tabs = ['dashboard', 'live', 'menu', 'orders', 'offers', 'settings', 'inventory'];

            tabs.forEach(id => {
                const section = document.getElementById(`section-${id}`);
                const nav = document.getElementById(`nav-${id}`);

                if (section) {
                    section.classList.add('hide-section'); // Force hide
                    if (id === tabName) {
                        section.classList.remove('hide-section'); // Show target
                    }
                }

                if (nav) {
                    nav.classList.remove('active');
                    if (id === tabName) nav.classList.add('active');
                }
            });

            if (window.innerWidth < 768) {
                const sidebar = document.getElementById('sidebar');
                if (sidebar.classList.contains('sidebar-open')) window.toggleSidebar();
            }
            
            // Update dashboard when switching to it
            if (tabName === 'dashboard') {
                updateDashboardStats();
            }
           // --- FIX: Load Reports on Tab Click ---
    if (tabName === 'reports') {
        setTimeout(() => {
            if(window.generateReport) window.generateReport();
        }, 100);
    }
    // ----------------------------------------------------
        };

        window.toggleSidebar = () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (sidebar.classList.contains('translate-x-0')) {
                sidebar.classList.remove('translate-x-0');
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
                document.body.style.overflow = 'auto'; // Scroll unlock
            } else {
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.add('translate-x-0');
                overlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Scroll lock on mobile
            }
        };

        window.toggleAddonModal = () => document.getElementById('addon-modal').classList.toggle('hidden');

        // --- MODAL LOGIC ---
        let pendingDeleteAction = null;
        window.openDeleteModal = (actionFunc, title = "Delete Item?", msg = "This cannot be undone.") => {
            pendingDeleteAction = actionFunc;
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-msg').innerText = msg;
            document.getElementById('confirmation-modal').classList.remove('hidden');
        };

        window.closeConfirmModal = () => {
            document.getElementById('confirmation-modal').classList.add('hidden');
            pendingDeleteAction = null;
        };

        document.getElementById('btn-confirm-action').onclick = () => {
            if (pendingDeleteAction) pendingDeleteAction();
            window.closeConfirmModal();
        };

        // --- GLOBAL ERROR HANDLERS (CRASH PREVENTION) ---
        window.addEventListener('error', (event) => {
            console.error("Ã…?ï¿½?ï¿½ Global Error Caught:", event.error);
            console.error("Error details:", { message: event.message, filename: event.filename, lineno: event.lineno });
            // Prevent crash - show user-friendly message
            if (window.showToast) {
                window.showToast("An error occurred. System is still running.", "error");
            }
            return true; // Prevent default error handling
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error("Ã…?ï¿½?ï¿½ Unhandled Promise Rejection:", event.reason);
            // Prevent crash from unhandled promises
            if (window.showToast) {
                window.showToast("Network error. Please refresh if issues persist.", "error");
            }
            event.preventDefault(); // Prevent default error handling
        });

        // --- LIVE DASHBOARD (WITH AUTO FEE DEDUCTION) ---
        const initLiveDashboard = () => {
            const ordersRef = ref(dbRTDB, `restaurants/${RESTAURANT_ID}/orders`);
            onValue(ordersRef, async (snapshot) => {
                try {
                    const data = snapshot.val();
                    let liveHtml = "";
                    let pending = 0, prep = 0, ready = 0, completed = 0;
                    let activeCount = 0;

                    if (data) {
                        const ordersArr = Object.keys(data).map(key => ({ id: key, ...data[key] }));
ordersArr.sort((a, b) => b.timestamp - a.timestamp);

// ? CORRECT LOGIC (Sirf ek baar)
todaySalesTotal = 0; 
const todayStr = new Date().toLocaleDateString(); 

ordersArr.forEach(order => {
    let orderDateStr = order.date; 
    if(!orderDateStr && order.timestamp) orderDateStr = new Date(order.timestamp).toLocaleDateString();

    if (orderDateStr === todayStr && order.paymentStatus === 'paid') {
        todaySalesTotal += (Number(order.totalAmount) || Number(order.total) || 0);
    }
});
// --- END FIX: Today's Sales Calculation ---   

                        // AUTO-DEDUCTION DISABLED - All orders require manual admin approval
                        // No automatic wallet deduction - admin must verify and approve each order

                        // THEN: Build HTML and process display logic
                        ordersArr.forEach(order => {
                            if (order.status === 'pending') pending++;
                            if (order.status === 'preparing') prep++;
                            if (order.status === 'ready') ready++;
                            if (order.status === 'completed' && order.paymentStatus !== 'paid') completed++;

                            const isDoneAndPaid = (order.status === 'completed' && order.paymentStatus === 'paid');

                            if (isDoneAndPaid) {
                                checkAndSyncFirestore(order);
                            } else {
                                activeCount++;

                                const displayId = order.orderId || order.id.substring(0, 5);

                                let statusBadge = "";
                                if (order.status === 'pending') statusBadge = `<span class="status-badge status-pending"><i class="fas fa-clock"></i> PENDING</span>`;
                                else if (order.status === 'preparing') statusBadge = `<span class="status-badge status-preparing"><i class="fas fa-fire"></i> COOKING</span>`;
                                else if (order.status === 'ready') statusBadge = `<span class="status-badge status-ready"><i class="fas fa-bell"></i> READY</span>`;
                                else if (order.status === 'completed') statusBadge = `<span class="status-badge status-completed"><i class="fas fa-check-circle"></i> SERVED</span>`;

                                let payAction = "";
                                let dueHtml = "";
                                const amt = order.totalAmount || order.total_amount || 0;
                                const displayAmt = Math.round(amt);

                                // Check payment and fee status
                                if (order.isFeeDeducted === true && order.paymentStatus === 'paid') {
                                    // Fee deducted and payment confirmed
                                    dueHtml = `<div class="text-green-600 font-bold text-xs"><i class="fas fa-check-circle"></i>?${displayAmt}</div>
                                               <div class="text-[10px] text-green-500 mt-1">?ï¿½ï¿½ Fee Collected</div>`;
                                    payAction = `<div class="text-green-500 font-bold text-xs italic"><i class="fas fa-check"></i> Done</div>`;
                                } else if (order.paymentStatus === 'paid' && !order.isFeeDeducted) {
                                    // Payment marked but fee not deducted - handled in kitchen
                                    dueHtml = `<div class="text-blue-600 font-bold text-xs"><i class="fas fa-check-circle"></i>?${displayAmt}</div>`;
                                    payAction = `<div class="text-orange-500 font-bold text-xs"><i class="fas fa-kitchen-set mr-1"></i> Kitchen handles payment</div>`;
                                } else {
                                    // Payment pending - handled in kitchen
                                    dueHtml = `<div class="text-red-600 font-bold text-sm">Due:?${displayAmt}</div>`;
                                    payAction = `<div class="text-orange-500 font-bold text-xs"><i class="fas fa-kitchen-set mr-1"></i> Kitchen handles payment</div>`;
                                }

                                const itemSummary = order.items ? order.items.map(i => {
                                    let details = "";
                                    if (i.size) details += `(${i.size})`;
                                    if (i.addons && i.addons.length > 0) details += `+ ${i.addons.length} Addons`;
                                    return `<span class="bg-gray-100 px-2 py-1 rounded text-xs text-gray-700 font-medium whitespace-nowrap block mb-1">${i.name} x${i.qty} <span class="text-[10px] text-gray-500">${details}</span></span>`;
                                }).join('') : "No items";

                                const isPOS = order.orderType === 'POS/Admin';
                                const typeBadge = isPOS
                                    ? `<span class="bg-indigo-100 text-indigo-700 text-[10px] font-bold px-2 py-0.5 rounded">Admin POS</span>`
                                    : `<span class="bg-gray-100 text-gray-700 text-[10px] font-bold px-2 py-0.5 rounded">${order.orderType || 'Website'}</span>`;

                                const cName = order.customerName || order.name || order.fullName || order.user_name || 'Guest';
                                const cMobile = order.customerMobile || order.mobile || order.phone || order.phoneNumber || 'N/A';

                                liveHtml += `
            <tr class="hover:bg-orange-50/50 transition border-b border-gray-50">
                                    <td class="p-5 font-mono font-bold text-orange-600">#${displayId}</td>
                                    <td class="p-5">${typeBadge}</td>
                                    <td class="p-5">
                                        <div><p class="font-bold text-gray-800">${cName}</p><p class="text-xs text-gray-500"><i class="fas fa-phone"></i> ${cMobile}</p></div>
                                    </td>
                                    <td class="p-5"><div>${itemSummary}</div></td>
                                    <td class="p-5">${dueHtml}</td>
                                    <td class="p-5">${statusBadge}</td>
                                    <td class="p-5 text-right w-40">${payAction}</td>
                                </tr>
            `;
                            }
                        });
                    }

                    if (activeCount > 50) {
                        const statusRef = ref(dbRTDB, `restaurants/${RESTAURANT_ID}/appStatus`);
                        get(statusRef).then(snap => {
                            if (snap.val() !== true) {
                                update(ref(dbRTDB, `restaurants/${RESTAURANT_ID}/appStatus`), true);
                                window.showToast("System Overload: App Blocked (>50 Live Orders)", "error");
                            }
                        });
                    }

                    document.getElementById('live-orders-table').innerHTML = liveHtml;
                    document.getElementById('no-live-orders').classList.toggle('hidden', activeCount > 0);

                    // Safe DOM updates with null checks
                    const statPending = document.getElementById('stat-pending');
                    const statPrep = document.getElementById('stat-prep');
                    const statReady = document.getElementById('stat-ready');
                    const statCompleted = document.getElementById('stat-completed');
                    const currentDate = document.getElementById('current-date');

                    if (statPending) statPending.innerText = pending;
                    if (statPrep) statPrep.innerText = prep;
                    if (statReady) statReady.innerText = ready;
                    if (statCompleted) statCompleted.innerText = completed;
                    if (currentDate) currentDate.innerText = new Date().toLocaleDateString();
                } catch (error) {
                    console.error("?ï¿½Ã…?ï¿½ï¿½ Error in live dashboard update:", error);
                    // Don't crash - continue with next update
                }
            }, (error) => {
                console.error("?ï¿½Ã…?ï¿½ï¿½ Firebase listener error:", error);
                // Show user-friendly error
                if (window.showToast) {
                    window.showToast("Connection issue. Retrying...", "error");
                }
            });
        };

        // --- AUTO DEDUCT DISABLED - MANUAL APPROVAL REQUIRED ---
        // This function is kept for reference but will NEVER be called automatically
        // All wallet deductions now require explicit admin approval via markOrderPaid()
        const autoDeductFee = async (order) => {
            // DISABLED: Auto-deduction is now locked
            console.warn("Ã…?ï¿½?ï¿½?ï¿½?ï¿½?ï¿½ AUTO-DEDUCTION ATTEMPTED BUT DISABLED:", order.orderId);
            console.warn("Ã…?ï¿½?ï¿½?ï¿½?ï¿½?ï¿½ This order requires manual admin approval");

            // Show error to admin
            window.showToast(`Ã…?ï¿½?ï¿½?ï¿½?ï¿½?ï¿½ Order #${order.orderId} requires manual verification`, "error");
            window.showToast("Auto-deduction is disabled for security", "error");

            // DO NOT DEDUCT - Return without action
            return;
        };

        window.checkAndSyncFirestore = async (order) => {
            if (window.syncedOrdersCache.has(order.orderId)) return;
            try {
                const q = query(collection(dbFirestore, "restaurants", RESTAURANT_ID, "orders"), where("orderId", "==", order.orderId));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    querySnapshot.forEach(async (docRef) => {
                        const firestoreData = docRef.data();
                        if (firestoreData.status !== 'completed' || firestoreData.paymentStatus !== 'paid') {
                            await updateDoc(doc(dbFirestore, "restaurants", RESTAURANT_ID, "orders", docRef.id), {
                                status: 'completed',
                                paymentStatus: 'paid'
                            });
                        }
                    });
                } else {
                    await addDoc(collection(dbFirestore, "restaurants", RESTAURANT_ID, "orders"), {
                        ...order,
                        paymentStatus: 'paid',
                        status: 'completed',
                        createdAt: serverTimestamp()
                    });
                }
                window.syncedOrdersCache.add(order.orderId);
                // ðŸ›¡ï¸ MEMORY PROTECTION: Limit cache size
                memoryGuard.checkMapSize(window.syncedOrdersCache, 'syncedOrdersCache');
            } catch (e) { console.error("Auto Sync Error:", e); }
        };

        // --- STRICT PAYMENT HANDLER (POS & Website Confirmation) ---
        // Double-click prevention: Track processing orders
        window.processingOrders = new Set();

        window.markOrderPaid = async (rtdbKey) => {
            // DOUBLE-CLICK PREVENTION: Check if already processing
            if (window.processingOrders.has(rtdbKey)) {
                console.warn("Ã…?ï¿½?ï¿½?ï¿½?ï¿½?ï¿½ Payment already being processed for order:", rtdbKey);
                window.showToast("Payment is being processed... Please wait", "info");
                return;
            }

            // Disable button immediately to prevent double-click
            const payButton = document.getElementById(`btn-pay-${rtdbKey}`);
            if (payButton) {
                payButton.disabled = true;
                payButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            }

            // Mark as processing immediately
            window.processingOrders.add(rtdbKey);

            try {
                const orderSnapshot = await get(ref(dbRTDB, `restaurants/${RESTAURANT_ID}/orders/${rtdbKey}`));
                if (!orderSnapshot.exists()) {
                    window.processingOrders.delete(rtdbKey);
                    return;
                }
                
                const raw = orderSnapshot.val();
                const cleanAmount = Number(raw.totalAmount || raw.total_amount || raw.amount || raw.price || 0);
                const currentStatus = raw.status || 'pending';

                // GATEKEEPER: CHECK FOR DOUBLE PAYMENT (STRICT) - Double check before processing
                if (raw.isFeeDeducted === true) {
                    console.log("Ã…?ï¿½ï¿½?ï¿½ Fee already deducted for order:", raw.orderId);
                    await update(ref(dbRTDB, `restaurants/${RESTAURANT_ID}/orders/${rtdbKey}`), { paymentStatus: 'paid' });
                    window.showToast("Status updated (Fee was already collected)", "success");
                window.processingOrders.delete(rtdbKey);
                return;
            }

                // CRITICAL: Re-check after getting snapshot to prevent race condition
                const recheckSnapshot = await get(ref(dbRTDB, `restaurants/${RESTAURANT_ID}/orders/${rtdbKey}`));
                const recheckData = recheckSnapshot.val();
                if (recheckData && recheckData.isFeeDeducted === true) {
                    console.warn("Ã…?ï¿½?ï¿½?ï¿½?ï¿½?ï¿½ Fee was deducted between checks - preventing double deduction");
                    window.showToast("Payment already processed", "info");
                    window.processingOrders.delete(rtdbKey);
                    return;
                }

                // MANUAL DEDUCTION (Triggered by Admin for POS Pay Later / Unverified Website)
                const newBalance = window.currentAdminBalance - PLATFORM_FEE;
                
                console.log("?ï¿½ï¿½?ï¿½ Processing payment for order:", raw.orderId, "Current balance:", window.currentAdminBalance, "New balance:", newBalance);
                
                // 1. Mark as deducted FIRST to prevent race condition
                await update(ref(dbRTDB, `restaurants/${RESTAURANT_ID}/orders/${rtdbKey}`), { 
                    isFeeDeducted: true // Lock immediately
                });

        // 2. Update Wallet with SAFE function (requires permission)
        await safeWalletUpdate(newBalance, PLATFORM_FEE, `Fee: Order #${raw.orderId}`, "Admin Approval", true);

        // 3. Update Order with Payment Status
        await update(ref(dbRTDB, `restaurants/${RESTAURANT_ID}/orders/${rtdbKey}`), { 
                    paymentStatus: 'paid', 
                    totalAmount: cleanAmount
                });
                
                console.log("Ã…?ï¿½ï¿½?ï¿½ Payment processed successfully for order:", raw.orderId);
                window.showToast(`Payment Accepted! Wallet Deducted: ?${ PLATFORM_FEE }`, "success");
                
                // Firestore Sync (Trigger status update)
                checkAndSyncFirestore({...raw, paymentStatus: 'paid', status: currentStatus, isFeeDeducted: true});

            } catch (e) {
                console.error("?ï¿½Ã…?ï¿½ï¿½ Payment processing error:", e);
                window.showToast("Sync Error. Check Console.", "error");
            } finally {
                // Re-enable button and remove from processing set
                setTimeout(() => {
                    const payButton = document.getElementById(`btn - pay - ${ rtdbKey }`);
                    if (payButton && !payButton.disabled) {
                        // Button will be updated by the next render cycle
                    }
                    window.processingOrders.delete(rtdbKey);
                    console.log("?ï¿½?ï¿½ Cleaned up processing state for order:", rtdbKey);
                }, 2000); // Remove after 2 seconds to allow UI updates
            }
        };

        // --- HISTORY & REVENUE ---
        const initFinancials = () => {
            console.log('ðŸ“Š [Financials] Initializing revenue tracking...');
            console.log('ðŸ“Š [Financials] RESTAURANT_ID:', RESTAURANT_ID);
            
            // Performance Fix: Limit to 1000 recent orders to prevent browser crash on large datasets
            const q = query(collection(dbFirestore, "restaurants", RESTAURANT_ID, "orders"), orderBy("createdAt", "desc"), limit(1000));
            onSnapshot(q, (snap) => {
                // ðŸ›¡ï¸ CRASH PREVENTION: Wrap in try-catch
                try {
                    console.log('ðŸ“Š [Financials] Orders snapshot received, size:', snap.size);
                    
                    window.fullHistoryData = [];
                    let skipped = { notPaid: 0, notCompleted: 0 };
                    
                    snap.forEach(doc => {
                        const d = doc.data();
                        const isPaid = d.paymentStatus === 'paid';
                        const isCompleted = d.status === 'completed';
                        
                        if (!isPaid) { skipped.notPaid++; }
                        if (!isCompleted) { skipped.notCompleted++; }
                        if (!isPaid || !isCompleted) return;
                        
                        const orderDate = d.createdAt ? d.createdAt.toDate() : (d.timestamp ? new Date(d.timestamp) : new Date());
                        const amount = Number(d.totalAmount) || Number(d.total) || 0;
                        
                        window.fullHistoryData.push({ 
                            id: doc.id, 
                            ...d, 
                            jsDate: orderDate,
                            totalAmount: amount
                        });
                    });
                    
                    // ðŸ›¡ï¸ MEMORY PROTECTION: Limit array size
                    window.fullHistoryData = memoryGuard.checkArraySize(window.fullHistoryData, 'fullHistoryData');
                    
                    console.log('ðŸ“Š [Financials] Processed orders:', {
                        total: snap.size,
                        included: window.fullHistoryData.length,
                        skipped
                    });

                    window.calculateRevenue();
                    window.processCRMData();
                    window.visibleHistoryCount = 0;
                    document.getElementById('history-orders-table').innerHTML = "";
                    document.getElementById('transactions-table').innerHTML = "";
                    window.renderHistoryBatch();
                    window.renderTransBatch();
                } catch (error) {
                    console.error('ðŸ”´ [Financials] Processing error:', error);
                    window.showToast('Error processing financial data', 'error');
                }
            }, (error) => {
                console.error('?ï¿½ï¿½ [Financials] Error loading orders:', error);
                window.showToast('Error loading financial data', 'error');
            });
        };

        window.renderHistoryBatch = () => {
            const table = document.getElementById('history-orders-table');
            const btn = document.getElementById('btn-load-more-history');
            const total = window.fullHistoryData.length;
            const nextBatch = window.fullHistoryData.slice(window.visibleHistoryCount, window.visibleHistoryCount + BATCH_SIZE);

            if (nextBatch.length === 0 && window.visibleHistoryCount === 0) {
                document.getElementById('no-history-orders').classList.remove('hidden');
                btn.classList.add('hidden');
                return;
            }
            document.getElementById('no-history-orders').classList.add('hidden');

            let html = "";
            nextBatch.forEach(d => {
                const cName = d.customerName || d.name || 'Guest';
                const cMobile = d.customerMobile || d.mobile || '-';
                let ratingVal = d.rating || 0;
                let starHtml = '<div class="flex text-xs">';
                for (let i = 1; i <= 5; i++) {
                    if (i <= ratingVal) starHtml += '<i class="fas fa-star text-yellow-400"></i>';
                    else starHtml += '<i class="fas fa-star text-gray-200"></i>';
                }
                starHtml += '</div>';

                html += `
                    <tr class="hover:bg-gray-50 border-b border-gray-50 animate-fade-in" data-date="${d.date}">
                        <td class="p-4 text-gray-500 font-mono text-xs">#${d.orderId}</td>
                        <td class="p-4 text-xs text-gray-500">${d.date}<br>${d.time}</td>
                        <td class="p-4 text-gray-700"><span class="font-bold">${cName}</span><br><span class="text-xs text-gray-400">${cMobile}</span></td>
                        <td class="p-4 text-xs text-gray-500 truncate max-w-xs">${d.items ? d.items.length : 0} Items</td>
                        <td class="p-4 font-bold text-gray-800">Rs.${Math.round(d.totalAmount || d.total || 0).toLocaleString('en-IN')}</td>
                        <td class="p-4">${starHtml}</td>
                        <td class="p-4"><span class="text-green-600 bg-green-50 px-2 py-1 rounded text-xs font-bold uppercase"><i class="fas fa-check-double"></i> Done & Paid</span></td>
                    </tr>
                `;
            });
            table.insertAdjacentHTML('beforeend', html);
            window.visibleHistoryCount += nextBatch.length;
            if (window.visibleHistoryCount >= total) btn.classList.add('hidden');
            else btn.classList.remove('hidden');
        };

        window.renderTransBatch = () => {
            const table = document.getElementById('transactions-table');
            const btn = document.getElementById('btn-load-more-trans');
            const total = window.fullHistoryData.length;
            const currentRows = table.rows.length;
            const nextTrans = window.fullHistoryData.slice(currentRows, currentRows + BATCH_SIZE);

            let html = "";
            nextTrans.forEach(d => {
                const cName = d.customerName || d.name || 'Guest';
                const cMobile = d.customerMobile || d.mobile || '-';
                html += `
                    <tr class="hover:bg-gray-50 border-b border-gray-50 animate-fade-in">
                        <td class="p-4 font-mono font-bold text-gray-600">#${d.orderId}</td>
                        <td class="p-4 text-gray-500 text-xs">${d.date}</td>
                        <td class="p-4 text-gray-800"><span class="font-bold">${cName}</span><br><span class="text-xs text-gray-400">${cMobile}</span></td>
                        <td class="p-4 text-xs"><span class="bg-gray-100 px-2 py-1 rounded">${d.orderType || 'Standard'}</span></td>
                        <td class="p-4 text-right font-black text-green-600">Rs.${Math.round(d.totalAmount || d.total || 0).toLocaleString('en-IN')}</td>
                    </tr>
                `;
            });
            table.insertAdjacentHTML('beforeend', html);
            if ((currentRows + nextTrans.length) >= total) btn.classList.add('hidden');
            else btn.classList.remove('hidden');
        };

        window.calculateRevenue = () => {
            console.log('[Revenue] Starting calculation...');
            console.log('[Revenue] Data length:', window.fullHistoryData?.length || 0);
            
            // Rupee symbol via unicode
            const RS = '\u20B9';
            const formatMoney = (n) => RS + Math.round(n).toLocaleString('en-IN');
            
            if (!window.fullHistoryData || window.fullHistoryData.length === 0) {
                console.warn('[Revenue] No data available');
                document.getElementById('rev-total').innerText = RS + '0';
                document.getElementById('rev-total-orders').innerText = '0 orders';
                document.getElementById('rev-filtered').innerText = RS + '0';
                document.getElementById('rev-filter-label').innerText = 'No Data';
                document.getElementById('rev-avg').innerText = RS + '0';
                document.getElementById('rev-median').innerText = 'Median: ' + RS + '0';
                const ge = document.getElementById('rev-growth'); if(ge) ge.innerText = '';
                ['rev-today','rev-week','rev-month','rev-peak-amount'].forEach(id => {
                    const el = document.getElementById(id); if(el) el.innerText = RS + '0';
                });
                ['rev-today-orders','rev-week-orders','rev-month-orders'].forEach(id => {
                    const el = document.getElementById(id); if(el) el.innerText = '0 orders';
                });
                const ph = document.getElementById('rev-peak-hour'); if(ph) ph.innerText = '--';
                return;
            }
            
            const getAmt = (o) => Number(o.totalAmount) || Number(o.total) || 0;
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekAgo = new Date(today); weekAgo.setDate(weekAgo.getDate() - 7);
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const dateInput = document.getElementById('revenue-date-filter')?.value;
            let filteredOrders = [...window.fullHistoryData];
            let label = "All Time";
            
            if (dateInput) {
                const filterDate = new Date(dateInput);
                filteredOrders = filteredOrders.filter(o => o.jsDate && o.jsDate.toDateString() === filterDate.toDateString());
                label = 'Date: ' + filterDate.toLocaleDateString('en-IN');
            } else {
                filteredOrders = filteredOrders.filter(o => o.jsDate && o.jsDate > thirtyDaysAgo);
                label = "Last 30 Days";
            }
            
            // Calculations
            const totalRev = window.fullHistoryData.reduce((s, o) => s + getAmt(o), 0);
            const filteredRev = filteredOrders.reduce((s, o) => s + getAmt(o), 0);
            const totalCount = window.fullHistoryData.length;
            const filteredCount = filteredOrders.length;
            const avgValue = totalCount > 0 ? Math.round(totalRev / totalCount) : 0;
            
            // Median
            const sorted = window.fullHistoryData.map(getAmt).sort((a,b) => a-b);
            const median = sorted.length > 0 ? sorted[Math.floor(sorted.length/2)] : 0;
            
            // Today, Week, Month
            const todayOrders = window.fullHistoryData.filter(o => o.jsDate && o.jsDate >= today);
            const todayRev = todayOrders.reduce((s,o) => s + getAmt(o), 0);
            const weekOrders = window.fullHistoryData.filter(o => o.jsDate && o.jsDate >= weekAgo);
            const weekRev = weekOrders.reduce((s,o) => s + getAmt(o), 0);
            const monthOrders = window.fullHistoryData.filter(o => o.jsDate && o.jsDate >= monthStart);
            const monthRev = monthOrders.reduce((s,o) => s + getAmt(o), 0);
            
            // Peak Hour
            const hourly = {};
            window.fullHistoryData.forEach(o => {
                if (o.jsDate) {
                    const h = o.jsDate.getHours();
                    if (!hourly[h]) hourly[h] = {c:0, r:0};
                    hourly[h].c++; hourly[h].r += getAmt(o);
                }
            });
            let peakHour = '--', peakAmt = 0;
            Object.entries(hourly).forEach(([h, d]) => {
                if (d.r > peakAmt) {
                    peakAmt = d.r;
                    const hr = parseInt(h);
                    peakHour = (hr === 0 ? 12 : hr > 12 ? hr-12 : hr) + (hr >= 12 ? ' PM' : ' AM');
                }
            });
            
            // Growth
            let growthTxt = '';
            if (!dateInput) {
                const sixtyAgo = new Date(); sixtyAgo.setDate(sixtyAgo.getDate() - 60);
                const prevOrders = window.fullHistoryData.filter(o => o.jsDate && o.jsDate > sixtyAgo && o.jsDate <= thirtyDaysAgo);
                const prevRev = prevOrders.reduce((s,o) => s + getAmt(o), 0);
                if (prevRev > 0) {
                    const pct = ((filteredRev - prevRev) / prevRev * 100).toFixed(1);
                    growthTxt = (pct >= 0 ? 'UP ' : 'DOWN ') + Math.abs(pct) + '% vs prev 30d';
                } else if (filteredRev > 0) {
                    growthTxt = 'New revenue!';
                }
            }
            
            console.log('[Revenue] Results:', {totalRev, filteredRev, totalCount, todayRev, weekRev, monthRev, peakHour, avgValue, median});
            
            // Update UI
            document.getElementById('rev-total').innerText = formatMoney(totalRev);
            document.getElementById('rev-total-orders').innerText = totalCount.toLocaleString() + ' orders';
            document.getElementById('rev-filtered').innerText = formatMoney(filteredRev);
            document.getElementById('rev-filter-label').innerText = label + ' (' + filteredCount + ' orders)';
            document.getElementById('rev-avg').innerText = formatMoney(avgValue);
            document.getElementById('rev-median').innerText = 'Median: ' + formatMoney(median);
            
            // Analytics cards
            const setEl = (id, val) => { const e = document.getElementById(id); if(e) e.innerText = val; };
            setEl('rev-today', formatMoney(todayRev));
            setEl('rev-today-orders', todayOrders.length + ' orders');
            setEl('rev-week', formatMoney(weekRev));
            setEl('rev-week-orders', weekOrders.length + ' orders');
            setEl('rev-month', formatMoney(monthRev));
            setEl('rev-month-orders', monthOrders.length + ' orders');
            setEl('rev-peak-hour', peakHour);
            setEl('rev-peak-amount', formatMoney(peakAmt));
            
            const growthEl = document.getElementById('rev-growth');
            if (growthEl) {
                growthEl.innerText = growthTxt;
                growthEl.className = 'text-[10px] font-bold ' + (growthTxt.startsWith('UP') ? 'text-green-600' : 'text-red-600');
            }
            
            if (typeof window.updateRevenueChart === 'function') window.updateRevenueChart();
            console.log('[Revenue] UI updated!');
        };
        
        // Revenue Chart Function
        window.revenueChartInstance = null;
        window.updateRevenueChart = () => {
            const canvas = document.getElementById('revenue-chart');
            if (!canvas || !window.fullHistoryData || window.fullHistoryData.length === 0) return;
            
            const period = parseInt(document.getElementById('chart-period')?.value || 30);
            const now = new Date();
            const startDate = new Date(); startDate.setDate(startDate.getDate() - period);
            
            // Group by date
            const dailyRevenue = {};
            for (let i = 0; i < period; i++) {
                const d = new Date(now);
                d.setDate(d.getDate() - i);
                dailyRevenue[d.toDateString()] = 0;
            }
            
            window.fullHistoryData.forEach(o => {
                if (o.jsDate && o.jsDate > startDate) {
                    const key = o.jsDate.toDateString();
                    if (dailyRevenue.hasOwnProperty(key)) {
                        dailyRevenue[key] += Number(o.totalAmount) || Number(o.total) || 0;
                    }
                }
            });
            
            // Prepare chart data
            const labels = Object.keys(dailyRevenue).reverse().map(d => {
                const date = new Date(d);
                return date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
            });
            const data = Object.values(dailyRevenue).reverse();
            
            // Destroy existing chart
            if (window.revenueChartInstance) {
                window.revenueChartInstance.destroy();
            }
            
            // Create new chart
            const ctx = canvas.getContext('2d');
            window.revenueChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Revenue',
                        data: data,
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#22c55e',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => String.fromCharCode(0x20B9) + ctx.raw.toLocaleString('en-IN')
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (v) => String.fromCharCode(0x20B9) + (v >= 1000 ? (v/1000).toFixed(0) + 'K' : v)
                            }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
            console.log('[Revenue] Chart updated with', period, 'days data');
        };

        window.downloadRevenueReport = () => {
            const dateInput = document.getElementById('revenue-date-filter').value;
            let data = [...window.fullHistoryData];

            if (dateInput) {
                const filterDate = new Date(dateInput).toDateString();
                data = data.filter(o => o.jsDate.toDateString() === filterDate);
            }

            let csv = "Order ID,Date,Time,Customer Name,Mobile,Type,Amount,Status\n";
            data.forEach(row => {
                csv += `${row.orderId},${row.date},${row.time},${row.customerName || row.name},${row.customerMobile || row.mobile},${row.orderType || 'Website'},${row.totalAmount},Paid\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Revenue_Report_${dateInput || 'All_Time'}.csv`;
            a.click();
            window.showToast("Full Report Downloaded", "success");
        }

        // --- CRM LOGIC ---
        window.processCRMData = () => {
            try {
                const customers = {};
                window.fullHistoryData.forEach(order => {
                    const mob = order.customerMobile || order.mobile;
                    if (mob && String(mob).trim().length > 5) {
                        const key = String(mob).trim();
                        if (!customers[key]) {
                            customers[key] = {
                                name: sanitizer.escapeHtml(order.customerName || order.name || "Unknown"),
                                mobile: sanitizer.escapeHtml(key),
                                visits: 0,
                                lastVisit: order.jsDate
                            };
                        }
                        customers[key].visits++;
                        if (order.jsDate > customers[key].lastVisit) customers[key].lastVisit = order.jsDate;
                    }
                });
                window.crmData = Object.values(customers);
                // ðŸ›¡ï¸ MEMORY PROTECTION
                window.crmData = memoryGuard.checkArraySize(window.crmData, 'crmData');
                window.visibleCRMCount = 0;
                document.getElementById('crm-table').innerHTML = "";
                window.renderCRMBatch();
            } catch (error) {
                console.error('ðŸ”´ CRM Processing error:', error);
                window.showToast('Error processing customer data', 'error');
            }
        };

        window.renderCRMBatch = () => {
            const table = document.getElementById('crm-table');
            const btn = document.getElementById('btn-load-more-crm');
            const total = window.crmData.length;
            const nextBatch = window.crmData.slice(window.visibleCRMCount, window.visibleCRMCount + BATCH_SIZE);

            let html = "";
            if (window.visibleCRMCount === 0 && nextBatch.length === 0) {
                html = "<tr><td colspan='4' class='p-8 text-center text-gray-400'>No customers yet.</td></tr>";
            } else {
                nextBatch.forEach(c => {
                    html += `
                        <tr class="border-b border-gray-50 hover:bg-blue-50/30 animate-fade-in">
                            <td class="p-4 font-bold text-gray-800">${c.name}</td>
                            <td class="p-4 text-gray-600 font-mono">${c.mobile}</td>
                            <td class="p-4 text-center"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-bold">${c.visits} orders</span></td>
                            <td class="p-4 text-xs text-gray-500">${c.lastVisit.toLocaleDateString()}</td>
                        </tr>
                    `;
                });
            }
            table.insertAdjacentHTML('beforeend', html);
            window.visibleCRMCount += nextBatch.length;

            if (window.visibleCRMCount >= total) btn.classList.add('hidden');
            else btn.classList.remove('hidden');
        };

        // --- MENU/ADDONS/OFFERS INITIALIZATION ---
        const initMenuLogic = () => {
            if (!RESTAURANT_ID) {
                console.error('?ï¿½Å’ Cannot init menu: RESTAURANT_ID not set');
                return;
            }
            console.log('nitializing menu listener for:', `restaurants/${RESTAURANT_ID}/menu`);
            onSnapshot(collection(dbFirestore, "restaurants", RESTAURANT_ID, "menu"), (snap) => {
                console.log('enu snapshot received:', snap.size, 'items');
                window.menuItemsCache = {};
                const container = document.getElementById('menu-list-container');
                let html = "";
                snap.forEach(docSnap => {
                    const item = docSnap.data();
                    window.menuItemsCache[docSnap.id] = { id: docSnap.id, ...item };
                    const bestSellerIcon = item.isBestSeller ? '<i class="fas fa-star text-yellow-500 ml-2" title="Best Seller"></i>' : '';

                    html += `
                        <div class="flex justify-between items-center bg-gray-50 p-4 rounded-xl border border-gray-100 mb-3 hover:border-orange-200 transition">
                            <div class="flex items-center gap-4">
                                <img src="${item.img || 'https://cdn-icons-png.flaticon.com/512/1046/1046784.png'}" class="w-14 h-14 rounded-lg object-cover bg-white border">
                                <div><h4 class="font-bold text-gray-800">${item.name} ${bestSellerIcon}</h4><p class="text-xs text-gray-500">${item.category} | ?${item.price}</p></div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="populateMenuEdit('${docSnap.id}')" class="w-8 h-8 rounded-full bg-white border hover:text-blue-500"><i class="fas fa-pen text-xs"></i></button>
                                <button onclick="deleteMenuItem('${docSnap.id}')" class="w-8 h-8 rounded-full bg-white border hover:text-red-500"><i class="fas fa-trash-alt text-xs"></i></button>
                            </div>
                        </div>`;
                });
                container.innerHTML = html;
                renderPOSMenu();
            });
        };

        window.addSizeRow = (name = "", price = "") => {
            document.getElementById('size-container').insertAdjacentHTML('beforeend', `<div class="flex gap-2 mt-2"><input type="text" placeholder="Size" value="${name}" class="w-2/3 p-2 text-xs border rounded size-name-input"><input type="number" placeholder="?" value="${price}" class="w-1/3 p-2 text-xs border rounded size-price-input"><button type="button" onclick="this.parentElement.remove()" class="text-red-500 px-1"><i class="fas fa-times"></i></button></div>`);
        };

        window.saveMenuitem = async () => {
            const btn = document.getElementById('btn-save-item');
            const editId = document.getElementById('m-edit-id').value;
            const name = document.getElementById('m-name').value.trim();
            const price = document.getElementById('m-price').value;
            const isBestSeller = document.getElementById('m-bestseller').checked;

            if (!name || !price) return window.showToast("Name & Display Price required", "error");

            // CRITICAL: Validate RESTAURANT_ID before saving
            if (!RESTAURANT_ID || RESTAURANT_ID.trim() === '') {
                console.error('?ï¿½Å’ BLOCKED: No RESTAURANT_ID set! Cannot save menu item.');
                window.showToast("Error: Cafe ID not set. Login with valid ?id= parameter.", "error");
                return;
            }

            btn.innerText = "Saving...";
            console.log('aving menu item to:', `restaurants/${RESTAURANT_ID}/menu`);

            const sizes = [];
            const sizeNames = document.querySelectorAll('.size-name-input');
            const sizePrices = document.querySelectorAll('.size-price-input');
            for (let i = 0; i < sizeNames.length; i++) {
                if (sizeNames[i].value) sizes.push({ name: sizeNames[i].value, price: Number(sizePrices[i].value) });
            }

            const linkedAddons = [];
            document.querySelectorAll('.addon-checkbox:checked').forEach(cb => linkedAddons.push(cb.value));

            const data = {
                name, price: Number(price), category: document.getElementById('m-cat').value,
                desc: document.getElementById('m-desc').value, img: document.getElementById('m-img').value,
                isBestSeller: isBestSeller,
                sizes, linkedAddons, updatedAt: serverTimestamp()
            };

            try {
                const targetPath = `restaurants/${RESTAURANT_ID}/menu`;
                if (editId) {
                    console.log('[OK]?ï¿½?ï¿½?ï¿½ Updating menu item:', editId, 'at path:', targetPath);
                    await updateDoc(doc(dbFirestore, "restaurants", RESTAURANT_ID, "menu", editId), data);
                } else {
                    console.log('Å¾?ï¿½ï¿½ Adding new menu item at path:', targetPath);
                    const docRef = await addDoc(collection(dbFirestore, "restaurants", RESTAURANT_ID, "menu"), data);
                    console.log('[OK]?ï¿½ï¿½ Menu item saved with ID:', docRef.id, 'Full path:', `${targetPath}/${docRef.id}`);
                }
                resetMenuForm();
                window.showToast("Item Saved Successfully", "success");
            } catch (e) { 
                console.error('?ï¿½Å’ Failed to save menu item:', e); 
                window.showToast("Failed to save: " + e.message, "error"); 
            }
            btn.innerText = "Save Item";
        };

        window.populateMenuEdit = (id) => {
            const item = window.menuItemsCache[id];
            if (!item) return;
            document.getElementById('m-name').value = item.name;
            document.getElementById('m-price').value = item.price;
            document.getElementById('m-cat').value = item.category;
            document.getElementById('m-desc').value = item.desc;
            document.getElementById('m-img').value = item.img || '';
            document.getElementById('m-edit-id').value = id;
            document.getElementById('m-bestseller').checked = item.isBestSeller || false;

            document.getElementById('size-container').innerHTML = '';
            if (item.sizes && item.sizes.length > 0) item.sizes.forEach(s => window.addSizeRow(s.name, s.price));
            else window.addSizeRow();

            document.querySelectorAll('.addon-checkbox').forEach(cb => cb.checked = false);
            if (item.linkedAddons) {
                item.linkedAddons.forEach(aid => {
                    const cb = document.querySelector(`.addon-checkbox[value="${aid}"]`);
                    if (cb) cb.checked = true;
                });
            }

            document.getElementById('menu-form-title').innerHTML = "Edit Item";
            document.getElementById('btn-save-item').innerHTML = "Update Item";
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
        };

        window.resetMenuForm = () => {
            document.getElementById('m-name').value = '';
            document.getElementById('m-price').value = '';
            document.getElementById('m-edit-id').value = '';
            document.getElementById('m-bestseller').checked = false;
            document.getElementById('size-container').innerHTML = '';
            window.addSizeRow();
            document.querySelectorAll('.addon-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('menu-form-title').innerHTML = '<i class="fas fa-plus-circle text-orange-600"></i> Add Item';
            document.getElementById('btn-save-item').innerHTML = "Save Item";
            document.getElementById('btn-cancel-edit').classList.add('hidden');
        };

        window.deleteMenuItem = (id) => {
            if (!RESTAURANT_ID) {
                window.showToast("Error: Cafe ID not set", "error");
                return;
            }
            window.openDeleteModal(async () => {
                console.log('?ï¿½ Deleting menu item:', id, 'from:', `restaurants/${RESTAURANT_ID}/menu`);
                await deleteDoc(doc(dbFirestore, "restaurants", RESTAURANT_ID, "menu", id));
                window.showToast("Item deleted", "success");
            });
        };

        const initAddons = () => {
            if (!RESTAURANT_ID) {
                console.error('?ï¿½Å’ Cannot init addons: RESTAURANT_ID not set');
                return;
            }
            console.log('nitializing addons listener for:', `restaurants/${RESTAURANT_ID}/addons`);
            onSnapshot(collection(dbFirestore, "restaurants", RESTAURANT_ID, "addons"), (snap) => {
                console.log('ddons snapshot received:', snap.size, 'items');
                let html = "", selectorHtml = "";
                window.universalAddons = {};
                snap.forEach(doc => {
                    const data = doc.data();
                    window.universalAddons[doc.id] = data;
                    html += `<div class="flex justify-between items-center bg-gray-50 p-2 rounded mb-2 border border-gray-200"><span class="text-sm font-bold">${data.name} (?${data.price})</span><button onclick="deleteAddon('${doc.id}')" class="text-red-500"><i class="fas fa-trash"></i></button></div>`;
                    selectorHtml += `<label class="checkbox-wrapper cursor-pointer block"><input type="checkbox" class="hidden addon-checkbox" value="${doc.id}"><div class="p-2 border rounded-lg text-xs font-bold text-gray-600 hover:bg-gray-50 transition border-gray-200">${data.name} (+?${data.price})</div></label>`;
                });
                document.getElementById('universal-addons-list').innerHTML = html || "<p class='text-xs text-gray-400'>No addons.</p>";
                document.getElementById('addon-selector-list').innerHTML = selectorHtml || "<p class='text-xs text-gray-400'>Create addons first.</p>";
            });
        };
        window.createUniversalAddon = async () => {
            if (!RESTAURANT_ID) {
                window.showToast("Error: Cafe ID not set", "error");
                return;
            }
            const name = document.getElementById('new-addon-name').value.trim();
            const price = document.getElementById('new-addon-price').value;
            if (name && price) {
                console.log('Å¾?ï¿½ï¿½ Creating addon at:', `restaurants/${RESTAURANT_ID}/addons`);
                const docRef = await addDoc(collection(dbFirestore, "restaurants", RESTAURANT_ID, "addons"), { name, price: Number(price) });
                console.log('[OK]?ï¿½ï¿½ Addon created:', docRef.id);
                window.showToast("Addon created", "success");
            }
            document.getElementById('new-addon-name').value = ""; document.getElementById('new-addon-price').value = "";
        };

        window.deleteAddon = (id) => {
            if (!RESTAURANT_ID) {
                window.showToast("Error: Cafe ID not set", "error");
                return;
            }
            window.openDeleteModal(async () => {
                console.log('?ï¿½ Deleting addon:', id, 'from:', `restaurants/${RESTAURANT_ID}/addons`);
                await deleteDoc(doc(dbFirestore, "restaurants", RESTAURANT_ID, "addons", id));
                window.showToast("Addon deleted", "success");
            }, "Delete Addon?");
        };

        const initOffers = () => {
            if (!RESTAURANT_ID) {
                console.error('?ï¿½Å’ Cannot init offers: RESTAURANT_ID not set');
                return;
            }
            console.log('nitializing offers listener for:', `restaurants/${RESTAURANT_ID}/site_cards`);
            onSnapshot(collection(dbFirestore, "restaurants", RESTAURANT_ID, "site_cards"), (snap) => {
                const map = {}; snap.forEach(d => map[d.id] = d.data());
                let html = "";
                for (let i = 1; i <= 6; i++) {
                    const d = map[`card_${i}`] || { offerText: "Slot Empty", discount: 0, minOrderValue: 0 };
                    const hasData = d.offerText !== "Slot Empty";
                    const minOrderBadge = d.minOrderValue ? `<span class="absolute top-2 left-2 bg-black/50 text-white text-[10px] px-2 py-1 rounded backdrop-blur-sm">Min: ?${d.minOrderValue}</span>` : '';

                    html += `
                    <div class="bg-white rounded-xl shadow-sm border p-4 group">
                        <div class="h-32 bg-gray-100 rounded-lg mb-4 flex items-center justify-center relative overflow-hidden">
                            ${minOrderBadge}
                            ${d.img ? `<img src="${d.img}" class="w-full h-full object-cover">` : '<i class="fas fa-image text-3xl text-gray-300"></i>'}
                        </div>
                        <h4 class="font-bold text-gray-800 text-sm">${d.offerText}</h4>
                        <p class="text-xs text-gray-500 font-bold mb-3">${d.discount}% Off</p>
                        <button onclick="editOfferCard('card_${i}')" class="w-full bg-gray-50 text-xs font-bold py-2 rounded-lg hover:bg-orange-600 hover:text-white transition">
                            ${hasData ? 'Update Offer' : 'Add Offer'} (Slot ${i})
                        </button>
                    </div>`;
                }
                document.getElementById('offers-container').innerHTML = html;
            });
        };

        window.editOfferCard = async (id) => {
            document.getElementById('offer-edit-id').value = id;
            document.getElementById('offer-text-input').value = "";
            document.getElementById('offer-disc-input').value = "";
            document.getElementById('offer-min-input').value = "";
            document.getElementById('offer-img-input').value = "";
            document.getElementById('offer-editor-modal').classList.remove('hidden');
        };

        window.closeOfferModal = () => {
            document.getElementById('offer-editor-modal').classList.add('hidden');
        };

        window.saveOfferData = async () => {
            const id = document.getElementById('offer-edit-id').value;
            const txt = document.getElementById('offer-text-input').value;
            const disc = document.getElementById('offer-disc-input').value;
            const minVal = document.getElementById('offer-min-input').value;
            const img = document.getElementById('offer-img-input').value;

            if (!id) return;

            try {
                await setDoc(doc(dbFirestore, "restaurants", RESTAURANT_ID, "site_cards", id), {
                    offerText: txt,
                    discount: Number(disc),
                    minOrderValue: Number(minVal),
                    img
                }, { merge: true });
                window.showToast("Offer Updated", "success");
                window.closeOfferModal();
            } catch (e) {
                window.showToast("Update Failed", "error");
            }
        };

        window.deleteOfferData = async () => {
            const id = document.getElementById('offer-edit-id').value;
            if (!id) return;

            try {
                await deleteDoc(doc(dbFirestore, "restaurants", RESTAURANT_ID, "site_cards", id));
                window.showToast("Offer Removed", "success");
                window.closeOfferModal();
            } catch (e) {
                window.showToast("Delete Failed", "error");
            }
        };

        // ========== ADVANCED DASHBOARD ANALYTICS ==========
        let salesChart = null;
        let dashboardData = {
            todayRevenue: 0,
            todayOrders: 0,
            activeOrders: 0,
            todayCustomers: 0,
            weeklyData: [],
            topItems: [],
            recentOrders: []
        };

        window.initSalesChart = () => {
            const ctx = document.getElementById('salesChart');
            if (!ctx) return;
            
            if (salesChart) salesChart.destroy();
            
            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Revenue (Rs.)',
                        data: [0, 0, 0, 0, 0, 0, 0],
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#f97316',
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: {
                                callback: val => 'Rs.' + val
                            }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        };

        window.setChartPeriod = (period) => {
            // Update button styles
            document.querySelectorAll('.chart-period-btn').forEach(btn => {
                btn.classList.remove('bg-orange-100', 'text-orange-700');
                btn.classList.add('bg-gray-100', 'text-gray-600');
            });
            const activeBtn = document.getElementById(`btn-${period}`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-gray-100', 'text-gray-600');
                activeBtn.classList.add('bg-orange-100', 'text-orange-700');
            }
            
            // Update chart based on period (simplified - shows available data)
            updateDashboardStats();
        };

        window.updateDashboardStats = async () => {
            if (!RESTAURANT_ID) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            try {
                // Get today's orders
                const ordersRef = ref(dbRTDB, `restaurants/${RESTAURANT_ID}/orders`);
                const snapshot = await get(ordersRef);
                
                if (snapshot.exists()) {
                    const orders = snapshot.val();
                    let todayRevenue = 0;
                    let todayOrders = 0;
                    let activeOrders = 0;
                    let pendingOrders = 0;
                    let cookingOrders = 0;
                    const customers = new Set();
                    const itemCounts = {};
                    const recentOrders = [];
                    const weeklyRevenue = [0, 0, 0, 0, 0, 0, 0];
                    
                    Object.entries(orders).forEach(([key, order]) => {
                        const orderDate = new Date(order.timestamp);
                        const orderDay = orderDate.getDay();
                        const isToday = orderDate >= today;
                        
                        // Weekly data (last 7 days)
                        const dayDiff = Math.floor((today - orderDate) / (1000 * 60 * 60 * 24));
                        if (dayDiff >= 0 && dayDiff < 7) {
                            const idx = 6 - dayDiff;
                            weeklyRevenue[idx] += (order.total || 0);
                        }
                        
                        if (isToday) {
                            todayRevenue += (order.total || 0);
                            todayOrders++;
                            
                            if (order.customerPhone) customers.add(order.customerPhone);
                            
                            // Count items
                            if (order.items) {
                                order.items.forEach(item => {
                                    itemCounts[item.name] = (itemCounts[item.name] || 0) + (item.qty || 1);
                                });
                            }
                            
                            // Active orders with breakdown
                            if (order.status !== 'completed' && order.status !== 'cancelled') {
                                activeOrders++;
                                if (order.status === 'new' || order.status === 'pending') {
                                    pendingOrders++;
                                } else if (order.status === 'preparing') {
                                    cookingOrders++;
                                }
                            }
                            
                            // Recent orders
                            recentOrders.push({
                                id: order.orderNum || key.slice(-4),
                                customer: order.customerName || 'Guest',
                                total: order.total || 0,
                                status: order.status || 'new',
                                time: orderDate
                            });
                        }
                    });
                    
                    // Update stats
                    dashboardData = {
                        todayRevenue,
                        todayOrders,
                        pendingOrders,
                        cookingOrders,
                        activeOrders,
                        todayCustomers: customers.size,
                        weeklyData: weeklyRevenue,
                        topItems: Object.entries(itemCounts)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 5)
                            .map(([name, count]) => ({ name, count })),
                        recentOrders: recentOrders
                            .sort((a, b) => b.time - a.time)
                            .slice(0, 5)
                    };
                    
                    renderDashboardStats();
                }
            } catch (e) {
                console.error('Dashboard stats error:', e);
            }
        };

        window.renderDashboardStats = () => {
            // Update stat cards
            const revenueEl = document.getElementById('stat-today-revenue');
            const ordersEl = document.getElementById('stat-today-orders');
            const activeEl = document.getElementById('stat-active-orders');
            const customersEl = document.getElementById('stat-today-customers');
            
            if (revenueEl) revenueEl.textContent = 'Rs.' + dashboardData.todayRevenue.toLocaleString();
            if (ordersEl) ordersEl.textContent = dashboardData.todayOrders;
            if (activeEl) activeEl.textContent = dashboardData.activeOrders;
            if (customersEl) customersEl.textContent = dashboardData.todayCustomers;
            
            // Update average order value
            const avgOrderEl = document.getElementById('stat-avg-order');
            if (avgOrderEl && dashboardData.todayOrders > 0) {
                const avg = Math.round(dashboardData.todayRevenue / dashboardData.todayOrders);
                avgOrderEl.textContent = 'Rs.' + avg;
            }
            
            // Update pending/cooking stats
            const pendingEl = document.getElementById('stat-pending');
            const prepEl = document.getElementById('stat-prep');
            if (pendingEl) pendingEl.textContent = dashboardData.pendingOrders || 0;
            if (prepEl) prepEl.textContent = dashboardData.cookingOrders || 0;
            
            // Update chart
            if (salesChart && dashboardData.weeklyData.length) {
                salesChart.data.datasets[0].data = dashboardData.weeklyData;
                salesChart.update();
            }
            
            // Update top items
            const topItemsEl = document.getElementById('top-items-list');
            if (topItemsEl && dashboardData.topItems.length) {
                topItemsEl.innerHTML = dashboardData.topItems.map((item, idx) => `
                    <div class="flex items-center justify-between py-2 ${idx < dashboardData.topItems.length - 1 ? 'border-b' : ''}">
                        <div class="flex items-center gap-3">
                            <span class="w-6 h-6 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-xs font-bold">${idx + 1}</span>
                            <span class="text-sm font-medium">${item.name}</span>
                        </div>
                        <span class="text-sm text-gray-500">${item.count} sold</span>
                    </div>
                `).join('');
            } else if (topItemsEl) {
                topItemsEl.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">No sales yet today</p>';
            }
            
            // Update recent orders
            const recentOrdersEl = document.getElementById('recent-orders-list');
            if (recentOrdersEl && dashboardData.recentOrders.length) {
                recentOrdersEl.innerHTML = dashboardData.recentOrders.map(order => {
                    const statusColors = {
                        'new': 'bg-blue-100 text-blue-700',
                        'preparing': 'bg-yellow-100 text-yellow-700',
                        'ready': 'bg-green-100 text-green-700',
                        'completed': 'bg-gray-100 text-gray-700',
                        'cancelled': 'bg-red-100 text-red-700'
                    };
                    const statusClass = statusColors[order.status] || 'bg-gray-100 text-gray-700';
                    const timeStr = order.time.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
                    
                    return `
                        <div class="flex items-center justify-between py-2 border-b last:border-0">
                            <div>
                                <p class="font-medium text-sm">#${order.id}</p>
                                <p class="text-xs text-gray-500">${order.customer}?ï¿½ ${timeStr}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-sm">Rs.${order.total}</p>
                                <span class="text-xs px-2 py-0.5 rounded-full ${statusClass}">${order.status}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            } else if (recentOrdersEl) {
                recentOrdersEl.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">No orders yet today</p>';
            }
            
            // Update health metrics (mock for now, can be calculated from real data)
            const completedOrders = dashboardData.recentOrders.filter(o => o.status === 'completed').length;
            const totalOrders = dashboardData.todayOrders || 1;
            const completionRate = Math.round((completedOrders / totalOrders) * 100) || 85;
            
            document.querySelectorAll('.progress-ring-progress').forEach((ring, idx) => {
                const values = [completionRate, 92, 88]; // completion, satisfaction, prep time
                const circumference = 2 * Math.PI * 36;
                const offset = circumference - (values[idx] / 100) * circumference;
                ring.style.strokeDashoffset = offset;
            });
        };

        window.quickAction = (action) => {
            switch(action) {
                case 'viewOrders':
                    switchTab('live');
                    break;
                case 'addItem':
                    switchTab('menu');
                    document.getElementById('menu-modal')?.classList.remove('hidden');
                    break;
            }
        };

        // Initialize dashboard on load
        window.initDashboard = () => {
            initSalesChart();
            updateDashboardStats();
            
            // Auto-refresh dashboard every 30 seconds
            setInterval(() => {
                const dashSection = document.getElementById('section-dashboard');
                if (dashSection && !dashSection.classList.contains('hide-section')) {
                    updateDashboardStats();
                }
            }, 30000);
        };

        // Init - only focus on login pin, rest is handled by initAdminFeatures after validation
        document.getElementById('login-pin').focus();

        // =====================================================
        // INVENTORY MANAGEMENT SYSTEM
        // =====================================================
        window.inventoryCache = {};
        
        const initInventory = () => {
            if (!RESTAURANT_ID) return;
            
            onSnapshot(collection(dbFirestore, "restaurants", RESTAURANT_ID, "inventory"), (snap) => {
                window.inventoryCache = {};
                let lowStock = 0, outStock = 0, totalValue = 0;
                
                snap.forEach(doc => {
                    const item = { id: doc.id, ...doc.data() };
                    window.inventoryCache[doc.id] = item;
                    
                    const qty = Number(item.quantity) || 0;
                    const min = Number(item.minStock) || 0;
                    const cost = Number(item.costPerUnit) || 0;
                    
                    totalValue += qty * cost;
                    if (qty === 0) outStock++;
                    else if (qty <= min) lowStock++;
                });
                
                document.getElementById('inv-total-items').textContent = Object.keys(window.inventoryCache).length;
                document.getElementById('inv-low-stock').textContent = lowStock;
                document.getElementById('inv-out-stock').textContent = outStock;
                document.getElementById('inv-total-value').textContent = 'Rs.' + totalValue.toLocaleString('en-IN');
                
                // Update low stock badge in sidebar
                const badge = document.getElementById('low-stock-badge');
                if (badge && lowStock > 0) {
                    badge.innerHTML = `<span class="text-red-500 font-bold">${lowStock} Low Stock!</span>`;
                } else if (badge) {
                    badge.textContent = 'Stock Management';
                }
                
                renderInventoryTable();
            });
        };
        
        window.renderInventoryTable = (filter = 'all') => {
            const tbody = document.getElementById('inventory-table');
            let html = '';
            
            Object.values(window.inventoryCache).forEach(item => {
                if (filter !== 'all') {
                    if (filter === 'low' && Number(item.quantity) > Number(item.minStock || 0)) return;
                    if (filter !== 'low' && item.category !== filter) return;
                }
                
                const qty = Number(item.quantity) || 0;
                const min = Number(item.minStock) || 0;
                let status = '';
                
                if (qty === 0) {
                    status = '<span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-bold">Stock</span>';
                } else if (qty <= min) {
                    status = '<span class="px-2 py-1 bg-red-100 text-red-600 rounded-full text-xs font-bold animate-pulse">Stock</span>';
                } else {
                    status = '<span class="px-2 py-1 bg-green-100 text-green-600 rounded-full text-xs font-bold">Stock</span>';
                }
                
                const categoryEmojis = {
                    vegetables: 'Vegetables', dairy: 'Dairy', meat: 'Meat', spices: 'Spices',
                    grains: 'Grains', beverages: 'Beverages', packaging: 'Packaging', cleaning: 'Cleaning', other: 'Other'
                };
                
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="p-4 font-medium">${item.name}</td>
                        <td class="p-4 text-sm">${categoryEmojis[item.category] || item.category || "Other"}</td>
                        <td class="p-4 font-bold ${qty <= min ? 'text-red-600' : 'text-gray-800'}">${qty}</td>
                        <td class="p-4 text-sm text-gray-500">${item.unit || 'units'}</td>
                        <td class="p-4 text-sm">?${item.costPerUnit || 0}</td>
                        <td class="p-4 text-sm text-gray-500">${min}</td>
                        <td class="p-4">${status}</td>
                        <td class="p-4 text-right">
                            <button onclick="openStockAdjust('${item.id}')" class="px-2 py-1 bg-amber-100 text-amber-700 rounded text-xs font-bold hover:bg-amber-200 mr-1">Stock</button>
                            <button onclick="editInventoryItem('${item.id}')" class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-bold hover:bg-blue-200 mr-1"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteInventoryItem('${item.id}')" class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-bold hover:bg-red-200"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html || '<tr><td colspan="8" class="p-8 text-center text-gray-400">No inventory items. Click "Add Item" to start.</td></tr>';
        };
        
        window.filterInventory = (filter) => {
            document.querySelectorAll('.inv-filter-btn').forEach(btn => {
                btn.classList.remove('bg-gray-800', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-600');
            });
            event.target.classList.remove('bg-gray-100', 'text-gray-600');
            event.target.classList.add('bg-gray-800', 'text-white');
            renderInventoryTable(filter);
        };
        
        window.openInventoryModal = () => {
            document.getElementById('inv-edit-id').value = '';
            document.getElementById('inv-name').value = '';
            document.getElementById('inv-qty').value = '';
            document.getElementById('inv-cost').value = '';
            document.getElementById('inv-min').value = '10';
            document.getElementById('inv-supplier').value = '';
            document.getElementById('inv-notes').value = '';
            document.getElementById('inv-modal-title').textContent = 'Add Inventory Item';
            document.getElementById('inventory-modal').classList.remove('hidden');
        };
        
        window.closeInventoryModal = () => document.getElementById('inventory-modal').classList.add('hidden');
        
        window.editInventoryItem = (id) => {
            const item = window.inventoryCache[id];
            if (!item) return;
            
            document.getElementById('inv-edit-id').value = id;
            document.getElementById('inv-name').value = item.name || '';
            document.getElementById('inv-category').value = item.category || 'other';
            document.getElementById('inv-unit').value = item.unit || 'kg';
            document.getElementById('inv-qty').value = item.quantity || '';
            document.getElementById('inv-cost').value = item.costPerUnit || '';
            document.getElementById('inv-min').value = item.minStock || '10';
            document.getElementById('inv-supplier').value = item.supplier || '';
            document.getElementById('inv-notes').value = item.notes || '';
            document.getElementById('inv-modal-title').textContent = 'Edit Inventory Item';
            document.getElementById('inventory-modal').classList.remove('hidden');
        };
        
        window.saveInventoryItem = async () => {
            const editId = document.getElementById('inv-edit-id').value;
            const name = document.getElementById('inv-name').value.trim();
            const qty = document.getElementById('inv-qty').value;
            
            if (!name || !qty) {
                window.showToast('Name and Quantity required', 'error');
                return;
            }
            
            const data = {
                name,
                category: document.getElementById('inv-category').value,
                unit: document.getElementById('inv-unit').value,
                quantity: Number(qty),
                costPerUnit: Number(document.getElementById('inv-cost').value) || 0,
                minStock: Number(document.getElementById('inv-min').value) || 10,
                supplier: document.getElementById('inv-supplier').value,
                notes: document.getElementById('inv-notes').value,
                updatedAt: serverTimestamp()
            };
            
            try {
                if (editId) {
                    await updateDoc(doc(dbFirestore, "restaurants", RESTAURANT_ID, "inventory", editId), data);
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(dbFirestore, "restaurants", RESTAURANT_ID, "inventory"), data);
                }
                closeInventoryModal();
                window.showToast('Inventory item saved!', 'success');
            } catch (e) {
                console.error(e);
                window.showToast('Failed to save', 'error');
            }
        };
        
        window.deleteInventoryItem = (id) => {
            window.openDeleteModal(async () => {
                await deleteDoc(doc(dbFirestore, "restaurants", RESTAURANT_ID, "inventory", id));
                window.showToast('Item deleted', 'success');
            }, 'Delete Inventory Item?', 'This will permanently remove this item from inventory.');
        };
        
        window.openStockAdjust = (id) => {
            const item = window.inventoryCache[id];
            if (!item) return;
            
            document.getElementById('stock-item-id').value = id;
            document.getElementById('stock-item-name').textContent = item.name;
            document.getElementById('stock-current-qty').textContent = item.quantity || 0;
            document.getElementById('stock-current-unit').textContent = item.unit || 'units';
            document.getElementById('stock-qty').value = '';
            document.getElementById('stock-action').value = 'add';
            setStockAction('add');
            document.getElementById('stock-adjust-modal').classList.remove('hidden');
        };
        
        window.closeStockAdjustModal = () => document.getElementById('stock-adjust-modal').classList.add('hidden');
        
        window.setStockAction = (action) => {
            document.getElementById('stock-action').value = action;
            document.querySelectorAll('.stock-action-btn').forEach(btn => {
                btn.classList.remove('border-green-500', 'bg-green-50', 'text-green-700', 'border-red-500', 'bg-red-50', 'text-red-700');
                btn.classList.add('border-gray-200', 'text-gray-600');
            });
            if (action === 'add') {
                event.target.classList.add('border-green-500', 'bg-green-50', 'text-green-700');
            } else {
                event.target.classList.add('border-red-500', 'bg-red-50', 'text-red-700');
            }
        };
        
        window.confirmStockAdjust = async () => {
            const id = document.getElementById('stock-item-id').value;
            const item = window.inventoryCache[id];
            if (!item) return;
            
            const qty = Number(document.getElementById('stock-qty').value);
            const action = document.getElementById('stock-action').value;
            const reason = document.getElementById('stock-reason').value;
            
            if (!qty || qty <= 0) {
                window.showToast('Enter valid quantity', 'error');
                return;
            }
            
            const currentQty = Number(item.quantity) || 0;
            const newQty = action === 'add' ? currentQty + qty : Math.max(0, currentQty - qty);
            
            try {
                await updateDoc(doc(dbFirestore, "restaurants", RESTAURANT_ID, "inventory", id), {
                    quantity: newQty,
                    updatedAt: serverTimestamp()
                });
                
                // Log stock movement
                await addDoc(collection(dbFirestore, "restaurants", RESTAURANT_ID, "stock_movements"), {
                    itemId: id,
                    itemName: item.name,
                    action: action,
                    quantity: qty,
                    previousQty: currentQty,
                    newQty: newQty,
                    reason: reason,
                    timestamp: serverTimestamp()
                });
                
                closeStockAdjustModal();
                window.showToast(`Stock ${action === 'add' ? 'added' : 'removed'} successfully!`, 'success');
            } catch (e) {
                console.error(e);
                window.showToast('Failed to update stock', 'error');
            }
        };
        
        window.exportInventory = () => {
            let csv = "Item Name,Category,Quantity,Unit,Cost/Unit,Min Stock,Supplier,Value\n";
            Object.values(window.inventoryCache).forEach(item => {
                const value = (Number(item.quantity) || 0) * (Number(item.costPerUnit) || 0);
                csv += `"${item.name}",${item.category},${item.quantity},${item.unit},${item.costPerUnit || 0},${item.minStock || 0},"${item.supplier || ''}",${value}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.showToast('Inventory exported!', 'success');
        };

        // =====================================================
        // UPDATE SWITCHTAB TO INCLUDE NEW SECTIONS
        // =====================================================
        const originalSwitchTab = window.switchTab;
        window.switchTab = (tabName) => {
            const allTabs = ['dashboard', 'live', 'menu', 'orders', 'offers', 'settings', 'inventory'];

            allTabs.forEach(id => {
                const section = document.getElementById(`section-${id}`);
                const nav = document.getElementById(`nav-${id}`);

                if (section) {
                    section.classList.add('hide-section');
                    if (id === tabName) {
                        section.classList.remove('hide-section');
                    }
                }

                if (nav) {
                    nav.classList.remove('active');
                    if (id === tabName) nav.classList.add('active');
                }
            });

            if (window.innerWidth < 768) {
                const sidebar = document.getElementById('sidebar');
                if (sidebar.classList.contains('sidebar-open')) window.toggleSidebar();
            }
            
            // Update dashboard when switching to it
            if (tabName === 'dashboard') {
                updateDashboardStats();
            }
            // Refresh specific sections when navigated
            if (tabName === 'inventory') renderInventoryTable();
        };

        // =====================================================
        // Command Center - LIVE SALES TICKER
        // =====================================================
        let salesTickerInterval = null;
        let todaySalesTotal = 0;
        let orderVelocity = 0;
        let lastOrderCount = 0;
        
        function updateLiveSalesTicker() {
            const tickerEl = document.getElementById('live-sales-ticker');
            if (!tickerEl) return;
            
            // Animate ticker update
            tickerEl.classList.add('scale-110');
            tickerEl.textContent = `Rs.${todaySalesTotal.toLocaleString()}`;
            setTimeout(() => tickerEl.classList.remove('scale-110'), 300);
        }
        
        function updateOrderVelocity() {
            const velocityEl = document.getElementById('order-velocity');
            const trendEl = document.getElementById('velocity-trend');
            if (!velocityEl) return;
            
            velocityEl.textContent = `${orderVelocity}/hr`;
            
            // Update trend indicator
            if (trendEl) {
                if (orderVelocity > 10) {
                    trendEl.innerHTML = '<i class="fas fa-arrow-up text-green-400"></i> High';
                    trendEl.className = 'text-xs text-green-400';
                } else if (orderVelocity > 5) {
                    trendEl.innerHTML = '<i class="fas fa-minus text-yellow-400"></i> Normal';
                    trendEl.className = 'text-xs text-yellow-400';
                } else {
                    trendEl.innerHTML = '<i class="fas fa-arrow-down text-red-400"></i> Low';
                    trendEl.className = 'text-xs text-red-400';
                }
            }
        }
        
        function updateTopSellingItems() {
            const listEl = document.getElementById('top-items-list');
            if (!listEl) return;
            
            // Calculate top items from orders
            const itemCounts = {};
            Object.values(window.ordersCache || {}).forEach(order => {
                if (order.items) {
                    order.items.forEach(item => {
                        const name = item.name || 'Unknown';
                        itemCounts[name] = (itemCounts[name] || 0) + (item.qty || 1);
                    });
                }
            });
            
            const sorted = Object.entries(itemCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            if (sorted.length === 0) {
                listEl.innerHTML = '<p class="text-gray-400 text-sm">No orders today</p>';
                return;
            }
            
            listEl.innerHTML = sorted.map((item, idx) => `
                <div class="flex justify-between items-center py-1 ${idx > 0 ? 'border-t border-gray-700' : ''}">
                    <span class="text-sm">${item[0]}</span>
                    <span class="text-xs bg-primary/20 px-2 py-0.5 rounded">${item[1]} sold</span>
                </div>
            `).join('');
        }
        
        function updateAlertsPanel() {
            const alertsEl = document.getElementById('alerts-panel');
            if (!alertsEl) return;
            
            const alerts = [];
            
            // Check low stock items
            Object.values(window.inventoryCache || {}).forEach(item => {
                if (item.quantity <= (item.minStock || 5)) {
                    alerts.push({
                        type: 'warning',
                        icon: 'exclamation-triangle',
                        message: `Low Stock: ${item.name} (${item.quantity} left)`,
                        action: () => switchTab('inventory')
                    });
                }
            });
            
            // Check pending orders
            const pendingOrders = Object.values(window.ordersCache || {}).filter(o => o.status === 'pending');
            if (pendingOrders.length > 5) {
                alerts.push({
                    type: 'error',
                    icon: 'bell',
                    message: `${pendingOrders.length} orders pending! Check kitchen`,
                    action: () => switchTab('live')
                });
            }
            
            // Check internet connectivity
            if (!navigator.onLine) {
                alerts.push({
                    type: 'error',
                    icon: 'wifi-slash',
                    message: 'No Internet Connection - Working Offline',
                    action: null
                });
            }
            
            if (alerts.length === 0) {
                alertsEl.innerHTML = `
                    <div class="text-center py-4 text-green-400">
                        <i class="fas fa-check-circle text-2xl mb-2"></i>
                        <p class="text-sm">All systems normal</p>
                    </div>`;
                return;
            }
            
            alertsEl.innerHTML = alerts.map(alert => `
                <div class="flex items-center gap-3 p-2 rounded ${alert.type === 'error' ? 'bg-red-500/20' : 'bg-yellow-500/20'} cursor-pointer hover:opacity-80"
                     onclick="${alert.action ? alert.action.toString().replace(/"/g, "'") : ''}">
                    <i class="fas fa-${alert.icon} ${alert.type === 'error' ? 'text-red-400' : 'text-yellow-400'}"></i>
                    <span class="text-sm flex-1">${alert.message}</span>
                    <i class="fas fa-chevron-right text-xs opacity-50"></i>
                </div>
            `).join('');
        }
        
        // =====================================================
        // QR CODE GENERATION
        // =====================================================
        window.openQRCodeModal = () => {
            document.getElementById('qrcode-modal').classList.remove('hidden');
            generateMenuQRCode();
        };
        
        window.closeQRCodeModal = () => {
            document.getElementById('qrcode-modal').classList.add('hidden');
        };
        
        function generateMenuQRCode() {
            const canvas = document.getElementById('qr-canvas');
            const ctx = canvas.getContext('2d');
            const menuUrl = `https://Orderly.menu/${RESTAURANT_ID}`;
            
            // Update URL display
            document.getElementById('menu-url-display').value = menuUrl;
            
            // Simple QR code pattern (placeholder - in production use QRCode.js library)
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, 200, 200);
            ctx.fillStyle = '#000000';
            
            // Create QR-like pattern
            const size = 8;
            for (let i = 0; i < 25; i++) {
                for (let j = 0; j < 25; j++) {
                    // Position patterns (corners)
                    if ((i < 7 && j < 7) || (i < 7 && j > 17) || (i > 17 && j < 7)) {
                        if ((i === 0 || i === 6 || j === 0 || j === 6) ||
                            (i > 1 && i < 5 && j > 1 && j < 5) ||
                            (i === 0 || i === 6 || j === 18 || j === 24) ||
                            (j === 0 || j === 6 || i === 18 || i === 24)) {
                            ctx.fillRect(i * size, j * size, size, size);
                        }
                    } else {
                        // Random data pattern based on URL hash
                        const hash = (menuUrl.charCodeAt(i % menuUrl.length) + j * 31) % 3;
                        if (hash === 0) {
                            ctx.fillRect(i * size, j * size, size, size);
                        }
                    }
                }
            }
            
            // Add logo in center
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(85, 85, 30, 30);
            ctx.fillStyle = '#f97316';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('W', 100, 105);
        }
        
        window.copyMenuURL = () => {
            const url = document.getElementById('menu-url-display').value;
            navigator.clipboard.writeText(url).then(() => {
                window.showToast('URL copied to clipboard!', 'success');
            });
        };
        
        window.downloadQRCode = () => {
            const canvas = document.getElementById('qr-canvas');
            const link = document.createElement('a');
            link.download = 'wow-cafe-menu-qr.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            window.showToast('QR Code downloaded!', 'success');
        };
        
        window.printQRCode = () => {
            const canvas = document.getElementById('qr-canvas');
            const printWindow = window.open('', '_blank');
            const htmlContent = [
                '<html>',
                '<head><title>Menu QR Code - Orderly<\/title><\/head>',
                '<body style="text-align:center; padding:50px;">',
                '<h2>Scan to View Menu<\/h2>',
                '<img src="' + canvas.toDataURL() + '" style="width:300px;height:300px;">',
                '<p style="margin-top:20px;">Orderly Digital Menu<\/p>',
                '<\/body>',
                '<\/html>'
            ].join('');
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            printWindow.print();
        };
        
        // =====================================================
        // ACTIVITY LOGS (AUDIT TRAIL)
        // =====================================================
        let activityLogs = [];
        
        window.openActivityLogsModal = async () => {
            document.getElementById('activity-logs-modal').classList.remove('hidden');
            await loadActivityLogs();
        };
        
        window.closeActivityLogsModal = () => {
            document.getElementById('activity-logs-modal').classList.add('hidden');
        };

        // --- PRIVACY POLICY & TERMS FUNCTIONS ---
        window.openPrivacyPolicy = () => {
            document.getElementById('privacy-policy-modal').classList.remove('hidden');
        };
        
        window.closePrivacyPolicy = () => {
            document.getElementById('privacy-policy-modal').classList.add('hidden');
        };
        
        window.openTermsConditions = () => {
            document.getElementById('terms-conditions-modal').classList.remove('hidden');
        };
        
        window.closeTermsConditions = () => {
            document.getElementById('terms-conditions-modal').classList.add('hidden');
        };

        // --- ACCORDION TOGGLE FUNCTION ---
        window.toggleAccordion = (sectionId) => {
            const content = document.getElementById(sectionId);
            const icon = document.getElementById(sectionId + '-icon');
            
            if (content.classList.contains('hidden')) {
                // Open this section
                content.classList.remove('hidden');
                if (icon) icon.classList.add('rotate-180');
            } else {
                // Close this section
                content.classList.add('hidden');
                if (icon) icon.classList.remove('rotate-180');
            }
        };
        
        async function loadActivityLogs() {
            const container = document.getElementById('activity-logs-list');
            container.innerHTML = '<p class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> Loading...</p>';
            
            try {
                const q = query(
                    collection(dbFirestore, "restaurants", RESTAURANT_ID, "activity_logs"),
                    orderBy("timestamp", "desc"),
                    limit(100)
                );
                
                const snap = await getDocs(q);
                activityLogs = [];
                snap.forEach(doc => activityLogs.push({ id: doc.id, ...doc.data() }));
                
                renderActivityLogs();
            } catch (e) {
                console.error('Failed to load activity logs:', e);
                container.innerHTML = '<p class="text-center text-red-400 py-4">Failed to load logs</p>';
            }
        }
        
        function renderActivityLogs(filter = 'all') {
            const container = document.getElementById('activity-logs-list');
            let filtered = activityLogs;
            
            if (filter !== 'all') {
                filtered = activityLogs.filter(log => log.action === filter);
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 py-4">No activity logs found</p>';
                return;
            }
            
            container.innerHTML = filtered.map(log => {
                const time = log.timestamp?.toDate ? log.timestamp.toDate() : new Date(log.timestamp);
                const actionColors = {
                    'order': 'text-green-400',
                    'refund': 'text-red-400',
                    'edit': 'text-yellow-400',
                    'delete': 'text-red-400',
                    'login': 'text-blue-400',
                    'settings': 'text-purple-400'
                };
                const actionIcons = {
                    'order': 'shopping-cart',
                    'refund': 'undo',
                    'edit': 'edit',
                    'delete': 'trash',
                    'login': 'sign-in-alt',
                    'settings': 'cog'
                };
                
                return `
                    <div class="flex items-start gap-3 p-3 border-b border-gray-700 hover:bg-gray-800/50">
                        <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center ${actionColors[log.action] || 'text-gray-400'}">
                            <i class="fas fa-${actionIcons[log.action] || 'info'}"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm">${log.description || 'Activity recorded'}</p>
                            <div class="flex gap-4 text-xs text-gray-400 mt-1">
                                <span><i class="fas fa-user"></i> ${log.user || 'System'}</span>
                                <span><i class="fas fa-clock"></i> ${time.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        window.filterActivityLogs = (filter) => {
            renderActivityLogs(filter);
        };
        
        async function logActivity(action, description, details = {}) {
            try {
                await addDoc(collection(dbFirestore, "restaurants", RESTAURANT_ID, "activity_logs"), {
                    action,
                    description,
                    details,
                    user: localStorage.getItem('adminName') || 'Admin',
                    timestamp: serverTimestamp(),
                    ip: 'local'
                });
            } catch (e) {
                console.error('Failed to log activity:', e);
            }
        }
        
        window.exportActivityLogs = () => {
            const csv = [
                ['Timestamp', 'Action', 'Description', 'User'].join(','),
                ...activityLogs.map(log => {
                    const time = log.timestamp?.toDate ? log.timestamp.toDate() : new Date(log.timestamp);
                    return [
                        time.toISOString(),
                        log.action,
                        `"${log.description || ''}"`,
                        log.user || 'System'
                    ].join(',');
                })
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `activity-logs-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            window.showToast('Logs exported!', 'success');
        };
        
        // =====================================================
        // EOD (END OF DAY) REPORT
        // =====================================================
        window.openEODReportModal = () => {
            document.getElementById('eod-report-modal').classList.remove('hidden');
            window.generateEODReport();
        };
        
        window.closeEODReportModal = () => {
            document.getElementById('eod-report-modal').classList.add('hidden');
        };
        
        window.generateEODReport = function() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const todayOrders = Object.values(window.ordersCache || {}).filter(o => {
                const orderDate = new Date(o.timestamp);
                orderDate.setHours(0, 0, 0, 0);
                return orderDate.getTime() === today.getTime();
            });
            
            // Calculate stats
            const totalSales = todayOrders.reduce((sum, o) => sum + (o.grandTotal || o.total || 0), 0);
            const cashSales = todayOrders.filter(o => o.paymentMethod === 'cash')
                .reduce((sum, o) => sum + (o.grandTotal || o.total || 0), 0);
            const onlineSales = totalSales - cashSales;
            const cardSales = todayOrders.filter(o => o.paymentMethod === 'card')
                .reduce((sum, o) => sum + (o.grandTotal || o.total || 0), 0);
            const pendingSales = todayOrders.filter(o => o.paymentStatus === 'pending')
                .reduce((sum, o) => sum + (o.grandTotal || o.total || 0), 0);
            
            const totalOrders = todayOrders.length;
            const avgOrder = totalOrders > 0 ? totalSales / totalOrders : 0;
            
            // Order types
            const dineinOrders = todayOrders.filter(o => o.orderType === 'dine-in' || o.orderType === 'dinein').length;
            const takeawayOrders = todayOrders.filter(o => o.orderType === 'takeaway').length;
            const deliveryOrders = todayOrders.filter(o => o.orderType === 'delivery').length;
            const onlineOrders = todayOrders.filter(o => o.source === 'online').length;
            
            const totalDiscount = todayOrders.reduce((sum, o) => sum + (o.discount || 0), 0);
            
            // Update EOD modal with stats (using correct IDs from the modal)
            const modalSalesEl = document.getElementById('eod-modal-sales');
            const modalOrdersEl = document.getElementById('eod-modal-orders');
            const modalAvgEl = document.getElementById('eod-modal-avg');
            
            if (modalSalesEl) modalSalesEl.textContent = `Rs.${totalSales.toLocaleString()}`;
            if (modalOrdersEl) modalOrdersEl.textContent = totalOrders;
            if (modalAvgEl) modalAvgEl.textContent = `Rs.${Math.round(avgOrder).toLocaleString()}`;
            
            // Payment breakdown
            const cashEl = document.getElementById('eod-cash-amount');
            const onlineEl = document.getElementById('eod-online-amount');
            const cardEl = document.getElementById('eod-card-amount');
            const pendingEl = document.getElementById('eod-pending-amount');
            
            if (cashEl) cashEl.textContent = `Rs.${cashSales.toLocaleString()}`;
            if (onlineEl) onlineEl.textContent = `Rs.${onlineSales.toLocaleString()}`;
            if (cardEl) cardEl.textContent = `Rs.${cardSales.toLocaleString()}`;
            if (pendingEl) pendingEl.textContent = `Rs.${pendingSales.toLocaleString()}`;
            
            // Order types
            const dineinEl = document.getElementById('eod-dinein');
            const takeawayEl = document.getElementById('eod-takeaway');
            const deliveryEl = document.getElementById('eod-delivery');
            const onlineOrdersEl = document.getElementById('eod-online-orders');
            
            if (dineinEl) dineinEl.textContent = dineinOrders;
            if (takeawayEl) takeawayEl.textContent = takeawayOrders;
            if (deliveryEl) deliveryEl.textContent = deliveryOrders;
            if (onlineOrdersEl) onlineOrdersEl.textContent = onlineOrders;
            
            // Discount audit
            const discountAuditEl = document.getElementById('eod-discount-audit');
            if (discountAuditEl) {
                const discountedOrders = todayOrders.filter(o => o.discount > 0);
                if (discountedOrders.length === 0) {
                    discountAuditEl.innerHTML = '<p class="text-green-600">No discounts applied today</p>';
                } else {
                    discountAuditEl.innerHTML = `
                        <div class="flex justify-between"><span>Total Discounts:</span><span class="font-bold">Rs.${totalDiscount.toLocaleString()}</span></div>
                        <div class="flex justify-between"><span>Orders with Discount:</span><span class="font-bold">${discountedOrders.length}</span></div>
                        <div class="flex justify-between"><span>Avg Discount/Order:</span><span class="font-bold">Rs.${Math.round(totalDiscount/discountedOrders.length).toLocaleString()}</span></div>
                    `;
                }
            }
            
            // Cash drawer reconciliation
            const expectedCashEl = document.getElementById('eod-expected-cash');
            if (expectedCashEl) expectedCashEl.textContent = `Rs.${cashSales.toLocaleString()}`;
            
            // Listen for actual cash input
            const actualCashInput = document.getElementById('eod-actual-cash');
            const differenceBox = document.getElementById('eod-difference-box');
            const differenceEl = document.getElementById('eod-difference');
            
            if (actualCashInput) {
                actualCashInput.value = '';
                actualCashInput.oninput = () => {
                    const actual = parseFloat(actualCashInput.value) || 0;
                    const diff = actual - cashSales;
                    if (differenceEl) {
                        differenceEl.textContent = `Rs.${Math.abs(diff).toLocaleString()} ${diff >= 0 ? '(Over)' : '(Short)'}`;
                        differenceEl.className = diff >= 0 ? 'font-black text-green-600' : 'font-black text-red-600';
                    }
                    if (differenceBox) {
                        differenceBox.className = `mt-3 p-2 rounded-lg ${diff >= 0 ? 'bg-green-100' : 'bg-red-100'}`;
                    }
                };
            }
        };
        
        window.downloadEODReport = () => {
            const totalSales = document.getElementById('eod-modal-sales')?.textContent || 'Rs.0';
            const totalOrders = document.getElementById('eod-modal-orders')?.textContent || '0';
            const cashAmount = document.getElementById('eod-cash-amount')?.textContent || 'Rs.0';
            const onlineAmount = document.getElementById('eod-online-amount')?.textContent || 'Rs.0';
            const cardAmount = document.getElementById('eod-card-amount')?.textContent || 'Rs.0';
            const dinein = document.getElementById('eod-dinein')?.textContent || '0';
            const takeaway = document.getElementById('eod-takeaway')?.textContent || '0';
            const delivery = document.getElementById('eod-delivery')?.textContent || '0';
            const reportDate = new Date().toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const generatedOn = new Date().toLocaleString();
            
            const html = [
                '<html>',
                '<head>',
                '<title>EOD Report - ' + new Date().toLocaleDateString() + '<\/title>',
                '<style>',
                'body { font-family: Arial; padding: 20px; max-width: 600px; margin: 0 auto; }',
                '.header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }',
                '.section { margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 8px; }',
                '.section h3 { margin-top: 0; color: #333; }',
                '.row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }',
                '.row:last-child { border-bottom: none; }',
                '.total { font-weight: bold; font-size: 1.2em; background: #e8f5e9; padding: 10px; border-radius: 5px; }',
                '<\/style>',
                '<\/head>',
                '<body>',
                '<div class="header">',
                '<h1>Orderly<\/h1>',
                '<h2>End of Day Report<\/h2>',
                '<p>' + reportDate + '<\/p>',
                '<\/div>',
                '<div class="section">',
                '<h3>Sales Summary<\/h3>',
                '<div class="row total"><span>Total Sales:<\/span><span>' + totalSales + '<\/span><\/div>',
                '<div class="row"><span>Total Orders:<\/span><span>' + totalOrders + '<\/span><\/div>',
                '<\/div>',
                '<div class="section">',
                '<h3>Payment Breakdown<\/h3>',
                '<div class="row"><span>Cash:<\/span><span>' + cashAmount + '<\/span><\/div>',
                '<div class="row"><span>UPI/Online:<\/span><span>' + onlineAmount + '<\/span><\/div>',
                '<div class="row"><span>Card:<\/span><span>' + cardAmount + '<\/span><\/div>',
                '<\/div>',
                '<div class="section">',
                '<h3>Order Types<\/h3>',
                '<div class="row"><span>Dine-in:<\/span><span>' + dinein + '<\/span><\/div>',
                '<div class="row"><span>Takeaway:<\/span><span>' + takeaway + '<\/span><\/div>',
                '<div class="row"><span>Delivery:<\/span><span>' + delivery + '<\/span><\/div>',
                '<\/div>',
                '<p style="text-align:center; color:#888; margin-top:30px;">Generated on ' + generatedOn + '<\/p>',
                '<\/body>',
                '<\/html>'
            ].join('\n');
            
            const blob = new Blob([html], { type: 'text/html' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'eod-report-' + new Date().toISOString().split('T')[0] + '.html';
            link.click();
            window.showToast('EOD Report downloaded!', 'success');
        };
        
        window.saveEODReport = async () => {
            try {
                const totalSales = parseFloat((document.getElementById('eod-modal-sales')?.textContent || '0').replace(/[Rs.,]/g, '')) || 0;
                const cashSales = parseFloat((document.getElementById('eod-cash-amount')?.textContent || '0').replace(/[Rs.,]/g, '')) || 0;
                const onlineSales = parseFloat((document.getElementById('eod-online-amount')?.textContent || '0').replace(/[Rs.,]/g, '')) || 0;
                const totalOrders = parseInt(document.getElementById('eod-modal-orders')?.textContent || '0') || 0;
                
                await addDoc(collection(dbFirestore, "restaurants", RESTAURANT_ID, "eod_reports"), {
                    date: new Date().toISOString().split('T')[0],
                    totalSales,
                    cashSales,
                    onlineSales,
                    totalOrders,
                    dinein: parseInt(document.getElementById('eod-dinein')?.textContent || '0') || 0,
                    takeaway: parseInt(document.getElementById('eod-takeaway')?.textContent || '0') || 0,
                    delivery: parseInt(document.getElementById('eod-delivery')?.textContent || '0') || 0,
                    closedBy: localStorage.getItem('adminName') || 'Admin',
                    closedAt: serverTimestamp(),
                    actualCash: parseFloat(document.getElementById('eod-actual-cash')?.value || 0) || 0
                });
                
                await logActivity('settings', 'EOD Report saved and day closed');
                window.showToast('EOD Report saved successfully!', 'success');
                closeEODReportModal();
            } catch (e) {
                console.error(e);
                window.showToast('Failed to save report', 'error');
            }
        };
        
        // --- TAX & FEE SETTINGS ---
        window.saveTaxSettings = async () => {
            try {
                const taxEnabled = document.getElementById('setting-tax-enabled')?.checked ?? true;
                const taxPercent = parseFloat(document.getElementById('setting-tax-percent')?.value) || 5;
                const convenienceFee = parseFloat(document.getElementById('setting-convenience-fee')?.value) || 1.98;
                const gstin = document.getElementById('setting-gstin')?.value || '';
                const cgst = parseFloat(document.getElementById('setting-cgst')?.value) || 2.5;
                const sgst = parseFloat(document.getElementById('setting-sgst')?.value) || 2.5;
                
                const taxData = {
                    taxEnabled,
                    taxPercent,
                    convenienceFee,
                    gstin,
                    cgst,
                    sgst,
                    updatedAt: Date.now()
                };
                
                await setDoc(doc(dbFirestore, `restaurants/${RESTAURANT_ID}/settings`, 'tax'), taxData);
                window.showToast('Tax & Fee settings saved!', 'success');
                console.log('? Tax settings saved:', taxData);
            } catch (e) {
                console.error('? Error saving tax settings:', e);
                window.showToast('Failed to save: ' + e.message, 'error');
            }
        };
        
        window.loadTaxSettings = async () => {
            try {
                const settingsSnap = await getDoc(doc(dbFirestore, `restaurants/${RESTAURANT_ID}/settings`, 'tax'));
                if (settingsSnap.exists()) {
                    const data = settingsSnap.data();
                    const taxEnabledEl = document.getElementById('setting-tax-enabled');
                    const taxPercentEl = document.getElementById('setting-tax-percent');
                    const convFeeEl = document.getElementById('setting-convenience-fee');
                    const gstinEl = document.getElementById('setting-gstin');
                    const cgstEl = document.getElementById('setting-cgst');
                    const sgstEl = document.getElementById('setting-sgst');
                    
                    if (taxEnabledEl) taxEnabledEl.checked = data.taxEnabled !== false;
                    if (taxPercentEl) taxPercentEl.value = data.taxPercent || 5;
                    if (convFeeEl) convFeeEl.value = data.convenienceFee || 1.98;
                    if (gstinEl) gstinEl.value = data.gstin || '';
                    if (cgstEl) cgstEl.value = data.cgst || 2.5;
                    if (sgstEl) sgstEl.value = data.sgst || 2.5;
                    
                    console.log('? Tax settings loaded');
                }
            } catch (e) {
                console.log('?? No tax settings found, using defaults');
            }
        };
        
        // Load tax settings on page load
        setTimeout(loadTaxSettings, 2000);
        
        // --- FEATURE SETTINGS (Admin control, Super Admin allocation) ---
        window.saveFeatureSettings = async () => {
            try {
                // First check if features are allocated by Super Admin
                const allocatedSnap = await getDoc(doc(dbFirestore, `restaurants/${RESTAURANT_ID}/settings`, 'features'));
                const allocated = allocatedSnap.exists() ? allocatedSnap.data() : {};
                
                const featureData = {
                    spinWheel: document.getElementById('setting-spin-wheel')?.checked && allocated.spinWheel,
                    donations: document.getElementById('setting-donations')?.checked && (allocated.donations !== false),
                    promoAds: document.getElementById('setting-promo-ads')?.checked && allocated.promoAds,
                    adminEnabled: {
                        spinWheel: document.getElementById('setting-spin-wheel')?.checked,
                        donations: document.getElementById('setting-donations')?.checked,
                        promoAds: document.getElementById('setting-promo-ads')?.checked
                    },
                    updatedAt: Date.now()
                };
                
                await setDoc(doc(dbFirestore, `restaurants/${RESTAURANT_ID}/settings`, 'features'), featureData, { merge: true });
                window.showToast('Feature settings saved!', 'success');
                console.log('? Feature settings saved:', featureData);
            } catch (e) {
                console.error('? Error saving features:', e);
                window.showToast('Failed to save: ' + e.message, 'error');
            }
        };
        
        window.loadFeatureSettings = async () => {
            try {
                const featuresSnap = await getDoc(doc(dbFirestore, `restaurants/${RESTAURANT_ID}/settings`, 'features'));
                const features = featuresSnap.exists() ? featuresSnap.data() : {};
                
                // Check Super Admin allocation
                const spinWheelAllocated = features.spinWheel || false;
                const donationsAllocated = features.donations !== false;
                const promoAdsAllocated = features.promoAds || false;
                
                // Set checkbox states based on admin preferences
                const adminEnabled = features.adminEnabled || {};
                document.getElementById('setting-spin-wheel').checked = adminEnabled.spinWheel || false;
                document.getElementById('setting-donations').checked = adminEnabled.donations !== false;
                document.getElementById('setting-promo-ads').checked = adminEnabled.promoAds || false;
                
                // Show/hide or disable features not allocated by Super Admin
                const spinRow = document.getElementById('spinWheel-feature-row');
                const donRow = document.getElementById('donations-feature-row');
                const promoRow = document.getElementById('promoAds-feature-row');
                
                if (!spinWheelAllocated && spinRow) {
                    spinRow.classList.add('opacity-50');
                    spinRow.querySelector('input').disabled = true;
                    spinRow.querySelector('span.text-\\[10px\\]').textContent = '? Not allocated by Super Admin';
                }
                if (!donationsAllocated && donRow) {
                    donRow.classList.add('opacity-50');
                    donRow.querySelector('input').disabled = true;
                    donRow.querySelector('span.text-\\[10px\\]').textContent = '? Not allocated by Super Admin';
                }
                if (!promoAdsAllocated && promoRow) {
                    promoRow.classList.add('opacity-50');
                    promoRow.querySelector('input').disabled = true;
                    promoRow.querySelector('span.text-\\[10px\\]').textContent = '? Not allocated by Super Admin';
                }
                
                console.log('? Feature settings loaded:', features);
            } catch (e) {
                console.log('?? No feature settings found, using defaults');
            }
        };
        
        // Load feature settings on page load
        setTimeout(loadFeatureSettings, 2500);
        
        // --- PROMO AD SETTINGS ---
        window.savePromoAdSettings = async () => {
            try {
                const promoData = {
                    enabled: document.getElementById('promo-ad-enabled')?.checked || false,
                    title: document.getElementById('promo-ad-title')?.value || 'Special Offer!',
                    description: document.getElementById('promo-ad-description')?.value || 'Check out our amazing deals',
                    buttonText: document.getElementById('promo-ad-button')?.value || 'View Offer',
                    linkUrl: document.getElementById('promo-ad-link')?.value || '',
                    bgColor: document.getElementById('promo-ad-bg-color')?.value || '#7c3aed',
                    textColor: document.getElementById('promo-ad-text-color')?.value || '#ffffff',
                    updatedAt: Date.now()
                };
                
                await setDoc(doc(dbFirestore, `restaurants/${RESTAURANT_ID}/settings`, 'promoAd'), promoData);
                window.showToast('Promo ad saved!', 'success');
                console.log('? Promo ad saved:', promoData);
            } catch (e) {
                console.error('? Error saving promo ad:', e);
                window.showToast('Failed to save: ' + e.message, 'error');
            }
        };
        
        window.loadPromoAdSettings = async () => {
            try {
                const promoSnap = await getDoc(doc(dbFirestore, `restaurants/${RESTAURANT_ID}/settings`, 'promoAd'));
                if (promoSnap.exists()) {
                    const data = promoSnap.data();
                    document.getElementById('promo-ad-enabled').checked = data.enabled || false;
                    document.getElementById('promo-ad-title').value = data.title || '';
                    document.getElementById('promo-ad-description').value = data.description || '';
                    document.getElementById('promo-ad-button').value = data.buttonText || '';
                    document.getElementById('promo-ad-link').value = data.linkUrl || '';
                    document.getElementById('promo-ad-bg-color').value = data.bgColor || '#7c3aed';
                    document.getElementById('promo-ad-text-color').value = data.textColor || '#ffffff';
                    console.log('? Promo ad settings loaded');
                }
            } catch (e) {
                console.log('?? No promo ad settings found');
            }
        };
        
        // Load promo ad settings on page load
        setTimeout(loadPromoAdSettings, 3000);
        
        window.downloadGSTReport = () => {
            const today = new Date();
            const month = today.toLocaleString('default', { month: 'long', year: 'numeric' });
            
            // Generate GST report
            const todayOrders = Object.values(window.ordersCache || {});
            const totalTaxable = todayOrders.reduce((sum, o) => sum + ((o.grandTotal || o.total || 0) - (o.tax || 0)), 0);
            const totalCGST = todayOrders.reduce((sum, o) => sum + ((o.tax || 0) / 2), 0);
            const totalSGST = totalCGST;
            
            const csv = [
                'GST Report - ' + month,
                '',
                'Category,Taxable Amount,CGST (2.5%),SGST (2.5%),Total Tax',
                `Food & Beverages,${totalTaxable.toFixed(2)},${totalCGST.toFixed(2)},${totalSGST.toFixed(2)},${(totalCGST + totalSGST).toFixed(2)}`,
                '',
                `Total,${totalTaxable.toFixed(2)},${totalCGST.toFixed(2)},${totalSGST.toFixed(2)},${(totalCGST + totalSGST).toFixed(2)}`
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `gst-report-${month.replace(' ', '-')}.csv`;
            link.click();
            window.showToast('GST Report downloaded!', 'success');
        };
        
        // REFUND / VOID ORDER
        // =====================================================
        let refundOrderId = null;
        
        window.openRefundModal = (orderId) => {
            refundOrderId = orderId;
            const order = (window.ordersCache || {})[orderId];
            if (!order) {
                window.showToast('Order not found', 'error');
                return;
            }
            
            document.getElementById('refund-modal').classList.remove('hidden');
            document.getElementById('refund-order-id').textContent = `#${orderId.slice(-6).toUpperCase()}`;
            document.getElementById('refund-order-amount').textContent = `Rs.${(order.grandTotal || order.total || 0).toLocaleString()}`;
            document.getElementById('refund-amount').value = order.grandTotal || order.total || 0;
            document.getElementById('refund-reason').value = '';
        };
        
        window.closeRefundModal = () => {
            document.getElementById('refund-modal').classList.add('hidden');
            refundOrderId = null;
        };
        
        window.processVoid = async () => {
            if (!refundOrderId) return;
            
            const reason = document.getElementById('refund-reason').value.trim();
            if (!reason) {
                window.showToast('Please enter a reason', 'error');
                return;
            }
            
            try {
                const orderRef = ref(dbRTDB, `restaurants/${RESTAURANT_ID}/orders/${refundOrderId}`);
                await update(orderRef, {
                    status: 'cancelled',
                    voidedAt: Date.now(),
                    voidReason: reason,
                    voidedBy: localStorage.getItem('adminName') || 'Admin'
                });
                
                await logActivity('refund', `Voided order #${refundOrderId.slice(-6).toUpperCase()} - ${reason}`);
                window.showToast('Order voided successfully', 'success');
                closeRefundModal();
            } catch (e) {
                console.error(e);
                window.showToast('Failed to void order', 'error');
            }
        };
        
        window.processRefund = async () => {
            if (!refundOrderId) return;
            
            const reason = document.getElementById('refund-reason').value.trim();
            const amount = parseFloat(document.getElementById('refund-amount').value);
            
            if (!reason) {
                window.showToast('Please enter a reason', 'error');
                return;
            }
            
            if (!amount || amount <= 0) {
                window.showToast('Invalid refund amount', 'error');
                return;
            }
            
            try {
                const orderRef = ref(dbRTDB, `restaurants/${RESTAURANT_ID}/orders/${refundOrderId}`);
                await update(orderRef, {
                    status: 'refunded',
                    refundAmount: amount,
                    refundedAt: Date.now(),
                    refundReason: reason,
                    refundedBy: localStorage.getItem('adminName') || 'Admin'
                });
                
                await logActivity('refund', `Refunded Rs.${amount} for order #${refundOrderId.slice(-6).toUpperCase()} - ${reason}`);
                window.showToast(`Refund of Rs.${amount} processed`, 'success');
                closeRefundModal();
            } catch (e) {
                console.error(e);
                window.showToast('Failed to process refund', 'error');
            }
        };
        
        // =====================================================
        // RECIPE LINKING (INVENTORY DEDUCTION)
        // =====================================================
        let selectedMenuItemForRecipe = null;
        let recipeIngredients = [];
        
        window.openRecipeModal = (menuItemId) => {
            selectedMenuItemForRecipe = menuItemId;
            document.getElementById('recipe-modal').classList.remove('hidden');
            
            // Load existing recipe if any
            const menuItem = (window.menuItemsCache || {})[menuItemId];
            if (menuItem) {
                document.getElementById('recipe-menu-item').textContent = menuItem.name;
                recipeIngredients = menuItem.recipe || [];
            }
            
            renderRecipeIngredients();
            renderInventoryDropdown();
        };
        
        window.closeRecipeModal = () => {
            document.getElementById('recipe-modal').classList.add('hidden');
            selectedMenuItemForRecipe = null;
            recipeIngredients = [];
        };
        
        function renderInventoryDropdown() {
            const select = document.getElementById('recipe-ingredient-select');
            if (!select) return;
            
            select.innerHTML = '<option value="">Select Ingredient</option>' + 
                Object.values(window.inventoryCache || {}).map(item => 
                    `<option value="${item.id}">${item.name} (${item.quantity} ${item.unit})</option>`
                ).join('');
        }
        
        function renderRecipeIngredients() {
            const container = document.getElementById('recipe-ingredients-list');
            if (!container) return;
            
            if (recipeIngredients.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">No ingredients added</p>';
                return;
            }
            
            container.innerHTML = recipeIngredients.map((ing, idx) => {
                const invItem = (window.inventoryCache || {})[ing.inventoryId];
                return `
                    <div class="flex items-center gap-2 p-2 bg-gray-700 rounded">
                        <span class="flex-1">${invItem?.name || 'Unknown'}</span>
                        <span class="text-sm text-primary">${ing.quantity} ${invItem?.unit || ''}</span>
                        <button onclick="removeRecipeIngredient(${idx})" class="text-red-400 hover:text-red-300">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        window.addRecipeIngredient = () => {
            const select = document.getElementById('recipe-ingredient-select');
            const qtyInput = document.getElementById('recipe-ingredient-qty');
            
            const inventoryId = select.value;
            const quantity = parseFloat(qtyInput.value);
            
            if (!inventoryId || !quantity || quantity <= 0) {
                window.showToast('Select ingredient and enter quantity', 'error');
                return;
            }
            
            // Check if already exists
            const existing = recipeIngredients.findIndex(r => r.inventoryId === inventoryId);
            if (existing >= 0) {
                recipeIngredients[existing].quantity += quantity;
            } else {
                recipeIngredients.push({ inventoryId, quantity });
            }
            
            renderRecipeIngredients();
            select.value = '';
            qtyInput.value = '';
        };
        
        window.removeRecipeIngredient = (idx) => {
            recipeIngredients.splice(idx, 1);
            renderRecipeIngredients();
        };
        
        window.saveRecipe = async () => {
            if (!selectedMenuItemForRecipe) return;
            
            try {
                // Save to menu item in Firebase
                // Note: Implement based on your menu storage structure
                const menuItem = (window.menuItemsCache || {})[selectedMenuItemForRecipe];
                if (menuItem) {
                    menuItem.recipe = recipeIngredients;
                    // If menu is stored in Firestore:
                    // await updateDoc(doc(dbFirestore, "restaurants", RESTAURANT_ID, "menu", selectedMenuItemForRecipe), { recipe: recipeIngredients });
                }
                
                window.showToast('Recipe saved! Inventory will auto-deduct on orders.', 'success');
                closeRecipeModal();
            } catch (e) {
                console.error(e);
                window.showToast('Failed to save recipe', 'error');
            }
        };
        
        // Auto-deduct inventory when order is completed
        async function autoDeductInventory(order) {
            if (!order.items) return;
            
            const menuItemsList = Object.values(window.menuItemsCache || {});
            const inventoryItems = window.inventoryCache || {};
            
            for (const item of order.items) {
                const menuItem = menuItemsList.find(m => m.name === item.name);
                if (!menuItem?.recipe) continue;
                
                const qty = item.qty || 1;
                
                for (const ing of menuItem.recipe) {
                    const invItem = inventoryItems[ing.inventoryId];
                    if (!invItem) continue;
                    
                    const deductQty = ing.quantity * qty;
                    const newQty = Math.max(0, (invItem.quantity || 0) - deductQty);
                    
                    try {
                        await updateDoc(doc(dbFirestore, "restaurants", RESTAURANT_ID, "inventory", ing.inventoryId), {
                            quantity: newQty,
                            lastDeducted: serverTimestamp()
                        });
                    } catch (e) {
                        console.error('Failed to deduct inventory:', e);
                    }
                }
            }
        }
        
        // =====================================================
        // MULTI-BRANCH MANAGEMENT
        // =====================================================
        let branches = [];
        let currentBranch = null;
        
        window.openBranchSelector = async () => {
            document.getElementById('branch-selector-modal').classList.remove('hidden');
            await loadBranches();
        };
        
        window.closeBranchSelector = () => {
            document.getElementById('branch-selector-modal').classList.add('hidden');
        };
        
        async function loadBranches() {
            const container = document.getElementById('branch-list');
            container.innerHTML = '<p class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> Loading branches...</p>';
            
            try {
                const q = query(collection(dbFirestore, "branches"));
                const snap = await getDocs(q);
                branches = [];
                snap.forEach(doc => branches.push({ id: doc.id, ...doc.data() }));
                
                currentBranch = localStorage.getItem('currentBranch') || RESTAURANT_ID;
                
                if (branches.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4">
                            <p class="text-gray-400 mb-4">No other branches found</p>
                            <p class="text-sm text-gray-500">Contact super admin to add branches</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = branches.map(b => `
                    <div class="flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-all ${b.id === currentBranch ? 'bg-primary/20 border border-primary' : 'bg-gray-700 hover:bg-gray-600'}"
                         onclick="switchBranch('${b.id}')">
                        <div class="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center">
                            <i class="fas fa-store"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-medium">${b.name}</p>
                            <p class="text-xs text-gray-400">${b.address || 'No address'}</p>
                        </div>
                        ${b.id === currentBranch ? '<span class="text-primary text-sm"><i class="fas fa-check"></i> Active</span>' : ''}
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load branches:', e);
                container.innerHTML = '<p class="text-center text-red-400 py-4">Failed to load branches</p>';
            }
        }
        
        window.switchBranch = (branchId) => {
            if (branchId === currentBranch) return;
            
            localStorage.setItem('currentBranch', branchId);
            window.showToast('Switching branch...', 'info');
            
            // Reload page to load new branch data
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        };
        
        // =====================================================
        // MENU ENHANCEMENTS
        // =====================================================
        window.toggleItemAvailability = async (itemId, available) => {
            try {
                const menuItem = (window.menuItemsCache || {})[itemId];
                if (menuItem) {
                    menuItem.available = available;
                    // Update in Firebase if needed
                    if (typeof logActivity === 'function') {
                        await logActivity('edit', `Toggled ${menuItem.name} ${available ? 'available' : 'unavailable'}`);
                    }
                    window.showToast(`${menuItem.name} is now ${available ? 'available' : 'out of stock'}`, 'success');
                    if (typeof renderMenuItems === 'function') renderMenuItems();
                }
            } catch (e) {
                console.error(e);
                window.showToast('Failed to update item', 'error');
            }
        };
        
        window.bulkToggleOutOfStock = () => {
            const menuItemsList = Object.values(window.menuItemsCache || {});
            const outOfStockItems = menuItemsList.filter(m => !m.available);
            if (outOfStockItems.length === 0) {
                window.showToast('No out-of-stock items to restore', 'info');
                return;
            }
            
            outOfStockItems.forEach(item => {
                item.available = true;
            });
            
            window.showToast(`${outOfStockItems.length} items restored to available`, 'success');
            if (typeof renderMenuItems === 'function') renderMenuItems();
        };
        
        function updateMenuStats() {
            const menuItemsList = Object.values(window.menuItemsCache || {});
            const totalItems = menuItemsList.length;
            const available = menuItemsList.filter(m => m.available !== false).length;
            const outOfStock = totalItems - available;
            
            const statsEl = document.getElementById('menu-stats');
            if (statsEl) {
                statsEl.innerHTML = `
                    <span class="text-green-400">${available} Available</span>
                    <span class="mx-2">|</span>
                    <span class="text-red-400">Stock</span>
                `;
            }
        }
        
        // =====================================================
        // ROLE BASED ACCESS CONTROL (RBAC)
        // =====================================================
        window.manageRole = (role) => {
            const rolePermissions = {
                'manager': {
                    name: 'Manager',
                    permissions: ['View Dashboard', 'Manage Orders', 'View Reports', 'Manage Menu', 'Manage Staff'],
                    color: 'purple'
                },
                'waiter': {
                    name: 'Waiter',
                    permissions: ['Take Orders', 'View Tables', 'Update Order Status'],
                    color: 'blue'
                },
                'cashier': {
                    name: 'Cashier',
                    permissions: ['Process Payments', 'View Orders', 'Generate Bills', 'EOD Reports'],
                    color: 'green'
                }
            };
            
            const roleInfo = rolePermissions[role];
            if (!roleInfo) {
                window.showToast('Invalid role', 'error');
                return;
            }
            
            const permList = roleInfo.permissions.map(p => `<li class="flex items-center gap-2"><i class="fas fa-check text-${roleInfo.color}-500"></i>${p}</li>`).join('');
            
            // Create a simple modal for now
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden">
                    <div class="p-4 border-b bg-${roleInfo.color}-50">
                        <h3 class="font-bold text-lg text-${roleInfo.color}-800"><i class="fas fa-user-shield mr-2"></i>${roleInfo.name} Role</h3>
                    </div>
                    <div class="p-6">
                        <h4 class="font-bold text-gray-700 mb-3">Permissions:</h4>
                        <ul class="space-y-2 text-sm text-gray-600">${permList}</ul>
                        <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-500">To modify permissions, go to Settings?ï¿½ï¿½?ï¿½ï¿½ Staff Management and assign roles to team members.</p>
                        </div>
                    </div>
                    <div class="p-4 border-t bg-gray-50">
                        <button onclick="this.closest('.fixed').remove()" class="w-full bg-gray-600 text-white py-2 rounded-xl font-bold hover:bg-gray-700">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        };
        
        // =====================================================
        // INITIALIZE Command Center
        // =====================================================
        function initCommandCenter() {
            // Update dashboard stats every 30 seconds
            setInterval(() => {
                if (document.getElementById('section-dashboard')?.classList.contains('hide-section') === false) {
                    updateLiveSalesTicker();
                    updateOrderVelocity();
                    updateTopSellingItems();
                    updateAlertsPanel();
                }
            }, 30000);
            
            // Initial update
            setTimeout(() => {
                updateTopSellingItems();
                updateAlertsPanel();
            }, 2000);
        }
        
        // Call init
        initCommandCenter();

    </script>
</body>

</html>
